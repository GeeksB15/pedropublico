import{_ as G,Y as W,Z as K,$ as Y,bp as X,dB as oo,be as to,cc as D,cb as B,cd as ao,a5 as eo,aF as io,cf as T,p as w,o as p,d as z,f as e,w as i,K as so,G as ro,A as lo,B as N,C as Z,D as A,L as no,E as U,e as u,H as co,t as v,l as C,i as y,s as $,x as d,Q as j,j as O,N as R,P as M,R as I,F as P,r as Q,S as k,k as S,a4 as J,I as mo,y as uo,aE as E,bi as po,a6 as fo,az as ho,b0 as go}from"./index.094a6fb0.js";import{l as vo}from"./listaV2.63da52a4.js";import{P as _o}from"./ItensManipulacaoApontamento.7c9c243a.js";import"./QBreadcrumbs.efe5b83b.js";import"./xlsx.6cceadb4.js";const bo={components:{Avatar:W,Badge:K,BadgeCopiarUid:Y,PromptItemV2:X,CodigoBarras:oo,PromptApontamento:_o,SeletorCampoTabela:to},data(){return{itens:{},documentoAnterior:{},documentoItensAnterior:[],documento:{id:"",codigoDocumento:"",idEmpresa:"",codigoEmpresa:"",descricaoEmpresa:"",numeroDocumentoEmpresa:"",inscricaoMunicipalEmpresa:"",operacao:"Manipulacao",tipo:"Produ\xE7\xE3o",status:"",dataEmissao:D(),dataFinalizacao:"",observacao:""},documentoItens:[],adicionar:{modal:{name:"",value:!1}},listaApontamentos:[],totalOrigem:0,totalDestino:0,visivel:!1,promptApontamento:{},equipamentos:[],composicoes:[],quantidadeOriginal:0,contatos:[],dataPrevistaEntrega:"",horaPrevistaEntrega:""}},emits:["atualizar"],methods:{zerarCampos(){this.documentoAnterior={},this.documentoItensAnterior=[],this.documento={id:B(),idEmpresa:"",descricaoEmpresa:"",operacao:"Manipula\xE7\xE3o",tipo:"Produ\xE7\xE3o",status:"Digita\xE7\xE3o",dataHoraEmissao:D(),dataHoraFinalizado:"",observacao:""},this.documentoItens=[],this.totalOrigem=0,this.totalDestino=0},async atualizar(a){var o,n;if(this.zerarCampos(),a){if(this.documentoAnterior=await $db.itemManipulacao.le({id:a}),this.documento=$utils.clonarV2(this.documentoAnterior),this.documentoItensAnterior=await $db.itemManipulacao.leItens({idDocumento:a}),this.documentoItens=ao(this.documentoItensAnterior),(o=this.documento)!=null&&o.idContato){const l=this.documento.idContato;this.contatos[l]||(this.contatos[l]=await $db.contato.le({id:l}))}if((n=this.documento)!=null&&n.idEmpresa){const l=this.documento.idEmpresa;this.contatos[l]||(this.contatos[l]=await $db.contato.le({id:l}))}this.documento.dataHoraPrevisto&&(this.dataPrevistaEntrega=this.documento.dataHoraPrevisto.slice(0,10),this.horaPrevistaEntrega=this.documento.dataHoraPrevisto.slice(11,16));for(const l of this.documentoItens){if(!l.idItem)continue;const t=await $erp().item.get(l.idItem);!t||t.id in this.itens||(this.itens[t.id]={codigoItem:t.codigoItem,referencia:t.referencia})}}else{let l,t,s;if(t=(await $db.contato.ler({filtros:{ativo:!0,empresas:!0}})).data,!(t.length>0)){this.$q.notify({message:"N\xE3o h\xE1 empresa configurada",timeout:0,type:"negative",closeBtn:!0});return}if(l=t[0],t.length>1){const c={ativo:!0,empresas:!0};if(l=await $g.promptContato.show({filtro:c,placeholder:"Selecione"}),!l){this.visivel=!1,this.$q.notifyError("Empresa n\xE3o selecionada");return}}if(s=(await $erp().empresa.where({idContato:l.id}).toArray())[0],!s){this.visivel=!1,this.$q.notifyError("Erro ao selecionar empresa");return}this.documento.descricaoEmpresa=s.nome,this.documento.idEmpresa=s.idContato,this.documento.numeroDocumentoEmpresa=s.numeroDocumentoNacional,this.documento.inscricaoMunicipalEmpresa=s.numeroDocumentoMunicipal}this.somarValorTotal(),this.buscarApontamentos(),a||this.abrirModal("Destino")},async salvar(a,o){try{if(this.dataPrevistaEntrega){const n=`${this.dataPrevistaEntrega} ${this.horaPrevistaEntrega||"00:00:00"}`;this.documento.dataHoraPrevisto=eo.formatDate(n)}this.dataPrevistaEntrega===null&&(this.documento.dataHoraPrevisto=""),await $db.itemManipulacao.grava({documentoAnterior:this.documentoAnterior,documento:this.documento,documentoItensAnterior:this.documentoItensAnterior,documentoItens:this.documentoItens})}catch(n){this.$q.notifyError("Erro ao salvar",n)}this.atualizar(this.documento.id),this.$emit("atualizar"),this.$q.notify(o),this.visivel=a},finalizar(){if(!!this.verificarTotal()){this.documento.status="Finalizado",this.documento.dataHoraFinalizado=D();for(let o of this.documentoItens)o.status="Finalizado",o.dataHoraFinalizado=D();this.salvar(!1,"Produ\xE7\xE3o Finalizada")}},reabrir(){try{this.documento.status="Digita\xE7\xE3o",this.documento.dataHoraFinalizado="";for(let a of this.documentoItens)a.status="Digita\xE7\xE3o",a.dataHoraFinalizado="";this.salvar(!0,"Produ\xE7\xE3o reaberta")}catch(a){this.$q.notifyError("Erro ao reabrir",a)}},async excluirItem(a){this.documentoItens=this.documentoItens.filter(o=>o.id!==a),this.somarValorTotal()},verificarTotal(){return this.documentoItens.length===0&&this.totalDestino===0&&this.totalOrigem===0?(this.$q.notifyError("Selecione alguns itens na lista"),!1):this.totalOrigem!==this.totalDestino?(this.$q.notifyError("Valores Totais de Origem e Destino devem ser iguais!"),!1):!0},async abrirModal(a,o=""){let n={},l=[];const t=a==="Destino"?1:-1;o?l=this.documentoItens.filter(s=>s.idItem===o):l=this.documentoItens.filter(s=>s.operacaoFator===t);for(const s of l)n[s.idItem]={item:await io().item.get(s.idItem)||{},quantidade:s.quantidade};this.$refs.promptItem.itensSelecionados=n,this.$refs.promptItem.termo=o,this.$refs.promptItem.atualizar(),this.adicionar.modal.value=!0,this.adicionar.modal.name=a},async selecionarItens(a){var l,t,s;let o={};const n=this.adicionar.modal.name==="Destino"?1:-1;for(const c in a){let f=await $db.estoqueSaldoProdutoEmpresa.le({idEmpresa:this.documento.idEmpresa,tipoEstoque:"Dispon\xEDvel",idItem:c});f=f[0];const _=await $db.configuracoes.porNome("vendas.checaestoque",this.documento.idEmpresa),q=!!Number((l=_.find(m=>m.id))==null?void 0:l.valor),h=a[c].item||{},r=a[c].quantidade||0,g=(t=(f==null?void 0:f.valorCustoMedio)||(h==null?void 0:h.valorCustoReposicao))!=null?t:0;if(h.id in this.itens||(this.itens[h.id]={codigoItem:h.codigoItem,referencia:h.referencia}),q&&n===-1&&(!(f!=null&&f.saldo)||r>(f==null?void 0:f.saldo))){this.$q.notifyError(`${h.descricao} n\xE3o dispon\xEDvel no estoque`);continue}let x=this.documentoItens.find(m=>m.idItem===c);x?(x.quantidade=r,x.quantidadeRealizado=r,x.subTotal=T(r*g),x.total=T(r*g)):this.documentoItens.push({dataHoraEmissao:D(),dataHoraFinalizado:"",descricaoItem:h.descricao,id:B(),idDocumento:this.documento.id,idItem:h.id,operacao:"Manipula\xE7\xE3o",operacaoFator:n,quantidade:r,quantidadeRealizado:r,status:"Digita\xE7\xE3o",tipoItem:h.tipo,subTotal:T(r*g),total:T(r*g),unidade:h.unidade,valorCustoMedio:(s=f==null?void 0:f.valorCustoMedio)!=null?s:0,valorItem:g,valorOriginal:g});let H=await $db.item.leCompleto({id:h.id});!this.composicoes.includes(H.atual.composicao[0].idItemUtilizado)&&H.atual.composicao[0].idItemUtilizado!==""?(o={titulo:"Composi\xE7\xE3o",msg:"O item selecionado possui itens de composi\xE7\xE3o, deseja preencher?"},n===1&&await this.verificarComposicao(h.id,r,o)):o={}}this.somarValorTotal()},async verificarComposicao(a,o,n){var c,f;let l=[],t=await $db.item.leCompleto({id:a});(f=(c=t==null?void 0:t.atual)==null?void 0:c.composicao)==null||f.sort((_,q)=>_.ordem<q.ordem?-1:1);for(let _ of t.atual.composicao)_.idItemUtilizado&&(_.quantidade=_.quantidade*o,l.push(_),this.composicoes.push(_.idItemUtilizado));const s=l.reduce((_,q)=>(_[q.idItemUtilizado]||(_[q.idItemUtilizado]=q),_),{});n.titulo?$q.dialog({title:n.titulo,message:n.msg,cancel:!0,persistent:!0}).onOk(()=>{this.adicionar.modal.name="Origem",this.selecionarItens(s),n.titulo=""}):(this.adicionar.modal.name="Origem",this.selecionarItens(s))},async incluirApontamento(a){let o={id:B(),documentoItemIdContato:a.operador,idItem:a.equipamento,tipoItem:"ApontamentoPCP",quantidade:a.quantidade,dataHoraEmissao:a.dataIni,dataHoraFinalizado:a.dataFim,peso:a.peso,idDocumento:this.documento.id};try{await $db.documentoItem.grava({atual:o})}catch(n){this.$q.notifyError("Erro ao salvar",n)}this.buscarApontamentos()},async buscarApontamentos(){try{this.listaApontamentos=[],(await $db.documentoItem.leApontamento({tipoItem:"ApontamentoPCP",idDocumento:this.documento.id})).forEach((o,n)=>{this.listaApontamentos[n]={id:o.id,operador:o.documentoItemIdContato,equipamento:o.idItem,quantidade:o.quantidade,dataIni:o.dataHoraEmissao,dataFim:o.dataHoraFinalizado,peso:o.peso,idDocumento:o.idDocumento}})}catch(a){this.$q.notifyError("Erro ao consultar apontamentos",a)}},async carregarEquipamentos(){let a=await $db.item.leRefatorado({filtros:{tipo:"Servi\xE7o"}});this.equipamentos=a.data.map(o=>({descricao:o.descricao,id:o.id}))},async carregarOperadores(){let a=await $db.contato.leRefatorado({filtros:{}});this.operadores=a.data.map(o=>({nome:o.nome,id:o.id}))},async carregarOperacoes(){let a=await $db.hibrido.lista({table:"documento",where:{tipo:"Produ\xE7\xE3o"}});this.documento.operacoes=a.map(o=>({rotulo:o.operacao,valor:o.operacao}))},async abrirModalContato(){const a=await this.selecionarContato({placeholder:"Selecione o cliente",filtro:{ativo:!0}});a.id&&(this.documento.idContato=a.id),a.nome&&(this.documento.descricaoContato=a.nome),this.contatos[a.id]||(this.contatos[a.id]=await $db.contato.le({id:a.id}))},async selecionarContato(a){const{placeholder:o,filtro:n}={placeholder:"Selecione o contato",filtro:{ativo:!0},...a},l=await $g.promptContato.show({filtro:n,placeholder:o});if(!l)throw new Error("Contato n\xE3o selecionado");return l}},async beforeMount(){await this.carregarEquipamentos(),await this.carregarOperadores()},mounted(){}},Io={key:0},yo={ref:"form"},qo={class:"col-12 col-md"},wo={class:"col-auto"},Co={class:"col"},Eo={class:"col-12 col-md"},zo={class:"col-auto"},ko={class:"col"},xo={class:"col-12 col-md"},Vo={class:"col-6 bg-transparent"},Fo={class:"col-6 bg-transparent"},Ao={class:"col-12"},Po={class:"q-item-label q-mb-none",style:{color:"#0c0c0c"}},Do={class:"col-2 col-md-1"},Mo={class:"col-2 col-md"},So={key:0},Ho=d("br",null,null,-1),To=d("div",{class:"col-3 col-md"},[d("small",null,"Estoque"),d("br"),d("span",{class:"q-mt-xs"},"Dispon\xEDvel 7 | Total 10")],-1),Uo={class:"col-6 col-md text-right"},Oo={class:"col-6 col-md text-right"},Qo={class:"u-container relative-position"};function Lo(a,o,n,l,t,s){const c=w("badge"),f=w("BadgeCopiarUid"),_=w("avatar"),q=w("campo"),h=w("row"),r=w("SeletorCampoTabela"),g=w("CodigoBarras"),x=w("PromptItemV2"),H=w("PromptApontamento");return p(),z(P,null,[e(uo,{modelValue:t.visivel,"onUpdate:modelValue":o[7]||(o[7]=m=>t.visivel=m),maximized:""},{default:i(()=>[e(so,{class:"bg-light",container:""},{default:i(()=>[e(ro,{class:"u-container"},{default:i(()=>[e(lo,null,{default:i(()=>[e(N,null,{default:i(()=>[Z(e(A,{dense:"",flat:"",icon:"arrow_back",round:""},null,512),[[no]]),e(U,null,{default:i(()=>[u("Separa\xE7\xE3o")]),_:1}),e(A,{class:"q-ml-sm no-shadow",color:"white",unelevated:"","text-color":"primary",label:"Salvar",onClick:o[0]||(o[0]=m=>s.salvar(!1,"Produ\xE7\xE3o salva!"))})]),_:1})]),_:1}),e(co,null,{default:i(()=>[e(N,{class:"q-pa-none q-ma-none q-my-md",color:"none","text-color":"black",style:{"min-height":"auto"}},{default:i(()=>[e(U,{class:"text-black q-px-none text-body2"},{default:i(()=>[u("Emiss\xE3o: "+v(a.$filters.data(t.documento.dataHoraEmissao))+" ",1),t.documento.dataHoraFinalizado?(p(),z("span",Io,"Cancelamento: "+v(a.$filters.data(t.documento.dataHoraFinalizado)),1)):C("",!0)]),_:1}),t.documento.status?(p(),y(c,{key:0,cor:"positive",class:"q-mx-sm",icone:"flag",escuro:""},{default:i(()=>[u(v(t.documento.status),1)]),_:1})):C("",!0),t.documento.numero?(p(),y(c,{key:1,class:"q-mr-sm",cor:"tertiary",escuro:""},{default:i(()=>[u(" #"+v(t.documento.numero.toString().padStart(6,"0")),1)]),_:1})):(p(),y(f,{key:2,id:t.documento.id,numero:t.documento.id.slice(-8),cor:"tertiary"},null,8,["id","numero"]))]),_:1}),e($,{class:"bg-white q-pa-md q-mt-md no-shadow"},{default:i(()=>[d("form",yo,[e(h,{class:"q-col-gutter-sm"},{default:i(()=>[d("div",qo,[e(h,null,{default:i(()=>{var m,F,V,b;return[d("div",wo,[e(_,{imagem:(F=(m=t.contatos[t.documento.idEmpresa])==null?void 0:m.imagem)!=null?F:"",rotulo:(b=(V=t.contatos[t.documento.idEmpresa])==null?void 0:V.nome)!=null?b:"",tamanho:"30",style:{float:"left"},class:"q-mr-sm"},null,8,["imagem","rotulo"])]),d("div",Co,[e(q,{somenteLeitura:"",rotulo:"Transportadora",tipo:"texto",class:"col-10",modelValue:t.documento.descricaoEmpresa,"onUpdate:modelValue":o[1]||(o[1]=L=>t.documento.descricaoEmpresa=L)},null,8,["modelValue"])])]}),_:1})]),d("div",Eo,[e(h,null,{default:i(()=>{var m,F,V,b;return[d("div",zo,[e(_,{imagem:(F=(m=t.contatos[t.documento.idContato])==null?void 0:m.imagem)!=null?F:"",rotulo:(b=(V=t.contatos[t.documento.idEmpresa])==null?void 0:V.nome)!=null?b:"",tamanho:"30",style:{float:"left"},class:"q-mr-sm"},null,8,["imagem","rotulo"])]),d("div",ko,[e(q,{somenteLeitura:"",placeholder:"Cliente",rotulo:"Cliente",tipo:"texto",after:[{icon:"search",handler(){s.abrirModalContato()}}],modelValue:t.documento.descricaoContato,"onUpdate:modelValue":o[2]||(o[2]=L=>t.documento.descricaoContato=L)},null,8,["after","modelValue"])])]}),_:1})])]),_:1}),e(h,null,{default:i(()=>[d("div",{class:"col-12 col-md",onClick:o[4]||(o[4]=(...m)=>s.carregarOperacoes&&s.carregarOperacoes(...m))},[e(r,{modelValue:t.documento.operacao,"onUpdate:modelValue":o[3]||(o[3]=m=>t.documento.operacao=m),filtro:{tipo:"Produ\xE7\xE3o"},tabela:"documento",campo:"operacao",label:"Tipo de Transportadora",buscarSemCaractere:!0,enableAdd:""},null,8,["modelValue"])]),d("div",xo,[e(h,null,{default:i(()=>[d("div",Vo,[e(j,{modelValue:t.dataPrevistaEntrega,"onUpdate:modelValue":o[5]||(o[5]=m=>t.dataPrevistaEntrega=m),type:"date",clearable:"",dense:"","stack-label":"",label:"Data Prevista de Entrega"},null,8,["modelValue"])]),d("div",Fo,[e(j,{modelValue:t.horaPrevistaEntrega,"onUpdate:modelValue":o[6]||(o[6]=m=>t.horaPrevistaEntrega=m),type:"time",clearable:"",dense:"","stack-label":"",label:"Hora Prevista de Entrega"},null,8,["modelValue"])])]),_:1})])]),_:1})],512)]),_:1}),e(h,{class:"q-col-gutter-x-sm q-mt-md"},{default:i(()=>[d("div",Ao,[e($,{class:"no-shadow bg-white full-width fit q-pa-md"},{default:i(()=>[e(N,{class:"q-pa-none q-ma-none q-mb-md",color:"none","text-color":"black",style:{"min-height":"auto"}},{default:i(()=>[d("p",Po,[e(O,{class:"q-mr-md",name:"shopping_cart",size:"24px",style:{color:"#737373"}}),u(" Itens ")]),e(U,{class:"q-pa-none q-ma-none",style:{height:"0 !important","min-height":"auto"}}),e(g)]),_:1}),e(R,{class:"col-12 no-border q-mx-none q-pa-none"},{default:i(()=>[e(M,{class:"q-pa-none"},{default:i(()=>[e(I,null,{default:i(()=>[(p(!0),z(P,null,Q(t.documentoItens,(m,F)=>(p(),z("div",{key:F},[m.operacaoFator===-1?(p(),y(k,{key:0,caption:""},{default:i(()=>[e(h,{class:"text-left justify-around"},{default:i(()=>{var V;return[d("div",Do,[e(_,{imagem:"https://media.istockphoto.com/id/1212936395/pt/vetorial/funny-cartoon-monster-face-vector-monster-square-avatar.jpg?s=170667a&w=0&k=20&c=GqTIimVozdAMxd2e5ok0AQTCbPnu3pIV6ALgjht15hM=",tamanho:"30",class:"q-mr-sm"})]),d("div",Mo,[(V=t.itens[m.idItem])!=null&&V.referencia?(p(),z("span",So,[u(v(m.descricaoItem||"-")+" ",1),Ho,e(c,{cor:"warning",class:"q-mr-xs q-mt-xs",denso:"",escuro:""},{default:i(()=>{var b;return[u(v((b=t.itens[m.idItem])==null?void 0:b.referencia)+" ",1),e(S,null,{default:i(()=>[u("Referencia")]),_:1})]}),_:2},1024),e(c,{cor:"tertiary",class:"q-mr-xs q-mt-xs",denso:"",escuro:""},{default:i(()=>{var b;return[u(" #"+v((b=t.itens[m.idItem])==null?void 0:b.codigoItem)+" ",1),e(S,null,{default:i(()=>[u("codigoItem")]),_:1})]}),_:2},1024),e(c,{class:"q-mr-xs q-mt-xs",denso:""},{default:i(()=>{var b;return[u(" #"+v((b=t.itens[m.idItem])==null?void 0:b.codigoItem)+" ",1),e(S,null,{default:i(()=>[u("codigoItem")]),_:1})]}),_:2},1024)])):C("",!0)]),To,d("div",Uo,[e(q,{dense:"",min:"1",modelValue:m.quantidade,"onUpdate:modelValue":b=>m.quantidade=b,modelModifiers:{number:!0},outlined:"",somenteLeitura:"",tipo:"decimal",decimals:"4",zerosDireita:"0"},null,8,["modelValue","onUpdate:modelValue"])]),d("div",Oo,[e(q,{dense:"",min:"1",modelValue:m.quantidade,"onUpdate:modelValue":b=>m.quantidade=b,modelModifiers:{number:!0},outlined:"",tipo:"quantidade",decimals:"4",zerosDireita:"0"},null,8,["modelValue","onUpdate:modelValue"])])]}),_:2},1024)]),_:2},1024)):C("",!0),m.operacaoFator===-1?(p(),y(J,{key:1,class:"q-my-xs"})):C("",!0),m.operacaoFator===-1?(p(),y(k,{key:2,caption:""})):C("",!0)]))),128))]),_:1})]),_:1})]),_:1})]),_:1})])]),_:1})]),_:1}),e(mo,{class:"bg-light no-shadow q-pa-sm text-right",bordered:""},{default:i(()=>[d("div",Qo,[e(U,{class:"text-right"},{default:i(()=>[t.documento.status==="Finalizado"?(p(),y(A,{key:0,color:"primary",label:"Reabrir",onClick:s.reabrir},null,8,["onClick"])):C("",!0),t.documento.status==="Digita\xE7\xE3o"?(p(),y(A,{key:1,color:"primary",label:"Finalizar",onClick:s.finalizar},null,8,["onClick"])):C("",!0)]),_:1})])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(x,{modelValue:t.adicionar.modal.value,"onUpdate:modelValue":o[8]||(o[8]=m=>t.adicionar.modal.value=m),habilitarQuantidade:!0,filtro:{ativo:!0,idEmpresa:t.documento.idEmpresa},exibirValorVenda:!1,onSelecionarItens:s.selecionarItens,ref:"promptItem"},null,8,["modelValue","filtro","onSelecionarItens"]),e(H,{onIncluirApontamento:s.incluirApontamento,habilitarQuantidade:!0,ref:"promptApontamento"},null,8,["onIncluirApontamento"])],64)}var Bo=G(bo,[["render",Lo]]);const No={components:{lista:vo,Badge:K,ItensModal:Bo,BadgeCopiarUid:Y},data(){return{paginacao:{atual:1,minimo:1,maximo:1,total:1,limite:25},filtros:{tab:"digitacao",empresa:{selecionada:"",opcoes:[]},periodoEmissao:{ini:"",fim:""},periodoFinalizado:{ini:"",fim:""}},documentos:[],tabs:[{rotulo:"Ag. Separa\xE7\xE3o",value:"digitacao"},{rotulo:"Em Separa\xE7\xE3o",value:"finalizado"},{rotulo:"Todos",value:"Todos"}],tabSelecionada:{valor:"digitacao"},listaLayout:{},buscaCampo:"",checkboxModel:[],configImpressao:[]}},watch:{showFilters:function(a){a===!0?this.showList=!1:(this.section===!0||this.kanban===!0||this.gantt===!0)&&(this.showList=!0)}},methods:{async atualizar(){this.filtros.tab=this.tabSelecionada.valor;try{this.$q.loading.show();const a=this.paginacao.limite,o=this.paginacao.atual,n="descricao";let l="";this.filtros.tab==="digitacao"?l="Digita\xE7\xE3o":this.filtros.tab==="finalizado"&&(l="Finalizado");let t=this.filtros.empresa.selecionada.value||"";this.filtros.idEmpresa=t;let s={};if(this.buscaCampo){let c=this.$utils.eliminarVazios(this.filtros);c.termoBusca=this.buscaCampo,c.status=l,s=await this.filtrarCampos(c,a,o,n)}else{let c=this.$utils.eliminarVazios(this.filtros);c.status=l,s=await this.filtrarCampos(c,a,o,n)}this.listaLayout={};for(let c of s.data)this.listaLayout[c.id]={detalhes:!1};this.documentos=s.data,this.calcularPorcentagem(this.documentos),this.paginacao.total=s.total,this.paginacao.maximo=s.totalPages,this.configuraImpressao(this.filtros.idEmpresa)}catch(a){this.$q.notifyError("Erro iniciar",a)}finally{this.$q.loading.hide()}},async filtrarCampos(a,o,n,l){return console.log({filtros:a}),E.itemManipulacao.leRefatorado({filtros:a,limit:o,page:n,sort:l})},limparFiltros_click(){this.filtros={tab:this.tabAtiva,empresa:{selecionada:"",opcoes:[]},periodoEmissao:{ini:"",fim:""},periodoFinalizado:{ini:"",fim:""}},this.atualizar()},async showDetails(a){let o=await E.itemManipulacao.leItens({idDocumento:a.id});a.documentoItens=o,a.showPreviewDetail=!a.showPreviewDetail},async editarManipulacao(a){this.$router.replace({params:{id:a}}),this.$refs.ItensModal.visivel=!0,await this.$refs.ItensModal.atualizar(a)},async adicionarManipulacaoItens(){this.$refs.ItensModal.visivel=!0,await this.$refs.ItensModal.atualizar()},async filtrar(a=1){this.buscaCampo="";const o=(a-1)*this.pageSize;this.documentos.status="digitacao";let n=await E.itemManipulacao.le({periodoEmissao:{ini:this.filtro.periodoEmissao.ini,fim:this.filtro.periodoEmissao.fim},periodoFinalizado:{ini:this.filtro.periodoFinalizado.ini,fim:this.filtro.periodoFinalizado.fim},status:this.page.ativa,idEmpresa:this.filtro.empresas.selected,offset:o,limit:this.pageSize});this.documentos=n[0].map(t=>({...t,showPreviewDetail:!1,documentoItens:[]})),this.documentos=po.exports.orderBy(this.documentos,["dataHoraFinalizado","dataHoraEmissao"],["desc","desc"]);let l=n[1];this.page.digitacao.max=Math.ceil(l/this.pageSize),this.page.finalizado.max=Math.ceil(l/this.pageSize)},excluir(a){$q.dialog({cancel:{label:"N\xE3o",push:!0,color:"tertiary",flat:!0},title:"Remover",message:"Ao continuar voc\xEA ir\xE1 remover este item.",ok:{label:"Sim",push:!0,class:"bg-negative",textColor:"white",flat:!0}}).onOk(async()=>{try{$q.loading.show(),await E.itemManipulacao.remove(a),this.atualizar(),$q.notifyPositive("O item foi exclu\xEDdo com sucesso.")}catch(o){$q.notifyError("Ocorreu um erro ao remover item",o)}finally{$q.loading.hide()}})},async buscar(){setTimeout(async()=>{let o=(await E.item.ler({filtros:{termoBusca:this.buscaCampo}})).data,n=[],l=[];for(let t of o)n=await E.itemManipulacao.leItens({idItem:t.id});for(let t of n){console.log("doc");let s=await E.itemManipulacao.le({id:t.idDocumento});l.push(s)}this.documentos=l.map(t=>({...t,showPreviewDetail:!1,documentoItens:[]}))},1500)},async empresaOpcoesCarregar(){console.log("carregar empresas"),this.filtros.empresa.opcoes=(await E.empresa.le()).map(a=>({rotulo:a.nome,valor:a.idContato}))},async configuraImpressao(a){const o=await $db.configuracoes.porNome("impressao.producao",a);this.configImpressao=[...o.length?o.map(n=>({texto:"Imprimir Composi\xE7\xE3o",...n})):[{valor:"Impressao-ordem-producao",texto:"Ordem de Produ\xE7\xE3o"},{valor:"impressao-etiqueta-pcp1",texto:"Etiq. 2 - Semi Acabado"},{valor:"impressao-etiqueta-pcp2",texto:"Etiq. 1 - Acabado"}]]},async calcularPorcentagem(a){for(let o=0;o<a.length;o++){let n=0,l=0,t=await E.itemManipulacao.leItens({idDocumento:a[o].id}),s=await E.documentoItem.leApontamento({tipoItem:"ApontamentoPCP",idDocumento:a[o].id});t.forEach((c,f)=>{c?c.operacaoFator===1&&(n+=c.quantidade):n+=0}),s.forEach((c,f)=>{c?c.tipoItem==="ApontamentoPCP"&&(l+=c.quantidade):l+=0}),n===0?(a[o].porcentagemApontamento=0,a[o].porcentagemApontamentoLabel="0 %"):(a[o].porcentagemApontamento=l/n,a[o].porcentagemApontamentoLabel=`${Math.round(l/n*100)} %`)}}},created(){this.atualizar()}},Ro={class:"row"},$o={class:"col-12 row q-px-md q-mt-lg"},jo=d("strong",{class:"col-12 text-body1 text-dark"},"Per\xEDodo de Emiss\xE3o",-1),Go={class:"col-6"},Ko={class:"col-6"},Yo={class:"col-12 row q-px-md q-mt-lg"},Zo=d("strong",{class:"col-12 text-body1 text-dark"},"Per\xEDodo de Finaliza\xE7\xE3o",-1),Jo={class:"col-6"},Wo={class:"col-6"},Xo={class:"col-12 row q-px-md q-mt-lg"},ot={class:"row items-center"},tt={class:"text-tertiary q-gutter-xs"},at=d("strong",null,"Descri\xE7\xE3o",-1),et=d("strong",null,"Quantidade ",-1),it=d("strong",null,"C\xF3digo Item ",-1);function st(a,o,n,l,t,s){const c=w("campo"),f=w("badge"),_=w("BadgeCopiarUid"),q=w("lista"),h=w("ItensModal");return p(),z("div",null,[e(q,{titulo:"Separa\xE7\xE3o",onCriar_click:s.adicionarManipulacaoItens,showAdd:!1,showToolbar:!1,icone:"mdi-forklift",onFiltro_change:s.atualizar,onLimparFiltros_click:s.limparFiltros_click,textoNovo:"Iniciar Separa\xE7\xE3o",iconNovo:"false",tabSelecionada:t.tabSelecionada,tabs:t.tabs,listaLayout:t.listaLayout,paginacao:t.paginacao,filtros:t.filtros,buscaCampo:t.buscaCampo,"onUpdate:buscaCampo":o[7]||(o[7]=r=>t.buscaCampo=r),checkboxModel:t.checkboxModel,"onUpdate:checkboxModel":o[8]||(o[8]=r=>t.checkboxModel=r)},{filtroCampos:i(()=>[d("div",Ro,[d("div",{class:"col-12 q-px-sm",onClick:o[1]||(o[1]=(...r)=>s.empresaOpcoesCarregar&&s.empresaOpcoesCarregar(...r))},[e(c,{modelValue:t.filtros.empresa.selecionada,"onUpdate:modelValue":o[0]||(o[0]=r=>t.filtros.empresa.selecionada=r),opcoes:t.filtros.empresa.opcoes,rotulo:"Por Empresa",tipo:"seletor"},null,8,["modelValue","opcoes"])]),d("div",$o,[jo,d("div",Go,[e(c,{modelValue:t.filtros.periodoEmissao.ini,"onUpdate:modelValue":o[2]||(o[2]=r=>t.filtros.periodoEmissao.ini=r),after:[{icon:"mdi-close-circle",handler(){t.filtros.periodoEmissao.ini=""}}],class:"no-shadow full-width",rotulo:"De",tipo:"data"},null,8,["modelValue","after"])]),d("div",Ko,[e(c,{modelValue:t.filtros.periodoEmissao.fim,"onUpdate:modelValue":o[3]||(o[3]=r=>t.filtros.periodoEmissao.fim=r),after:[{icon:"mdi-close-circle",handler(){t.filtros.periodoEmissao.fim=""}}],class:"no-shadow full-width",rotulo:"at\xE9",tipo:"data"},null,8,["modelValue","after"])])]),d("div",Yo,[Zo,d("div",Jo,[e(c,{modelValue:t.filtros.periodoFinalizado.ini,"onUpdate:modelValue":o[4]||(o[4]=r=>t.filtros.periodoFinalizado.ini=r),after:[{icon:"mdi-close-circle",handler(){t.filtros.periodoFinalizado.ini=""}}],class:"no-shadow full-width",rotulo:"De",tipo:"data"},null,8,["modelValue","after"])]),d("div",Wo,[e(c,{modelValue:t.filtros.periodoFinalizado.fim,"onUpdate:modelValue":o[5]||(o[5]=r=>t.filtros.periodoFinalizado.fim=r),after:[{icon:"mdi-close-circle",handler(){t.filtros.periodoFinalizado.fim=""}}],class:"no-shadow full-width",rotulo:"at\xE9",tipo:"data"},null,8,["modelValue","after"])])]),d("div",Xo,[e(fo,{modelValue:t.paginacao.limite,"onUpdate:modelValue":o[6]||(o[6]=r=>t.paginacao.limite=r),options:[10,25,50,100],placeholder:"Quantidade por p\xE1gina"},null,8,["modelValue"])])])]),itemLista:i(()=>[(p(!0),z(P,null,Q(t.documentos,r=>(p(),y(R,{key:r.id,class:"q-py-none qListaItems",style:{border:"none !important"}},{default:i(()=>[e(M,{class:"items-center d-flex"},{default:i(()=>[e(I,{avatar:"",center:""},{default:i(()=>[d("div",ot,[r.numero?(p(),y(f,{key:0,class:"q-mr-sm",cor:"tertiary",escuro:""},{default:i(()=>[u(" #"+v(r.numero.toString().padStart(6,"0")),1)]),_:2},1024)):(p(),y(_,{key:1,id:r.id,numero:r.id.slice(-8),cor:"tertiary"},null,8,["id","numero"]))])]),_:2},1024),e(I,null,{default:i(()=>[e(k,null,{default:i(()=>[u(v(r.descricaoEmpresa),1)]),_:2},1024)]),_:2},1024),e(I,null,{default:i(()=>[e(k,null,{default:i(()=>[u(v(r.descricaoContato),1)]),_:2},1024)]),_:2},1024),e(I,{caption:""},{default:i(()=>[e(k,null,{default:i(()=>[e(O,{class:"text-tertiary",name:"event"}),u(" "+v(a.$filters.data(r.dataHoraEmissao)),1)]),_:2},1024),e(S,null,{default:i(()=>[u("Data Emiss\xE3o "+v(a.$filters.dataHora(r.dataHoraEmissao)),1)]),_:2},1024)]),_:2},1024),t.tabSelecionada.valor!=="digitacao"?(p(),y(I,{key:0,caption:""},{default:i(()=>[e(k,null,{default:i(()=>[e(O,{class:"text-tertiary",name:"event"}),u(" "+v(a.$filters.data(r.dataHoraFinalizado)),1)]),_:2},1024),e(S,null,{default:i(()=>[u("Data Finalizado "+v(a.$filters.dataHora(r.dataHoraFinalizado)),1)]),_:2},1024)]),_:2},1024)):C("",!0),e(I,{caption:""},{default:i(()=>[e(k,null,{default:i(()=>[u(" Tipo de transporte ")]),_:1})]),_:1}),e(I,{caption:""},{default:i(()=>[e(k,null,{default:i(()=>[u(" Transportadora ")]),_:1})]),_:1}),e(I,{avatar:""},{default:i(()=>[e(f,{class:"q-mr-sm",cor:"warning",escuro:""},{default:i(()=>[u(v(r.status),1)]),_:2},1024)]),_:2},1024),e(I,{side:"",top:""},{default:i(()=>[d("div",tt,[e(A,{icon:r.showPreviewDetail?"keyboard_arrow_up":"keyboard_arrow_down",class:"buttons",color:"tertiary",dense:"",flat:"",round:"",size:"md",onClick:g=>s.showDetails(r)},null,8,["icon","onClick"]),e(A,{rounded:"",dense:"",flat:"",icon:"print",color:"primary",class:"no-shadow q-mx-xs",size:"md",style:{float:"right"}},{default:i(()=>[e(ho,null,{default:i(()=>[e(R,{link:"",separator:""},{default:i(()=>[(p(!0),z(P,null,Q(t.configImpressao.filter(g=>g.valor),g=>(p(),y(M,{clickable:"",key:g.valor,onClick:x=>a.$imprimir(g.valor,(r||{}).id||"0")},{default:i(()=>[e(I,{avatar:""},{default:i(()=>[e(O,{name:"print"})]),_:1}),e(I,null,{default:i(()=>[e(k,null,{default:i(()=>[u(v(g.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:2},1024)]),_:2},1024)]),_:2},1024),e(A,{class:"buttons",color:"tertiary",dense:"",flat:"",icon:"play_circle",round:"",size:"md",onClick:g=>s.editarManipulacao(r.id)},null,8,["onClick"])])]),_:2},1024)]),_:2},1024),r.showPreviewDetail?(p(),z(P,{key:0},[e(M,null,{default:i(()=>[e(I,{stamp:""},{default:i(()=>[at]),_:1}),e(I,{stamp:""},{default:i(()=>[et]),_:1}),e(I,{stamp:""},{default:i(()=>[it]),_:1})]),_:1}),(p(!0),z(P,null,Q(r.documentoItens,g=>Z((p(),y(M,{key:g.id,class:"q-py-none",style:{"min-height":"24px"}},{default:i(()=>[e(I,{stamp:""},{default:i(()=>[u(v(g.descricaoItem),1)]),_:2},1024),g.operacaoFator===-1?(p(),y(I,{key:0,stamp:""},{default:i(()=>[u(v(g.quantidade),1)]),_:2},1024)):C("",!0),g.operacaoFator===-1?(p(),y(I,{key:1,stamp:""},{default:i(()=>[u(v(g.codigoItem),1)]),_:2},1024)):C("",!0)]),_:2},1024)),[[go,g.operacaoFator===-1]])),128))],64)):C("",!0),e(J)]),_:2},1024))),128))]),_:1},8,["onCriar_click","onFiltro_change","onLimparFiltros_click","tabSelecionada","tabs","listaLayout","paginacao","filtros","buscaCampo","checkboxModel"]),e(h,{ref:"ItensModal",onAtualizar:s.atualizar},null,8,["onAtualizar"])])}var mt=G(No,[["render",st]]);export{mt as default};
