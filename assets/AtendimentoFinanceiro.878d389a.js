import{_ as F,a0 as I,r as E,o as n,p,f as o,w as s,aR as w,aQ as P,b7 as T,C as b,t as g,F as q,u as x,d as v,c6 as A,e as D,Q as N,m as Q,k as C,z as V,P as M,S as z,T as y,j as $,U as k,H,aN as S,bj as B,b6 as O}from"./index.a1a1867c.js";import{F as R,T as j}from"./FaturaModal.81db70b8.js";import{_ as G}from"./Grafico.24be9e44.js";import"./DocumentosFiscais.c97e8810.js";import"./Campo.5cd61c3c.js";import"./compactarValidarNFe.b0a0ca66.js";import"./obterItens.2c072976.js";import"./codigosANP.a6c1a264.js";import"./emitirNFe.35117289.js";import"./VendaCard.41ba9f3d.js";import"./ModalHistoricoStatus.f4b94690.js";import"./EnvelopeCard.c61133eb.js";import"./Chart.cf162fd3.js";const L={components:{Badge:I,FaturaModal:R,TituloCard:j,Grafico:G},data(){return{contato:{},tab:"tab-1",graficoMensal:{labels:["Em dia","Dentro do m\xEAs","Fora do m\xEAs","Inadimplente","Outros"],datasets:[{backgroundColor:["green","yellow","orange","red","gray"],data:[0,0,0,0,0]}]},graficoOpcoesMensal:{responsive:!0,maintainAspectRatio:!1},historicoColunas:[{name:"dataPagamento",label:"Data",field:"dataPagamento",sortable:!0,format:this.$filters.diaMes},{name:"formaDePagamento",label:"Forma",field:"formaDePagamento",sortable:!0},{name:"parcela",label:"Parcelas",field:"parcela"},{name:"valor",label:"Valor",field:"valor",format:r=>this.$filters.numero(r,2)}],titulosCliente:[],titulosEmAberto:[],titulosHistorico:[],creditoCliente:{},saldo:0,documentos:{},modalFatura:{idFatura:"",idTitulo:""},carregandoIdEmpresas:!0,idEmpresasPermissao:[]}},methods:{async calculaDadosGraficoPizza(){let r=[];const m=await $db.financeiroTitulo.le({idContato:this.contato.id});for(const e of m){const t=(e.dataPagamento||"").substr(0,10),a=(e.dataVencimentoOriginal||"").substr(0,10),c=$utils.dataAtual().substr(0,10);let h="Outros",i="tertiary";a&&(t?t<=a?(h="Em dia",i="positive"):t.substr(0,7)===a.substr(0,7)?(h="Dentro do m\xEAs",i="warning"):(h="Fora do m\xEAs",i="orange"):a<c&&(h="Inadimplente",i="negative")),r.push({eixo:h,cor:i,valor:e.valorRealizado||0,dataPagamento:t,data:t||(e.dataVencimento||"").substr(0,10),dataVencimentoOriginal:a})}let d={"Em dia":{q:0,v:0},"Dentro do m\xEAs":{q:0,v:0},"Fora do m\xEAs":{q:0,v:0},Inadimplente:{q:0,v:0},Outros:{q:0,v:0}};for(const e of r)d[e.eixo].q+=1,d[e.eixo].v+=e.valor;this.graficoMensal.datasets[0].data=[d["Em dia"].q,d["Dentro do m\xEAs"].q,d["Fora do m\xEAs"].q,d.Inadimplente.q,d.Outros.q],this.titulosCliente=r},executar(r){this.atualizar()},async receberTitulo(r){let m=[],d=[],e=await $db.contato.le({id:r.idEmpresa}),t={},a=await $db.contato.le({id:r.idContato}),c={},h={};e.id||this.$q.notify("Erro ao recuperar informa\xE7\xF5es da Empresa."),m=await $db.contatoEndereco.leNew({idContato:e.id}),m.length&&(t=m[0]),a.id||this.$q.notify("Erro ao recuperar informa\xE7\xF5es do Contato."),m=await $db.contatoEndereco.leNew({idContato:a.id}),d=await $db.contatoTelefone.leNew({idContato:a.id}),m.length&&(c=m[0]),d.length&&(h=d[0]);let i=await $db.fatura.leNew({status:"Aberta",idContato:a.id,idEmpresa:e.id});for(const l of $lodash.orderBy(i,"dataHoraEmissao","desc")){try{this.modalFatura={idTitulo:r.id},this.$refs.faturaModal.mostrar({id:l.id})}catch(_){this.$q.notifyError("N\xE3o foi poss\xEDvel adicionar este t\xEDtulo a uma fatura.",_)}return}try{let l={id:$utils.uuid(),status:"Aberta",tipo:"Fatura",dataHoraEmissao:$utils.dataAtual(),calcularAutomatico:"Sim",idEmpresa:e.id,descricaoEmpresa:e.nome||"",numeroDocumentoEmpresa:e.numeroDocumentoNacional||"",inscricaoMunicipalEmpresa:e.numeroDocumentoMunicipal||"",idEmpresaEndereco:t.id||"",idContato:a.id,descricaoContato:a.nome||"",idContatoEndereco:c.id||"",numeroDocumentoContato:a.numeroDocumentoNacional||"",descricaoContatoEndereco:"".concat(c.logradouro||"",", ",c.numero||""," ",c.complemento||""," - ",c.bairro||""," - ",c.cep||""," - ",c.municipio||"","/",c.uf||""),telefoneContato:h.telefone||"",emailContato:a.email||"",regimeContato:a.regime||"",observacaoFaturamento:"",optanteSimplesNacional:e.regime==="SimplesNacional"?"1":"0",freteSeparado:!1,operacao:"Faturamento",tipoFrete:"CIF",totalDesconto:0,totalPercentualDesconto:0,subTotal:0,totalDocumento:0};await $db.documento.grava({atual:l}),this.modalFatura={idTitulo:r.id},this.$refs.faturaModal.mostrar({id:l.id})}catch(l){this.$q.notifyError("N\xE3o foi poss\xEDvel adicionar este t\xEDtulo a uma fatura.",l)}},async atualizar(){var c,h;if(this.contato=await $erp().contato.get((c=this.$route.params.id)!=null?c:""),!((h=this.contato)!=null&&h.id))return;this.titulosEmAberto=[],this.titulosHistorico=[];const r=await $db.financeiroTitulo.le({idContato:this.contato.id,emAberto:!0}),m=await $db.financeiroTitulo.le({idContato:this.contato.id,emAberto:!1});this.titulosEmAberto=$lodash.orderBy(r,"dataVencimento","asc"),this.titulosHistorico=$lodash.orderBy(m,"dataPagamento","asc"),this.carregandoIdEmpresas=!0,$db.contato.ler({filtros:{ativo:!0,empresas:!0}}).then(i=>{this.idEmpresasPermissao=i.data.map(l=>l.id),this.carregandoIdEmpresas=!1});let d=await $db.contatoCreditoExtrato.le({idContato:this.contato.id});d=$lodash.orderBy(d,"dataEmissao","asc");let e=0,t={};d=d.filter(i=>i.tipo==="Cr\xE9dito Devolu\xE7\xE3o").reduce((i,l)=>{const _=this.$filters.data(l.dataEmissao);return i[_]||(i[_]=[]),l.documentoId&&!t[l.documentoId]&&(t[l.documentoId]=$db.hibrido.le({table:"documento",id:l.documentoId})),e+=l.creditoDevolucao,l.saldo=$utils.arredondar(e),i[_].push(l),i},{}),this.saldo=$utils.arredondar(e);let a={};for(const i in t)a[i]=await t[i];this.documentos=a,this.creditoCliente=d,await this.calculaDadosGraficoPizza()}},watch:{"$route.params.id"(){this.atualizar()}},mounted(){this.atualizar()}},U={class:"AtendimentoFinanceiro"},J={class:"q-mt-md q-mb-md text-h6"},K={key:0},W={key:1},X={class:"q-mt-md q-mb-md text-h6"},Y={header:"",class:"text-weight-bold"},Z={key:0,style:{margin:"0","text-align":"right",color:"red"},class:"text-weight-bold"},tt={key:1,style:{margin:"0","text-align":"right",color:"#4caf50"},class:"text-weight-bold"},ot={key:2,style:{margin:"0","text-align":"right",color:"red"}},et={key:3,style:{margin:"0","text-align":"right"}},at={class:"col-12 col-md-6"},it=b("div",{class:"text-h6 text-tertiary"}," Perfil ",-1),st={class:"col-12 col-md-6"},rt=b("div",{class:"text-h6 text-tertiary"}," Hist\xF3rico ",-1),lt={key:0},nt={key:1};function dt(r,m,d,e,t,a){const c=E("titulo-card"),h=E("badge"),i=E("grafico"),l=E("row"),_=E("fatura-modal");return n(),p("div",U,[o(P,{modelValue:t.tab,"onUpdate:modelValue":m[0]||(m[0]=u=>t.tab=u),class:"bg-transparent q-mt-lg text-primary",color:"transparent",align:"left"},{default:s(()=>[o(w,{label:"Em aberto",name:"tab-1"}),o(w,{label:"Cr\xE9dito do Cliente",name:"tab-2"}),o(w,{label:"Hist\xF3rico",name:"tab-3"})]),_:1},8,["modelValue"]),o(O,{modelValue:t.tab,"onUpdate:modelValue":m[1]||(m[1]=u=>t.tab=u),animated:"",class:"q-mb-md"},{default:s(()=>[o(T,{class:"bg-white",name:"tab-1"},{default:s(()=>[b("div",J," Total R$ "+g(r.$filters.numero(t.titulosEmAberto.reduce((u,f)=>u+f.valorTotal,0),2)),1),t.titulosEmAberto.length?(n(),p("div",K,[(n(!0),p(q,null,x(t.titulosEmAberto,u=>(n(),p("div",{key:u.id},[o(c,{dados:u,class:"q-mb-md",onExecutar:a.executar},{default:s(()=>[t.carregandoIdEmpresas?(n(),v(A,{key:0,dense:"",flat:"",class:"no-shadow q-ma-xs",style:{float:"right"}})):D("",!0),!t.carregandoIdEmpresas&&!u.cheque&&t.idEmpresasPermissao.includes(u.idEmpresa)?(n(),v(N,{key:1,color:"primary",dense:"",flat:"",rounded:"",icon:"save_alt",size:"md",unelevated:"",style:{float:"right"},onClick:f=>a.receberTitulo(u)},{default:s(()=>[o(Q,null,{default:s(()=>[C("Receber")]),_:1})]),_:2},1032,["onClick"])):D("",!0)]),_:2},1032,["dados","onExecutar"])]))),128))])):(n(),p("div",W," N\xE3o h\xE1 titulos em aberto para este contato "))]),_:1}),o(T,{class:"bg-white",name:"tab-2"},{default:s(()=>[b("div",X," Saldo R$ "+g(r.$filters.numero(t.saldo,2)),1),o(V,{class:"no-shadow"},{default:s(()=>[(n(!0),p(q,null,x(Object.keys(t.creditoCliente),u=>(n(),p("div",{key:u,class:"q-pa-none text-left"},[b("label",Y,g(u),1),o(M,{highlight:"",style:{width:"100%"}},{default:s(()=>[(n(!0),p(q,null,x(t.creditoCliente[u],f=>(n(),v(z,{key:f.id},{default:s(()=>[f.creditoDevolucao<0?(n(),v(y,{key:0,avatar:""},{default:s(()=>[o($,{name:"trending_down",color:"red"})]),_:1})):(n(),v(y,{key:1,icon:"trending_up",avatar:""},{default:s(()=>[o($,{name:"trending_up",color:"green-6"})]),_:1})),o(y,null,{default:s(()=>[o(k,null,{default:s(()=>[C(g(f.documentoTipo),1)]),_:2},1024),o(k,{caption:""},{default:s(()=>[C(" Saldo ")]),_:1})]),_:2},1024),o(y,{avatar:""},{default:s(()=>[o(h,{class:"q-mx-sm",escuro:"",cor:"green-6",denso:"",round:""},{default:s(()=>[C(" #"+g(parseInt((t.documentos[f.documentoId]||{}).numero)||(f.documentoId||"").slice(-6)),1)]),_:2},1024)]),_:2},1024),o(y,{right:""},{default:s(()=>[f.creditoDevolucao<0?(n(),p("p",Z,g(r.$filters.numero(f.creditoDevolucao,2)),1)):(n(),p("p",tt,g(r.$filters.numero(f.creditoDevolucao,2)),1)),f.saldo<0?(n(),p("p",ot,[b("small",null,g(r.$filters.numero(f.saldo,2)),1)])):(n(),p("p",et,[b("small",null,g(r.$filters.numero(f.saldo,2)),1)]))]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)]))),128))]),_:1})]),_:1}),o(T,{class:"bg-white",name:"tab-3"},{default:s(()=>[o(l,null,{default:s(()=>[b("div",at,[H(b("div",null,[it,o(l,{class:"q-mt-md"},{default:s(()=>[o(i,{type:"pie",data:t.graficoMensal,options:t.graficoOpcoesMensal,class:"col-12"},null,8,["data","options"])]),_:1})],512),[[S,t.titulosCliente.length]])]),b("div",st,[rt,t.titulosHistorico.length?(n(),p("div",lt,[o(B,{columns:t.historicoColunas,rows:t.titulosHistorico,grid:"","rows-per-page-options":[15]},null,8,["columns","rows"])])):(n(),p("div",nt," N\xE3o h\xE1 titulos pagos "))])]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(_,{ref:"faturaModal",receberTitulo:{id:t.modalFatura.idTitulo},onExecutar:a.executar},null,8,["receberTitulo","onExecutar"])])}var wt=F(L,[["render",dt]]);export{wt as default};
