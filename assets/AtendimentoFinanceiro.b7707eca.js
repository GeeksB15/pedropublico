import{_ as N,$ as Q,r as _,o as c,n as g,f as o,w as e,b4 as x,b3 as S,bf as q,B as b,k as E,t as v,Q as C,F as T,s as P,d as y,aX as B,e as D,m as O,y as V,O as z,R as H,S as w,j as k,T as F,G as $,bd as R,bg as U,be as G,N as A,P as j,M as I,C as L}from"./index.9b156bba.js";import{F as X,T as J}from"./FaturaModal.c2a34fd1.js";import{_ as K}from"./Grafico.d9ca830e.js";import"./DocumentosFiscais.9a161678.js";import"./Campo.7909a0e7.js";import"./compactarValidarNFe.d3892009.js";import"./obterItens.68ea9ec4.js";import"./codigosANP.a6c1a264.js";import"./emitirNFe.35117289.js";import"./VendaCard.9cec35eb.js";import"./ModalHistoricoStatus.d2a763d2.js";import"./EnvelopeCard.c011f679.js";import"./Chart.309d37f6.js";const W={components:{Badge:Q,FaturaModal:X,TituloCard:J,Grafico:K},data(){return{contato:{},tab:"tab-1",graficoMensal:{labels:["Em dia","Dentro do m\xEAs","Fora do m\xEAs","Inadimplente","Outros"],datasets:[{backgroundColor:["green","yellow","orange","red","gray"],data:[0,0,0,0,0]}]},graficoOpcoesMensal:{responsive:!0,maintainAspectRatio:!1},historicoColunas:[{name:"dataPagamento",label:"Data",field:"dataPagamento",sortable:!0,format:this.$filters.diaMes},{name:"formaDePagamento",label:"Forma",field:"formaDePagamento",sortable:!0},{name:"parcela",label:"Parcelas",field:"parcela"},{name:"valor",label:"Valor",field:"valor",format:a=>this.$filters.numero(a,2)}],titulosCliente:[],titulosEmAberto:[],titulosHistorico:[],creditoCliente:{},saldo:0,documentos:{},modalFatura:{idFatura:"",idTitulo:"",titulos:[]},carregandoIdEmpresas:!0,idEmpresasPermissao:[],pagamentoMultiploVisivel:!1,valorPagMultiplo:0}},methods:{async calculaDadosGraficoPizza(){let a=[];const i=await $db.financeiroTitulo.le({idContato:this.contato.id});for(const d of i){const t=(d.dataPagamento||"").substr(0,10),l=(d.dataVencimentoOriginal||"").substr(0,10),m=$utils.dataAtual().substr(0,10);let u="Outros",s="tertiary";l&&(t?t<=l?(u="Em dia",s="positive"):t.substr(0,7)===l.substr(0,7)?(u="Dentro do m\xEAs",s="warning"):(u="Fora do m\xEAs",s="orange"):l<m&&(u="Inadimplente",s="negative")),a.push({eixo:u,cor:s,valor:d.valorRealizado||0,dataPagamento:t,data:t||(d.dataVencimento||"").substr(0,10),dataVencimentoOriginal:l})}let r={"Em dia":{q:0,v:0},"Dentro do m\xEAs":{q:0,v:0},"Fora do m\xEAs":{q:0,v:0},Inadimplente:{q:0,v:0},Outros:{q:0,v:0}};for(const d of a)r[d.eixo].q+=1,r[d.eixo].v+=d.valor;this.graficoMensal.datasets[0].data=[r["Em dia"].q,r["Dentro do m\xEAs"].q,r["Fora do m\xEAs"].q,r.Inadimplente.q,r.Outros.q],this.titulosCliente=a},executar(a){this.atualizar()},async receberTitulo(a,i=!1){let r=[],d=[],t=await $db.contato.le({id:a.idEmpresa}),l={},m=await $db.contato.le({id:a.idContato}),u={},s={};t.id||this.$q.notify("Erro ao recuperar informa\xE7\xF5es da Empresa."),r=await $db.contatoEndereco.leNew({idContato:t.id}),r.length&&(l=r[0]),m.id||this.$q.notify("Erro ao recuperar informa\xE7\xF5es do Contato."),r=await $db.contatoEndereco.leNew({idContato:m.id}),d=await $db.contatoTelefone.leNew({idContato:m.id}),r.length&&(u=r[0]),d.length&&(s=d[0]);let p=await $db.fatura.leNew({status:"Aberta",idContato:m.id,idEmpresa:t.id});for(const f of $lodash.orderBy(p,"dataHoraEmissao","desc")){if(i)return f.id;try{this.modalFatura={idTitulo:a.id},await this.$refs.faturaModal.mostrar({id:f.id}),i&&await this.$refs.faturaModal.fechar()}catch(M){this.$q.notifyError("N\xE3o foi poss\xEDvel adicionar este t\xEDtulo a uma fatura.",M)}await this.$forceUpdate();return}try{let f={id:$utils.uuid(),status:"Aberta",tipo:"Fatura",dataHoraEmissao:$utils.dataAtual(),calcularAutomatico:"Sim",idEmpresa:t.id,descricaoEmpresa:t.nome||"",numeroDocumentoEmpresa:t.numeroDocumentoNacional||"",inscricaoMunicipalEmpresa:t.numeroDocumentoMunicipal||"",idEmpresaEndereco:l.id||"",idContato:m.id,descricaoContato:m.nome||"",idContatoEndereco:u.id||"",numeroDocumentoContato:m.numeroDocumentoNacional||"",descricaoContatoEndereco:"".concat(u.logradouro||"",", ",u.numero||""," ",u.complemento||""," - ",u.bairro||""," - ",u.cep||""," - ",u.municipio||"","/",u.uf||""),telefoneContato:s.telefone||"",emailContato:m.email||"",regimeContato:m.regime||"",observacaoFaturamento:"",optanteSimplesNacional:t.regime==="SimplesNacional"?"1":"0",freteSeparado:!1,operacao:"Faturamento",tipoFrete:"CIF",totalDesconto:0,totalPercentualDesconto:0,subTotal:0,totalDocumento:0};if(await $db.documento.grava({atual:f}),i)return f.id;this.modalFatura={idTitulo:a.id},this.$refs.faturaModal.mostrar({id:f.id})}catch(f){this.$q.notifyError("N\xE3o foi poss\xEDvel adicionar este t\xEDtulo a uma fatura.",f)}await this.$forceUpdate()},async atualizar(){var m,u;if(this.contato=await $erp().contato.get((m=this.$route.params.id)!=null?m:""),!((u=this.contato)!=null&&u.id))return;this.titulosEmAberto=[],this.titulosHistorico=[];const a=await $db.financeiroTitulo.le({idContato:this.contato.id,emAberto:!0}),i=await $db.financeiroTitulo.le({idContato:this.contato.id,emAberto:!1});this.titulosEmAberto=$lodash.orderBy(a,"dataVencimento","asc"),this.titulosHistorico=$lodash.orderBy(i,"dataPagamento","asc"),this.carregandoIdEmpresas=!0,$db.contato.ler({filtros:{ativo:!0,empresas:!0}}).then(s=>{this.idEmpresasPermissao=s.data.map(p=>p.id),this.carregandoIdEmpresas=!1});let r=await $db.contatoCreditoExtrato.le({idContato:this.contato.id});r=$lodash.orderBy(r,"dataEmissao","asc");let d=0,t={};r=r.filter(s=>s.tipo==="Cr\xE9dito Devolu\xE7\xE3o").reduce((s,p)=>{const f=this.$filters.data(p.dataEmissao);return s[f]||(s[f]=[]),p.documentoId&&!t[p.documentoId]&&(t[p.documentoId]=$db.hibrido.le({table:"documento",id:p.documentoId})),d+=p.creditoDevolucao,p.saldo=$utils.arredondar(d),s[f].push(p),s},{}),this.saldo=$utils.arredondar(d);let l={};for(const s in t)l[s]=await t[s];this.documentos=l,this.creditoCliente=r,await this.calculaDadosGraficoPizza()},async gerarPagamentoMultiplo(){if(this.valorPagMultiplo<=0){$q.notifyError("O valor informado deve ser maior que 0"),this.valorPagMultiplo=0;return}const a=[],i=await this.selecionarEmpresa(),r=this.titulosEmAberto.filter(l=>l.idEmpresa===i.id);if(!r.length){$q.notifyError("N\xE3o h\xE1 titulos pendentes para a empresa Selecionada."),this.valorPagMultiplo=0;return}let d=0;r.forEach(l=>{d<=this.valorPagMultiplo&&!l.idFatura&&(console.log("entrou"),a.push(l),d+=l.valorTotal)});const t=await this.receberTitulo(r[0],!0);this.modalFatura={idTitulo:a.map(l=>l.id)},await this.$refs.faturaModal.mostrar({id:t}),await this.$forceUpdate()},async selecionarEmpresa(){const a={ativo:!0,empresas:!0},i=await $g.promptContato.show({filtro:a,placeholder:"Selecione"});if(!i)throw new Error("Nenhum contato selecionado");return i},pagamentoMultiploModal(){this.pagamentoMultiploVisivel=!0,this.valorPagMultiplo=0}},watch:{"$route.params.id"(){this.atualizar()}},mounted(){this.atualizar()}},Y={class:"AtendimentoFinanceiro"},Z={class:"q-mt-md q-mb-md text-h6"},tt={key:0},ot={key:1},et={class:"q-mt-md q-mb-md text-h6"},at={header:"",class:"text-weight-bold"},it={key:0,style:{margin:"0","text-align":"right",color:"red"},class:"text-weight-bold"},rt={key:1,style:{margin:"0","text-align":"right",color:"#4caf50"},class:"text-weight-bold"},lt={key:2,style:{margin:"0","text-align":"right",color:"red"}},st={key:3,style:{margin:"0","text-align":"right"}},nt={class:"col-12 col-md-6"},dt=b("div",{class:"text-h6 text-tertiary"}," Perfil ",-1),ut={class:"col-12 col-md-6"},ct=b("div",{class:"text-h6 text-tertiary"}," Hist\xF3rico ",-1),mt={key:0},pt={key:1},ft=b("div",{class:"text-h6"},"Qual o valor a receber?",-1);function ht(a,i,r,d,t,l){const m=_("titulo-card"),u=_("badge"),s=_("grafico"),p=_("row"),f=_("fatura-modal"),M=_("campo");return c(),g("div",Y,[o(S,{modelValue:t.tab,"onUpdate:modelValue":i[0]||(i[0]=n=>t.tab=n),class:"bg-transparent q-mt-lg text-primary",color:"transparent",align:"left"},{default:e(()=>[o(x,{label:"Em aberto",name:"tab-1"}),o(x,{label:"Cr\xE9dito do Cliente",name:"tab-2"}),o(x,{label:"Hist\xF3rico",name:"tab-3"})]),_:1},8,["modelValue"]),o(G,{modelValue:t.tab,"onUpdate:modelValue":i[2]||(i[2]=n=>t.tab=n),animated:"",class:"q-mb-md"},{default:e(()=>[o(q,{class:"bg-white",name:"tab-1"},{default:e(()=>[b("div",Z,[E(" Total R$ "+v(a.$filters.numero(t.titulosEmAberto.reduce((n,h)=>n+h.valorTotal,0),2))+" ",1),o(C,{color:"primary",icon:"attach_money",label:"Receber v\xE1rios",style:{float:"right"},onClick:i[1]||(i[1]=n=>l.pagamentoMultiploModal())})]),t.titulosEmAberto.length?(c(),g("div",tt,[(c(!0),g(T,null,P(t.titulosEmAberto,n=>(c(),g("div",{key:n.id},[o(m,{dados:n,class:"q-mb-md",onExecutar:l.executar},{default:e(()=>[t.carregandoIdEmpresas?(c(),y(B,{key:0,dense:"",flat:"",class:"no-shadow q-ma-xs",style:{float:"right"}})):D("",!0),!t.carregandoIdEmpresas&&!n.cheque&&t.idEmpresasPermissao.includes(n.idEmpresa)?(c(),y(C,{key:1,color:"primary",dense:"",flat:"",rounded:"",icon:"save_alt",size:"md",unelevated:"",onClick:h=>l.receberTitulo(n)},{default:e(()=>[o(O,null,{default:e(()=>[E("Receber")]),_:1})]),_:2},1032,["onClick"])):D("",!0)]),_:2},1032,["dados","onExecutar"])]))),128))])):(c(),g("div",ot," N\xE3o h\xE1 titulos em aberto para este contato "))]),_:1}),o(q,{class:"bg-white",name:"tab-2"},{default:e(()=>[b("div",et," Saldo R$ "+v(a.$filters.numero(t.saldo,2)),1),o(V,{class:"no-shadow"},{default:e(()=>[(c(!0),g(T,null,P(Object.keys(t.creditoCliente),n=>(c(),g("div",{key:n,class:"q-pa-none text-left"},[b("label",at,v(n),1),o(z,{highlight:"",style:{width:"100%"}},{default:e(()=>[(c(!0),g(T,null,P(t.creditoCliente[n],h=>(c(),y(H,{key:h.id},{default:e(()=>[h.creditoDevolucao<0?(c(),y(w,{key:0,avatar:""},{default:e(()=>[o(k,{name:"trending_down",color:"red"})]),_:1})):(c(),y(w,{key:1,icon:"trending_up",avatar:""},{default:e(()=>[o(k,{name:"trending_up",color:"green-6"})]),_:1})),o(w,null,{default:e(()=>[o(F,null,{default:e(()=>[E(v(h.documentoTipo),1)]),_:2},1024),o(F,{caption:""},{default:e(()=>[E(" Saldo ")]),_:1})]),_:2},1024),o(w,{avatar:""},{default:e(()=>[o(u,{class:"q-mx-sm",escuro:"",cor:"green-6",denso:"",round:""},{default:e(()=>[E(" #"+v(parseInt((t.documentos[h.documentoId]||{}).numero)||(h.documentoId||"").slice(-6)),1)]),_:2},1024)]),_:2},1024),o(w,{right:""},{default:e(()=>[h.creditoDevolucao<0?(c(),g("p",it,v(a.$filters.numero(h.creditoDevolucao,2)),1)):(c(),g("p",rt,v(a.$filters.numero(h.creditoDevolucao,2)),1)),h.saldo<0?(c(),g("p",lt,[b("small",null,v(a.$filters.numero(h.saldo,2)),1)])):(c(),g("p",st,[b("small",null,v(a.$filters.numero(h.saldo,2)),1)]))]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)]))),128))]),_:1})]),_:1}),o(q,{class:"bg-white",name:"tab-3"},{default:e(()=>[o(p,null,{default:e(()=>[b("div",nt,[$(b("div",null,[dt,o(p,{class:"q-mt-md"},{default:e(()=>[o(s,{type:"pie",data:t.graficoMensal,options:t.graficoOpcoesMensal,class:"col-12"},null,8,["data","options"])]),_:1})],512),[[R,t.titulosCliente.length]])]),b("div",ut,[ct,t.titulosHistorico.length?(c(),g("div",mt,[o(U,{columns:t.historicoColunas,rows:t.titulosHistorico,grid:"","rows-per-page-options":[15]},null,8,["columns","rows"])])):(c(),g("div",pt," N\xE3o h\xE1 titulos pagos "))])]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(f,{ref:"faturaModal",receberTitulo:{id:t.modalFatura.idTitulo},onExecutar:l.executar},null,8,["receberTitulo","onExecutar"]),o(L,{ref:"pagamentoMultiplo",modelValue:t.pagamentoMultiploVisivel,"onUpdate:modelValue":i[5]||(i[5]=n=>t.pagamentoMultiploVisivel=n),persistent:""},{default:e(()=>[o(V,{style:{"min-width":"350px"}},{default:e(()=>[o(A,null,{default:e(()=>[ft]),_:1}),o(A,{class:"q-pt-none"},{default:e(()=>[o(M,{rotulo:"Valor a receber",modelValue:t.valorPagMultiplo,"onUpdate:modelValue":i[3]||(i[3]=n=>t.valorPagMultiplo=n),decimals:"4",value:"0",prefix:"R$",tipo:"decimal"},null,8,["modelValue"])]),_:1}),o(j,{align:"right",class:"text-primary"},{default:e(()=>[$(o(C,{flat:"",label:"Cancelar",color:"tertiary"},null,512),[[I]]),$(o(C,{flat:"",label:"Receber",onClick:i[4]||(i[4]=n=>l.gerarPagamentoMultiplo()),class:"bg-primary",textColor:"white"},null,512),[[I]])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}var $t=N(W,[["render",ht]]);export{$t as default};
