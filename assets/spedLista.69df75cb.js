import{_ as I,bJ as Q,r as E,o as g,n as V,f as a,w as e,R as y,S as n,O,F as H,s as N,B as _,T as v,t as b,d as A,k as u,m as S,e as w,Q as x,az as G,G as U,j as L,M as B,l as T,L as Y,D as j,E as J,h as $,i as X,H as K,I as W,J as Z,C as R}from"./index.9b156bba.js";import{L as aa}from"./Lista.e33ba20c.js";import"./QBtnDropdown.2d29d66b.js";import"./QBtnGroup.4d3a3d67.js";import"./QScrollArea.e1ed3c28.js";const oa={components:{Lista:aa},data(){return{usuario:{},sped:{},lista:[],mostrar:{barraTopo:!0,toolbarTitulo:!0,icone:"description",titulo:"SPED",buscar:!0,filtroAvancado:!0,btnAjuda:!0,btnAtualizar:!0,btnNovo:!0,toolbarAcoes:!0,checkBox:!1,btnRemover:!1,btnRestaurar:!1,centralizaTabs:!1,btnDetalhes:!1,btnExportaXLS:!1,btnMenuMais:!1,toolbarAdicao:!1,bannerMsg:""},busca:"",tabSelecionada:{valor:""},tabs:[{valor:"retificadas",rotulo:"Retificadas"},{valor:"escrituracao",rotulo:"Escritura\xE7\xE3o"},{valor:"",rotulo:"Todas"}],filtrosOriginal:{},filtros:{codigoEmpresa:null,usuario:null,mes:null,ano:null,geracao:{ini:"",fim:""}},empresaOpcoes:[],contatoEmpresas:[],opcoesMeses:[{value:1,label:"Janeiro"},{value:2,label:"Fevereiro"},{value:3,label:"Mar\xE7o"},{value:4,label:"Abril"},{value:5,label:"Maio"},{value:6,label:"Junho"},{value:7,label:"Julho"},{value:8,label:"Agosto"},{value:9,label:"Setembro"},{value:10,label:"Outubro"},{value:11,label:"Novembro"},{value:12,label:"Dezembro"}],paginacao:{atual:1,maximo:1,total:1,limite:25}}},methods:{async atualizar(s){var d;const t=$utils.logarIni("spedLista");await $tryLoading(async()=>{var k,C,D,q,z,l,i,c,h,F,M,P;let{buscarDadosRecentes:p}=s!=null?s:{},o={},r={};p&&(o=await $utils.localIDB.getItem({objectStore:"dadosRecentes",id:"SpedLista_"+((k=this.usuario)==null?void 0:k.id)}),o!=null&&o._id&&(this.tabSelecionada.valor=o==null?void 0:o.tabSelecionada,this.busca=(o==null?void 0:o.busca)||"",this.filtros={codigoEmpresa:((C=o==null?void 0:o.filtros)==null?void 0:C.codigoEmpresa)||null,usuario:((D=o==null?void 0:o.filtros)==null?void 0:D.usuario)||null,mes:((q=o==null?void 0:o.filtros)==null?void 0:q.mes)||null,ano:((z=o==null?void 0:o.filtros)==null?void 0:z.ano)||null,geracao:{ini:((i=(l=o==null?void 0:o.filtros)==null?void 0:l.geracao)==null?void 0:i.ini)||"",fim:((h=(c=o==null?void 0:o.filtros)==null?void 0:c.geracao)==null?void 0:h.fim)||""}},this.compareObject(this.filtrosOriginal,this.filtros)&&(this.$refs.faturaLista.filtros=!0))),this.busca=((F=this.busca)==null?void 0:F.trim())||"",this.filtros.termoBusca=this.busca,this.filtros.usuario=(P=(M=this.filtros)==null?void 0:M.usuario)==null?void 0:P.trim(),this.filtros=$utils.eliminarVazios(this.filtros),r=$utils.clonarV2(this.filtros),r.status=this.tabSelecionada.valor,/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/.test(this.busca)&&(delete r.termoBusca,this.tabSelecionada.valor="",r.status="",r.id=this.busca);const m=await $db.sped.leListaCompleta({filtros:r,page:this.paginacao.atual,limit:this.paginacao.limite,sort:["dataHoraSolicitacao"],dir:["desc"]});this.lista=m==null?void 0:m.data,this.paginacao.total=m==null?void 0:m.total,this.paginacao.maximo=m==null?void 0:m.totalPages,o={_id:"SpedLista_"+this.usuario.id,tabSelecionada:this.tabSelecionada.valor,filtros:$utils.clonarV2(this.filtros),page:this.paginacao.atual,limit:this.paginacao.limite},await $utils.localIDB.setItem({objectStore:"dadosRecentes",data:o})}),$utils.logarFim(t,(d=this.lista)==null?void 0:d.length)},async atualizarPeriodico(){for(;this.ativaAtualizarPeriodico;){if(await $utils.dormir(3e4),!this.ativaAtualizarPeriodico)return;const s=this.lista.filter(({status:t})=>["Solicitado","Processando"].includes(t));for(const t of s)try{const d=await $db.sped.leListaCompleta({filtros:{id:t.id},page:1,limit:1,sort:["dataHoraSolicitacao"],dir:["desc"]});t.status=d.data[0].status,t.mensagemGeracao=d.data[0].mensagemGeracao}catch(d){console.error("Erro na consulta de status",d)}}},dialogSped(){var t;let s=new Date;s.setMonth(s.getMonth()-1),this.sped={visivel:!0,codigoEmpresa:this.sped.codigoEmpresa||((t=this.contatoEmpresas[0])==null?void 0:t.codigoContato),ano:this.sped.ano||s.getFullYear(),mes:this.sped.mes||s.getMonth()+1}},async gerarSped(){try{$q.loading.show({spinner:Q,spinnerColor:"amber",message:"Processando..."});const s=await $utils.geeksApi({gerarSped:{funcao:"CFA9862B-7CA9-4A4A-AC44-0424483B1C78",ano:this.sped.ano,mes:this.sped.mes,codigoEmpresa:this.sped.codigoEmpresa,usuario:$db.usuario.logado.nome,removerImpostoEntrada:0,retificadora:0}});this.sped.visivel=!1,$q.notifyPositive(s.data.gerarSped.mensagem||"Erro"),await $utils.dormir(100),await this.atualizar()}catch(s){$q.notifyError("Erro ao gerar SPED",s)}finally{$q.loading.hide()}},limparSped(){this.sped.visivel=!1},async limparFiltrosClick(){this.filtros=$utils.clonar(this.filtrosOriginal),await this.atualizar()},async empresaOpcoesCarregar(){this.contatoEmpresas=await $db.contatoEmpresa.listaCache(),this.empresaOpcoes=this.contatoEmpresas.map(s=>({label:s.nome,value:s.codigoContato}))},compareObject(s,t,d=[]){const p=Object.keys(s);for(const o of p)if(!d.includes(o)){if(typeof s[o]=="object"&&s[o]!==null){if(!this.compareObject(s[o],t[o],d))continue;return!0}else if(s[o]!==t[o])return!0}return!1},async retificar(s){var d;if(!s)return;const t=(d=this.contatoEmpresas)==null?void 0:d.find(p=>p.codigoContato===s.codigoEmpresa);if(!!await $q.dialogSimNao({title:"Retificar",message:`Deseja retificar o SPED de ${s.mes}/${s.ano} para ${t==null?void 0:t.nome} - ${t==null?void 0:t.numeroDocumentoNacional}?`}))try{$q.loading.show({spinner:Q,spinnerColor:"amber",message:"Processando..."});const p=await $utils.geeksApi({retificarSped:{funcao:"CFA9862B-7CA9-4A4A-AC44-0424483B1C78",ano:s.ano,mes:s.mes,codigoEmpresa:s.codigoEmpresa,usuario:$db.usuario.logado.nome,removerImpostoEntrada:0,retificadora:1}});$q.notifyPositive(p.data.retificarSped.mensagem||"Erro"),await $utils.dormir(100),await this.atualizar()}catch(p){$q.notifyError("Erro na gera\xE7\xE3o do SPED",p)}finally{$q.loading.hide()}},async download(s){!s.id||!await $q.dialogSimNao({title:"Download",message:"Deseja prosseguir com a opera\xE7\xE3o?"})||await $tryLoading(async()=>{var m;const d=(await $utils.geeksApi({downloadSped:{funcao:"34498589-8107-4A24-AC38-A4443D104D44",id:s.id}})).data.downloadSped;$utils.verificarErro(!d,"N\xE3o foi poss\xEDvel recuperar o arquivoSped");const p=(m=this.contatoEmpresas)==null?void 0:m.find(k=>k.codigoContato===s.codigoEmpresa),o=$utils.filtrarDigitos(p==null?void 0:p.numeroDocumentoNacional),r=document.createElement("a"),f=new Blob([d],{type:"text/plain"});r.setAttribute("href",window.URL.createObjectURL(f)),r.setAttribute("download",`${o}-${s.ano}-${String(s.mes).padStart(2,"0")}-sped.txt`),r.click()})}},beforeUnmount(){this.ativaAtualizarPeriodico=!1},async created(){this.usuario=JSON.parse(localStorage.getItem("usuario")),this.filtrosOriginal=$utils.clonar(this.filtros),this.empresaOpcoesCarregar(),await this.atualizar({buscarDadosRecentes:!0}),this.ativaAtualizarPeriodico=!0,this.atualizarPeriodico()}},ea={id:"SpedLista"},la={class:"mw80 text-center"},ta={class:"text-weight-bold"},sa={class:"q-mt-xs"},ia={class:"text-weight-medium"},ra={class:"q-ml-sm"},na={key:0,class:"text-weight-bold"},ua={key:1};function da(s,t,d,p,o,r){const f=E("campo"),m=E("BadgeCopiarUid"),k=E("avatar"),C=E("badge"),D=E("Lista"),q=E("g-col"),z=E("g-row");return g(),V("div",ea,[a(D,{ref:"spedLista",busca:o.busca,"onUpdate:busca":t[7]||(t[7]=l=>o.busca=l),onAtualizar:r.atualizar,onLimparFiltrosClick:r.limparFiltrosClick,onCriarClick:r.dialogSped,lista:o.lista,tabSelecionada:o.tabSelecionada,tabs:o.tabs,paginacao:o.paginacao,mostrar:o.mostrar},{filtroCampos:e(()=>[a(f,{modelValue:o.filtros.usuario,"onUpdate:modelValue":t[0]||(t[0]=l=>o.filtros.usuario=l),debounce:500,dense:"",rotulo:"Usu\xE1rio",class:"col-12 q-mt-md"},null,8,["modelValue"]),a(f,{modelValue:o.filtros.codigoEmpresa,"onUpdate:modelValue":t[1]||(t[1]=l=>o.filtros.codigoEmpresa=l),options:o.empresaOpcoes,clearable:"",dense:"",tipo:"seletor",rotulo:"Por empresa",class:"col-12 q-mt-lg"},null,8,["modelValue","options"]),a(f,{modelValue:o.filtros.mes,"onUpdate:modelValue":t[2]||(t[2]=l=>o.filtros.mes=l),options:o.opcoesMeses,clearable:"",dense:"",tipo:"seletor",rotulo:"M\xEAs",class:"col-12 q-mt-lg"},null,8,["modelValue","options"]),a(f,{modelValue:o.filtros.ano,"onUpdate:modelValue":t[3]||(t[3]=l=>o.filtros.ano=l),dense:"",tipo:"numero",rotulo:"Ano",class:"col-12 q-mt-lg"},null,8,["modelValue"]),a(y,{class:"q-pa-none q-mt-xl"},{default:e(()=>[a(n,null,{default:e(()=>[a(f,{modelValue:o.filtros.geracao.ini,"onUpdate:modelValue":t[4]||(t[4]=l=>o.filtros.geracao.ini=l),dense:"",tipo:"data",format:"DD/MM/YYYY",rotulo:"Gera\xE7\xE3o de"},null,8,["modelValue"])]),_:1})]),_:1}),a(y,{class:"q-pa-none q-mt-xs"},{default:e(()=>[a(n,null,{default:e(()=>[a(f,{modelValue:o.filtros.geracao.fim,"onUpdate:modelValue":t[5]||(t[5]=l=>o.filtros.geracao.fim=l),dense:"",tipo:"data",format:"DD/MM/YYYY",rotulo:"Gera\xE7\xE3o at\xE9"},null,8,["modelValue"])]),_:1})]),_:1}),a(f,{modelValue:o.paginacao.limite,"onUpdate:modelValue":t[6]||(t[6]=l=>o.paginacao.limite=l),tipo:"quantidade",dense:"",rotulo:"Quantidade por p\xE1gina",min:"1",class:"col-12 q-mt-xl"},null,8,["modelValue"])]),itemLista:e(()=>[a(O,{bordered:"",class:"bg-white q-mb-xs rounded-borders"},{default:e(()=>[(g(!0),V(H,null,N(o.lista,l=>(g(),V("div",{key:l.id,class:"itemHover"},[a(y,{"manual-focus":"",clickable:"",class:"q-py-sm q-px-xs items-center"},{default:e(()=>[a(n,{class:"hideonmobile col-auto q-pr-sm no-margin"},{default:e(()=>[a(y,{class:"q-pa-none"},{default:e(()=>[a(n,{side:"",class:"col-auto q-pa-none"},{default:e(()=>[_("div",la,[a(m,{id:l.id,escuro:"",cor:"positive"},null,8,["id"])])]),_:2},1024)]),_:2},1024)]),_:2},1024),a(n,{class:"col-md col-lg col-xl no-margin"},{default:e(()=>[a(y,{class:"q-pa-none"},{default:e(()=>[a(n,{class:"col-auto items-center"},{default:e(()=>{var i,c;return[a(k,{rotulo:(c=(i=o.empresaOpcoes)==null?void 0:i.filter(h=>h.value===l.codigoEmpresa))==null?void 0:c.label,tamanho:"40",style:{display:"flex","align-self":"center"}},null,8,["rotulo"])]}),_:2},1024),a(n,{class:"col"},{default:e(()=>[a(v,{lines:"2"},{default:e(()=>{var i,c;return[_("span",null,[_("span",ta,b((c=(i=o.empresaOpcoes)==null?void 0:i.find(h=>h.value===l.codigoEmpresa))==null?void 0:c.label),1)])]}),_:2},1024),a(v,{caption:"",lines:"2"},{default:e(()=>{var i,c;return[_("span",null,b((c=(i=o.contatoEmpresas)==null?void 0:i.find(h=>h.codigoContato===l.codigoEmpresa))==null?void 0:c.numeroDocumentoNacional),1)]}),_:2},1024),l.usuario?(g(),A(v,{key:0,caption:"",lines:"2"},{default:e(()=>[_("span",null,[u(b(l.usuario)+" ",1),a(S,{anchor:"bottom middle",self:"center middle"},{default:e(()=>[u("Usu\xE1rio")]),_:1})])]),_:2},1024)):w("",!0),a(n,{class:"hideondesktop"},{default:e(()=>[_("div",sa,[a(m,{id:l.id,escuro:"",cor:"positive"},null,8,["id"]),a(C,{dica:"Status",class:"q-ml-xs",cor:l.idSpedAnterior?"tertiary":"light",rotulo:l.idSpedAnterior?"Retificadas":"Escritura\xE7\xE3o",escuro:!!l.idSpedAnterior},null,8,["cor","rotulo","escuro"]),l.dataHoraSolicitacao?(g(),A(v,{key:0,caption:"",class:"q-pt-xs"},{default:e(()=>[_("span",ia,b(s.$filters.data(l.dataHoraSolicitacao)),1),_("span",ra,b(s.$filters.hora(l.dataHoraSolicitacao)),1)]),_:2},1024)):w("",!0),l.mes&&l.ano?(g(),A(v,{key:1,caption:"",lines:"2"},{default:e(()=>{var i,c;return[l.mes?(g(),V("span",na,[u(b((c=(i=o.opcoesMeses)==null?void 0:i.find(h=>h.value===l.mes))==null?void 0:c.label)+" ",1),a(S,{anchor:"bottom middle",self:"center middle"},{default:e(()=>[u("M\xEAs")]),_:1})])):w("",!0),l.ano?(g(),V("span",ua,[u(" / "+b(l.ano)+" ",1),a(S,{anchor:"bottom middle",self:"center middle"},{default:e(()=>[u("Ano")]),_:1})])):w("",!0)]}),_:2},1024)):w("",!0)])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024),o.tabSelecionada.valor===""?(g(),A(n,{key:0,class:"hideonmobile maxw100 no-margin text-center"},{default:e(()=>[a(v,{caption:"",lines:"2"},{default:e(()=>[a(C,{cor:l.idSpedAnterior?"tertiary":"light",rotulo:l.idSpedAnterior?"Retificadas":"Escritura\xE7\xE3o",escuro:!!l.idSpedAnterior,dica:"Status"},null,8,["cor","rotulo","escuro"])]),_:2},1024)]),_:2},1024)):w("",!0),a(n,{class:"maxw100 no-margin text-center"},{default:e(()=>[a(v,{caption:"",lines:"2"},{default:e(()=>[a(C,{cor:l.status==="Finalizado"?"positive":"tertiary",rotulo:l.status,escuro:""},null,8,["cor","rotulo"])]),_:2},1024),l.mensagemGeracao?(g(),A(S,{key:0,anchor:"bottom middle",self:"center middle"},{default:e(()=>[u(b(l.mensagemGeracao),1)]),_:2},1024)):w("",!0)]),_:2},1024),a(n,{class:"hideonmobile maxw90 no-margin"},{default:e(()=>[a(v,{caption:"",class:"text-weight-medium"},{default:e(()=>[u(b(s.$filters.data(l.dataHoraSolicitacao)),1)]),_:2},1024),a(v,{caption:""},{default:e(()=>[u(b(s.$filters.hora(l.dataHoraSolicitacao)),1)]),_:2},1024),a(S,{anchor:"bottom middle",self:"center middle"},{default:e(()=>[u("Data da Gera\xE7\xE3o")]),_:1})]),_:2},1024),a(n,{class:"hideonmobile maxw80 no-margin"},{default:e(()=>[l.mes?(g(),A(v,{key:0,caption:"",lines:"2",class:"text-weight-bold"},{default:e(()=>{var i,c;return[_("span",null,[u(b((c=(i=o.opcoesMeses)==null?void 0:i.find(h=>h.value===l.mes))==null?void 0:c.label)+" ",1),a(S,{anchor:"bottom middle",self:"center middle"},{default:e(()=>[u("M\xEAs")]),_:1})])]}),_:2},1024)):w("",!0),l.ano?(g(),A(v,{key:1,caption:"",lines:"2"},{default:e(()=>[_("span",null,[u(b(l.ano)+" ",1),a(S,{anchor:"bottom middle",self:"center middle"},{default:e(()=>[u("Ano")]),_:1})])]),_:2},1024)):w("",!0)]),_:2},1024),a(n,{class:"col-auto q-pl-sm no-margin"},{default:e(()=>[a(y,{class:"q-pa-none"},{default:e(()=>[a(n,{class:"hideonmobile no-margin"},{default:e(()=>[_("span",null,[a(x,{onClick:i=>r.retificar(l),icon:"reply_all",size:"md",flat:"",dense:"",round:"",class:"hideonmobile"},null,8,["onClick"]),a(S,{anchor:"bottom middle",self:"center middle"},{default:e(()=>[u("Retificar")]),_:1})])]),_:2},1024),a(n,{onClick:i=>r.download(l),class:"hideonmobile no-margin"},{default:e(()=>[_("span",null,[a(x,{icon:"download",size:"md",flat:"",dense:"",round:"",class:"hideonmobile",disabled:l.status!=="Finalizado"},null,8,["disabled"]),a(S,{anchor:"bottom middle",self:"center middle"},{default:e(()=>[u(b(l.status==="Finalizado"?"Exportar":"Aguarde finaliza\xE7\xE3o"),1)]),_:2},1024)])]),_:2},1032,["onClick"]),a(n,{class:"hideondesktop no-margin"},{default:e(()=>[a(x,{icon:"more_vert",size:"md",round:"",flat:"",dense:""},{default:e(()=>[a(G,null,{default:e(()=>[U((g(),A(O,{link:"","no-border":"",separator:""},{default:e(()=>[a(y,{onClick:i=>r.retificar(l),clickable:"",class:"hideondesktop"},{default:e(()=>[a(n,{avatar:""},{default:e(()=>[a(L,{name:"reply_all",size:"sm"})]),_:1}),a(n,null,{default:e(()=>[u("Retificar")]),_:1})]),_:2},1032,["onClick"]),a(y,{onClick:i=>r.download(l),clickable:"",class:"hideondesktop"},{default:e(()=>[a(n,{avatar:""},{default:e(()=>[a(L,{name:"download",size:"sm"})]),_:1}),a(n,null,{default:e(()=>[u("Exportar")]),_:1})]),_:2},1032,["onClick"])]),_:2},1024)),[[B]])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024),a(T)]))),128))]),_:1})]),_:1},8,["busca","onAtualizar","onLimparFiltrosClick","onCriarClick","lista","tabSelecionada","tabs","paginacao","mostrar"]),a(R,{modelValue:o.sped.visivel,"onUpdate:modelValue":t[11]||(t[11]=l=>o.sped.visivel=l),onHide:r.limparSped},{default:e(()=>[a(Y,{container:"",view:"hHh LpR fFf",class:"bg-white rounded-borders",style:{height:"100%","max-height":"350px"}},{default:e(()=>[a(j,{onSubmit:r.gerarSped,autocorrect:"off",autocapitalize:"off",autocomplete:"off",spellcheck:"false",novalidate:""},{default:e(()=>[a(J,{class:"bg-white text-tertiary border-bottom"},{default:e(()=>[a($,null,{default:e(()=>[a(X,null,{default:e(()=>[a(L,{name:"event",size:"sm",class:"q-mr-sm"}),u(" Gerar SPED ")]),_:1})]),_:1})]),_:1}),a(K,null,{default:e(()=>[a(W,null,{default:e(()=>[a(z,{gutter:"md"},{default:e(()=>[a(q,{col:"12"},{default:e(()=>[a(f,{modelValue:o.sped.codigoEmpresa,"onUpdate:modelValue":t[8]||(t[8]=l=>o.sped.codigoEmpresa=l),options:o.empresaOpcoes,clearable:"",dense:"",tipo:"seletor",rotulo:"Por empresa",class:"col-12 q-mt-lg"},null,8,["modelValue","options"])]),_:1}),a(q,{col:"12 sm6"},{default:e(()=>[a(f,{modelValue:o.sped.mes,"onUpdate:modelValue":t[9]||(t[9]=l=>o.sped.mes=l),options:o.opcoesMeses,clearable:"",dense:"",tipo:"seletor",rotulo:"M\xEAs",class:"col-12 q-mt-lg"},null,8,["modelValue","options"])]),_:1}),a(q,{col:"12 sm6"},{default:e(()=>[a(f,{modelValue:o.sped.ano,"onUpdate:modelValue":t[10]||(t[10]=l=>o.sped.ano=l),dense:"",tipo:"numero",rotulo:"Ano",class:"col-12 q-mt-lg"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),a(Z,{class:"bg-white text-right border-top q-pa-sm"},{default:e(()=>[U(a(x,{label:"Cancelar",color:"tertiary",flat:"",class:"q-mr-sm"},null,512),[[B]]),a(x,{label:"Gerar",type:"submit",color:"primary",unelevated:"",dark:"",class:"q-ml-sm"})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1},8,["modelValue","onHide"])])}var ha=I(oa,[["render",da]]);export{ha as default};
