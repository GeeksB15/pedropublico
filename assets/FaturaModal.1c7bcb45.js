import{_ as _a,r as K,o as p,n as A,f as t,w as i,B as F,h as fa,i as ba,k as V,t as x,d as y,c$ as io,e as k,j as R,m as ga,Q as U,A as ja,ax as qa,G as ea,O as wa,F as Q,s as Z,R as H,S as M,T as J,M as ia,l as Ua,y as no,N as ro,D as so,bD as Ia,C as za,u as lo,a as uo,d1 as co,d2 as mo,d3 as fo,d4 as po,L as Ha,E as Ja,H as Qa,I as Ga,J as vo,aY as ho}from"./index.f2a220da.js";import{D as Co,C as go}from"./DocumentosFiscais.33fbcb1f.js";import{e as bo}from"./emitirNFe.35117289.js";import{V as $o}from"./VendaCard.27ca8a76.js";import{E as Fo}from"./EnvelopeCard.4a4cb843.js";const Eo={computed:{mostrarMenuTresPontos(){return this.mostrarOpcaoMigrarFatura}},data(){return{titulo:{},tituloOriginal:{},detalhes:!1,contatos:{},documento:{},fatura:{},faturasAbertas:[],mostrarOpcaoMigrarFatura:!1,visibilidade:{botao:{remover:!1,editar:!1}},modalEditar:{visivel:!1,campos:{valorMulta:0},rules:[]},tema:["TituloCard","bg-white","rounded-borders"]}},emits:["executar"],methods:{irParaAtendimentoFatura(e){this.$router.push({name:"AtendimentoFatura",params:{id:e}})},async migrarFatura(e){try{await new Promise((o,d)=>{this.$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 migrar esta venda para outra fatura.",noRefocus:!0,preventClose:!0,title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{o()}).onCancel(()=>{d()})})}catch{return}if(!e&&this.titulo.idContato&&this.titulo.idEmpresa){const o=await $erp().contato.get(this.titulo.idContato)||{};let d=await $erp().contatoEndereco.where({idContato:this.titulo.idContato}).toArray(),g=await $erp().contatoTelefone.where({idContato:this.titulo.idContato}).toArray();d=d.find(_=>(_.grupo||"").trim().toLowerCase()==="Principal")||d[0]||{},g=g.find(_=>(_.tipoTelefone||"").trim().toLowerCase()==="Principal")||g[0]||{};const a=await $erp().contato.get(this.titulo.idEmpresa)||{};let l=await $erp().contatoEndereco.where({idContato:this.titulo.idEmpresa}).toArray();l=l.find(_=>_.grupo.trim().toLowerCase()==="Principal")||l[0]||{},e=$db.fatura.criar({idEmpresa:a.id,idEmpresaEndereco:l.id||"",descricaoEmpresa:a.nome||"",numeroDocumentoEmpresa:a.numeroDocumentoNacional||"",inscricaoMunicipalEmpresa:a.numeroDocumentoMunicipal||"",optanteSimplesNacional:a.regime==="SimplesNacional"?"1":"0",idContato:o.id,idContatoEndereco:d.id||"",numeroDocumentoContato:o.numeroDocumentoNacional||"",descricaoContato:o.nome||"",descricaoContatoEndereco:"".concat(d.logradouro||"",", ",d.numero||""," ",d.complemento||""," - ",d.bairro||""," - ",d.cep||""," - ",d.municipio||"","/",d.uf||""),telefoneContato:g.telefone||"",emailContato:o.email||"",regimeContato:o.regime||"",observacaoFaturamento:""}),await $db.fatura.grava({fatura:e})}e.id?(await $db.financeiroTitulo.grava({atual:{id:this.titulo.id,idFatura:e.id},original:this.titulo}),localStorage.setItem("idFatura",e.id),this.titulo.idContato&&(this.$emit("executar","atualizar"),this.irParaAtendimentoFatura(this.titulo.idContato))):this.$q.notify("N\xE3o foi poss\xEDvel realizar a opera\xE7\xE3o")},async salvar(){if(this.titulo.valorDesconto===this.tituloOriginal.valorDesconto){this.modalEditar.visivel=!1;return}try{await $db.financeiroTitulo.grava({atual:this.titulo,original:this.tituloOriginal}),this.tituloOriginal=$utils.clonar(this.titulo),this.modalEditar.visivel=!1,this.$q.notifyPositive("T\xEDtulo salvo."),this.$emit("executar","recalcular")}catch{this.$q.notifyPositive("N\xE3o foi poss\xEDvel salvar o t\xEDtulo. Por favor, tente novamente.")}},editar(){const e=Number(this.titulo.diasEmAtraso)||0;let o=0;e>0&&(o=Number(this.titulo.valorMulta)||0),this.modalEditar={visivel:!0,campos:{valorMulta:o},rules:[]}},async permissaoEditar(){return await $db.permissao.objeto("Diretiva_Caixa_DescontoTitulo")},cancelarDesconto(){this.titulo=$utils.clonar(this.tituloOriginal),this.modalEditar.visivel=!1},async desconto(){const e=this.titulo.valorDesconto;let o=0,d=0,g=0,a=Number(this.titulo.diasEmAtraso)||0;const l=Number(this.titulo.valor)||0;if(a<0&&(a=0),a>0&&(d=Number(this.titulo.valorMulta)||0,o=Number(this.titulo.valorJuros)||0,g=$utils.arredondar(d+o*a)),await $db.permissao.objeto("PadraoNovo_Financeiro")&&(g=$utils.arredondar(l+d+o*a)),e<0||e>g){this.modalEditar.rules=[()=>"Desconto n\xE3o permitido"];return}this.modalEditar.rules=[()=>!0];const c=$utils.arredondar(l-e+d+o*a),b=$utils.arredondar(e*100/(l||1));this.titulo.valorTotal=c,this.titulo.valorARealizar=c,this.titulo.percentualDesconto=b},alternarDetalhes(){this.detalhes=!this.detalhes},async remover(){try{await new Promise((e,o)=>{this.$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 remover este t\xEDtulo da fatura.",noRefocus:!0,preventClose:!0,title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-negative",textColor:"white",flat:!0}}).onOk(()=>{e()}).onCancel(()=>{o()})})}catch{return}this.titulo.idFatura="",await $db.financeiroTitulo.grava({atual:this.titulo,original:this.tituloOriginal}),this.visibilidade.botao.remover=!1,this.$q.notifyPositive("T\xEDtulo removido da fatura."),this.$emit("executar","remover")}},props:{dados:{required:!0,type:Object}},async mounted(){const e=new Date(this.dados.dataVencimento).setHours(0,0,0,0),o=new Date().setHours(0,0,0,0);e<o?this.tema.push("vencido"):this.tema=$lodash.remove(this.tema,g=>g!=="vencido"),this.tituloOriginal=$utils.clonar(this.dados),this.titulo=$utils.clonar(this.dados),this.titulo.documentoId&&(this.documento=await $db.hibrido.le({table:"documento",id:this.titulo.documentoId})),this.visibilidade.botao.remover=!1,this.permissaoEditar().then(g=>this.visibilidade.botao.editar=g&&!this.tituloOriginal.valorRealizado),this.contatos={};const d={};if(this.titulo.idContato){const g=await $db.contato.le({id:this.titulo.idContato});g&&(d[this.titulo.idContato]=g)}if(this.titulo.idEmpresa){const g=await $db.contato.le({id:this.titulo.idEmpresa});g&&(d[this.titulo.idEmpresa]=g)}this.contatos=d,this.mostrarOpcaoMigrarFatura=!0,this.titulo.idFatura&&$db.fatura.leNew({id:this.titulo.idFatura}).then(g=>{this.fatura=g,g.status==="Aberta"&&$db.contato.ler({filtros:{ativo:!0,empresas:!0}}).then(a=>{a.data.find(_=>_.id===this.titulo.idEmpresa)&&(this.visibilidade.botao.remover=!0)})})}},Do={class:"col-12 col-md-6 q-pl-none"},wo={class:"col-4 col-md"},To={key:0,class:"q-my-none"},yo={class:"q-my-none"},Po={class:"q-my-none"},qo={class:"col-4 col-md text-right"},xo={class:"col-4 col-md text-right"},ko={class:"col-12 col-md"},Mo={class:"text-right text-h5 text-positive text-weight-bold q-my-none"},Vo={class:"text-right text-weight-normal text-tertiary text-body2 q-my-none"},_o={class:"col-12 col-md-6"},Io={class:"text-body2"},zo={class:"col-12 col-md-6 text-right hideonmobile"},Bo={class:"col-12 text-right"},No={class:"col-12 col-md-6"},Ao={class:"text-body2 q-my-none q-mb-md"},Ro={class:"col-12 col-sm-4 col-md-2"},Oo={class:"text-left q-my-none"},So={class:"col-6 col-md-1"},Lo={class:"text-left q-my-none"},jo={class:"col-6 col-md-1"},Uo={class:"text-left q-my-none"},Ho={class:"col-12 col-sm-4 col-md-2 text-right"},Jo={class:"q-ma-none"},Qo={class:"q-mt-xs"},Go={class:"q-mt-xs"},Ko={class:"q-mt-lg text-right q-gutter-md"};function Wo(e,o,d,g,a,l){const _=K("avatar"),c=K("row"),b=K("campo");return p(),A("div",{class:lo([a.tema,"extratoItem bg-white q-pa-sm no-shadow"])},[t(c,{class:"items-center q-mx-none q-px-none q-mb-sm text-tertiary"},{default:i(()=>{var $;return[F("div",Do,[t(fa,{class:"q-pa-none"},{default:i(()=>[t(_,{imagem:(a.contatos[a.titulo.idContato]||{}).imagem,rotulo:(a.contatos[a.titulo.idContato]||{}).apelido,tamanho:"30"},null,8,["imagem","rotulo"]),t(ba,null,{default:i(()=>[V(x((a.contatos[a.titulo.idContato]||{}).apelido)+" ",1),o[9]||(o[9]=F("br",null,null,-1))]),_:1}),a.titulo.parcela?(p(),y(io,{key:0,rounded:"",color:"tertiary",small:""},{default:i(()=>[V(x(a.titulo.parcela),1)]),_:1})):k("",!0)]),_:1})]),F("div",wo,[a.titulo.documentoCodigo?(p(),A("p",To,x(a.titulo.documentoTipo)+" #"+x(($=a.documento)==null?void 0:$.numero),1)):k("",!0),F("p",yo,x(a.titulo.formaDePagamento),1),F("p",Po,x(a.titulo.descricaoPlanoConta),1)]),F("div",qo,[a.titulo.dataVencimentoOriginal?(p(),y(R,{key:0,name:"mdi-calendar-today"})):k("",!0),V(" "+x(e.$filters.data(a.titulo.dataVencimentoOriginal))+" ",1),t(ga,null,{default:i(()=>o[10]||(o[10]=[V("Vencimento original")])),_:1})]),F("div",xo,[a.titulo.dataVencimento?(p(),y(R,{key:0,name:"mdi-calendar-check"})):k("",!0),V(" "+x(e.$filters.data(a.titulo.dataVencimento))+" ",1),t(ga,null,{default:i(()=>o[11]||(o[11]=[V("Vencimento")])),_:1})]),F("div",ko,[F("p",Mo,x(e.$filters.numero(a.titulo.valorTotal,2)),1),F("p",Vo,x(e.$filters.numero(a.titulo.valor,2)),1)])]}),_:1}),t(c,{class:"items-center justify-end"},{default:i(()=>[F("div",_o,[F("div",Io,x(a.titulo.descricao),1)]),F("div",zo,[a.visibilidade.botao.remover?(p(),y(U,{key:0,onClick:l.remover,icon:"clear",color:"tertiary",round:"",dense:"",flat:""},{default:i(()=>[t(ga,null,{default:i(()=>[V(" Remover da Fatura #"+x(parseInt(a.fatura.numero)||(a.fatura.id||"").slice(-6)),1)]),_:1})]),_:1},8,["onClick"])):k("",!0),t(U,{onClick:l.alternarDetalhes,icon:`keyboard_arrow_${a.detalhes?"up":"down"}`,color:"tertiary",round:"",dense:"",flat:""},null,8,["onClick","icon"]),a.visibilidade.botao.editar?(p(),y(U,{key:1,onClick:l.editar,icon:"edit",color:"primary",round:"",dense:"",flat:""},null,8,["onClick"])):k("",!0),ja(e.$slots,"default"),l.mostrarMenuTresPontos?(p(),y(U,{key:2,icon:"more_vert",color:"tertiary",rounded:"",dense:"",flat:""},{default:i(()=>[t(qa,null,{default:i(()=>[ea((p(),y(wa,{link:"",separator:""},{default:i(()=>[a.mostrarOpcaoMigrarFatura?(p(),A(Q,{key:0},[(p(!0),A(Q,null,Z(a.faturasAbertas,$=>(p(),y(H,{clickable:"",key:$.id,onClick:I=>l.migrarFatura($)},{default:i(()=>[t(M,{avatar:""},{default:i(()=>[t(R,{name:"mdi-folder-move"})]),_:1}),t(M,null,{default:i(()=>[t(J,null,{default:i(()=>[V(x("Migrar para fatura #"+($.numero||$.id.slice(-6))),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),t(H,{clickable:"",onClick:o[0]||(o[0]=$=>l.migrarFatura())},{default:i(()=>[t(M,{avatar:""},{default:i(()=>[t(R,{name:"mdi-folder-move"})]),_:1}),t(M,null,{default:i(()=>[t(J,null,{default:i(()=>o[12]||(o[12]=[V("Migrar para nova fatura")])),_:1})]),_:1})]),_:1})],64)):k("",!0)]),_:1})),[[ia]])]),_:1})]),_:1})):k("",!0)])]),_:3}),t(Ua,{class:"hideondesktop q-mb-sm q-mt-xs"}),t(c,{class:"q-mx-none q-px-none hideondesktop"},{default:i(()=>[F("div",Bo,[a.visibilidade.botao.remover?(p(),y(U,{key:0,onClick:l.remover,icon:"clear",color:"tertiary",round:"",dense:"",flat:""},{default:i(()=>[t(ga,null,{default:i(()=>[V(" Remover da Fatura #"+x(parseInt(a.fatura.numero)||(a.fatura.id||"").slice(-6)),1)]),_:1})]),_:1},8,["onClick"])):k("",!0),t(U,{onClick:l.alternarDetalhes,round:"",dense:"",flat:"",color:"tertiary",icon:`keyboard_arrow_${a.detalhes?"up":"down"}`},null,8,["onClick","icon"]),a.visibilidade.botao.editar?(p(),y(U,{key:1,onClick:l.editar,icon:"edit",color:"primary",round:"",dense:"",flat:""},null,8,["onClick"])):k("",!0),ja(e.$slots,"default"),l.mostrarMenuTresPontos?(p(),y(U,{key:2,round:"",dense:"",flat:"",icon:"more_vert",color:"tertiary"},{default:i(()=>[t(qa,null,{default:i(()=>[ea((p(),y(wa,{link:"",separator:""},{default:i(()=>[a.mostrarOpcaoMigrarFatura?(p(),A(Q,{key:0},[(p(!0),A(Q,null,Z(a.faturasAbertas,$=>(p(),y(H,{clickable:"",key:$.id,onClick:I=>l.migrarFatura($)},{default:i(()=>[t(M,{avatar:""},{default:i(()=>[t(R,{name:"mdi-folder-move"})]),_:1}),t(M,null,{default:i(()=>[t(J,null,{default:i(()=>[V(x("Migrar para fatura #"+($.numero||$.id.slice(-6))),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),t(H,{clickable:"",onClick:o[1]||(o[1]=$=>l.migrarFatura())},{default:i(()=>[t(M,{avatar:""},{default:i(()=>[t(R,{name:"mdi-folder-move"})]),_:1}),t(M,null,{default:i(()=>[t(J,null,{default:i(()=>o[13]||(o[13]=[V("Migrar para nova fatura")])),_:1})]),_:1})]),_:1})],64)):k("",!0)]),_:1})),[[ia]])]),_:1})]),_:1})):k("",!0)])]),_:3}),a.detalhes?(p(),y(Ua,{key:0,class:"hideondesktop q-my-sm"})):k("",!0),a.detalhes?(p(),y(c,{key:1,class:"items-start q-mx-none q-px-none q-mt-md"},{default:i(()=>[F("div",No,[t(fa,{class:"u-autoHeight q-pa-none",color:"none",dark:""},{default:i(()=>[t(R,{name:"business"}),t(ba,null,{default:i(()=>[V(x((a.contatos[a.titulo.idEmpresa]||{}).apelido),1)]),_:1})]),_:1}),F("p",Ao,x(a.titulo.observacao),1)]),F("div",Ro,[F("p",Oo,x(a.titulo.descricaoCentroCusto),1)]),F("div",So,[F("p",Lo,[a.titulo.dataEmissao?(p(),y(R,{key:0,name:"mdi-calendar-check"})):k("",!0),V(" "+x(e.$filters.data(a.titulo.dataEmissao))+" ",1),t(ga,null,{default:i(()=>o[14]||(o[14]=[V("Emiss\xE3o")])),_:1})])]),F("div",jo,[F("p",Uo,[a.titulo.dataCompetencia?(p(),y(R,{key:0,name:"mdi-calendar-check"})):k("",!0),V(" "+x(e.$filters.data(a.titulo.dataCompetencia))+" ",1),t(ga,null,{default:i(()=>o[15]||(o[15]=[V("Compet\xEAncia")])),_:1})])]),F("div",Ho,[o[18]||(o[18]=F("p",{class:"text-subtitle1 text-weight-bold q-ma-none"}," Desconto ",-1)),F("p",Jo,x(e.$filters.numero(a.titulo.valorDesconto||0,2)),1),a.titulo.diasEmAtraso?(p(),A(Q,{key:0},[F("div",Qo,[o[16]||(o[16]=F("small",{class:"block text-caption"},"Multa",-1)),F("strong",null,x(e.$filters.numero(a.titulo.valorMulta||0,2))+" ("+x(e.$filters.numero(a.titulo.percentualMulta||0,2))+"%) ",1)]),F("div",Go,[o[17]||(o[17]=F("small",{class:"block text-caption"},"Juros",-1)),F("strong",null,x(e.$filters.numero(a.titulo.valorTotalJuros||0,2))+" ("+x(e.$filters.numero(a.titulo.percentualJuros||0,2))+"% dia) ",1)])],64)):k("",!0)])]),_:1})):k("",!0),t(za,{modelValue:a.modalEditar.visivel,"onUpdate:modelValue":o[8]||(o[8]=$=>a.modalEditar.visivel=$),onKeyup:Ia(l.cancelarDesconto,["esc"]),persistent:""},{default:i(()=>[t(no,{style:{"min-width":"30vw"}},{default:i(()=>[t(fa,{class:"bg-primary text-white"},{default:i(()=>[t(ba,null,{default:i(()=>o[19]||(o[19]=[V("Editar T\xEDtulo")])),_:1})]),_:1}),t(ro,null,{default:i(()=>[t(so,{onSubmit:l.salvar,class:"q-pa-lg q-gutter-md"},{default:i(()=>[t(b,{modelValue:a.titulo.valor,"onUpdate:modelValue":o[2]||(o[2]=$=>a.titulo.valor=$),rotulo:"Valor",tipo:"decimal",decimals:"2","somente-leitura":"",outlined:""},null,8,["modelValue"]),t(b,{modelValue:a.titulo.diasEmAtraso,"onUpdate:modelValue":o[3]||(o[3]=$=>a.titulo.diasEmAtraso=$),rotulo:"Dias em Atraso",tipo:"decimal",decimals:"0",zerosDireita:"0",zeros:"","somente-leitura":"",outlined:""},null,8,["modelValue"]),t(b,{modelValue:a.modalEditar.campos.valorMulta,"onUpdate:modelValue":o[4]||(o[4]=$=>a.modalEditar.campos.valorMulta=$),ajuda:`Multa de R$ ${e.$filters.numero(a.titulo.valorMulta,2)}`,rotulo:"Multa",tipo:"decimal",decimals:"2","somente-leitura":"",outlined:""},null,8,["modelValue","ajuda"]),t(b,{modelValue:a.titulo.valorTotalJuros,"onUpdate:modelValue":o[5]||(o[5]=$=>a.titulo.valorTotalJuros=$),ajuda:`Juros ao ${a.titulo.tipoJuros} de R$ ${e.$filters.numero(a.titulo.valorJuros,2)}`,rotulo:"Juros",tipo:"decimal",decimals:"2","somente-leitura":"",outlined:""},null,8,["modelValue","ajuda"]),t(b,{modelValue:a.titulo.valorDesconto,"onUpdate:modelValue":[o[6]||(o[6]=$=>a.titulo.valorDesconto=$),l.desconto],rotulo:"Desconto",tipo:"decimal",decimals:"2",rules:a.modalEditar.rules,outlined:""},null,8,["modelValue","onUpdate:modelValue","rules"]),t(b,{modelValue:a.titulo.valorTotal,"onUpdate:modelValue":o[7]||(o[7]=$=>a.titulo.valorTotal=$),rotulo:"Total",tipo:"decimal",decimals:"2","somente-leitura":"",outlined:""},null,8,["modelValue"]),F("div",Ko,[t(U,{color:"tertiary",flat:"",unelevated:"",label:"Cancelar",onClick:l.cancelarDesconto},null,8,["onClick"]),t(U,{color:"primary",unelevated:"",label:"Salvar",type:"submit"})])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue","onKeyup"])],2)}var Zo=_a(Eo,[["render",Wo]]),Yo={async enviar(e,o){var d,g;try{const a=o.nome.replace("enviaemail.fatura.",""),l=(d=o.valor)!=null?d:"Impresso",_=(g=o.texto)!=null?g:`Voc\xEA est\xE1 recebendo o ${l} da empresa ${e.descricaoEmpresa}.`,c=await $db.contato.le({id:e.idContato}),b=await $utils.impressaoObterHtml(a,e),$={de:"Geeks Solu\xE7\xF5es <auto@geekssolucoes.com.br>",para:String(c==null?void 0:c.email).trim().toLowerCase(),assunto:`${l}`,mensagem:`${_}`},I=`${l} enviado para ${$.para}, com sucesso!.`,S=`Erro ao enviar e-mail. ${l} n\xE3o enviado.`;$q.loading.show({message:`Enviando ${l} por e-mail...`,html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"});const N=[{name:`${l}.pdf`,content:b,method:"html2pdf"}],W={host:"smtp.gmail.com",port:587,ssl:!0,auth:{user:"auto@geekssolucoes.com.br",pass:"xpto@9@9"},from:$.de,to:$.para,subject:$.assunto,text:$.mensagem,attachments:N},n=await uo({baseURL:"https://api.b15.com.br",method:"post",url:"/email/v2",data:W});$q.notifyPositive((n==null?void 0:n.status)===200&&I?I:n.data.message)}catch(a){$q.notifyError(errorMsg||"Erro ao enviar e-mail",a)}finally{$q.loading.hide()}}},Xo={async finalizar(e,o){var d,g,a,l,_,c,b,$,I,S,N,W;try{if($utils.verificarErro(this.erroCalculo,"Erro de c\xE1lculo encontrado."),!e)try{await new Promise((r,s)=>{$q.dialog({cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},message:"Esta a\xE7\xE3o ir\xE1 finalizar esta fatura",ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0},title:"Tem certeza?"}).onOk(()=>{r()}).onCancel(()=>{s()})})}catch{return!1}this.$q.loading.show({message:"Processando..."});const n=$utils.clonar(this.fatura),G=$utils.clonar(this.vendas),u=$utils.clonar(this.documentosEnvelope),m=$utils.clonar(this.carnes),v=[...G,...u].map(r=>r.id),j=await $db.hibrido.lista({table:"documentoItem",whereIn:{idDocumento:v}}),L=$utils.clonar(j),pa=$utils.arredondar((n.totalDesconto||0)+(n.totalBonus||0));if(m.length>0){const r=m.reduce((s,E)=>(E.idFinanceiroBoleto&&E.codigoFinanceiroTitulo&&(s+=String(E.codigoFinanceiroTitulo)+";"),s),"");if(r)try{$q.loading.show({message:"Baixando boletos..."});const s=`exec sp_Financeiro_BoletoBaixar '${r.slice(0,-1)}'`,E=await $utils.executarSql(s)}catch(s){$q.notifyError("N\xE3o foi poss\xEDvel baixar boletos",s);return}finally{$q.loading.hide()}}const C=e?n.dataHoraFinalizado:$utils.dataAtual(),z=C,T=await $db.hibrido.le({table:"documento",id:this.$refs.faturamento.idDocumentoCaixa}),$a=await $db.formaPagamento.le();this.documentoStatus=[],await this.$refs.faturamento.validar();let X=$lodash.orderBy(this.$refs.faturamento.condicaoPagamento.filter(r=>r.valor),["idFormaPagamento","autorizacao","dataVencimento"]);if($utils.verificarErro(G.some(r=>!r.dataHoraFinalizado),"Existe pedido de venda sem data de finaliza\xE7\xE3o."),n.tokenBonusUtilizado){const r=await $utils.geeksApi({utilizaBonus:{funcao:"1A130FC6-C9BA-4121-B9CF-069CEAEC36CB",tokenBonus:n.tokenBonusUtilizado,valorVenda:(n.subTotal||0)-(n.totalDesconto||0),cnpjEmissor:n.numeroDocumentoEmpresa,cpfCliente:n.numeroDocumentoContato,idDocumentoDestino:n.id,utiliza:!0}});$utils.verificarErro(((g=(d=r.data)==null?void 0:d.utilizaBonus)==null?void 0:g.status)!=="Utilizado","B\xF4nus inv\xE1lido"),$utils.verificarErro(!((l=(a=r.data)==null?void 0:a.utilizaBonus)!=null&&l.valor),"Valor do B\xF4nus inv\xE1lido")}const na=$utils.arredondar(this.carnes.reduce((r,s)=>r+(s.valorARealizar||0),0)),ra=$utils.arredondar(X.reduce((r,s)=>r+(s.valor||0),0));let da=0;if(e&&(X=X.filter(r=>!this.$refs.faturamento.condicaoPagamentoOriginal.find(s=>s.id===r.id))),n.totalDocumento>=0){if(this.carnes.length){if(ra<na)return this.$q.notify("Valor pago menor que a soma dos t\xEDtulos \xE0 faturar!"),!1;if(!await $db.permissao.objeto("Diretiva_Caixa_PagarCarneCartao")){const s=X.reduce((E,D)=>{const P=`${D.autorizacao||""}${D.documento||""}${D.idFormaPagamento}`;return E[P]||(E[P]={parcelas:0,formaPagamento:D.formaPagamento}),E[P].parcelas++,E},{});for(const E in s)if(s[E].parcelas>this.carnes.length)return this.$q.notify(`Quantidade de parcelas da forma de pagamento ${s[E].formaPagamento} acima do permitido.`),!1}}ra<n.totalDocumento&&(da=1)}let ca=da===1?"Aguardando Pagamento":"Finalizada";if(!e){this.documentoStatus.push({id:$utils.uuid(),idDocumento:n.id,operacao:"Fatura",statusOriginal:n.status,statusFinalizado:ca,dataHoraEmissao:C,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:T.id||""}),n.status=ca,n.dataHoraFinalizado=C,ca="Faturado";const r=parseInt(await $db.configuracoes.leValorComFiltroEmpresa("vendas.usaExpedicao",n.idEmpresa,0))||0;let s=0,E=u.filter(f=>f.status!=="Entregue").length,D=!1,P=!0;if(G.length>0&&r&&(this.$q.loading.hide(),await new Promise((f,w)=>{this.$q.dialog({cancel:{label:"N\xE3o",push:!0,color:"tertiary",flat:!0},ok:{label:"Sim",push:!0,class:"bg-primary",textColor:"white",flat:!0},message:"Gostaria de dar baixa na(s) venda(s), removendo-a(s) do processo de expedi\xE7\xE3o?",noRefocus:!0,preventClose:!0,persistent:!0,title:"Confirma?"}).onOk(()=>{P=!0,f()}).onCancel(()=>{P=!1,f()})}),this.$q.loading.show({message:"Processando..."})),E){let f="Nesta Fatura h\xE1 1 envelope aguardando entrega, deseja mudar o status deste para Entregue?";E>1&&(f=`Nesta Fatura h\xE1 ${E} envelopes aguardando entrega, deseja mudar o status destes para Entregue?`),this.$q.loading.hide();try{await new Promise((w,q)=>{this.$q.dialog({cancel:"N\xE3o",message:f,noRefocus:!0,ok:"Sim",preventClose:!0,title:"Confirma?"}).onOk(()=>{D=!0,w()}).onCancel(()=>{q()})})}catch{}this.$q.loading.show({message:"Processando..."})}let h=0;h=$utils.arredondar(L.reduce((f,w)=>(w.total>0&&(f+=w.total),f),h));for(const f of[...G,...u])f.tipo==="Envelope"&&D&&(this.documentoStatus.push({id:$utils.uuid(),idDocumento:f.id,operacao:f.operacao,statusOriginal:f.status,statusFinalizado:"Entregue",dataHoraEmissao:C,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}),f.status="Entregue"),f.tipo==="Venda"&&P&&(this.documentoStatus.push({id:$utils.uuid(),idDocumento:f.id,operacao:f.operacao,statusOriginal:f.status,statusFinalizado:ca,dataHoraEmissao:C,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:T.id||""}),f.status="Faturado");for(const f of L){const w=[...G,...u].find(q=>q.id===f.idDocumento);if(f.status=w.status,f.total>0){f.quantidade=f.quantidade||1,f.valorItem=f.valorItem||0,f.descontoItem=f.descontoItem||0,f.descontoTotalRateado=f.descontoTotalRateado||0;let q=(f.valorItem-f.descontoItem)*f.quantidade-f.descontoTotalRateado;const B=$utils.arredondar(pa*q/(h||1)||0);f.descontoFaturaRateado=$utils.arredondar(B),f.valorRealTotal=$utils.arredondar(q-B),f.valorReal=$utils.arredondar(f.valorRealTotal/f.quantidade),s+=B}}if(this.documentosItem=L,this.documentosItemOriginal=j,pa!==$utils.arredondar(s)){const f=$utils.arredondar(pa-(s||0));let w,q=0;for(const B of L)B.total>q&&(q=B.total,w=B);if(w){const B=(w.descontoFaturaRateado||0)+(f||0),ta=((w.valorItem||0)-(w.descontoItem||0))*(w.quantidade||1)-(w.descontoTotalRateado||0)-(B||0),ha=(ta||0)/(w.quantidade||1);w.descontoFaturaRateado=$utils.arredondar(B),w.valorReal=$utils.arredondar(ha),w.valorRealTotal=$utils.arredondar(ta)}}}const xa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.renegociacao"}))[0].valor),Fa=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:xa}),Ka=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.duplicatareceber"}))[0].valor);let va=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ka});const Wa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.duplicatapagar"}))[0].valor),Ba=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Wa}),Za=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.cheque"}))[0].valor),Na=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Za}),Ya=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.faturamentogeral"}))[0].valor),aa=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ya}),Xa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.comprageral"}))[0].valor),Aa=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Xa}),ao=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.frete"}))[0].valor),Ra=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:ao}),oo=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.cmv"}))[0].valor),Ta=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:oo}),to=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.creditoclientes"}))[0].valor),eo=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:to}),ka=(_=this.contatos[n.idContato])==null?void 0:_.descontoCondicionadoPercentual;let ma=G.reduce((r,s)=>r+s.totalDocumento,0);ma=ma+u.reduce((r,s)=>r+s.totalDocumento,0),ma=$utils.arredondar(ma-pa);let ua=n.totalDocumento,oa=[];const O=[],Oa=[],ya=[],Sa=[];let Ea=1,Ma="",Pa=1,sa="";for(const r of X.filter(s=>!s.sinal)){r.sinal=r.sinal||da;const s=$a.filter(E=>E.id===r.idFormaPagamento)[0];if(ua<0)sa=$utils.uuid(),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:sa,idContato:n.idContato,idEmpresa:n.idEmpresa,idFinanceiroPlanoConta:aa.id,dataEmissao:C,valorCredito:0,valorDebito:$utils.arredondar(ua*-1),descricao:aa.descricao,observacao:`Movimenta\xE7\xE3o de d\xE9bito da devolu\xE7\xE3o de clientes no(s) pedido(s) da fatura c\xF3digo (${n.id})`,automatico:0,liquidando:0,dataCompetencia:z,dataVencimento:r.dataVencimento,dataMovimento:r.dataVencimento,documentoTipo:"Fatura",documentoId:n.id,idDocumentoCaixa:T.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:sa,idContato:n.idContato,idEmpresa:n.idEmpresa,idFinanceiroPlanoConta:eo.id,dataEmissao:C,valorCredito:$utils.arredondar(ua*-1),valorDebito:0,descricao:`Cr\xE9dito proveniente de produtos devolvidos no(s) pedido(s) da fatura c\xF3digo (${n.id})`,observacao:"Movimenta\xE7\xE3o de cr\xE9dito na conta de clientes",automatico:0,liquidando:0,dataCompetencia:z,dataVencimento:r.dataVencimento,dataMovimento:r.dataVencimento,documentoTipo:"Fatura",documentoId:n.id,idDocumentoCaixa:T.id});else{if(Ma!==r.idFormaPagamento+r.autorizacao&&(Ma=r.idFormaPagamento+r.autorizacao,Ea=1,Pa=X.reduce((E,D)=>D.idFormaPagamento+D.autorizacao===Ma?E+1:E,0)),s.tipoFinanceiro==="T\xEDtulo Liquidado"&&(sa=$utils.uuid()),na>0){const E=$utils.uuid(),D=$utils.arredondar(r.valor*(na/ua));let P=0,h=0,f=0,w=0;if(s.tipo===5){let q=(await $erp().financeiroBanco.toArray()).find(B=>B.codigoBanco===122);q&&(h=q.percentualMulta||0,w=q.percentualJuros||0,P=$utils.arredondar(h/100*D),f=$utils.arredondar(w/100*D))}oa.push({id:E,idFinanceiroPlanoConta:Fa.id,idContato:n.idContato,dataEmissao:C,dataCompetencia:z,dataVencimento:r.dataVencimento,dataVencimentoOriginal:r.dataVencimento,valor:D,valorTotal:D,valorARealizar:D,valorMulta:P,percentualMulta:h,valorJuros:f,percentualJuros:w,documentoId:n.id,documentoTipo:"Fatura",parcela:Ea+"/"+Pa,descricao:"Fatura de Venda Mercadoria",observacao:`${n.observacaoFaturamento||""} ${r.observacao||""}`.trim(),documentoVinculado:1,receberPagar:1,valorDesconto:0,percentualDesconto:0,idEmpresa:n.idEmpresa,formaDePagamento:s.descricao,carne:s.tipo===5?1:0,dataEmissaoCarne:s.tipo===5?C:"",idDocumentoCaixa:T.id,idFinanceiroMovimentacaoAgrupamento:s.tipoFinanceiro==="T\xEDtulo Liquidado"?sa:""}),r.idFinanceiroTitulo=E,s.tipo===2&&ya.push({idTitulo:E,idDocumentoCondicaoPagamento:r.id,valor:D,dataVencimento:r.dataVencimento,idBanco:r.idBanco,agencia:r.agencia,conta:r.conta,numeroCheque:r.numeroCheque,formaPagamento:s}),Sa.push({idTitulo:E,valor:D,desconto:0})}if(ma>0){const E=$utils.uuid(),D=$utils.arredondar(r.valor*(ma/ua));let P=0,h=0,f=0,w=0;if(s.tipo===5){let q=(await $erp().financeiroBanco.toArray()).find(B=>B.codigoBanco===122);q&&(h=q.percentualMulta||0,w=q.percentualJuros||0,P=$utils.arredondar(h/100*D),f=$utils.arredondar(w/100*D))}oa.push({id:E,idFinanceiroPlanoConta:aa.id,idContato:n.idContato,dataEmissao:C,dataCompetencia:z,dataVencimento:r.dataVencimento,dataVencimentoOriginal:r.dataVencimento,valor:D,valorTotal:D,valorARealizar:D,valorMulta:P,percentualMulta:h,valorJuros:f,percentualJuros:w,documentoId:n.id,documentoTipo:"Fatura",parcela:Ea+"/"+Pa,descricao:"Fatura de Venda Mercadoria",observacao:`${n.observacaoFaturamento||""} ${r.observacao||""}`.trim(),documentoVinculado:1,receberPagar:1,valorDesconto:0,percentualDesconto:0,idEmpresa:n.idEmpresa,formaDePagamento:s.descricao,carne:s.tipo===5?1:0,dataEmissaoCarne:s.tipo===5?C:"",idDocumentoCaixa:T.id,idFinanceiroMovimentacaoAgrupamento:s.tipoFinanceiro==="T\xEDtulo Liquidado"?sa:"",descontoCondicionadoValor:ka>0?ka/100*D:0,descontoCondicionadoPercentual:ka}),r.idFinanceiroTitulo=E,s.tipo===2&&ya.push({idTitulo:E,idDocumentoCondicaoPagamento:r.id,valor:D,dataVencimento:r.dataVencimento,idBanco:r.idBanco,agencia:r.agencia,conta:r.conta,numeroCheque:r.numeroCheque,formaPagamento:s})}if(s.tipoFinanceiro==="T\xEDtulo Liquidado"&&ma>=0){O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:sa,idEmpresa:n.idEmpresa,idContato:n.idContato,idFinanceiroPlanoConta:va.id,idFinanceiroTitulo:r.idFinanceiroTitulo,dataEmissao:C,valorCredito:r.valor,valorDebito:0,descricao:va.descricao,observacao:`Liquida\xE7\xE3o referente t\xEDtulo fatura (${n.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:z,dataVencimento:r.dataVencimento,dataMovimento:r.dataVencimento,documentoTipo:"Fatura",documentoId:n.id,idDocumentoCaixa:T.id});let E=s.idFinanceiroPlanoConta;s.tipo===1&&(T||{}).idFinanceiroPlanoContaCaixa&&(E=T.idFinanceiroPlanoContaCaixa);let D=await $db.financeiroPlanoConta.le({id:E}),P="";[3,4].includes(s.tipo)&&(P=($=(b=(c=oa[0])==null?void 0:c.observacao)==null?void 0:b.match(/Autorização\s(\d+)/))==null?void 0:$[1],P&&(P=` (Autoriza\xE7\xE3o ${P})`)),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:sa,idEmpresa:n.idEmpresa,idContato:n.idContato,idFinanceiroPlanoConta:D.id,idFinanceiroTitulo:r.idFinanceiroTitulo,dataEmissao:C,valorCredito:0,valorDebito:r.valor,descricao:D.descricao+P,observacao:`Liquida\xE7\xE3o referente t\xEDtulo fatura (${n.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:z,dataVencimento:r.dataVencimento,dataMovimento:r.dataVencimento,documentoTipo:"Fatura",documentoId:n.id,idDocumentoCaixa:T.id});for(const h of oa)h.idFinanceiroMovimentacaoAgrupamento===sa&&(h.valorRealizado=h.valorARealizar,h.dataPagamento=r.dataVencimento,h.dataMovimento=r.dataVencimento,h.idDocumentoCaixaLiquidacao=T.id)}if(s.aliquota){const E=$utils.uuid(),D=$utils.arredondar(r.valor*(s.aliquota/100));if(oa.push({id:E,idFinanceiroPlanoConta:s.idFinanceiroPlanoContaAliquota,idContato:s.idContatoOperadoraCartao,dataEmissao:C,dataCompetencia:z,dataVencimento:r.dataVencimento,dataVencimentoOriginal:r.dataVencimento,valor:D,valorTotal:D,valorARealizar:D,valorMulta:0,percentualJuros:0,documentoId:n.id,documentoTipo:"Fatura",parcela:Ea+"/"+Pa,descricao:`T\xEDtulo referente a al\xEDquota da forma de pagamento: ${s.descricao}`,observacao:`T\xEDtulo referente a al\xEDquota. ${n.observacaoFaturamento||""} ${r.observacao||""}`.trim(),documentoVinculado:1,receberPagar:0,valorDesconto:0,percentualDesconto:0,idEmpresa:n.idEmpresa,formaDePagamento:s.descricao,idDocumentoCaixa:T.id}),r.idFinanceiroTituloPagar=E,s.tipoFinanceiro==="T\xEDtulo Liquidado"){const P=$utils.uuid();O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:P,idEmpresa:n.idEmpresa,idFinanceiroPlanoConta:Ba.id,dataEmissao:C,valorCredito:0,valorDebito:D,descricao:Ba.descricao,observacao:`Liquida\xE7\xE3o al\xEDquota cart\xE3o referente fatura (${n.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:z,dataVencimento:r.dataVencimento,dataMovimento:r.dataVencimento,documentoTipo:"Fatura",documentoId:n.id,idFinanceiroTitulo:E,idContato:s.idContatoOperadoraCartao,idDocumentoCaixa:T.id});let h=s.idFinanceiroPlanoConta;s.tipo===1&&(T||{}).idFinanceiroPlanoContaCaixa&&(h=T.idFinanceiroPlanoContaCaixa);let f=await $db.financeiroPlanoConta.le({id:h});O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:P,idEmpresa:n.idEmpresa,idFinanceiroPlanoConta:f.id,dataEmissao:C,valorCredito:D,valorDebito:0,descricao:f.descricao,observacao:`Liquida\xE7\xE3o al\xEDquota cart\xE3o referente fatura (${n.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:z,dataVencimento:r.dataVencimento,dataMovimento:r.dataVencimento,documentoTipo:"Fatura",documentoId:n.id,idFinanceiroTitulo:E,idContato:s.idContatoOperadoraCartao,idDocumentoCaixa:T.id});for(const w of oa)w.id===E&&(w.idFinanceiroMovimentacaoAgrupamento=P,w.valorRealizado=D,w.dataPagamento=r.dataVencimento,w.dataMovimento=r.dataVencimento,w.idDocumentoCaixaLiquidacao=T.id)}}Ea++}}const La=[];for(const r of ya){const s=$utils.uuid(),E=$utils.uuid();for(const P of oa)P.id===r.idTitulo&&(P.idFinanceiroMovimentacaoAgrupamento=E,P.valorRealizado=P.valorARealizar,P.dataPagamento=C,P.dataMovimento=C,P.dataVencimento=C,P.dataVencimentoOriginal=C,P.idDocumentoCaixaLiquidacao=T.id);if(La.includes(r.idDocumentoCondicaoPagamento))continue;La.push(r.idDocumentoCondicaoPagamento);const D=$utils.arredondar(ya.reduce((P,h)=>h.idDocumentoCondicaoPagamento===r.idDocumentoCondicaoPagamento?P+(h.valor||0):P,0));oa.push({id:s,idFinanceiroPlanoConta:Na.id,idContato:n.idContato,dataEmissao:C,dataCompetencia:z,dataVencimento:r.dataVencimento,dataVencimentoOriginal:r.dataVencimento,valor:D,valorTotal:D,valorARealizar:D,valorMulta:0,percentualJuros:0,receberPagar:1,valorDesconto:0,percentualDesconto:0,documentoId:n.id,documentoTipo:"Fatura",idEmpresa:n.idEmpresa,formaDePagamento:r.formaPagamento.descricao,idDocumentoCaixa:T.id,cheque:1,idBanco:r.idBanco,agencia:r.agencia,conta:r.conta,numeroCheque:r.numeroCheque,observacao:`Liquida\xE7\xE3o de Cheques da Fatura #${n.id} - C\xF3digoN #${E}`,descricao:"Cheque"}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:E,idEmpresa:n.idEmpresa,idContato:n.idContato,idFinanceiroPlanoConta:Na.id,idFinanceiroTitulo:s,dataEmissao:C,valorCredito:0,valorDebito:D,descricao:"Cheque - Cr\xE9dito de t\xEDtulos a receber",observacao:"Cr\xE9dito de t\xEDtulos a receber",automatico:0,liquidando:0,dataCompetencia:z,dataVencimento:C,dataMovimento:C,idFinanceiroCheque:s,idDocumentoCaixa:T.id,documentoId:n.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:E,idEmpresa:n.idEmpresa,idContato:n.idContato,idFinanceiroPlanoConta:va.id,idFinanceiroTitulo:s,dataEmissao:C,valorCredito:D,valorDebito:0,descricao:va.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica",automatico:0,liquidando:0,dataCompetencia:z,dataVencimento:C,dataMovimento:C,idFinanceiroCheque:s,idDocumentoCaixa:T.id,documentoId:n.id})}if(na>0){const r=$utils.uuid();O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:r,idEmpresa:n.idEmpresa,idContato:n.idContato,idFinanceiroPlanoConta:va.id,dataEmissao:C,valorCredito:na,valorDebito:0,descricao:va.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica",automatico:1,liquidando:0,dataCompetencia:z,dataVencimento:C,dataMovimento:C,idDocumentoCaixa:T.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:r,idEmpresa:n.idEmpresa,idContato:n.idContato,idFinanceiroPlanoConta:Fa.id,dataEmissao:C,valorCredito:0,valorDebito:na,descricao:Fa.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica - Complemento",automatico:0,liquidando:0,dataCompetencia:z,dataVencimento:C,dataMovimento:C,documentoTipo:"Renegocia\xE7\xE3o",documentoId:r,idDocumentoCaixa:T.id});for(const s of Sa)Oa.push({idFinanceiroMovimentacaoN:r,idFinanceiroTitulo:s.idTitulo,dataVencimento:C,valorOriginal:s.valor,valorDesconto:s.desconto,valorTotal:$utils.arredondar(s.valor-s.desconto)});for(const s of m){if(s.idFinanceiroMovimentacaoAgrupamento=r,s.idDocumentoCaixaLiquidacao=T.id,s.dataPagamento=C,s.dataMovimento=C,s.renegociado=1,s.cheque===1){s.valorRealizado=s.valor;continue}if(!s.valorARealizar){s.valorRealizado=s.valorTotal;continue}s.valorRealizado=s.valorARealizar}oa=oa.concat(m)}if(da===0){let r=$utils.uuid();const s=n.valorFrete||0;let E=0,D=0;const P=[];if(s>0&&(O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:r,idEmpresa:n.idEmpresa,idFinanceiroPlanoConta:aa.id,dataEmissao:C,valorCredito:0,valorDebito:s,descricao:aa.descricao,observacao:`Lan\xE7amento frete da fatura (${n.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:z,dataVencimento:C,dataMovimento:C,documentoTipo:"Fatura",documentoId:n.id,idDocumentoCaixa:T.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:r,idEmpresa:n.idEmpresa,idFinanceiroPlanoConta:Ra.id,dataEmissao:C,valorCredito:s,valorDebito:0,descricao:Ra.descricao,observacao:`Lan\xE7amento frete da fatura (${n.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:z,dataVencimento:C,dataMovimento:C,documentoTipo:"Fatura",documentoId:n.id,idDocumentoCaixa:T.id})),!e){r=$utils.uuid();for(const h of L){let f="",w={},q="",B={},ta="",ha={};const Ca=await $db.item.leNew({id:h.idItem});if(f=h.idPlanoContaEstoque,!f){const Y=await $db.perfilContabilItem.le({idPerfilContabil:Ca.idPerfilContabil,idCfop:h.idCfop,and:{idPerfilContabil:Ca.idPerfilContabil,idCfop:h.idCfop}});Y.length&&Y[0].idPlanoContaEstoque&&(f=Y[0].idPlanoContaEstoque)}if(!f&&Aa.id&&(f=Aa.id),!f&&h.idCfop&&(f=(await $db.cfop.le({id:h.idCfop})).idPlanoContaEstoque),w=await $db.financeiroPlanoConta.le({id:f}),!w.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Estoque.");return}if(q="",!q){const Y=await $db.perfilContabilItem.le({idPerfilContabil:Ca.idPerfilContabil,idCfop:h.idCfop,and:{idPerfilContabil:Ca.idPerfilContabil,idCfop:h.idCfop}});Y.length&&Y[0].idPlanoContaDespesa&&(q=Y[0].idPlanoContaDespesa)}if(!q&&Ta.id&&(q=Ta.id),!q&&h.idCfop&&(q=(await $db.cfop.le({id:h.idCfop})).idPlanoContaDestino),B=await $db.financeiroPlanoConta.le({id:q}),!B.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Despesa.");return}const Va=$utils.arredondar(h.total-(h.descontoTotalRateado||0)-(h.descontoFaturaRateado||0)),Da=$utils.arredondar(h.valorCustoMedio*h.quantidade);if(Da){if(h.operacaoFator<0?(O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:r,idEmpresa:n.idEmpresa,idFinanceiroPlanoConta:w.id,dataEmissao:h.dataHoraFinalizado||C,valorCredito:Da,valorDebito:0,descricao:w.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${n.id}) e item (${h.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:z,dataVencimento:C,dataMovimento:C,documentoTipo:n.tipo,documentoId:n.id,idDocumentoCaixa:T.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:r,idEmpresa:n.idEmpresa,idFinanceiroPlanoConta:B.id,dataEmissao:h.dataHoraFinalizado||C,valorCredito:0,valorDebito:Da,descricao:B.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${n.id}) e item (${h.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:z,dataVencimento:C,dataMovimento:C,documentoTipo:n.tipo,documentoId:n.id,idDocumentoCaixa:T.id})):(O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:r,idEmpresa:n.idEmpresa,idFinanceiroPlanoConta:w.id,dataEmissao:h.dataHoraFinalizado||C,valorCredito:0,valorDebito:Da,descricao:w.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${n.id}) e item (${h.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:z,dataVencimento:C,dataMovimento:C,documentoTipo:n.tipo,documentoId:n.id,idDocumentoCaixa:T.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:r,idEmpresa:n.idEmpresa,idFinanceiroPlanoConta:B.id,dataEmissao:h.dataHoraFinalizado||C,valorCredito:Da,valorDebito:0,descricao:B.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${n.id}) e item (${h.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:z,dataVencimento:C,dataMovimento:C,documentoTipo:n.tipo,documentoId:n.id,idDocumentoCaixa:T.id})),ta=h.idPlanoContaDestino,!ta){const la=await $db.perfilContabilItem.le({idPerfilContabil:Ca.idPerfilContabil,idCfop:h.idCfop,and:{idPerfilContabil:Ca.idPerfilContabil,idCfop:h.idCfop}});la.length&&la[0].idPlanoContaDespesa&&(ta=la[0].idPlanoContaDespesa)}if(!ta&&Ta.id&&(ta=Ta.id),!ta&&h.idCfop&&(ta=(await $db.cfop.le({id:h.idCfop})).idPlanoContaDestino),ha=await $db.financeiroPlanoConta.le({id:ta}),!ha.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Receita.");return}let Y=!0;for(const la of P)if(la.idPlanoContaDestino===ha.id&&la.idPlanoContaEstoque===w.id){la.valor=$utils.arredondar(la.valor+Va),Y=!1;break}Y&&P.push({idPlanoContaDestino:ha.id,idPlanoContaEstoque:w.id,valor:Va}),E+=Va}}for(const h of P)h.valor<0&&(D+=h.valor);for(const h of P)if(h.valor>0){const f=await $db.financeiroPlanoConta.le({id:h.idPlanoContaDestino}),w=$utils.arredondar(D*(h.valor/(E||1)));if(w>0){O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:r,idEmpresa:n.idEmpresa,idFinanceiroPlanoConta:aa.id,dataEmissao:C,valorCredito:0,valorDebito:w,descricao:aa.descricao,observacao:`Lan\xE7amento entrada faturamento geral da devolu\xE7\xE3o referente fatura (${n.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:z,dataVencimento:C,dataMovimento:C,documentoTipo:"Fatura",documentoId:n.id,idDocumentoCaixa:T.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:r,idEmpresa:n.idEmpresa,idFinanceiroPlanoConta:f.id,dataEmissao:C,valorCredito:w,valorDebito:0,descricao:f.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de destino referente fatura (${n.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:z,dataVencimento:C,dataMovimento:C,documentoTipo:"Fatura",documentoId:n.id,idDocumentoCaixa:T.id});for(const q of X)O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:r,idEmpresa:n.idEmpresa,idFinanceiroPlanoConta:aa.id,dataEmissao:C,valorCredito:0,valorDebito:$utils.arredondar((h.valor-w)*(q.valor/(ua||1))),descricao:aa.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de faturamento geral referente fatura (${n.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:z,dataVencimento:q.dataVencimento,dataMovimento:q.dataVencimento,documentoTipo:"Fatura",documentoId:n.id,idDocumentoCaixa:T.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:r,idEmpresa:n.idEmpresa,idFinanceiroPlanoConta:f.id,dataEmissao:C,valorCredito:$utils.arredondar((h.valor-w)*(q.valor/(ua||1))),valorDebito:0,descricao:f.descricao,observacao:`Lan\xE7amento entrada na conta de venda do produto referente fatura (${n.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:z,dataVencimento:q.dataVencimento,dataMovimento:q.dataVencimento,documentoTipo:"Fatura",documentoId:n.id,idDocumentoCaixa:T.id})}else for(const q of X){const B=$utils.arredondar(h.valor*(q.valor/(ua||1)));O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:r,idEmpresa:n.idEmpresa,idFinanceiroPlanoConta:aa.id,dataEmissao:C,valorCredito:0,valorDebito:B,descricao:aa.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de faturamento geral referente fatura (${n.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:z,dataVencimento:q.dataVencimento,dataMovimento:q.dataVencimento,documentoTipo:"Fatura",documentoId:n.id,idDocumentoCaixa:T.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:r,idEmpresa:n.idEmpresa,idFinanceiroPlanoConta:f.id,dataEmissao:C,valorCredito:B,valorDebito:0,descricao:f.descricao,observacao:`Lan\xE7amento entrada na conta de venda do produto referente fatura (${n.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:z,dataVencimento:q.dataVencimento,dataMovimento:q.dataVencimento,documentoTipo:"Fatura",documentoId:n.id,idDocumentoCaixa:T.id})}}}}if(this.financeiroTitulo=oa,this.financeiroMovimentacao=O,this.financeiroRenegociacao=Oa,this.fatura=n,this.vendas=G,this.documentosEnvelope=u,this.carnes=m,!e){await this.salvarFatura(),$utils.emitter.emit("desativarBotoesFaturaModal");try{let s,E,D,P;if(s=await $db.configuracoes.porNome("integracao.bten.business"),E=(S=(I=s[0])==null?void 0:I.valor)!=null?S:!1,s=await $db.configuracoes.porNome("integracao.bten.authorization"),D=(W=(N=s[0])==null?void 0:N.valor)!=null?W:!1,P=E&&D,P){const h=[],f=this.contatos[n.idContato],w=await $api.bten.send(f,n);for(let q=0;q<w.length;q++){const B=w[q];B.status?h.push(B.telefone):this.$q.notifyError(`Falha ao enviar NPS para ${B.telefone}!`)}h.length&&this.$q.notifyPositive(`NPS enviado para ${h.join(",")}!`)}}catch(s){s.name==="GeeksException"&&this.$q.notifyAlert(`N\xE3o foi poss\xEDvel enviar NPS: ${s.message}`),s.name!=="GeeksException"&&this.$q.notifyError("N\xE3o foi possivel enviar NPS para o contato.",s)}let r;if(T!=null&&T.idCaixa){const s=await $erp().caixa.get(T==null?void 0:T.idCaixa);s!=null&&s.id&&(r=$db.caixa.tiposCaixa[Number(s.tipo)])}if([...G,...u].length&&~["SAT","NFCe"].indexOf(r))try{await this.$refs.documentosFiscais.emitirCupom(this.fatura.id)}catch{}if(this.$q.notifyPositive("Fatura finalizada"),this.fatura.status==="Finalizada"){$db.bonus.gera(n).then(D=>{D&&$q.notifyPositive("B\xF4nus gerado com sucesso!")});const s=await $db.configuracoes.le({prefixoNome:"enviaemail.fatura"});let E=s.find(D=>D.idEmpresa===this.fatura.idEmpresa);E||(E=s.find(D=>!D.idEmpresa)),E&&await Yo.enviar(this.fatura,E)}}return!0}catch(n){this.$q.notifyError("N\xE3o foi poss\xEDvel finalizar a fatura",n)}finally{this.$q.loading.hide()}}};const at={components:{DocumentoCodigo:co,DocumentoMetas:mo,DocumentosFiscais:Co,Faturamento:fo,TituloCard:Zo,VendaCard:$o,EnvelopeCard:Fo},computed:{config(){return $db.configuracoes.valores},descontoSomenteLeitura(){let e=!1;return e=this.fatura.status==="Aberta",e||(e=this.fatura.status==="Aguardando Pagamento"&&this.permissaoDescontoFaturaSinal),!e},bonusSomenteLeitura(){return this.fatura.status!=="Aberta"}},data(){return{contatos:{},faturaOriginal:{},fatura:{totalDocumento:0,subTotal:0,totalDesconto:0,totalPercentualDesconto:0,totalBonus:0,tokenBonusUtilizado:""},vendas:[],vendasOriginal:[],documentosEnvelope:[],documentosEnvelopeOriginal:[],documentosItem:[],documentosItemOriginal:[],carnes:[],carnesOriginal:[],documentoStatus:[],erroCalculo:!1,erroCalculoMsg:"",erroCalculoBonusMsg:"",erroTokenBonusMsg:"",sistemaPai:"",impressaoVisivel:!1,configImpressaoCarne:[],configImpressaoConvenio:[],configImpressaoFatura:[],configImpressaoEnvelope:[],permissaoDesconto:!1,permissaoDescontoFaturaSinal:!1,permissaoBonus:!1,pesoTotal:null,pesoBrutoTotal:null,metroCubicoTotal:null}},emits:["executar"],mixins:[bo],methods:{async executarRecebimentoMultiplos(e){console.log(e)},async calcularPesoTotal(){var l,_;const e=await $db.hibrido.lista({table:"documento",where:{idFatura:this.fatura.id}}),o=[],d={};let g=0,a=0;for(const c of e){const b=await $db.hibrido.lista({table:"documentoItem",where:{idDocumento:c.id}});for(const $ of b)o.push($)}for(const c of o)if(c.operacaoFator===-1){if(c.idItem&&!d[c.idItem]){const b=await $erp().item.get(c.idItem);b&&(d[c.idItem]=b)}g+=(((l=d[c.idItem])==null?void 0:l.peso)||0)*(c.quantidade||0),a+=(((_=d[c.idItem])==null?void 0:_.pesoBruto)||0)*(c.quantidade||0)}g=$utils.arredondar(g,4),a=$utils.arredondar(a,4),this.pesoTotal=g?$filters.numeroZerosDireita(g,4,2):null,this.pesoBrutoTotal=a?$filters.numeroZerosDireita(a,4,2):null},async calcularMetroCubicoTotal(){var a,l,_;const e=await $db.hibrido.lista({table:"documento",where:{idFatura:this.fatura.id}}),o=[],d={};let g=0;for(const c of e){const b=await $db.hibrido.lista({table:"documentoItem",where:{idDocumento:c.id}});for(const $ of b)o.push($)}for(const c of o){if(c.operacaoFator!==-1||c.tipoItem!=="Produto")continue;if(c.idItem&&!d[c.idItem]){const I=await $erp().item.get(c.idItem);I&&(d[c.idItem]=I)}const b=((a=d[c.idItem])==null?void 0:a.altura)*((l=d[c.idItem])==null?void 0:l.largura)*((_=d[c.idItem])==null?void 0:_.comprimento)||0,$=c.quantidade||0;g+=b>0?b*$:0}g=$utils.arredondar(g,4),this.metroCubicoTotal=g?$filters.numeroZerosDireita(g,4,2):null},atualizarDocumentoMetas(){!this.$refs.documentoMetas||(this.$refs.documentoMetas.documento=$utils.clonarV2(this.fatura))},...Xo,async atualizar(){let e=!1;if(this.permissaoDesconto=await $db.permissao.objeto("Diretiva_Caixa_DescontoFatura"),this.permissaoDescontoFaturaSinal=await $db.permissao.objeto("Diretiva_Caixa_DescontoFatura_Sinal"),this.permissaoBonus=await $db.permissao.objeto("configuracoes/bonus"),this.vendas=[],this.documentosEnvelope=[],this.documentosEnvelopeOriginal=[],this.documentosItem=[],this.documentosItemOriginal=[],this.carnes=[],this.carnesOriginal=[],this.documentoStatus=[],this.contatos={},this.erroCalculo=!1,this.erroCalculoMsg="",this.erroCalculoBonusMsg="",this.erroTokenBonusMsg="",this.prop.id){const o=await $db.fatura.leCompleto(this.prop.id);this.faturaOriginal=$utils.clonar(o.fatura),this.fatura=o.fatura,this.$refs.faturamento&&(this.$refs.faturamento.condicaoPagamentoOriginal=$utils.clonar(o.condicaoPagamento),this.$refs.faturamento.condicaoPagamento=o.condicaoPagamento),this.vendasOriginal=$utils.clonar(o.vendas),this.vendas=o.vendas.sort((a,l)=>new Date(a.dataHoraFinalizado)<new Date(l.dataHoraFinalizado)?-1:1);const d=o.documentosEnvelope.sort((a,l)=>new Date(a.dataHoraFinalizado)<new Date(l.dataHoraFinalizado)?-1:1);if(this.documentosEnvelopeOriginal=$utils.clonar(d),this.documentosEnvelope=$utils.clonar(d),typeof this.receberTitulo.id!="object"&&this.receberTitulo.id&&!o.carnes.find(a=>a.id===this.receberTitulo.id)&&(o.carnes.push(await $db.financeiroTitulo.le({id:this.receberTitulo.id})),e=!0),typeof this.receberTitulo.id=="object")for(let a of this.receberTitulo.id)a&&!o.carnes.find(l=>l.id===a)&&(o.carnes.push(await $db.financeiroTitulo.le({id:a})),e=!0);this.carnesOriginal=$utils.clonar(o.carnes),this.carnes=o.carnes.sort((a,l)=>new Date(a.dataVencimento)<new Date(l.dataVencimento)?-1:1);const g={};if(o.fatura.idContato){const a=o.fatura.idContato;g[a]||(g[a]=await $db.contato.le({id:a}))}this.configuraImpressaoCarne(o.fatura.idEmpresa),this.configuraImpressaoConvenio(o.fatura.idEmpresa),this.configuraImpressaoEnvelope(o.fatura.idEmpresa),this.configuraImpressaoFatura(o.fatura.idEmpresa),this.contatos=g,await this.atualizarDocumentoMetas(),await this.calculaTotais(),await this.calcularPesoTotal(),await this.calcularMetroCubicoTotal();try{e&&await this.salvarFatura()}catch(a){console.error(a)}}},async executar(e){if(e==="recalcular"){if(this.prop.id){const o=await $db.fatura.leCompleto(this.prop.id);this.carnesOriginal=$utils.clonar(o.carnes),this.carnes=o.carnes,await this.calculaTotais()}}else e==="salvarFatura"?(await this.salvarFatura(),await this.atualizar(),this.$emit("executar","atualizarSemFechar")):(await this.atualizar(),this.$emit("executar",e))},async calculaTotais(e){const o=$utils.arredondar(this.vendas.reduce((a,l)=>a+l.totalDocumento||0,0)),d=$utils.arredondar(this.documentosEnvelope.reduce((a,l)=>a+l.totalDocumento||0,0)),g=$utils.arredondar(this.carnes.reduce((a,l)=>a+l.valorARealizar||0,0));if(e||(this.fatura.subTotal=$utils.arredondar(o+d+g),e="desconto"),e==="descontoPercentual"&&(this.fatura.totalDesconto=$utils.arredondar((this.fatura.totalPercentualDesconto||0)/100*this.fatura.subTotal)),e==="desconto"&&(this.fatura.totalPercentualDesconto=$utils.arredondar((this.fatura.totalDesconto||0)/this.fatura.subTotal*100)),await this.checarTokenBonus(),this.fatura.totalDocumento=$utils.arredondar(this.fatura.subTotal-(this.fatura.totalDesconto||0)-(this.fatura.totalBonus||0)),this.erroCalculo=!1,this.erroCalculoMsg="",this.erroCalculoBonusMsg="",this.fatura.totalDesconto!==0){const a=o+d;a===0&&(this.erroCalculo=!0,this.erroCalculoMsg="Desconto n\xE3o permitido para fatura sem venda"),a>0&&this.fatura.totalDesconto>a&&(this.erroCalculo=!0,this.erroCalculoMsg="Desconto maior que o total das vendas")}if(this.fatura.totalDesconto!==0&&this.fatura.totalDocumento>this.fatura.subTotal&&(this.erroCalculo=!0),this.fatura.totalBonus!==0){const a=o+d;a===0&&(this.erroCalculoBonusMsg="B\xF4nus n\xE3o permitido para fatura sem venda"),a>0&&this.fatura.totalBonus>a&&(this.erroCalculoBonusMsg="B\xF4nus maior que o total das vendas")}this.fatura.totalBonus!==0&&this.fatura.totalDocumento>this.fatura.subTotal&&(this.erroCalculoBonus="B\xF4nus com valor Inv\xE1lido");try{await this.$refs.faturamento.resumeCondicaoPagamento(),await this.$refs.faturamento.atualizaValorRestante(),await this.$refs.faturamento.redefinirCampos()}catch{}},async checarTokenBonus(){var e,o,d,g,a,l,_;if(!(this.ultimoTokenBonusVerificado===this.fatura.tokenBonusUtilizado&&this.ultimoDescontoVerificado===this.fatura.totalDesconto&&this.ultimoPercentualDescontoVerificado===this.fatura.totalPercentualDesconto)){if(!this.fatura.tokenBonusUtilizado){this.fatura.totalBonus=0,this.erroTokenBonusMsg="";return}try{this.ultimoTokenBonusVerificado=this.fatura.tokenBonusUtilizado,this.ultimoDescontoVerificado=this.fatura.totalDesconto,this.ultimoPercentualDescontoVerificado=this.fatura.totalPercentualDesconto;const c=await $utils.geeksApi({verificaBonus:{funcao:"1A130FC6-C9BA-4121-B9CF-069CEAEC36CB",tokenBonus:this.fatura.tokenBonusUtilizado,valorVenda:(this.fatura.subTotal||0)-(this.fatura.totalDesconto||0),cnpjEmissor:this.fatura.numeroDocumentoEmpresa,cpfCliente:this.fatura.numeroDocumentoContato,idDocumentoDestino:this.fatura.id,utiliza:!1}});$utils.verificarErro(!["Ativo","Utilizado"].includes((o=(e=c.data)==null?void 0:e.verificaBonus)==null?void 0:o.status),"B\xF4nus inv\xE1lido"),$utils.verificarErro(!((g=(d=c.data)==null?void 0:d.verificaBonus)!=null&&g.valor),"Valor do B\xF4nus inv\xE1lido"),this.fatura.totalBonus=(_=(l=(a=c.data)==null?void 0:a.verificaBonus)==null?void 0:l.valor)!=null?_:0,this.erroTokenBonusMsg=""}catch(c){this.fatura.totalBonus=0,this.erroTokenBonusMsg=c.message}}},async configuraImpressaoConvenio(e){const o=await $db.configuracoes.porNome("impressao.convenio",e);this.configImpressaoConvenio=[...o.length?o.map(d=>({texto:"Imprimir Conv\xEAnio",...d})):[{valor:"convenio",texto:"Imprimir Conv\xEAnio"}]]},async configuraImpressaoCarne(e){const o=await $db.configuracoes.porNome("impressao.carne",e);this.configImpressaoCarne=[...o.length?o.map(d=>({texto:"Imprimir Carn\xEA",...d})):[{valor:"carne-crediario",texto:"Reimprimir carn\xEA e notas promiss\xF3rias da fatura"}]]},async configuraImpressaoEnvelope(e){const o=await $db.configuracoes.porNome("impressao.envelope",e);this.configImpressaoEnvelope=[...o.length?o.map(d=>({texto:"Imprimir Envelope",...d})):[{valor:"envelope",texto:"Imprimir Envelope"},{valor:"envelopeMini",texto:"Imprimir Envelope Mini"}]]},async configuraImpressaoFatura(e){const o=await $db.configuracoes.porNome("impressao.fatura",e),d=[{valor:"invoice",texto:"Fatura (Invoice)"},{valor:"fatura-recibo",texto:"Recibo"}];this.sistemaPai==="optisoul"&&d.push({valor:"termoGarantia",texto:"Termo de Garantia"}),this.configImpressaoFatura=[...o.length?o.map(g=>({texto:"Imprimir Fatura",...g})):d]},async reabrir(e){var o;if(!((o=this.fatura)!=null&&o.id)){this.$q.notifyError("N\xE3o foi poss\xEDvel encontrar o ID da fatura");return}if(!e)try{$q.loading.show(),await po({idDocumento:this.fatura.id})}catch(d){this.$q.notifyError(d.message);return}finally{$q.loading.hide()}if(!e)try{await new Promise((d,g)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 reabrir esta fatura",title:"Tem certeza?",cancel:{label:"CANCELAR",push:!0,color:"tertiary",flat:!0},ok:{label:"CONTINUAR",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{d()}).onCancel(()=>{g()})})}catch{return}try{this.$q.loading.show({message:"Processando..."});const d=$utils.clonar(this.fatura),g=$utils.clonar(this.vendas),a=$utils.clonar(this.documentosEnvelope),l=$utils.clonar(this.documentosItem),_=this.$refs.faturamento.condicaoPagamento.filter(I=>I.valor);if(!e){const I=[];_.reduce((S,N)=>(N.idDocumentoCaixa&&!S[N.idDocumentoCaixa]&&(S[N.idDocumentoCaixa]=!0,I.push($db.hibrido.le({table:"documento",id:N.idDocumentoCaixa}))),S),{});for await(const S of I)if(S.status!=="Aberto")return this.$q.notify({message:"N\xE3o \xE9 poss\xEDvel reabrir fatura de caixas fechados!"}),!1}try{await $db.fatura.checarTitulosLiquidados({condicoesPagamento:this.$refs.faturamento.condicaoPagamentoOriginal})}catch(I){$q.notifyError(I.message);return}let c=[],b=[],$=[];if(!e){c=await $db.financeiroTitulo.le({documentoId:d.id});for(const m of c)if(m.idFinanceiroBoleto){const v=await $erp().financeiroBoleto.get(m.idFinanceiroBoleto),j=await $db.financeiroBanco.le({id:v.idFinanceiroBanco}),L=await $db.banco.le({id:j.idBanco}),pa=v.revisao,C=L.baixa,z=L.registro;if(v.remessaOperacao!==C){const T=m.idFinanceiroBoleto,$a=$utils.uuid(),X={id:$a,idFinanceiroBanco:v.idFinanceiroBanco,nossoNumero:v.nossoNumero,nossoNumeroDv:v.nossoNumeroDv,revisao:pa+1,idEmpresa:v.idEmpresa,idContato:v.idContato,empresaNome:v.empresaNome,empresaNumeroDocumento:v.empresaNumeroDocumento,contatoNome:v.contatoNome,contatoNumeroDocumento:v.contatoNumeroDocumento,contatoLogradouro:v.contatoLogradouro,contatoCEP:v.contatoCEP,contatoBairro:v.contatoBairro,contatoCidade:v.contatoCidade,contatoUF:v.contatoUF,dataEmissao:$utils.dataAtual(),dataVencimento:v.dataVencimento,dataImpressao:v.dataImpressao,valor:v.valor,valorJuros:v.valorJuros,tipoJuros:v.tipoJuros,valorMulta:v.valorMulta,valorDesconto:v.valorDesconto,valorTotal:v.valorTotal,codigoBarras:v.codigoBarras,linhaDigitavel:v.linhaDigitavel,mensagem1:v.mensagem1,mensagem2:v.mensagem2,mensagem3:v.mensagem3,mensagem4:v.mensagem4,mensagem5:v.mensagem5,gerarRemessa:1,remessaOperacao:C};await $db.financeiroBoleto.grava({atual:X});let na=[];T&&(na=await $db.financeiroTitulo.le({idFinanceiroBoleto:T}));for(const ra of na){const da=$utils.clonar(ra);ra.idFinanceiroBoleto=$a;let ca=[];T&&(ca=await $db.financeiroBoletoTitulo.le({idFinanceiroBoleto:T}));for(const xa of ca){const Fa={id:$utils.uuid(),idFinanceiroBoleto:$a,idFinanceiroTitulo:xa.idFinanceiroTitulo};await $db.financeiroBoletoTitulo.grava({atual:Fa})}await $db.financeiroTitulo.grava({atual:ra,original:da})}if(v.remessaOperacao===z&&v.gerarRemessa===1)for(const ra of[v,X]){const da={...ra,gerarRemessa:0};await $db.financeiroBoleto.grava({original:ra,atual:da})}}}let I=[];this.$refs.faturamento.idDocumentoCaixa&&(I=await $db.financeiroMovimentacao.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa})),c=await $db.financeiroTitulo.le({idFatura:d.id});let S=await $db.financeiroTitulo.le({idFatura:d.id});for(const m of $utils.clonar(c)){if(!m.idFinanceiroMovimentacaoAgrupamento)continue;const v=await $db.financeiroRenegociacao.le({idFinanceiroMovimentacaoN:m.idFinanceiroMovimentacaoAgrupamento});for(const j of v){const L=await $db.financeiroTitulo.le({id:j.idFinanceiroTitulo});L.idDocumentoCaixa===this.$refs.faturamento.idDocumentoCaixa&&(c=c.concat(L))}}let N=!1;for(const m of _){const v=await $db.financeiroTitulo.le({id:m.idFinanceiroTitulo});if(Object.keys(v).length){let j=[];j=I.filter(L=>L.idFinanceiroMovimentacaoN===v.idFinanceiroMovimentacaoAgrupamento),b=b.concat(j),j=I.filter(L=>L.idFinanceiroTitulo===v.id),b=b.concat(j),j=I.filter(L=>L.idFinanceiroCheque===v.id),b=b.concat(j),c=c.concat(v)}m.idFinanceiroTitulo="",m.sinal===1&&(N=!0)}S=await $db.financeiroTitulo.le({idFatura:d.id,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa});for(const m of S){if(!m.idFinanceiroMovimentacaoAgrupamento)continue;const v=await $db.financeiroMovimentacao.le({idFinanceiroMovimentacaoN:m.idFinanceiroMovimentacaoAgrupamento});b=b.concat(v);const j=await $db.financeiroRenegociacao.le({idFinanceiroMovimentacaoN:m.idFinanceiroMovimentacaoAgrupamento});$=$.concat(j)}if(S=await $db.financeiroTitulo.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:d.id}),c=c.concat(S),d.id){let m=await $db.financeiroMovimentacao.lerV2({documentoTipo:"Devolu\xE7\xE3o",documentoId:d.id});b=b.concat(m),m=await $db.financeiroMovimentacao.lerV2({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:d.id}),b=b.concat(m),m=await $db.financeiroMovimentacao.lerV2({documentoId:d.id});for(const v of m)(await $db.financeiroTitulo.le({id:v.idFinanceiroTitulo})).id||(b=b.concat(v))}const W=await $db.hibrido.lista({table:"documento",where:{idFatura:d.id}});for(const m of W){const v=await $db.financeiroMovimentacao.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:m.id});b=b.concat(v)}let n=[];for(const m in c){const v=c[m].id;n.includes(v)?delete c[m]:n.push(v)}c=c.filter(m=>m),n=[];for(const m in b){const v=b[m].id;n.includes(v)?delete b[m]:n.push(v)}b=b.filter(m=>m),n=[];for(const m in $){const v=$[m].id;n.includes(v)?delete $[m]:n.push(v)}$=$.filter(m=>m);let G=$utils.dataAtual(),u=N?"Aguardando Pagamento":"Aberta";this.documentoStatus=[{id:$utils.uuid(),idDocumento:d.id,operacao:"Fatura",statusOriginal:d.status,statusFinalizado:u,dataHoraEmissao:G,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}],d.status=u,u==="Aberta"&&(d.dataHoraFinalizado=""),u=N?"Aguardando Pagamento":"Aguardando Faturamento";for(const m of g)this.documentoStatus.push({id:$utils.uuid(),idDocumento:m.id,operacao:"Venda de Mercadoria",statusOriginal:m.status,statusFinalizado:u,dataHoraEmissao:G,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}),m.status=u;for(const m of a)this.documentoStatus.push({id:$utils.uuid(),idDocumento:m.id,operacao:"Envelope",statusOriginal:m.status,statusFinalizado:m.status,dataHoraEmissao:G,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa});for(const m of l)m.status=u;this.fatura=d,this.vendas=g,this.documentosEnvelope=a,this.documentosItem=l}if(this.$q.loading.hide(),e&&await this.finalizar(e),this.$q.loading.show({message:"Processando..."}),e){let I=[],S=[],N=[],W=[],n=[],G=[];I=this.$refs.faturamento.condicaoPagamento.map(u=>u.id),S=this.$refs.faturamento.condicaoPagamentoOriginal.filter(u=>!I.includes(u.id));for(const u of S)if(u.idFinanceiroTitulo&&N.push(u.idFinanceiroTitulo),u.idFormaPagamento){let m;m=await $erp().formaPagamento.get(u.idFormaPagamento),(m||{}).aliquota&&(u.idFinanceiroTituloPagar?N.push(u.idFinanceiroTituloPagar):this.$q.notify("N\xE3o foi poss\xEDvel excluir as movimenta\xE7\xF5es referentes \xE0 aliquota. Exclua-as manualmente."))}for(const u of N){let m;if(m=await $erp().financeiroTitulo.get(u),m.id&&W.push(m),m.idFinanceiroMovimentacaoAgrupamento){let v,j;if(v=await $db.hibrido.lista({table:"financeiroMovimentacao",where:{idFinanceiroMovimentacaoN:m.idFinanceiroMovimentacaoAgrupamento}}),j=(v.find(L=>L.idFinanceiroCheque)||{}).idFinanceiroCheque,j){let L=await $erp().financeiroTitulo.get(j);L.id&&W.push(L)}n.push(...v)}}for(let u of this.carnes){if(!u.id||(u=await $erp().financeiroTitulo.get(u.id),!(u||{}).idFinanceiroMovimentacaoAgrupamento))continue;let m,v;m=await $db.hibrido.lista({table:"financeiroMovimentacao",where:{idFinanceiroMovimentacaoN:u.idFinanceiroMovimentacaoAgrupamento}}),v=await $db.hibrido.lista({table:"financeiroRenegociacao",where:{idFinanceiroMovimentacaoN:u.idFinanceiroMovimentacaoAgrupamento}}),n.push(...m),G.push(...v)}await $db.financeiroTitulo.remove(W),await $db.financeiroMovimentacao.remove(n),await $db.financeiroRenegociacao.remove(G)}else{await $db.financeiroTitulo.remove(c.filter(I=>!(I.carne&&I.idFatura===d.id))),await $db.financeiroMovimentacao.remove(b),await $db.financeiroRenegociacao.remove($);for(const I of c.filter(S=>S.carne&&S.idFatura===d.id))await $db.financeiroTitulo.grava({original:I,atual:{valorRealizado:0,receberPagar:1,dataPagamento:""}})}return this.fatura.tokenBonusGerado&&!e&&($db.bonus.cancela(this.fatura),this.fatura.tokenBonusGerado=""),await this.salvarFatura(),await this.atualizar(),e?this.$q.notifyPositive("Fatura corrigida."):this.$q.notifyPositive("Fatura reaberta."),!0}catch{this.$q.notify("N\xE3o foi poss\xEDvel reabrir a fatura."),this.$q.loading.hide()}finally{this.$q.loading.hide()}},async corrigir(){let e,o,d,g;if(e=this.$refs.faturamento.condicaoPagamentoOriginal,o=this.$refs.faturamento.condicaoPagamento,g=$utils.arredondar(this.fatura.totalDocumento||0),d=$utils.arredondar(o.reduce((a,l)=>a+l.valor||0,0)),d!==g){this.$q.notify("Total das condi\xE7\xF5es de pagamento difere do total da fatura");return}if(e.length){let a=!1;o.length||(a=!0);for(const l of o)if(!e.find(_=>_.id===l.id)){a=!0;break}if(!a){this.$q.notify("N\xE3o h\xE1 corre\xE7\xE3o a ser realizada");return}}try{return await new Promise((a,l)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 corrigir esta fatura",title:"Tem certeza?",cancel:{label:"CANCELAR",push:!0,color:"tertiary",flat:!0},ok:{label:"CONTINUAR",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{a()}).onCancel(()=>{l()})}),await this.reabrir(!0),!0}catch{return!1}},async salvarFatura(){var e,o,d,g,a;try{this.$q.loading.show({message:"Processando..."});let l=$utils.clonar(((d=(o=(e=this==null?void 0:this.$refs)==null?void 0:e.faturamento)==null?void 0:o.condicaoPagamento)==null?void 0:d.filter(c=>c==null?void 0:c.valor))||{});for(let c in l)delete l[c].idDocumentoCondicaoPagamento,delete l[c].parcelas,delete l[c].formaPagamento,delete l[c].edicao,delete l[c].codigoDocumento,delete l[c].codigoDocumentoCaixa;const _=(this.carnesOriginal||[]).filter(c=>(this.financeiroTitulo||[]).find(b=>b.id===c.id));if(await $db.fatura.grava({faturaOriginal:this.faturaOriginal,fatura:this.fatura,vendasOriginal:this.vendasOriginal,vendas:this.vendas,documentosEnvelope:this.documentosEnvelope,documentosEnvelopeOriginal:this.documentosEnvelopeOriginal,documentosItemOriginal:this.documentosItemOriginal,documentosItem:this.documentosItem,condicaoPagamentoOriginal:((a=(g=this.$refs)==null?void 0:g.faturamento)==null?void 0:a.condicaoPagamentoOriginal)||{},condicaoPagamento:l,documentoStatus:this.documentoStatus,financeiroTitulo:this.financeiroTitulo,financeiroTituloOriginal:_,financeiroMovimentacao:this.financeiroMovimentacao,financeiroRenegociacao:this.financeiroRenegociacao}),this.receberTitulo.id&&typeof this.receberTitulo.id!="object"){let c=this.carnes.find(b=>b.id===this.receberTitulo.id);c.id&&await $db.financeiroTitulo.grava({original:c,atual:{idFatura:this.fatura.id}}),delete this.receberTitulo.id,await this.atualizar()}if(this.receberTitulo.id&&typeof this.receberTitulo.id=="object"){for(let c of this.receberTitulo.id){let b=this.carnes.find($=>$.id===c);b.id&&await $db.financeiroTitulo.grava({original:b,atual:{idFatura:this.fatura.id}})}delete this.receberTitulo.id,await this.atualizar()}}catch{this.$q.notify("N\xE3o foi poss\xEDvel salvar a fatura."),this.$q.loading.hide()}finally{this.$q.loading.hide()}},async dialogImpressao(){if(this.carnes.length>0&&(this.fatura.status==="Finalizada"||this.fatura.status!=="Aguardando Pagamento"&&this.fatura.dataHoraFinalizado))return this.impressaoVisivel=!0,new Promise(e=>{this.resolveDialogImpressao=e})},fecharDialogImpressao(){this.impressaoVisivel=!1,this.resolveDialogImpressao()},async reenviarBonus(e){try{$q.loading.show();const d=(await $utils.geeksApi({reenviaWhatsAppBonus:{funcao:"9F17EED5-57F2-4FFD-99B5-5D0C1757DFB7",idFatura:e}})).data.reenviaWhatsAppBonus;d.mensagem.includes("Falha ao enviar mensagem")?$q.notifyError(d.mensagem):$q.notifyPositive(d.mensagem),console.log("REENVIAR BONUS RESP: ",d.mensagem)}catch(o){$q.notifyError("Erro ao reenviar b\xF4nus pelo WhatsApp.",o)}finally{$q.loading.hide()}}},props:{prop:{default:()=>({}),required:!0,type:Object},receberTitulo:{default:()=>({}),type:Object}},mounted(){this.sistemaPai=$utils.sistemaPai(),this.atualizar()}},ot={class:"Fatura round-borders bg-grey-2 q-pb-sm"},tt={class:"row items-center"},et={class:"col q-ma-sm q-title"},it={class:"bg-grey-2"},nt={class:"q-ma-sm"},rt={key:0,class:"q-item-label",style:{color:"#0c0c0c"}},st={key:1,class:"q-item-label q-mt-md",style:{color:"#0c0c0c"}},lt={class:"col-12 col-md-6 border-1 q-ma-md"},dt={class:"col-8 text-right"},ut={class:"col-4"},ct={class:"col-4"},mt={class:"col-4"},ft={class:"col-4 q-mt-sm text-right"},pt={class:"col-8 q-mt-sm text-right"},vt={class:"col-8 q-mt-sm text-right"},ht={class:"col-8 q-mt-sm text-right"},Ct={class:"col-8 q-mt-sm text-right"},gt={class:"Fatura-faturamento round-borders q-ma-sm q-pa-md"},bt={class:"round-borders q-ma-sm q-pa-md"};function $t(e,o,d,g,a,l){const _=K("avatar"),c=K("documento-codigo"),b=K("documento-metas"),$=K("VendaCard"),I=K("EnvelopeCard"),S=K("titulo-card"),N=K("row"),W=K("campo"),n=K("faturamento"),G=K("documentos-fiscais");return p(),A(Q,null,[F("div",ot,[t(fa,{class:"Fatura-barra bg-grey-2 q-py-md",color:"black",dark:""},{default:i(()=>[t(ba,null,{default:i(()=>[F("div",tt,[t(_,{imagem:(a.contatos[a.fatura.idContato]||{}).imagem,rotulo:a.fatura.descricaoContato,tamanho:"60"},null,8,["imagem","rotulo"]),F("div",et,x(a.fatura.descricaoContato),1)])]),_:1}),a.fatura.id?(p(),y(c,{key:0,documento:a.fatura,class:"q-mx-sm"},null,8,["documento"])):k("",!0),a.fatura.status==="Finalizada"||a.fatura.status!=="Aguardando Pagamento"&&a.fatura.dataHoraFinalizado?(p(),y(U,{key:1,icon:"print",size:"md",color:"primary",round:"",flat:""},{default:i(()=>[t(qa,null,{default:i(()=>[ea((p(),y(wa,{link:"",separator:""},{default:i(()=>[(p(!0),A(Q,null,Z(a.configImpressaoFatura,u=>(p(),y(H,{clickable:"",key:u.valor,onClick:m=>e.$imprimir(u.valor,(a.fatura||{}).id||"0")},{default:i(()=>[t(M,{avatar:""},{default:i(()=>[t(R,{name:"print"})]),_:1}),t(M,null,{default:i(()=>[t(J,null,{default:i(()=>[V(x(u.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),a.sistemaPai==="optisoul"?(p(!0),A(Q,{key:0},Z(a.configImpressaoEnvelope,u=>(p(),y(H,{clickable:"",key:u.valor,onClick:m=>e.$imprimir(u.valor,(a.fatura||{}).id||"0")},{default:i(()=>[t(M,{avatar:""},{default:i(()=>[t(R,{name:"print"})]),_:1}),t(M,null,{default:i(()=>[t(J,null,{default:i(()=>[V(x(u.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)):k("",!0),(p(!0),A(Q,null,Z(a.configImpressaoCarne,u=>(p(),y(H,{clickable:"",key:u.valor,onClick:m=>e.$imprimir(u.valor,(a.fatura||{}).id||"0")},{default:i(()=>[t(M,{avatar:""},{default:i(()=>[t(R,{name:"print"})]),_:1}),t(M,null,{default:i(()=>[t(J,null,{default:i(()=>[V(x(u.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),(p(!0),A(Q,null,Z(a.configImpressaoConvenio,u=>(p(),y(H,{clickable:"",key:u.valor,onClick:m=>e.$imprimir(u.valor,(a.fatura||{}).id||"0")},{default:i(()=>[t(M,{avatar:""},{default:i(()=>[t(R,{name:"print"})]),_:1}),t(M,null,{default:i(()=>[t(J,null,{default:i(()=>[V(x(u.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})),[[ia]])]),_:1})]),_:1})):k("",!0),t(U,{icon:"more_vert",size:"md",color:"tertiary",flat:"",round:""},{default:i(()=>[t(qa,null,{default:i(()=>[t(wa,{link:"",separator:""},{default:i(()=>{var u;return[a.fatura.id&&!!((u=a.fatura)!=null&&u.tokenBonusGerado)?ea((p(),y(H,{key:0,onClick:o[0]||(o[0]=m=>l.reenviarBonus(a.fatura.id)),clickable:""},{default:i(()=>[t(M,{avatar:""},{default:i(()=>[t(R,{name:"card_giftcard"})]),_:1}),t(M,null,{default:i(()=>[t(J,null,{default:i(()=>o[13]||(o[13]=[V("Reenviar o B\xF4nus")])),_:1})]),_:1})]),_:1})),[[ia]]):k("",!0),a.fatura.id?ea((p(),y(H,{key:1,clickable:"",onClick:o[1]||(o[1]=m=>e.$refs.documentosFiscais.emitirCupom(a.fatura.id))},{default:i(()=>[t(M,{avatar:""},{default:i(()=>[t(R,{name:"account_balance"})]),_:1}),t(M,null,{default:i(()=>[t(J,null,{default:i(()=>o[14]||(o[14]=[V("Emitir cupom")])),_:1})]),_:1})]),_:1})),[[ia]]):k("",!0),a.fatura.id&&e.$utils.mapearStatus(a.fatura).permiteNota?(p(),A(Q,{key:2},[ea((p(),y(H,{clickable:"",onClick:o[2]||(o[2]=m=>e.emitirNFeV2({idFatura:a.fatura.id},1,"Venda"))},{default:i(()=>[t(M,{avatar:""},{default:i(()=>[t(R,{name:"account_balance"})]),_:1}),t(M,null,{default:i(()=>[t(J,null,{default:i(()=>o[15]||(o[15]=[V("NFe de Sa\xEDda/Venda")])),_:1})]),_:1})]),_:1})),[[ia]]),ea((p(),y(H,{onClick:o[3]||(o[3]=m=>e.emitirNFeV2({idFatura:a.fatura.id},0,"Devolu\xE7\xE3o")),clickable:""},{default:i(()=>[t(M,{avatar:""},{default:i(()=>[t(R,{name:"account_balance"})]),_:1}),t(M,null,{default:i(()=>[t(J,null,{default:i(()=>o[16]||(o[16]=[V("NFe de Entrada/Devolu\xE7\xE3o")])),_:1})]),_:1})]),_:1})),[[ia]]),ea((p(),y(H,{onClick:o[4]||(o[4]=m=>e.emitirNFeV2({idFatura:a.fatura.id},1,"Remessa")),clickable:""},{default:i(()=>[t(M,{avatar:""},{default:i(()=>[t(R,{name:"account_balance"})]),_:1}),t(M,null,{default:i(()=>[t(J,null,{default:i(()=>o[17]||(o[17]=[V("NFe de Remessa")])),_:1})]),_:1})]),_:1})),[[ia]])],64)):k("",!0),a.fatura.id?ea((p(),y(H,{key:3,clickable:"",onClick:o[5]||(o[5]=m=>e.$db.log.show({documentoTipo:"Fatura",documentoId:a.fatura.id}))},{default:i(()=>[t(M,{avatar:""},{default:i(()=>[t(R,{name:"description"})]),_:1}),t(M,null,{default:i(()=>[t(J,null,{default:i(()=>o[18]||(o[18]=[V("Ver Log")])),_:1})]),_:1})]),_:1})),[[ia]]):k("",!0)]}),_:1})]),_:1})]),_:1})]),_:1}),F("div",it,[t(b,{ref:"documentoMetas"},null,512)]),F("div",nt,[a.vendas.length>0?(p(),A("p",rt,[t(R,{name:"shopping_cart",class:"q-mr-md",size:"24px",style:{color:"#737373"}}),o[19]||(o[19]=V(" Vendas "))])):k("",!0),(p(!0),A(Q,null,Z(a.vendas,u=>(p(),A("div",{key:u.id,class:"bg-white q-mt-sm round-borders"},[t($,{id:u.id,onAtualizar:l.atualizar,onExecutar:l.executar},null,8,["id","onAtualizar","onExecutar"])]))),128)),(p(!0),A(Q,null,Z(a.documentosEnvelope,u=>(p(),A("div",{key:u.id,class:"bg-white q-mt-sm round-borders"},[t(I,{id:u.id,onExecutar:l.executar},null,8,["id","onExecutar"])]))),128)),a.carnes.length>0?(p(),A("p",st,[t(R,{name:"attach_money",class:"q-mr-md",size:"24px",style:{color:"#737373"}}),o[20]||(o[20]=V(" Titulos (Carn\xEAs/Boletos) "))])):k("",!0),(p(!0),A(Q,null,Z(a.carnes,u=>(p(),A("div",{key:u.id,class:"bg-white q-mt-sm round-borders"},[t(S,{dados:u,class:"q-mt-md",onExecutar:l.executar},null,8,["dados","onExecutar"])]))),128))]),t(N,{class:"justify-end"},{default:i(()=>[F("div",lt,[t(N,{class:"q-mb-sm"},{default:i(()=>[o[21]||(o[21]=F("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Subtotal",-1)),F("strong",dt,x(e.$filters.numero(a.fatura.subTotal,2)),1)]),_:1}),a.permissaoDesconto?(p(),y(N,{key:0},{default:i(()=>[o[22]||(o[22]=F("div",{class:"col-4 col-lg-3",style:{"line-height":"50px"}},"Desconto",-1)),F("div",ut,[t(W,{modelValue:a.fatura.totalPercentualDesconto,"onUpdate:modelValue":[o[6]||(o[6]=u=>a.fatura.totalPercentualDesconto=u),o[7]||(o[7]=u=>l.calculaTotais("descontoPercentual"))],tipo:"decimal",decimals:"2",suffix:"%","somente-leitura":l.descontoSomenteLeitura,debounce:500,error:a.erroCalculo},null,8,["modelValue","somente-leitura","error"])]),F("div",ct,[t(W,{modelValue:a.fatura.totalDesconto,"onUpdate:modelValue":[o[8]||(o[8]=u=>a.fatura.totalDesconto=u),o[9]||(o[9]=u=>l.calculaTotais("desconto"))],tipo:"decimal",decimals:"2","somente-leitura":l.descontoSomenteLeitura,debounce:500,error:a.erroCalculo,errorMessage:a.erroCalculoMsg},null,8,["modelValue","somente-leitura","error","errorMessage"])])]),_:1})):k("",!0),a.permissaoBonus?(p(),y(N,{key:1},{default:i(()=>[o[23]||(o[23]=F("div",{class:"col-4 col-lg-3",style:{"line-height":"50px"}},"B\xF4nus",-1)),F("div",mt,[t(W,{modelValue:a.fatura.tokenBonusUtilizado,"onUpdate:modelValue":[o[10]||(o[10]=u=>a.fatura.tokenBonusUtilizado=u),o[11]||(o[11]=u=>l.calculaTotais("bonus"))],"rotulo-fixo":"Token do B\xF4nus","somente-leitura":l.bonusSomenteLeitura,debounce:500,mask:"NNNN-NNNN",error:!!a.erroTokenBonusMsg,errorMessage:a.erroTokenBonusMsg},null,8,["modelValue","somente-leitura","error","errorMessage"])]),F("strong",ft,x(e.$filters.numero(a.fatura.totalBonus,2)),1)]),_:1})):k("",!0),t(N,{class:"q-col-gutter-x-sm q-mt-sm"},{default:i(()=>[o[24]||(o[24]=F("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Total",-1)),F("strong",pt,x(e.$filters.numero(a.fatura.totalDocumento,2)),1)]),_:1}),a.pesoTotal?(p(),y(N,{key:2,class:"q-col-gutter-x-sm q-mt-sm"},{default:i(()=>[o[25]||(o[25]=F("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Peso Total",-1)),F("span",vt,x(a.pesoTotal),1)]),_:1})):k("",!0),a.pesoBrutoTotal?(p(),y(N,{key:3,class:"q-col-gutter-x-sm q-mt-sm"},{default:i(()=>[o[26]||(o[26]=F("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Peso Bruto Total",-1)),F("span",ht,x(a.pesoBrutoTotal),1)]),_:1})):k("",!0),a.metroCubicoTotal?(p(),y(N,{key:4,class:"q-col-gutter-x-sm q-mt-sm"},{default:i(()=>[o[27]||(o[27]=F("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Metro C\xFAbico Total",-1)),F("span",Ct,x(a.metroCubicoTotal),1)]),_:1})):k("",!0)])]),_:1}),F("div",gt,[t(n,{documento:a.fatura,ref:"faturamento",onExecutar:l.executar,onSalvarFatura:l.salvarFatura},null,8,["documento","onExecutar","onSalvarFatura"])]),F("div",bt,[t(G,{ref:"documentosFiscais",idFatura:a.fatura.id},null,8,["idFatura"])])]),t(za,{modelValue:a.impressaoVisivel,"onUpdate:modelValue":o[12]||(o[12]=u=>a.impressaoVisivel=u),onKeyup:Ia(l.fecharDialogImpressao,["esc"]),persistent:""},{default:i(()=>[t(Ha,{container:"",view:"hHh LpR fFf",class:"bg-white rounded-borders",style:{height:"100%","max-height":"350px","max-width":"400px"}},{default:i(()=>[t(Ja,null,{default:i(()=>[t(fa,null,{default:i(()=>[t(U,{icon:"arrow_back",flat:"",round:"",dense:"",onClick:l.fecharDialogImpressao},null,8,["onClick"]),t(ba,null,{default:i(()=>o[28]||(o[28]=[V("Imprimir")])),_:1})]),_:1})]),_:1}),t(Qa,null,{default:i(()=>[t(Ga,null,{default:i(()=>[t(wa,{link:"",separator:""},{default:i(()=>[(p(!0),A(Q,null,Z(a.configImpressaoFatura,u=>(p(),y(H,{clickable:"",key:u.valor,onClick:m=>e.$imprimir(u.valor,(a.fatura||{}).id||"0")},{default:i(()=>[t(M,{avatar:""},{default:i(()=>[t(R,{name:"print"})]),_:1}),t(M,null,{default:i(()=>[t(J,null,{default:i(()=>[V(x(u.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),a.sistemaPai==="optisoul"?(p(!0),A(Q,{key:0},Z(a.configImpressaoEnvelope,u=>(p(),y(H,{clickable:"",key:u.valor,onClick:m=>e.$imprimir(u.valor,(a.fatura||{}).id||"0")},{default:i(()=>[t(M,{avatar:""},{default:i(()=>[t(R,{name:"print"})]),_:1}),t(M,null,{default:i(()=>[t(J,null,{default:i(()=>[V(x(u.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)):k("",!0),(p(!0),A(Q,null,Z(a.configImpressaoCarne,u=>(p(),y(H,{clickable:"",key:u.valor,onClick:m=>e.$imprimir(u.valor,(a.fatura||{}).id||"0")},{default:i(()=>[t(M,{avatar:""},{default:i(()=>[t(R,{name:"print"})]),_:1}),t(M,null,{default:i(()=>[t(J,null,{default:i(()=>[V(x(u.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),(p(!0),A(Q,null,Z(a.configImpressaoConvenio,u=>(p(),y(H,{clickable:"",key:u.valor,onClick:m=>e.$imprimir(u.valor,(a.fatura||{}).id||"0")},{default:i(()=>[t(M,{avatar:""},{default:i(()=>[t(R,{name:"print"})]),_:1}),t(M,null,{default:i(()=>[t(J,null,{default:i(()=>[V(x(u.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","onKeyup"])],64)}var Ft=_a(at,[["render",$t]]);const Et={components:{CpfCnpjNoCupom:go,Fatura:Ft},data(){return{fatura:{},cpfCnpjNoCupom:{visivel:!1,incluirCpfCnpjNoCupom:!1,idEmpresa:"",cpfCnpj:"",nomeCliente:"",tipoCaixa:""},visivel:!1,visibilidade:{botao:{finalizar:!1,reabrir:!1,corrigir:!1}},temPermissaoCorrigir:!1}},emits:["executar"],methods:{async atualizar(){let e;try{e=setTimeout(()=>{$q.loading.show({message:"Carregando informa\xE7\xF5es...",boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"})},500);let o=await $db.hibrido.le({table:"documento",id:this.id});this.fatura=o,await this.verificarPermissoes(),this.desativarBotoes(),o.status==="Aberta"&&(this.visibilidade.botao.salvar=!0),o.status==="Finalizada"||o.status!=="Aguardando Pagamento"&&o.dataHoraFinalizado?this.visibilidade.botao.reabrir=!0:this.visibilidade.botao.finalizar=!0,await $db.contato.exibirCondutaObservacao(o.idContato,$q.notify)}finally{clearTimeout(e),$q.loading.hide()}},desativarBotoes(){this.visibilidade.botao.finalizar=!1,this.visibilidade.botao.reabrir=!1,this.visibilidade.botao.salvar=!1},desativarEsc(){this.lockEsc=!0},reativarEsc(){this.lockEsc=!1},async reabrir(){await this.$refs.fatura.reabrir(),await this.atualizar(),this.runOnHide.push(()=>$utils.emitter.emit("atualizarAtendimentoFatura"))},voltar(e){e.stopPropagation(),!this.lockEsc&&this.fechar()},async finalizar(e){const d={cpfCnpjNoCupom:this.cpfCnpjNoCupom};if(this.lockEsc=!0,!await this.$refs.fatura.finalizar(!1,d)){this.lockEsc=!1;return}await this.$refs.fatura.atualizar(),await this.atualizar(),await this.$refs.fatura.dialogImpressao(),this.$emit("executar","finalizar"),this.fechar()},async executar(e){switch(e){case"finalizar":if(!await this.$refs.fatura.finalizar())return;break;case"retornarOrcamento":case"remover":await this.atualizar(),this.runOnHide.push(()=>$utils.emitter.emit("atualizarAtendimentoFatura"));return}if(e==="atualizarSemFechar"){await this.atualizar(),this.runOnHide.push(()=>this.$emit("executar","atualizar")),await this.$forceUpdate();return}this.$emit("executar",e),this.fechar()},fechar(){this.visivel=!1},async executarRecebimentoMultiplos(e){return await this.$refs.fatura.executarRecebimentoMultiplos(e)},async mostrar(e={}){this.id=e.id,await this.atualizar(),this.visivel=!0},onHide(){this.fatura={},this.visibilidade={botao:{finalizar:!1,reabrir:!1,corrigir:!1}},this.temPermissaoCorrigir=!1,this.runOnHide.forEach(e=>e()),this.runOnHide=[]},async salvar(){try{await new Promise((e,o)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 salvar esta fatura",title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{e()}).onCancel(()=>{o()})})}catch{return}await this.$refs.fatura.salvarFatura(),this.$emit("executar","atualizar"),this.fechar()},corrigir(){this.$refs.fatura.corrigir().then(()=>{this.$emit("executar","atualizar"),this.fechar()})},async verificarPermissoes(){this.temPermissaoCorrigir=await $db.permissao.objeto("caixa/tesouraria")}},props:{receberTitulo:{default:()=>({}),type:Object}},created(){this.runOnHide=[]},mounted(){$utils.emitter.on("desativarBotoesFaturaModal",this.desativarBotoes),$utils.emitter.on("desativarVoltarEscModal",this.desativarEsc),$utils.emitter.on("reativarVoltarEscModal",this.reativarEsc)},beforeUnmount(){$utils.emitter.off("desativarBotoesFaturaModal",this.desativarBotoes),$utils.emitter.off("desativarVoltarEscModal",this.desativarEsc),$utils.emitter.off("reativarVoltarEscModal",this.reativarEsc)}};function Dt(e,o,d,g,a,l){const _=K("fatura"),c=K("CpfCnpjNoCupom");return p(),A("div",null,[t(za,{modelValue:a.visivel,"onUpdate:modelValue":o[0]||(o[0]=b=>a.visivel=b),onKeyup:Ia(l.voltar,["esc"]),onHide:l.onHide,maximized:"",persistent:""},{default:i(()=>[t(Ha,{view:"hHh LpR fFf",container:"",class:"bg-grey-4"},{default:i(()=>[t(Ja,null,{default:i(()=>[t(fa,null,{default:i(()=>[ea(t(U,{icon:"arrow_back",round:"",flat:"",dense:""},null,512),[[ia]]),t(ba,null,{default:i(()=>o[3]||(o[3]=[V("Fatura")])),_:1}),a.visibilidade.botao.salvar?(p(),y(U,{key:0,onClick:l.salvar,label:"Salvar",color:"white","text-color":"primary",unelevated:""},null,8,["onClick"])):k("",!0),a.visibilidade.botao.reabrir&&a.temPermissaoCorrigir?(p(),y(U,{key:1,onClick:l.corrigir,label:"Corrigir",color:"white","text-color":"negative",unelevated:""},null,8,["onClick"])):k("",!0)]),_:1})]),_:1}),t(Qa,null,{default:i(()=>[t(Ga,{class:"u-container q-py-md"},{default:i(()=>[a.fatura.id?(p(),y(_,{key:0,onExecutar:l.executar,prop:{id:a.fatura.id},receberTitulo:d.receberTitulo,ref:"fatura"},null,8,["onExecutar","prop","receberTitulo"])):k("",!0)]),_:1})]),_:1}),t(vo,{class:"bg-light",bordered:""},{default:i(()=>[t(fa,{class:"q-pa-sm u-container"},{default:i(()=>[t(ho),a.visibilidade.botao.reabrir?(p(),y(U,{key:0,onClick:l.reabrir,label:"Reabrir",color:"negative",flat:"",class:"q-ml-sm"},null,8,["onClick"])):k("",!0),a.visibilidade.botao.reabrir?ea((p(),y(U,{key:1,label:"Fechar",color:"tertiary",flat:"",class:"q-ml-sm"},null,512)),[[ia]]):k("",!0),a.visibilidade.botao.reabrir?k("",!0):(p(),y(U,{key:2,onClick:l.finalizar,disabled:!a.visibilidade.botao.finalizar,label:"Finalizar",color:"primary",dark:"",unelevated:"",class:"q-ml-sm"},null,8,["onClick","disabled"]))]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","onKeyup","onHide"]),t(c,{modelValue:a.cpfCnpjNoCupom.visivel,"onUpdate:modelValue":o[1]||(o[1]=b=>a.cpfCnpjNoCupom.visivel=b),onConfirmar:o[2]||(o[2]=b=>l.finalizar()),dados:a.cpfCnpjNoCupom},null,8,["modelValue","dados"])])}var xt=_a(Et,[["render",Dt]]);export{xt as F,Zo as T};
