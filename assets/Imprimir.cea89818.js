import{_ as k,a as M,p,o as f,i as b,w as s,f as a,aI as F,er as q,ca as T,A as N,B as E,D as d,E as $,e as g,t as w,l as x,C as y,x as h,bs as A,G as _,y as z,K as C,L as V,H as j,Q as I,I as L,bm as O}from"./index.88955961.js";import{V as S}from"./Visualizador.0e9820d9.js";import{o as U}from"./open-url.de6258fb.js";const W={data(){return{email:{de:"",para:"",assunto:"",mensagem:""},ruleObrigatorio:e=>(e||"").trim().length||"Preenchimento obrigat\xF3rio"}},methods:{async enviarNFeEmail(e){const{showLoading:t,successMsg:i,errorMsg:l}=e!=null?e:{};try{(t==null||t)&&$q.loading.show({message:"Envio de e-mail em andamento...",html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"});const o=[{name:`danfe_${this.nota.nNF}.pdf`,content:this.html,method:"html2pdf"}];for(const m of this.xmls)o.push({name:`${m.tipo}_${m.nNF}_${m.operacao}${m.nSeqEvento>1?"_"+m.nSeqEvento:""}.xml`,content:m.xmlProt});const r={host:"smtp.gmail.com",port:587,ssl:!0,auth:{user:"auto@geekssolucoes.com.br",pass:"xpto@9@9"},from:this.email.de,to:this.email.para,subject:this.email.assunto,text:this.email.mensagem,attachments:o},n=await M({baseURL:"https://api.b15.com.br",method:"post",url:"/email/v2",data:r});this.$q.notifyPositive((n==null?void 0:n.status)===200&&i?i:n.data.message)}catch(o){this.$q.notifyError(l||"Erro ao enviar e-mail",o)}finally{this.$q.loading.hide()}},async enviarNFeEmailAutomatico(e,t){var i,l,o,r,n,m,c;try{if(this.html=t,this.nota=await $db.hibrido.le({table:"documentoFiscalEletronico",id:e}),this.xmls=await $db.hibrido.lista({table:"documentoFiscalEletronicoXml",where:{idDocumentoFiscalEletronico:e}}),this.json=JSON.parse((i=this.nota.json)!=null?i:null),!((r=(o=(l=this.json)==null?void 0:l.infNFe)==null?void 0:o.dest)!=null&&r.email)){this.$q.notify({type:"warning",message:"Cliente sem e-mail cadastrado. XML e DANFE n\xE3o enviado automaticamente."});return}this.email={de:"Geeks Solu\xE7\xF5es <auto@geekssolucoes.com.br>",para:(c=(m=(n=this.json)==null?void 0:n.infNFe)==null?void 0:m.dest)==null?void 0:c.email,assunto:`Nota Fiscal Eletr\xF4nica N\xBA ${this.nota.nNF}`,mensagem:`Voc\xEA est\xE1 recebendo os arquivos digitais NFe (Nota Fiscal Eletr\xF4nica) da empresa ${this.nota.xFantEmitente}`},this.enviarNFeEmail({successMsg:`XML e DANFE enviados para ${this.email.para} com sucesso.`,errorMsg:"Erro ao enviar e-mail. XML e DANFE n\xE3o enviado automaticamente."})}catch(v){this.$q.notifyError("Erro ao abrir a nota",v)}},async abrirNFeEmail(e,t){try{this.html=t,this.nota=await $db.hibrido.le({table:"documentoFiscalEletronico",id:e}),this.xmls=await $db.hibrido.lista({table:"documentoFiscalEletronicoXml",where:{idDocumentoFiscalEletronico:e}}),this.json=JSON.parse(this.nota.json),this.email={de:"Geeks Solu\xE7\xF5es <auto@geekssolucoes.com.br>",para:this.$lodash.get(this.json,"infNFe.dest.email",""),assunto:`Nota Fiscal Eletr\xF4nica N\xBA ${this.nota.nNF}`,mensagem:`Voc\xEA est\xE1 recebendo os arquivos digitais NFe (Nota Fiscal Eletr\xF4nica) da empresa ${this.nota.xFantEmitente}`},this.$refs.dialogNFeEmail.show()}catch(i){this.$q.notifyError("Erro ao abrir a nota",i)}}},mounted(){$utils.emitter.off("abrirNFeEmail"),$utils.emitter.on("abrirNFeEmail",this.abrirNFeEmail),$utils.emitter.off("enviarNFeEmailAutomatico"),$utils.emitter.on("enviarNFeEmailAutomatico",this.enviarNFeEmailAutomatico)},beforeUnmount(){$utils.emitter.off("enviarNFeEmailAutomatico"),$utils.emitter.off("abrirNFeEmail")}};function D(e,t,i,l,o,r){const n=p("campo"),m=p("row"),c=p("card"),v=p("dialogForm");return f(),b(v,{ref:"dialogNFeEmail",title:"Nota Fiscal / Email",labelButtonSubmit:"Enviar",size:"md",onSubmit:r.enviarNFeEmail},{default:s(()=>[a(c,null,{default:s(()=>[a(m,{class:"q-col-gutter-y-md"},{default:s(()=>[a(n,{modelValue:o.email.de,"onUpdate:modelValue":t[0]||(t[0]=u=>o.email.de=u),col:"12",rotulo:"De","somente-leitura":""},null,8,["modelValue"]),a(n,{modelValue:o.email.para,"onUpdate:modelValue":t[1]||(t[1]=u=>o.email.para=u),col:"12",rotulo:"Para",rules:[o.ruleObrigatorio]},null,8,["modelValue","rules"]),a(n,{modelValue:o.email.assunto,"onUpdate:modelValue":t[2]||(t[2]=u=>o.email.assunto=u),col:"12",rotulo:"Assunto",rules:[o.ruleObrigatorio]},null,8,["modelValue","rules"]),a(n,{modelValue:o.email.mensagem,"onUpdate:modelValue":t[3]||(t[3]=u=>o.email.mensagem=u),col:"12",rotulo:"Mensagem",tipo:"textoArea",autogrow:"",autofocus:"",rules:[o.ruleObrigatorio]},null,8,["modelValue","rules"])]),_:1})]),_:1})]),_:1},8,["onSubmit"])}var Q=k(W,[["render",D]]);const P={components:{NFeEmail:Q,Visualizador:S},computed:{nome(){return this.$route.params.nome},parametro(){const{parametro:e}=this.$route.params;return e?F.decodeFromUrl(e):""}},data(){return{botaoImprimir:!0,componente:null,objeto:{},urlCompartilhamento:"",editarMsgWhatsapp:!1,configuracoesTexto:""}},methods:{async visualizadorIsMounted(){if(this.nome==="nfe-danfe"&&q()==="emitirNFe"){let e,t=0,i;await new Promise((l,o)=>{e=this.$refs.visualizador.$el.contentWindow.document.body.innerHTML,i=setInterval(()=>{if(t===3){clearInterval(i),l();return}const r=this.$refs.visualizador.$el.contentWindow.document.body.innerHTML;e.length===r.length&&t++,e.length!==r.length&&(t=0),e=r},50)}),$utils.emitter.emit("enviarNFeEmailAutomatico",this.parametro,e)}},abrirNFeEmail(){$utils.emitter.emit("abrirNFeEmail",this.parametro,this.$refs.visualizador.$el.contentWindow.document.body.innerHTML)},async carregarObjeto(e){try{const t=await T.objeto.le({filtros:{nomeObjeto:e,tipo:"vue"}});if(!t||!t[0]||!t[0].codigoPersonalizado)return this.$q.notify("Relat\xF3rio indispon\xEDvel ou sem permiss\xE3o");this.objeto=t[0];const i=JSON.parse(F.decode(t[0].codigoPersonalizado));this.componente={parametro:this.parametro,estilo:i.estilo,script:i.script,template:i.template}}catch(t){throw this.$q.notify("N\xE3o foi poss\xEDvel carregar o relat\xF3rio"),t}},async copiarLink(){const e=this.$refs.urlCompartilhamento;e.type="text",await this.$nextTick();try{e.select(),document.execCommand("copy"),this.$q.notify({message:"Copiado para a \xE1rea de transfer\xEAncia",type:"info"})}catch(t){this.$q.notifyError("Erro ao copiar",t)}e.type="hidden",window.getSelection().removeAllRanges()},async compartilhar(){let e="";try{this.$q.loading.show();const l=this.$refs.visualizador.$el.contentWindow.document.body.innerHTML;e=(await M({baseURL:"https://api.b15.com.br",method:"post",url:"/html2pdf",data:{html:l}})).data.url,this.urlCompartilhamento=e}catch(l){return this.$q.notifyError("Erro ao gerar o link de compartilhamento.",l)}finally{this.$q.loading.hide()}const t=this.objeto.descricao||"Relat\xF3rio",i=[{label:"Copiar link",icon:"link",handler:this.copiarLink},{color:"green",label:"WhatsApp",icon:"message",handler:()=>{this.editarMsgWhatsapp=!0}}];navigator.share&&i.push({label:"Outros",icon:"more_horiz",handler:()=>{navigator.share({title:t,url:e})}}),this.$q.bottomSheet({grid:!0,title:"Compartilhar",actions:i}).onOk(l=>{console.log("bottomSheet chosen:",l),l.handler()})},async enviarMensagemWhatsapp(){const e=await $erp().configuracoes.where({nome:"imprimir.compartilhar.whatsapp.mensagem"}).first()||null;e?(console.log("CONFIGURACAO ATT: ",e),await $db.configuracoes.grava({atual:{id:e==null?void 0:e.id,nome:(e==null?void 0:e.nome)||"",valor:(e==null?void 0:e.valor)||"",texto:this.configuracoesTexto||(e==null?void 0:e.texto)||"",observacao:(e==null?void 0:e.observacao)||"",idEmpresa:(e==null?void 0:e.idEmpresa)||""}})):(console.log("CONFIGURACAO ADD: ",e),await $db.configuracoes.grava({atual:{id:$utils.uuid(),nome:"imprimir.compartilhar.whatsapp.mensagem",valor:"",texto:this.configuracoesTexto||"Acesse o documento atrav\xE9s do link:",observacao:"",idEmpresa:""}}));const t=`${this.configuracoesTexto} ${this.urlCompartilhamento}`;console.log("TEXT: ",t),U(`https://wa.me/?text=${t}`)},imprimirVisualizador(){if(window.cordova&&window.cordova.plugins&&window.cordova.plugins.printer){const e=this.$refs.visualizador.$el.contentWindow.document.body.innerHTML;return cordova.plugins.printer.print(e)}this.$refs.visualizador.$el.contentWindow.print()},voltar(){window&&window.history.back()}},async created(){const e=(await $db.configuracoes.le({nome:"imprimir.compartilhar.whatsapp.mensagem"}))[0]||[];if(this.configuracoesTexto=(e==null?void 0:e.texto)||"Acesse o documento atrav\xE9s do link:",this.nome&&this.nome!=="0")return this.carregarObjeto(this.nome);this.$q.notify("Relat\xF3rio inv\xE1lido")}},R={class:"Imprimir-visualizador"},H={class:"border-full border-radius q-mt-md q-pa-sm"},B=h("span",{class:"text-weight-medium"},[g("Visualizar como esta \xE1 mensagem:"),h("br")],-1);function X(e,t,i,l,o,r){const n=p("visualizador"),m=p("NFeEmail");return f(),b(C,{class:"Imprimir bg-white"},{default:s(()=>[a(N,{class:"Imprimir-barraTopo"},{default:s(()=>[a(E,{color:"primary"},{default:s(()=>[a(d,{onClick:r.voltar,icon:"arrow_back",flat:"",round:""},null,8,["onClick"]),a($,null,{default:s(()=>[g(w(o.objeto.descricao||"Relat\xF3rio"),1)]),_:1}),r.nome==="nfe-danfe"?(f(),b(d,{key:0,onClick:r.abrirNFeEmail,label:"Email",icon:"email",flat:"",color:"white"},null,8,["onClick"])):x("",!0),a(d,{onClick:t[0]||(t[0]=c=>e.tryLoading(r.compartilhar)),label:"Compartilhar",icon:"share",flat:"",color:"white"}),a(d,{onClick:r.imprimirVisualizador,label:"Imprimir",icon:"print",flat:"",color:"white"},null,8,["onClick"]),y(h("input",{"onUpdate:modelValue":t[1]||(t[1]=c=>o.urlCompartilhamento=c),ref:"urlCompartilhamento",type:"hidden"},null,512),[[A,o.urlCompartilhamento]])]),_:1})]),_:1}),a(_,{class:"Imprimir-pagina"},{default:s(()=>[h("div",R,[o.componente?(f(),b(n,{key:0,onMounted:r.visualizadorIsMounted,componente:o.componente,ref:"visualizador"},null,8,["onMounted","componente"])):x("",!0)])]),_:1}),a(m),a(z,{modelValue:o.editarMsgWhatsapp,"onUpdate:modelValue":t[4]||(t[4]=c=>o.editarMsgWhatsapp=c)},{default:s(()=>[a(C,{container:"",view:"hHh Lpr fFf",class:"bg-white",style:{"max-height":"400px"}},{default:s(()=>[a(N,null,{default:s(()=>[a(E,null,{default:s(()=>[y(a(d,{icon:"arrow_back",flat:"",round:""},null,512),[[V]]),a($,null,{default:s(()=>[g("Enviar mensagem WhatsApp")]),_:1})]),_:1})]),_:1}),a(_,null,{default:s(()=>[a(j,{class:"q-pa-md"},{default:s(()=>[a(I,{modelValue:o.configuracoesTexto,"onUpdate:modelValue":t[2]||(t[2]=c=>o.configuracoesTexto=c),type:"textarea",label:"Mensagem",filled:"",dense:""},null,8,["modelValue"]),h("p",H,[B,g(" "+w(o.configuracoesTexto)+" "+w(o.urlCompartilhamento),1)])]),_:1})]),_:1}),a(L,{class:"bg-light"},{default:s(()=>[a(E,null,{default:s(()=>[a(O),y(a(d,{flat:"",label:"Cancelar",color:"tertiary"},null,512),[[V]]),a(d,{onClick:t[3]||(t[3]=c=>r.enviarMensagemWhatsapp()),label:"Enviar",color:"primary",unelevated:""})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}var Y=k(P,[["render",X]]);export{Y as default};
