import{_ as H,p as q,o as g,i as E,w as h,f as n,K as P,A as N,B as F,C as z,D as V,L as T,E as $,e as v,G as U,x as a,t as l,j as C,k as B,d as b,F as y,r as D,l as S,y as M}from"./index.094a6fb0.js";const Q={computed:{recebimentos(){return $utils.arredondar((this.campos.fechamento||0)-(this.campos.abertura||0)+(this.campos.despesas||0)-(this.campos.suprimentos||0)+(this.campos.sangrias||0))}},data(){return{visivel:!1,idDocumentoCaixa:"",campos:{sangrias:0,despesas:0,suprimentos:0,sangriaFinal:0,fundoCaixa:0,abertura:0,fechamento:0,dataHoraAbertura:"",nomeUsuarioAbertura:"",caixaDescricao:"",caixaEmpresaNome:"",observacao:""},sangrias:[],despesas:[],suprimentos:[],condicaoPagamento:[]}},emits:["fechado","update:modelValue"],methods:{calculaSangriaFinal(){let s=$utils.arredondar(this.campos.fechamento-this.campos.fundoCaixa);s<0&&(this.$q.notify({message:"Sangria final n\xE3o pode ser maior do que o recebimento",type:"warning"}),this.campos.fundoCaixa=0,s=$utils.arredondar(this.campos.fechamento)),this.campos.sangriaFinal=s},async atualizar(){const s=$utils.logarIni("AtualizarCaixa");await $tryLoading(async()=>{var c,m,i,p,x,_,u;const r=await $db.contatoCpf.leCache($db.usuario.logado.numeroDocumentoNacional);$utils.verificarErro(!(r!=null&&r.id),"Usu\xE1rio n\xE3o cadastrado nos contatos da empresa."),$utils.verificarErro(!this.idDocumentoCaixa,"Selecione um caixa aberto");const e=await $db.hibrido.le({table:"documento",id:this.idDocumentoCaixa});e.tipo==="Caixa"&&["Aberto","Reaberto"].includes(e.status)&&(this.documentoCaixa=e),$utils.verificarErro(!((c=this.documentoCaixa)!=null&&c.id),"Selecione um caixa aberto");const t=await $db.caixa.leCompleto(this.idDocumentoCaixa);console.log("Atualizar",$utils.clonarV2(t)),this.campos.sangrias=0,this.campos.despesas=0,this.campos.suprimentos=0,this.campos.sangriaFinal=0,this.campos.fundoCaixa=0,this.campos.abertura=0,this.campos.fechamento=0,this.campos.dataHoraAbertura="",this.campos.nomeUsuarioAbertura="",this.campos.caixaDescricao="",this.campos.caixaEmpresaNome="",this.campos.observacao="";for(const f of t.faturas)$utils.verificarErro(!f.dataHoraFinalizado,"Existem faturas abertas com condi\xE7\xE3o de pagamento lan\xE7ada. N\xE3o \xE9 poss\xEDvel finalizar o caixa sem finalizar ou excluir essas faturas!");this.caixa=t.caixa,this.empresa=t.empresa,this.sangrias=t.sangrias.filter(({documentoTipo:f})=>f==="Sangria"),this.campos.sangrias=$utils.arredondar($utils.somar(this.sangrias,"valorCredito")),this.despesas=t.despesas;let o=0;for(const f of this.despesas)o+=f.valorTotal,f.contato=await $db.contato.le({id:f.idContato}),f.financeiroPlanoConta=await $db.financeiroPlanoConta.le({id:f.idFinanceiroPlanoConta});this.campos.despesas=t.totalDespesas,this.suprimentos=t.suprimentos,this.campos.suprimentos=$utils.arredondar(this.suprimentos.reduce((f,w)=>(f+=w.valorDebito,f),0)),this.condicaoPagamento=t.condicaoPagamento,(m=t.condicaoPagamentoDinheiro)!=null&&m.length||console.error("Caixa sem configura\xE7\xE3o completa de plano de contas para dinheiro"),((p=(i=t.condicaoPagamentoDinheiro)==null?void 0:i[0])==null?void 0:p.descricao)!=="Dinheiro"&&console.error("Caixa sem configura\xE7\xE3o correta de forma de pagamente em dinheiro. Nome da forma de pagamento:",(_=(x=t.condicaoPagamentoDinheiro)==null?void 0:x[0])==null?void 0:_.descricao),this.campos.abertura=this.documentoCaixa.valorAbertura,this.campos.dataHoraAbertura=this.documentoCaixa.dataHoraEmissao,this.campos.observacao=this.documentoCaixa.observacao;let d;this.documentoCaixa.idContato&&(d=await $erp().contato.get(this.documentoCaixa.idContato)),this.campos.nomeUsuarioAbertura=(u=d==null?void 0:d.nome)!=null?u:"",this.campos.caixaDescricao=this.caixa.descricao,this.campos.caixaEmpresaNome=this.empresa.nome,this.calculaSangriaFinal(),this.visivel=!0,this.$emit("update:modelValue",!0)}),$utils.logarFim(s,1)},async fecharCaixaGerarCaixaAlterado({caixa:s,documentoCaixa:r,agora:e}){const t=$utils.clonar(r);return t.status="Aguardando Confer\xEAncia",t.dataHoraFinalizado=e,t.observacao=this.campos.observacao,t.valorAbertura=this.campos.abertura,$utils.verificarErro(new Date(t.dataHoraFinalizado)<new Date(t.dataHoraEmissao),`
          A abertura do caixa foi registrada em ${this.$filters.dataHora(t.dataHoraEmissao)},
          sua data agora \xE9 ${this.$filters.dataHora(t.dataHoraFinalizado)},
          como ela \xE9 menor que a abertura, n\xE3o podemos continuar, confira a data e hora do seu dispositivo.
        `),$utils.verificarErro(!s.id,"Caixa n\xE3o existe"),{documentoCaixaAlterado:t}},async fecharCaixaGerarSangriaFinal({caixaCompleto:s,agora:r,documentoCaixa:e,documentosStatus:t,contaOrigem:o,contaDestino:d}){const c=s.sangriaFinal.find(u=>u.idFinanceiroPlanoConta===o.id),m=s.sangriaFinal.find(u=>u.idFinanceiroPlanoConta===d.id);if(!c&&!m&&$utils.arredondar(this.campos.sangriaFinal)<=0)return;const i=t.filter(u=>u.operacao==="Fechamento Caixa"&&u.statusFinalizado==="Aguardando Confer\xEAncia"&&u.statusOriginal==="Aberto"),p=i.length?i[0].dataHoraEmissao:r,x=$db.usuario.logado.id;let _=(c==null?void 0:c.idFinanceiroMovimentacaoN)||(m==null?void 0:m.idFinanceiroMovimentacaoN);if(_||(_=$utils.uuid(),await $db.hibrido.grava("financeiroMovimentacaoN",{atual:{id:_}})),c)await $db.hibrido.grava("financeiroMovimentacao",{atual:{...c,valorCredito:this.campos.sangriaFinal},original:c});else{const u={id:$utils.uuid(),idFinanceiroMovimentacaoN:_,idEmpresa:e.idEmpresa,idContato:x,idFinanceiroPlanoConta:o.id,dataEmissao:r,dataCompetencia:p,dataVencimento:p,dataMovimento:p,valorDebito:0,valorCredito:this.campos.sangriaFinal,descricao:`Sangria final de ${$db.usuario.logado.nome} no Caixa #${e.id}`,observacao:"Transfer\xEAncia entre contas",documentoTipo:"Sangria Final",documentoId:e.id,idDocumentoCaixa:e.id};await $db.hibrido.grava("financeiroMovimentacao",{atual:u})}if(m)await $db.hibrido.grava("financeiroMovimentacao",{atual:{...m,valorDebito:this.campos.sangriaFinal},original:m});else{const u={id:$utils.uuid(),idFinanceiroMovimentacaoN:_,idEmpresa:e.idEmpresa,idContato:x,idFinanceiroPlanoConta:d.id,dataEmissao:r,dataCompetencia:p,dataVencimento:p,dataMovimento:p,valorDebito:this.campos.sangriaFinal,valorCredito:0,descricao:`Sangria final de ${$db.usuario.logado.nome} no Caixa #${e.id}`,observacao:"Transfer\xEAncia entre contas",documentoTipo:"Sangria Final",documentoId:e.id,idDocumentoCaixa:e.id};await $db.hibrido.grava("financeiroMovimentacao",{atual:u})}s.sangriaFinal=await $db.caixa.leSangriaFinal(this.idDocumentoCaixa)},async fecharCaixaGerarStatus({agora:s,caixaCompleto:r}){const{documentoCaixa:e,documentosStatus:t}=r;let o=t,d="";return o.length&&(o=$lodash.orderBy(o,"dataHoraEmissao","desc"),d=o[0].statusFinalizado),{documentoStatusCaixa:{id:$utils.uuid(),idDocumento:e.id,operacao:"Fechamento Caixa",statusOriginal:d,statusFinalizado:"Aguardando Confer\xEAncia",dataHoraEmissao:s,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:e.id}}},async fecharCaixa(){const s=$utils.logarIni("CaixaFechar");await $tryLoading(async()=>{$utils.verificarErro(this.campos.sangriaFinal<0,"Sangria final n\xE3o pode ser negativa.");const r=$utils.dataAtual(),e=await $db.caixa.leCompleto(this.idDocumentoCaixa);console.log("Fechando",$utils.clonarV2(e));const{caixa:t,documentoCaixa:o,documentosStatus:d,contaOrigem:c,contaDestino:m}=e,{documentoCaixaAlterado:i}=await this.fecharCaixaGerarCaixaAlterado({caixa:t,documentoCaixa:o,agora:r});e.documentoCaixa=i,await this.fecharCaixaGerarSangriaFinal({caixaCompleto:e,agora:r,documentoCaixa:o,documentosStatus:d,contaOrigem:c,contaDestino:m});const{documentoStatusCaixa:p}=await this.fecharCaixaGerarStatus({agora:r,caixaCompleto:e});e.documentoStatusCaixa=p,e.campos=this.campos,e.valoresDigitados=this.condicaoPagamento.map(({id:_,tipo:u,descricao:f,valor:w,totalSistema:A,idFormaPagamento:k})=>({id:_,tipo:u,descricao:f,valor:w,totalSistema:A,idFormaPagamento:k})),e.totalValoresDigitados=$utils.somar(e.valoresDigitados,"valor"),console.log("Fechado",$utils.clonarV2(e));const x={id:$utils.uuid(),idDocumentoCaixa:i.id,idDocumentoStatus:p.id,tabela:"caixaCompleto",json:JSON.stringify(e),dataHoraEmissao:r};await $db.hibrido.grava("caixaConsolidacao2",{atual:x}),await $db.hibrido.grava("documento",{atual:i,original:o}),await $db.hibrido.grava("documentoStatus",{atual:p}),this.visivel=!1,this.$emit("update:modelValue",!1),this.$emit("fechado"),this.$imprimir("fechamento-de-caixa",o.id),$q.notifyPositive("Caixa fechado com sucesso")},{mensagem:"Fechando caixa...",erro:"Ocorreu um erro ao fechar caixa"}),$utils.logarFim(s,1)},async mostrar(s){this.idDocumentoCaixa=s==null?void 0:s.idDocumentoCaixa,await this.atualizar()}}},G={class:"layout-padding q-pa-none q-pb-md"},O={class:"u-container q-pt-md"},I={class:"col-12"},L={class:"bg-white round-borders q-px-md q-pb-md"},R={class:"q-px-sm text-tertiary"},j=a("small",null,"Abertura",-1),J=a("br",null,null,-1),K={class:"q-px-sm text-tertiary hideonmobile"},W=a("small",null,"Usu\xE1rio",-1),X=a("br",null,null,-1),Y={class:"q-px-sm text-tertiary hideonmobile"},Z=a("small",null,"Empresa",-1),aa=a("br",null,null,-1),oa={class:"col-6 text-tertiary hideondesktop"},ia=a("small",null,"Usu\xE1rio",-1),sa=a("br",null,null,-1),ea={class:"col-6 text-tertiary hideondesktop"},ta=a("small",null,"Empresa",-1),na=a("br",null,null,-1),ra={class:"col-12"},la={class:"col-12 col-md-6"},ca={class:"bg-white fit round-borders q-px-md q-pb-md"},da={class:"col-12 items-center q-col-gutter-sm text-body2 row"},ma=a("div",{class:"col-5"},"Abertura",-1),ua={class:"col-7"},ha=a("div",{class:"col-5"},"Recebimentos em dinheiro",-1),pa={class:"col-7 text-right"},fa=a("strong",null,"Recebimentos em dinheiro",-1),ga=a("div",{class:"col-5"},"Sangrias",-1),ba={class:"col-7 text-right"},va={key:0,class:"col-12"},_a={class:"Tabela q-ma-sm q-pa-md full-width"},xa=a("div",{class:"col-5"},"Suprimentos",-1),Ca={class:"col-7 text-right"},Fa={key:1,class:"col-12"},$a={class:"Tabela q-ma-sm q-pa-md full-width"},ya=a("div",{class:"col-5"},"Despesas",-1),Da={class:"col-7 text-right"},wa={key:2,class:"col-12"},Sa={class:"Tabela q-ma-sm q-pa-md full-width"},qa=a("div",{class:"col-5"},"Fechamento",-1),Ea={class:"col-7"},Va=a("div",{class:"col-5"},"Abertura dia seguinte",-1),Aa={class:"col-7"},ka=a("div",{class:"col-5"},"Sangria Final",-1),Ha={class:"col-7 text-right"},Pa={class:"col-12 col-md-6"},Na={class:"bg-white fit round-borders q-px-md q-pb-md"},za={class:"q-mt-sm"},Ta={class:"col-7"},Ua={class:"col-5"},Ba={key:1,class:"text-right",style:{"padding-top":"6px","padding-right":"8px"}};function Ma(s,r,e,t,o,d){const c=q("campo"),m=q("row");return g(),E(M,{id:"caixaFechar",modelValue:o.visivel,"onUpdate:modelValue":r[4]||(r[4]=i=>o.visivel=i),maximized:""},{default:h(()=>[n(P,{container:"",class:"bg-light"},{default:h(()=>[n(N,null,{default:h(()=>[n(F,null,{default:h(()=>[z(n(V,{dense:"",flat:"",icon:"arrow_back",round:"",clikable:""},null,512),[[T]]),n($,null,{default:h(()=>[v("Fechar caixa")]),_:1}),n(V,{color:"white",class:"text-primary",label:"Concluir",onClick:d.fecharCaixa,unelevated:""},null,8,["onClick"])]),_:1})]),_:1}),n(U,null,{default:h(()=>[a("div",G,[a("div",O,[n(m,{class:"q-col-gutter-md"},{default:h(()=>[a("div",I,[a("div",L,[n(F,{class:"q-px-none"},{default:h(()=>[n($,{class:"text-tertiary"},{default:h(()=>[v(l(o.campos.caixaDescricao),1)]),_:1}),a("div",R,[a("div",null,[j,J,n(C,{name:"calendar_today",class:"q-mr-sm"}),v(" "+l(s.$filters.dataHora(o.campos.dataHoraAbertura)),1)])]),a("div",K,[a("div",null,[W,X,n(C,{name:"person",class:"q-mr-sm"}),v(" "+l(o.campos.nomeUsuarioAbertura),1)])]),a("div",Y,[Z,aa,n(C,{name:"business"}),v(" "+l(o.campos.caixaEmpresaNome),1)])]),_:1}),n(m,{class:"items-center q-col-gutter-x-md"},{default:h(()=>[a("div",oa,[a("p",null,[ia,sa,n(C,{name:"person"}),v(" "+l(o.campos.nomeUsuarioAbertura),1)])]),a("div",ea,[a("p",null,[ta,na,n(C,{name:"business"}),v(" "+l(o.campos.caixaEmpresaNome),1)])]),a("div",ra,[n(c,{modelValue:o.campos.observacao,"onUpdate:modelValue":r[0]||(r[0]=i=>o.campos.observacao=i),rotulo:"Observa\xE7\xE3o",rows:"2",tipo:"textoArea"},null,8,["modelValue"])])]),_:1})])]),a("div",la,[a("div",ca,[a("form",null,[n(F,{class:"q-px-none"},{default:h(()=>[n(C,{name:"mdi-cash-multiple",size:"24px",class:"text-tertiary"}),n($,{class:"text-tertiary"},{default:h(()=>[v("Dinheiro")]),_:1})]),_:1}),n(m,{class:"q-col-gutter-md"},{default:h(()=>[a("div",da,[ma,a("div",ua,[n(c,{modelValue:o.campos.abertura,"onUpdate:modelValue":r[1]||(r[1]=i=>o.campos.abertura=i),class:"bg-grey-2",tipo:"decimal",decimals:"2"},null,8,["modelValue"])]),ha,a("div",pa,[v(l(s.$filters.numero(d.recebimentos,2))+" ",1),n(B,null,{default:h(()=>[v("Fechamento - Abertura + Despesas - Suprimentos + Sangrias = "),fa]),_:1})]),ga,a("div",ba,l(s.$filters.numero(o.campos.sangrias,2)),1),o.campos.sangrias>0?(g(),b("div",va,[a("table",_a,[a("tbody",null,[(g(!0),b(y,null,D(o.sangrias,i=>(g(),b("tr",{key:i.id},[a("td",null,l(s.$filters.data(i.dataEmissao)),1),a("td",null,l(i.observacao),1),a("td",null,l(s.$filters.numero(i.valorCredito,2)),1)]))),128))])])])):S("",!0),xa,a("div",Ca,l(s.$filters.numero(o.campos.suprimentos,2)),1),o.campos.suprimentos>0?(g(),b("div",Fa,[a("table",$a,[a("tbody",null,[(g(!0),b(y,null,D(o.suprimentos,i=>(g(),b("tr",{key:i.id},[a("td",null,l(s.$filters.data(i.dataEmissao)),1),a("td",null,l(i.observacao),1),a("td",null,l(s.$filters.numero(i.valorDebito,2)),1)]))),128))])])])):S("",!0),ya,a("div",Da,l(s.$filters.numero(o.campos.despesas,2)),1),o.campos.despesas>0?(g(),b("div",wa,[a("table",Sa,[a("tbody",null,[(g(!0),b(y,null,D(o.despesas,i=>(g(),b("tr",{key:i.id},[a("td",null,l(s.$filters.data(i.dataEmissao)),1),a("td",null,l(i.nomeContato),1),a("td",null,l(i.descricaoPlanoConta),1),a("td",null,l(s.$filters.numero(i.valorTotal,2)),1)]))),128))])])])):S("",!0),qa,a("div",Ea,[n(c,{modelValue:o.campos.fechamento,"onUpdate:modelValue":r[2]||(r[2]=i=>o.campos.fechamento=i),class:"bg-grey-2",tipo:"decimal",decimals:"2",onBlur:d.calculaSangriaFinal},null,8,["modelValue","onBlur"])]),Va,a("div",Aa,[n(c,{modelValue:o.campos.fundoCaixa,"onUpdate:modelValue":r[3]||(r[3]=i=>o.campos.fundoCaixa=i),class:"bg-grey-2",tipo:"decimal",decimals:"2",onBlur:d.calculaSangriaFinal},null,8,["modelValue","onBlur"])]),ka,a("div",Ha,l(s.$filters.numero(o.campos.sangriaFinal,2)),1)])]),_:1})])])]),a("div",Pa,[a("div",Na,[a("form",null,[n(F,{class:"q-px-none"},{default:h(()=>[n(C,{name:"mdi-credit-card-multiple",size:"24px",class:"text-tertiary"}),n($,{class:"text-tertiary"},{default:h(()=>[v("Outras formas de pagamento")]),_:1})]),_:1}),a("div",za,[(g(!0),b(y,null,D(o.condicaoPagamento,i=>(g(),b("div",{class:"q-col-gutter-x-sm items-center q-mt-sm row",key:i.id},[a("div",Ta,l(i.descricao),1),a("div",Ua,[[5,99].includes(i.tipo)?(g(),b("div",Ba,l(s.$filters.numero(i.valor,2)),1)):(g(),E(c,{key:0,modelValue:i.valor,"onUpdate:modelValue":p=>i.valor=p,tipo:"decimal",decimals:"2",class:"bg-grey-2"},null,8,["modelValue","onUpdate:modelValue"]))])]))),128))])])])])]),_:1})])])]),_:1})]),_:1})]),_:1},8,["modelValue"])}var Ga=H(Q,[["render",Ma]]);export{Ga as C};
