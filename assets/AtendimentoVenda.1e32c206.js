import{ah as F,a9 as aa,dB as ma,a3 as ua,dC as ea,a5 as k,Q as S,j as B,b9 as ta,al as oa,dD as va,dE as ga,ag as Y,aA as ha,dF as fa,dG as pa,a4 as ba,_ as ia,r as D,o as m,d as C,w as c,f as d,y as na,h as Ca,i as Ia,k as y,G as sa,M as la,B as h,ar as Va,aU as X,e as g,C as wa,X as ya,bh as xa,d6 as Pa,n as w,ax as Da,O as Z,R as M,S as T,T as j,z as N,bC as L,F as W,s as J,dj as Fa,dk as R,t as x,m as _a,be as ka}from"./index.f2a220da.js";import{n as za}from"./nfePrincipal.341dd0eb.js";import{E as qa}from"./EnvelopeCard.4a4cb843.js";import{V as Ea}from"./VendaCard.27ca8a76.js";import{G as Aa}from"./GChipsV2.ac8e38be.js";import{o as Ga}from"./open-url.108a4da6.js";import"./compactarValidarNFe.97394362.js";import"./obterItens.d48753e1.js";import"./codigosANP.a6c1a264.js";import"./emitirNFe.35117289.js";import"./DocumentosFiscais.33fbcb1f.js";import"./Campo.22f0bacd.js";import"./ModalHistoricoStatus.63e685c7.js";const Oa=["top","right","bottom","left"],K={type:{type:String,default:"a"},outline:Boolean,push:Boolean,flat:Boolean,unelevated:Boolean,color:String,textColor:String,glossy:Boolean,square:Boolean,padding:String,label:{type:[String,Number],default:""},labelPosition:{type:String,default:"right",validator:o=>Oa.includes(o)},externalLabel:Boolean,hideLabel:{type:Boolean},labelClass:[Array,String,Object],labelStyle:[Array,String,Object],disable:Boolean,tabindex:[Number,String]};function da(o,a){return{formClass:F(()=>`q-fab--form-${o.square===!0?"square":"rounded"}`),stacked:F(()=>o.externalLabel===!1&&["top","bottom"].includes(o.labelPosition)),labelProps:F(()=>{if(o.externalLabel===!0){const l=o.hideLabel===null?a.value===!1:o.hideLabel;return{action:"push",data:{class:[o.labelClass,`q-fab__label q-tooltip--style q-fab__label--external q-fab__label--external-${o.labelPosition}`+(l===!0?" q-fab__label--external-hidden":"")],style:o.labelStyle}}}return{action:["left","top"].includes(o.labelPosition)?"unshift":"push",data:{class:[o.labelClass,`q-fab__label q-fab__label--internal q-fab__label--internal-${o.labelPosition}`+(o.hideLabel===!0?" q-fab__label--internal-hidden":"")],style:o.labelStyle}}})}}const ra={start:"self-end",center:"self-center",end:"self-start"},Sa=Object.keys(ra);var $=aa({name:"QFabAction",props:{...K,icon:{type:String,default:""},anchor:{type:String,validator:o=>Sa.includes(o)},to:[String,Object],replace:Boolean},emits:["click"],setup(o,{slots:a,emit:l}){const n=ma(ea,()=>({showing:{value:!0},onChildClick:ua})),{formClass:e,labelProps:s}=da(o,n.showing),u=F(()=>{const v=ra[o.anchor];return e.value+(v!==void 0?` ${v}`:"")}),t=F(()=>o.disable===!0||n.showing.value!==!0);function f(v){n.onChildClick(v),l("click",v)}function V(){const v=[];return a.icon!==void 0?v.push(a.icon()):o.icon!==""&&v.push(k(B,{name:o.icon})),(o.label!==""||a.label!==void 0)&&v[s.value.action](k("div",s.value.data,a.label!==void 0?a.label():[o.label])),ta(a.default,v)}const b=oa();return Object.assign(b.proxy,{click:f}),()=>k(S,{class:u.value,...o,noWrap:!0,stack:o.stacked,icon:void 0,label:void 0,noCaps:!0,fabMini:!0,disable:t.value,onClick:f},V)}});const Ta=["up","right","down","left"],La=["left","center","right"];var Ra=aa({name:"QFab",props:{...K,...va,icon:String,activeIcon:String,hideIcon:Boolean,hideLabel:{...K.hideLabel,default:null},direction:{type:String,default:"right",validator:o=>Ta.includes(o)},persistent:Boolean,verticalActionsAlign:{type:String,default:"center",validator:o=>La.includes(o)}},emits:ga,setup(o,{slots:a}){const l=Y(null),n=Y(o.modelValue===!0),e=ha(),{proxy:{$q:s}}=oa(),{formClass:u,labelProps:t}=da(o,n),f=F(()=>o.persistent!==!0),{hide:V,toggle:b}=fa({showing:n,hideOnRouteChange:f}),v=F(()=>({opened:n.value})),_=F(()=>`q-fab z-fab row inline justify-center q-fab--align-${o.verticalActionsAlign} ${u.value}`+(n.value===!0?" q-fab--opened":" q-fab--closed")),P=F(()=>`q-fab__actions flex no-wrap inline q-fab__actions--${o.direction} q-fab__actions--${n.value===!0?"opened":"closed"}`),q=F(()=>{const I={id:e.value,role:"menu"};return n.value!==!0&&(I["aria-hidden"]="true"),I}),O=F(()=>`q-fab__icon-holder  q-fab__icon-holder--${n.value===!0?"opened":"closed"}`);function z(I,E){const A=a[I],G=`q-fab__${I} absolute-full`;return A===void 0?k(B,{class:G,name:o[E]||s.iconSet.fab[E]}):k("div",{class:G},A(v.value))}function i(){const I=[];return o.hideIcon!==!0&&I.push(k("div",{class:O.value},[z("icon","icon"),z("active-icon","activeIcon")])),(o.label!==""||a.label!==void 0)&&I[t.value.action](k("div",t.value.data,a.label!==void 0?a.label(v.value):[o.label])),ta(a.tooltip,I)}return pa(ea,{showing:n,onChildClick(I){V(I),l.value!==null&&l.value.$el.focus()}}),()=>k("div",{class:_.value},[k(S,{ref:l,class:u.value,...o,noWrap:!0,stack:o.stacked,align:void 0,icon:void 0,label:void 0,noCaps:!0,fab:!0,"aria-expanded":n.value===!0?"true":"false","aria-haspopup":"true","aria-controls":e.value,onClick:b},i),k("div",{class:P.value,...q.value},ba(a.default))])}});const Ba={data(){return{motivo:"",motivos:[],tipo:"devolucao",visivel:!1}},emits:["executa"],methods:{async atualizar(){this.motivo="",this.tipo="devolucao";const o=await $db.configuracoes.le({nome:"vendas.garantia.motivo"});this.motivos=o.map(a=>a.valor)},executa(){if(this.tipo==="garantia"&&!this.motivo){this.$q.notify({message:"Selecione o motivo",type:"negative"});return}this.visivel=!1,this.$emit("executa",{tipo:this.tipo,motivo:this.motivo})},async mostrar(){await this.atualizar(),this.visivel=!0}}},Qa={class:"layout-padding"},Ua={class:"q-mt-lg text-center"};function Ha(o,a,l,n,e,s){const u=D("campo");return m(),C(wa,{modelValue:e.visivel,"onUpdate:modelValue":a[5]||(a[5]=t=>e.visivel=t),"content-css":{minWidth:"30vw"}},{default:c(()=>[d(na,{class:"q-dialog-plugin"},{default:c(()=>[d(Ca,{class:"bg-primary text-white"},{default:c(()=>[d(Ia,null,{default:c(()=>a[6]||(a[6]=[y("Devolu\xE7\xE3o/Garantia")])),_:1}),sa(d(S,{dense:"",flat:"",icon:"close",round:""},null,512),[[la]])]),_:1}),h("div",Qa,[h("form",{class:"q-pa-md",onSubmit:a[4]||(a[4]=Va((...t)=>s.executa&&s.executa(...t),["prevent"]))},[d(X,{modelValue:e.tipo,"onUpdate:modelValue":[a[0]||(a[0]=t=>e.tipo=t),a[1]||(a[1]=t=>e.motivo="")],class:"q-mr-sm",label:"Devolu\xE7\xE3o",val:"devolucao"},null,8,["modelValue"]),d(X,{modelValue:e.tipo,"onUpdate:modelValue":a[2]||(a[2]=t=>e.tipo=t),label:"Garantia",val:"garantia"},null,8,["modelValue"]),e.tipo==="garantia"?(m(),C(u,{key:0,modelValue:e.motivo,"onUpdate:modelValue":a[3]||(a[3]=t=>e.motivo=t),rotulo:"Motivo",tipo:"seletor",opcoes:e.motivos},null,8,["modelValue","opcoes"])):g("",!0),h("div",Ua,[d(S,{color:"primary",class:"q-ml-sm no-shadow",label:"Continua",type:"submit"})])],32)])]),_:1})]),_:1},8,["modelValue"])}var Ma=ia(Ba,[["render",Ha]]);const ja={components:{Avatar:ya,NfePrincipal:za,EnvelopeCard:qa,VendaCard:Ea,VendaDevolucaoGarantia:Ma,VendaModal:xa,Envelope:Pa,GChipsV2:Aa},computed:{temVendasAbertas(){return!!this.vendasAbertas.length},temVendasCanceladas(){return!!this.vendasCanceladas.length},temVendasFinalizadas(){return!!this.vendasFinalizadas.length},temRegistros(){return this.temVendasAbertas||this.temVendasCanceladas||this.temVendasFinalizadas}},data(){return{grupos:[],documentos:{},itens:{},documentosItens:[],vendasCompletas:{},vendasAbertas:[],vendasFinalizadas:[],vendasCanceladas:[],totalVendasAbertas:0,totalVendasFinalizadas:0,totalVendasCanceladas:0,filtro:{},tipoLista:"documentos",dataIni:null,dataFim:null,carregando:!1,colunas:[{name:"descricao",label:"Descri\xE7\xE3o",align:"left"},{name:"documento",label:"Documento",align:"left"},{name:"valorUnitario",label:"Valor Unit\xE1rio",align:"right"},{name:"quantidade",label:"Quantidade",align:"right"},{name:"valorTotal",label:"Valor Total",align:"right"},{name:"botao",label:"",align:"right"}],contato:null,tablePagination:{page:1,rowsPerPage:25},vendaCardPagination:{maxPages:7,perPage:5,vendasAbertas:{page:1,min:1,max:1},vendasFinalizadas:{page:1,min:1,max:1},vendasCanceladas:{page:1,min:1,max:1}},documentoItemDevolucaoGarantia:{},modalVenda:{visivel:!1,orcamento:{}},urlHistoricoCliente:"",sistemaPai:""}},methods:{abrirHistoricoCliente(){Ga(this.urlHistoricoCliente)},adicionarVenda(){this.$refs.modalVenda.mostrar({idContato:this.$route.params.id})},adicionarEnvelope(){this.$refs.modalEnvelope.mostrar({idContato:this.$route.params.id})},abrirModalDevolucaoGarantia(o){this.documentoItemDevolucaoGarantia=o,this.$refs.modalDevolucaoGarantia.mostrar()},alternarLista(){this.tipoLista=this.tipoLista==="documentos"?"itens":"documentos",this.atualizar()},fechouNFe(o){o&&$utils.emitter.emit("atualizarDocumentosFiscais")},async finalizaDevolucaoGarantia(o){var P,q;let a,l;if(l=this.documentoItemDevolucaoGarantia||{},l.idDocumento&&(a=await $db.hibrido.le({table:"documento",id:l.idDocumento})),!a.id){this.$q.notify("Venda original n\xE3o encontrada");return}let n={};if(this.documentoItemDevolucaoGarantia.idItem&&(n=await $erp().item.get(this.documentoItemDevolucaoGarantia.idItem)||{}),!n.id){this.$q.notify("Erro na recupera\xE7\xE3o do item");return}const e=a.tipo==="Envelope"?a.idContatoResponsavel:a.idContato;if(!Boolean(e)){this.$q.notify("Destinat\xE1rio n\xE3o encontrado");return}if(!a.idEmpresa){this.$q.notify("Emitente n\xE3o encontrado");return}const s=await $erp().documento.where({idContato:e,idEmpresa:a.idEmpresa,tipo:"Venda",status:"Or\xE7amento"}).toArray();s.sort((O,z)=>new Date(O.dataHoraEmissao)<new Date(z.dataHoraEmissao)?1:-1);const u=await $utils.selecionarCfop({ncm:n.ncm,idItem:n.id,itemTipo:n.tipo,codigoDocumentoOperacao:((P=s[0])==null?void 0:P.codigoDocumentoOperacao)||a.codigoDocumentoOperacao,idContatoDestinatario:e,idContatoEmitente:a.idEmpresa,operacaoFator:1});if(!u){this.$q.notifyError("CFOP n\xE3o encontrado");return}let t={};const f=$utils.removerAcentos((this.documentoItemDevolucaoGarantia.tipoItem||"").toLowerCase())==="servico";o.tipo==="devolucao"&&(t.operacao=f?"Devolu\xE7\xE3o de Servi\xE7o":"Devolu\xE7\xE3o de Venda"),o.tipo==="garantia"&&(t.operacao=f?"Garantia de Servi\xE7o":"Garantia de Venda",t.motivo=o.motivo),t.id=$utils.uuid(),t.dataHoraFinalizado="",t.idDocumentoItemVenda=this.documentoItemDevolucaoGarantia.id,t.idDocumentoVenda=this.documentoItemDevolucaoGarantia.idDocumento,t.idItem=this.documentoItemDevolucaoGarantia.idItem,t.idPlanoContaDestino=this.documentoItemDevolucaoGarantia.idPlanoContaDestino,t.idPlanoContaEstoque=this.documentoItemDevolucaoGarantia.idPlanoContaEstoque,t.tipoItem=this.documentoItemDevolucaoGarantia.tipoItem,t.descricaoItem=this.documentoItemDevolucaoGarantia.descricaoItem,t.status="Or\xE7amento",t.quantidade=this.documentoItemDevolucaoGarantia.quantidade||1,t.operacaoFator=u==null?void 0:u.fator,t.idCfop=u==null?void 0:u.id;const V=this.documentoItemDevolucaoGarantia.descontoItem||0,b=(this.documentoItemDevolucaoGarantia.descontoTotalRateado||0)/t.quantidade,v=(this.documentoItemDevolucaoGarantia.descontoFaturaRateado||0)/t.quantidade,_=$utils.arredondar(V+b+v,4);t.descontoItem=$utils.arredondar(_*-1,4),t.descontoPercentualItem=$utils.arredondar(t.descontoItem/(this.documentoItemDevolucaoGarantia.valorItem||1)*100,2),t.descontoTotalRateado=0,t.descontoFaturaRateado=0,t.descontoSubTotal=this.documentoItemDevolucaoGarantia.descontoSubTotal||0,t.valorCustoMedio=this.documentoItemDevolucaoGarantia.valorCustoMedio||0,t.valorCustoReposicao=this.documentoItemDevolucaoGarantia.valorCustoReposicao||0,t.valorOriginal=(this.documentoItemDevolucaoGarantia.valorOriginal||0)*-1,t.valorItem=(this.documentoItemDevolucaoGarantia.valorItem||0)*-1,t.subTotal=$utils.arredondar(((this.documentoItemDevolucaoGarantia.valorItem||0)-_)*-t.quantidade,2),t.total=t.subTotal||0,t.valorReal=$utils.arredondar(((this.documentoItemDevolucaoGarantia.valorItem||0)-_)*-1,4),t.valorRealTotal=t.subTotal||0,t.valorIpi=(this.documentoItemDevolucaoGarantia.valorIpi||0)*-1,t.valorIcms=(this.documentoItemDevolucaoGarantia.valorIcms||0)*-1,t.valorIcmsSt=(this.documentoItemDevolucaoGarantia.valorIcmsSt||0)*-1,t.valorDifal=(this.documentoItemDevolucaoGarantia.valorDifal||0)*-1,t.loteEmpresa=this.documentoItemDevolucaoGarantia.loteEmpresa,localStorage.setItem("documentoItemDevolucao",JSON.stringify(t)),s.length&&(t.idDocumento=s[0].id,t.dataHoraEmissao=$utils.dataAtual(),await $db.documentoItem.grava({atual:t}),this.$q.notify({message:"Item adicionado ao or\xE7amento.",type:"positive"})),this.$refs.modalVenda.mostrar({id:(q=s[0])==null?void 0:q.id,idContato:this.$route.params.id})},async atualizar(){this.documentos={},this.itens={},this.documentosItens=[],this.vendasCompletas={},this.tablePagination={page:1,rowsPerPage:25};let o,a;a=JSON.parse(localStorage.getItem("clienteSistema"))||{},o="https://rel.storage.b15.com.br/Relatorios/OptiSoul/historico-cliente.html?",o+="CodigoCliente="+this.contato.codigoContato,o+="&BancoDeDados="+a.bancoDeDados,o+="&URLServidor="+a.urlServidor,this.urlHistoricoCliente=o,await this.atualizarVendas()},async carregarImagensItens(o){const a=Object.keys(o);if(!!a.length){await $utils.dormir(200);try{const l=await $db.hibrido.lista({table:"item",columns:["id","descricao","imagem"],whereIn:{id:a}});for(const n of l)o[n.id].imagem=n.imagem||""}catch(l){console.error("Erro ao ler imagens de itens - ",l)}}},async carregarImagensContatos(o){const a=Object.keys(o);if(!!a.length){await $utils.dormir(200);try{const l=await $db.hibrido.lista({table:"contato",columns:["id","apelido","imagem"],whereIn:{id:a}});for(const n of l)o[n.id].imagem=n.imagem||""}catch(l){console.error("Erro ao carregar imagens de contatos - ",l)}}},executar(){this.atualizar()},async atualizarVendas(){var a,l,n;const o=$utils.logarIni("AtendimentoVenda");await $tryLoading(async()=>{$db.hibrido.isOnline()?this.tipoLista==="itens"?await this.atualizarVendasItensOnline():await this.atualizarVendasOnline():this.tipoLista==="itens"?await this.atualizarVendasItensOffline():await this.atualizarVendasOffline()},{mensagem:"Carregando vendas...",erro:"Ocorreu um erro ao consultar vendas",carregando:e=>this.carregando=e}),$utils.logarFim(o,(((a=this.vendasAbertas)==null?void 0:a.length)||0)+(((l=this.vendasFinalizadas)==null?void 0:l.length)||0)+(((n=this.totalVendasCanceladas)==null?void 0:n.length)||0))},async atualizarVendasOnline(){var u,t,f,V,b,v;if(!this.contato.id){console.error("id contato n\xE3o fornecido em atualizarVendasOnline");return}const{vendasAbertas:o,vendasFinalizadas:a,vendasCanceladas:l}=await $db.venda.leListaCompletaOnline({where:{idContato:this.contato.id,periodo:{dataIni:this.dataIni,dataFim:this.dataFim},grupos:this.grupos},vendaCardPagination:this.vendaCardPagination}),n=[...o.data.vendas,...a.data.vendas,...l.data.vendas],e={...o.data.itens,...a.data.itens,...l.data.itens},s={...o.data.contatos,...a.data.contatos,...l.data.contatos};for(const _ of n)for(const P of _.carrinho)P.item=e[P.idItem];this.vendasCompletas={dadosContatos:s,contatosEmpresa:a.data.contatosEmpresa,faturasAbertas:a.data.faturasAbertas},this.vendaCardPagination.vendasAbertas.max=(u=o.totalPages)!=null?u:0,this.vendaCardPagination.vendasFinalizadas.max=(t=a.totalPages)!=null?t:0,this.vendaCardPagination.vendasCanceladas.max=(f=l.totalPages)!=null?f:0,this.vendasAbertas=o.data.vendas,this.vendasFinalizadas=a.data.vendas,this.vendasCanceladas=l.data.vendas,this.totalVendasAbertas=$filters.numero((V=o.somaTotalDocumento)!=null?V:0,2),this.totalVendasFinalizadas=$filters.numero((b=a.somaTotalDocumento)!=null?b:0,2),this.totalVendasCanceladas=$filters.numero((v=l.somaTotalDocumento)!=null?v:0,2),this.carregarImagensContatos(this.vendasCompletas.dadosContatos)},async atualizarVendasOffline(){var E,A,G,Q,U,H;const o=await $db.venda.leListaCompletaOffline({where:{idContato:this.contato.id,periodo:{dataIni:this.dataIni,dataFim:this.dataFim},status:"aberta",grupos:this.grupos},page:this.vendaCardPagination.vendasAbertas.page,limit:5}),a=await $db.venda.leListaCompletaOffline({where:{idContato:this.contato.id,periodo:{dataIni:this.dataIni,dataFim:this.dataFim},status:"finalizada",grupos:this.grupos},page:this.vendaCardPagination.vendasFinalizadas.page,limit:5}),l=await $db.venda.leListaCompletaOffline({where:{idContato:this.contato.id,periodo:{dataIni:this.dataIni,dataFim:this.dataFim},status:"cancelada",grupos:this.grupos},page:this.vendaCardPagination.vendasCanceladas.page,limit:5}),n=[...o.data,...a.data,...l.data],e=n.map(({id:r})=>r),s=await $db.hibrido.lista({table:"documentoItem",whereIn:{idDocumento:e}}),u=await $db.hibrido.lista({table:"documento",whereIn:{documentoId:e}}),t=n.map(({idContato:r})=>r),f=n.map(({idContatoVendedor:r})=>r),V=[...t,...f].filter(Boolean),b=await $db.hibrido.lista({table:"contato",whereIn:{id:V}}),v={};for(const r of b)v[r.id]=r;const P=(await $db.hibrido.lista({table:"empresa",columns:["idContato"],whereFilter:{ativo:!0}})).map(({idContato:r})=>r),q=await $db.hibrido.lista({table:"contato",columns:["id"],whereIn:{id:P},whereFilter:{ativo:!0}}),O=(await $db.hibrido.lista({table:"documento",where:{tipo:"Fatura",idContato:this.contato.id},whereFilter:{status:"Aberta"}})).sort((r,p)=>!r.numero||r.numero<p.numero?-1:1),z=s.filter(({idItem:r})=>r).map(({idItem:r})=>r),i=await $db.hibrido.lista({table:"item",whereIn:{id:z}}),I={};for(const r of i)I[r.id]=r;for(const r of n){r.carrinho=s.filter(({idDocumento:p})=>p===r.id),r.envelopes=u.filter(p=>p.documentoId===r.id&&p.tipo==="Envelope"),r.customs=u.filter(p=>p.documentoId===r.id&&p.tipo==="Custom"),r.oss=u.filter(p=>p.documentoId===r.id&&p.tipo==="Ordem de Servi\xE7o"),r.kits=u.filter(p=>p.documentoId===r.id&&p.tipo==="Venda Kit");for(const p of r.carrinho)p.item=I[p.idItem];for(const p of r.envelopes)p.itens=r.carrinho.filter(({idDocumentoAdicional:ca})=>ca===p.id)}this.vendasCompletas={dadosContatos:v,contatosEmpresa:q,faturasAbertas:O},this.vendaCardPagination.vendasAbertas.max=(E=o.totalPages)!=null?E:0,this.vendaCardPagination.vendasFinalizadas.max=(A=a.totalPages)!=null?A:0,this.vendaCardPagination.vendasCanceladas.max=(G=l.totalPages)!=null?G:0,this.vendasAbertas=o.data,this.vendasFinalizadas=a.data,this.vendasCanceladas=l.data,this.totalVendasAbertas=$filters.numero((Q=o.somaTotalDocumento)!=null?Q:0,2),this.totalVendasFinalizadas=$filters.numero((U=a.somaTotalDocumento)!=null?U:0,2),this.totalVendasCanceladas=$filters.numero((H=l.somaTotalDocumento)!=null?H:0,2)},async atualizarVendasItensOnline(){if(!this.contato.id){console.error("id contato n\xE3o fornecido em atualizarVendasItensOnline");return}const{vendasFinalizadas:o}=await $db.venda.leListaCompletaItensOnline({where:{idContato:this.contato.id,periodo:{dataIni:this.dataIni,dataFim:this.dataFim},grupos:this.grupos},vendaCardPagination:this.vendaCardPagination}),a={};let l=[];for(const n of o.data.vendas)a[n.id]=n,!(n.tipo==="Envelope"&&n.idContatoResponsavel!==this.contato.id)&&l.push(...n.carrinho);if(this.documentos=a,this.itens=o.data.itens,l=l.filter(n=>n.idItem),this.grupos.length){const n=await this.filtraTermos(l,this.grupos);n.length>0&&(l=l.filter(e=>n.includes(e.idItem)))}this.documentosItens=l.sort((n,e)=>new Date(e.dataHoraFinalizado||e.DataHoraEmissao||0)-new Date(n.dataHoraFinalizado||n.DataHoraEmissao||0)),this.carregarImagensItens(this.itens)},async atualizarVendasItensOffline(){const o=await $db.venda.leListaCompletaOffline({where:{idContato:this.contato.id,periodo:{dataIni:this.dataIni,dataFim:this.dataFim},status:"finalizada",grupos:this.grupos},page:this.vendaCardPagination.vendasFinalizadas.page,limit:1e3}),a={},l={},n=o.data.filter(t=>t.tipo==="Envelope"&&t.idContatoResponsavel===this.contato.id||t.tipo==="Venda").map(({id:t})=>t);let e=await $db.hibrido.lista({table:"documentoItem",whereIn:{idDocumento:n}});await $db.hibrido.lista({table:"documento",whereIn:{documentoId:n}});const s=e.filter(({idItem:t})=>t).map(({idItem:t})=>t),u=await $db.hibrido.lista({table:"item",whereIn:{id:s}});for(const t of u)l[t.id]=t;for(const t of o.data)a[t.id]=t;if(this.documentos=a,this.itens=l,e=e.filter(t=>t.idItem),this.grupos.length){const t=await this.filtraTermos(e,this.grupos);t.length>0&&(e=e.filter(f=>t.includes(f.idItem)))}this.documentosItens=e.sort((t,f)=>new Date(f.dataHoraFinalizado||f.DataHoraEmissao||0)-new Date(t.dataHoraFinalizado||t.DataHoraEmissao||0))},async filtraTermos(o,a){const l=(await $db.item.ler({filtros:{ids:o.map(t=>t.idItem)}})).data,n=a.map(t=>$utils.removerAcentos(t.toUpperCase())).filter(Boolean),e=n.filter(t=>t.match(/^\d+$/)),s=n.filter(t=>!t.match(/^\d+$/)),u=new Set;for(const t of l){const f=$utils.removerAcentos([t.id,"#"+t.codigoItem,t.descricaoConcatenada,t.marca,t.referencia].join(" ").toUpperCase()),V=[t.codigoItem].map(String);let b=!0;for(const v of e)b=b&&V.includes(v);for(const v of s)b=b&&f.includes(v);b&&u.add(t.id)}return Array.from(u)},async limparFiltro(){this.grupos=[],this.dataFim=new Date;const o=new Date;if(o.setFullYear(o.getFullYear()-2),this.dataIni=o,this.contato.codigoContato){const a=await $db.configuracoes.leValorNumerico("venda.codigoconsumidor");this.contato.codigoContato===a&&(this.dataIni=this.dataFim)}}},watch:{"$route.params.id"(){const o=this.$route.params.id;!o||$db.contato.le({id:o}).then(a=>{this.contato=a,this.tipoLista="documentos",this.limparFiltro().then(()=>{this.atualizar()}).catch(l=>{$q.notifyError("Ops! Ocorreu um erro",l)})}).catch(a=>{$q.notifyError("Ops! Ocorreu um erro",a)})}},created(){$utils.emitter.off("atualizarAtendimentoVenda"),$utils.emitter.on("atualizarAtendimentoVenda",this.atualizar)},mounted(){this.sistemaPai=$utils.sistemaPai();const o=this.$route.params.id;!o||$db.contato.le({id:o}).then(a=>{this.contato=a,this.limparFiltro().then(()=>{this.atualizar()}).catch(l=>{$q.notifyError("Ops! Ocorreu um erro",l)})}).catch(a=>{$q.notifyError("Ops! Ocorreu um erro",a)})}},Na={class:"AtendimentoVenda q-pb-md"},Wa={class:"row q-mt-md",style:{display:"flex","align-items":"center"}},Ja={class:"col"},Ka={class:"col-12 col-md-6"},Ya={class:"col"},Xa={class:"col"},Za={class:"col-auto q-ml-xs"},$a={key:0,class:"row justify-end q-mb-md"},ae={class:"row"},ee={key:1,class:"row justify-end q-mb-md"},te={key:0,class:"row justify-end q-mb-md"},oe={class:"row"},ie={key:1,class:"row justify-end q-mb-md"},ne={key:0,class:"col-12",style:{"margin-bottom":"50px"}},se={key:1,class:"col-12",style:{"margin-bottom":"50px"}},le={class:"row items-center",style:{"min-width":"180px","max-width":"100%"}},de={class:"col-auto hideonmobile"},re={class:"col",style:{"word-break":"break-word","white-space":"initial"}},ce={key:0,style:{"text-decoration":"line-through"}},me={key:2,class:"q-pa-lg text-center"},ue={key:3};function ve(o,a,l,n,e,s){var z;const u=D("GChipsV2"),t=D("campo"),f=D("row"),V=D("VendaCard"),b=D("EnvelopeCard"),v=D("avatar"),_=D("VendaModal"),P=D("Envelope"),q=D("VendaDevolucaoGarantia"),O=D("NfePrincipal");return m(),w("div",Na,[h("div",Wa,[h("div",Ja,[d(na,{class:"q-pa-sm q-ml-sm no-shadow"},{default:c(()=>[d(f,{class:"items-center q-col-gutter-md"},{default:c(()=>[h("div",Ka,[d(u,{modelValue:e.grupos,"onUpdate:modelValue":[a[0]||(a[0]=i=>e.grupos=i),s.atualizarVendas],placeholder:"Filtre por Produto, Marca, N\xFAmero..."},{prepend:c(()=>[d(B,{name:"mdi-filter"})]),_:1},8,["modelValue","onUpdate:modelValue"])]),h("div",Ya,[d(t,{modelValue:e.dataIni,"onUpdate:modelValue":a[1]||(a[1]=i=>e.dataIni=i),tipo:"data",onBlur:s.atualizar,dense:"",outlined:""},null,8,["modelValue","onBlur"])]),a[10]||(a[10]=h("div",{class:"col-auto",style:{"align-items":"center",display:"flex"}},[h("label",null,"at\xE9")],-1)),h("div",Xa,[d(t,{modelValue:e.dataFim,"onUpdate:modelValue":a[2]||(a[2]=i=>e.dataFim=i),tipo:"data",onBlur:s.atualizar,dense:"",outlined:""},null,8,["modelValue","onBlur"])])]),_:1})]),_:1})]),h("div",Za,[d(S,{round:"",dense:"",flat:"",icon:"more_vert",color:"primary",size:"md"},{default:c(()=>[d(Da,null,{default:c(()=>[sa((m(),C(Z,{link:"","no-border":"",separator:""},{default:c(()=>[e.tipoLista==="itens"?(m(),C(M,{key:0,onClick:s.alternarLista,clickable:""},{default:c(()=>[d(T,{avatar:""},{default:c(()=>[d(B,{name:"view_stream"})]),_:1}),d(T,null,{default:c(()=>[d(j,null,{default:c(()=>a[11]||(a[11]=[y("Vendas")])),_:1})]),_:1})]),_:1},8,["onClick"])):g("",!0),e.tipoLista==="documentos"?(m(),C(M,{key:1,onClick:s.alternarLista,clickable:""},{default:c(()=>[d(T,{avatar:""},{default:c(()=>[d(B,{name:"view_list"})]),_:1}),d(T,null,{default:c(()=>[d(j,null,{default:c(()=>a[12]||(a[12]=[y("Produtos e Servi\xE7os")])),_:1})]),_:1})]),_:1},8,["onClick"])):g("",!0),d(M,{clickable:"",onClick:s.abrirHistoricoCliente},{default:c(()=>[d(T,{avatar:""},{default:c(()=>[d(B,{name:"mdi-account"})]),_:1}),d(T,null,{default:c(()=>[d(j,null,{default:c(()=>a[13]||(a[13]=[y("Hist\xF3rico do Cliente")])),_:1})]),_:1})]),_:1},8,["onClick"])]),_:1})),[[la]])]),_:1})]),_:1})])]),!e.carregando&&s.temRegistros&&e.tipoLista==="documentos"?(m(),C(Z,{key:0,class:"no-border"},{default:c(()=>[s.temVendasAbertas?(m(),C(N,{key:0,"model-value":!0,label:`Abertas (Total R$ ${e.totalVendasAbertas})`,group:"vendasAbertas"},{default:c(()=>[e.vendaCardPagination.vendasAbertas.max>1?(m(),w("div",$a,[d(L,{modelValue:e.vendaCardPagination.vendasAbertas.page,"onUpdate:modelValue":a[3]||(a[3]=i=>e.vendaCardPagination.vendasAbertas.page=i),min:e.vendaCardPagination.vendasAbertas.min,unelevated:"",max:e.vendaCardPagination.vendasAbertas.max,ellipses:"","max-pages":e.vendaCardPagination.maxPages,class:"float-right",onClick:s.atualizarVendas},null,8,["modelValue","min","max","max-pages","onClick"])])):g("",!0),h("div",ae,[(m(!0),w(W,null,J(e.vendasAbertas,i=>(m(),w("div",{class:"q-px-sm full-width",key:i.id},[i.tipo==="Venda"?(m(),C(V,{key:0,id:i.id,dadosVenda:i,vendasCompletas:e.vendasCompletas,onExecutar:s.executar,class:"q-mb-md"},null,8,["id","dadosVenda","vendasCompletas","onExecutar"])):g("",!0),i.tipo==="Envelope"?(m(),C(b,{key:1,id:i.id,onExecutar:s.executar,class:"q-mb-md"},null,8,["id","onExecutar"])):g("",!0)]))),128))]),e.vendaCardPagination.vendasAbertas.max>1?(m(),w("div",ee,[d(L,{modelValue:e.vendaCardPagination.vendasAbertas.page,"onUpdate:modelValue":a[4]||(a[4]=i=>e.vendaCardPagination.vendasAbertas.page=i),min:e.vendaCardPagination.vendasAbertas.min,unelevated:"",max:e.vendaCardPagination.vendasAbertas.max,ellipses:"","max-pages":e.vendaCardPagination.maxPages,class:"float-right",onClick:s.atualizarVendas},null,8,["modelValue","min","max","max-pages","onClick"])])):g("",!0)]),_:1},8,["label"])):g("",!0),s.temVendasFinalizadas?(m(),C(N,{key:1,"model-value":!0,label:`Finalizadas (Total R$ ${e.totalVendasFinalizadas})`,group:"vendasFinalizadas"},{default:c(()=>[e.vendaCardPagination.vendasFinalizadas.max>1?(m(),w("div",te,[d(L,{modelValue:e.vendaCardPagination.vendasFinalizadas.page,"onUpdate:modelValue":a[5]||(a[5]=i=>e.vendaCardPagination.vendasFinalizadas.page=i),unelevated:"",min:e.vendaCardPagination.vendasFinalizadas.min,max:e.vendaCardPagination.vendasFinalizadas.max,ellipses:"","max-pages":e.vendaCardPagination.maxPages,class:"float-right",onClick:s.atualizarVendas},null,8,["modelValue","min","max","max-pages","onClick"])])):g("",!0),h("div",oe,[(m(!0),w(W,null,J(e.vendasFinalizadas,i=>(m(),w("div",{class:"q-px-sm full-width",key:i.id},[i.tipo==="Venda"?(m(),C(V,{key:0,id:i.id,dadosVenda:i,vendasCompletas:e.vendasCompletas,onExecutar:s.executar,class:"q-mb-md"},null,8,["id","dadosVenda","vendasCompletas","onExecutar"])):g("",!0),i.tipo==="Envelope"?(m(),C(b,{key:1,id:i.id,onExecutar:s.executar,class:"q-mb-md"},null,8,["id","onExecutar"])):g("",!0)]))),128))]),e.vendaCardPagination.vendasFinalizadas.max>1?(m(),w("div",ie,[d(L,{modelValue:e.vendaCardPagination.vendasFinalizadas.page,"onUpdate:modelValue":a[6]||(a[6]=i=>e.vendaCardPagination.vendasFinalizadas.page=i),min:e.vendaCardPagination.vendasFinalizadas.min,max:e.vendaCardPagination.vendasFinalizadas.max,ellipses:"",unelevated:"","max-pages":e.vendaCardPagination.maxPages,class:"float-right",onClick:s.atualizarVendas},null,8,["modelValue","min","max","max-pages","onClick"])])):g("",!0)]),_:1},8,["label"])):g("",!0),s.temVendasCanceladas?(m(),C(N,{key:2,"model-value":!0,label:`Canceladas (Total R$ ${e.totalVendasCanceladas})`,group:"vendasCanceladas"},{default:c(()=>[e.vendaCardPagination.vendasCanceladas.max>1?(m(),w("div",ne,[d(L,{modelValue:e.vendaCardPagination.vendasCanceladas.page,"onUpdate:modelValue":a[7]||(a[7]=i=>e.vendaCardPagination.vendasCanceladas.page=i),min:e.vendaCardPagination.vendasCanceladas.min,max:e.vendaCardPagination.vendasCanceladas.max,ellipses:"","max-pages":e.vendaCardPagination.maxPages,class:"float-right",onClick:s.atualizarVendas},null,8,["modelValue","min","max","max-pages","onClick"])])):g("",!0),(m(!0),w(W,null,J(e.vendasCanceladas,i=>(m(),w("div",{key:i.id},[i.tipo==="Venda"?(m(),C(V,{key:0,id:i.id,dadosVenda:i,vendasCompletas:e.vendasCompletas,onExecutar:s.executar,class:"q-mb-md"},null,8,["id","dadosVenda","vendasCompletas","onExecutar"])):g("",!0),i.tipo==="Envelope"?(m(),C(b,{key:1,id:i.id,onExecutar:s.executar,class:"q-mb-md"},null,8,["id","onExecutar"])):g("",!0)]))),128)),e.vendaCardPagination.vendasCanceladas.max>1?(m(),w("div",se,[d(L,{modelValue:e.vendaCardPagination.vendasCanceladas.page,"onUpdate:modelValue":a[8]||(a[8]=i=>e.vendaCardPagination.vendasCanceladas.page=i),min:e.vendaCardPagination.vendasCanceladas.min,max:e.vendaCardPagination.vendasCanceladas.max,ellipses:"","max-pages":e.vendaCardPagination.maxPages,class:"float-right",onClick:s.atualizarVendas},null,8,["modelValue","min","max","max-pages","onClick"])])):g("",!0)]),_:1},8,["label"])):g("",!0)]),_:1})):g("",!0),!e.carregando&&s.temRegistros&&e.tipoLista==="itens"?(m(),C(ka,{key:1,rows:e.documentosItens,columns:e.colunas,pagination:e.tablePagination,"onUpdate:pagination":a[9]||(a[9]=i=>e.tablePagination=i),class:"no-shadow text-left q-mt-md my-sticky-header-column-table"},{body:c(i=>[d(Fa,{props:i},{default:c(()=>[d(R,{key:"descricao",props:i},{default:c(()=>{var I,E,A,G,Q,U,H,r;return[h("div",le,[h("div",de,[d(v,{imagem:(I=e.itens[i.row.idItem])==null?void 0:I.imagem,rotulo:(E=e.itens[i.row.idItem])==null?void 0:E.descricaoConcatenada,tamanho:"40",class:"q-mr-sm"},null,8,["imagem","rotulo"])]),h("div",re,[y(x(i.row.idItem?(A=e.itens[i.row.idItem])==null?void 0:A.descricaoConcatenada:""),1),a[14]||(a[14]=h("br",null,null,-1)),y(" "+x(i.row.idItem&&(G=e.itens[i.row.idItem])!=null&&G.referencia?"Ref. "+((Q=e.itens[i.row.idItem])==null?void 0:Q.referencia):""),1),a[15]||(a[15]=h("br",null,null,-1)),y(" "+x(i.row.idItem&&(U=e.itens[i.row.idItem])!=null&&U.codigoItem?"#"+((H=e.itens[i.row.idItem])==null?void 0:H.codigoItem):""),1),a[16]||(a[16]=h("br",null,null,-1)),y(" "+x(i.row.idItem&&((r=e.itens[i.row.idItem])==null?void 0:r.marca)||""),1)])])]}),_:2},1032,["props"]),d(R,{key:"documento",props:i},{default:c(()=>[y(x(e.documentos[i.row.idDocumento].tipo)+" #"+x(parseInt(e.documentos[i.row.idDocumento].numero)||(e.documentos[i.row.idDocumento].id||"").slice(-6)),1),a[17]||(a[17]=h("br",null,null,-1)),y(" "+x(e.documentos[i.row.idDocumento].status),1),a[18]||(a[18]=h("br",null,null,-1)),y(" "+x(o.$filters.dataHora(e.documentos[i.row.idDocumento].dataHoraFinalizado||e.documentos[i.row.idDocumento].dataHoraEmissao)),1)]),_:2},1032,["props"]),d(R,{key:"valorUnitario",props:i},{default:c(()=>[i.row.valorReal!==i.row.valorItem?(m(),w("span",ce,x(o.$filters.numero(i.row.valorItem,2)),1)):g("",!0),y(" "+x(o.$filters.numero(i.row.valorReal,2)),1)]),_:2},1032,["props"]),d(R,{key:"quantidade",props:i},{default:c(()=>[y(x(i.row.quantidade*i.row.operacaoFator*-1),1)]),_:2},1032,["props"]),d(R,{key:"valorTotal",props:i},{default:c(()=>[y(x(o.$filters.numero(i.row.valorRealTotal,2)),1)]),_:2},1032,["props"]),d(R,{key:"botao",props:i},{default:c(()=>[i.row.operacaoFator===-1?(m(),C(S,{key:0,clickable:"",class:"q-ml-sm",color:"warning",dense:"",flat:"",icon:"replay",round:"",onClick:I=>s.abrirModalDevolucaoGarantia(i.row)},{default:c(()=>[d(_a,null,{default:c(()=>a[19]||(a[19]=[y("Devolu\xE7\xE3o/Garantia")])),_:1})]),_:2},1032,["onClick"])):g("",!0)]),_:2},1032,["props"])]),_:2},1032,["props"])]),_:1},8,["rows","columns","pagination"])):g("",!0),!e.carregando&&!s.temRegistros?(m(),w("div",me,a[20]||(a[20]=[h("p",null,[h("small",null,"Registros n\xE3o encontrados")],-1)]))):g("",!0),(z=e.contato)!=null&&z.ativo?(m(),w("div",ue,[e.sistemaPai==="optisoul"?(m(),C(Ra,{key:0,"vertical-actions-align":"right",round:"",color:"primary",class:"fixed",icon:"add",size:"lg",style:{right:"18px",bottom:"18px"},direction:"up"},{default:c(()=>[d($,{color:"primary",onClick:s.adicionarEnvelope,icon:"mdi-glasses",label:"Envelope"},null,8,["onClick"]),d($,{color:"primary",onClick:s.adicionarVenda,icon:"shopping_cart",label:"Venda"},null,8,["onClick"])]),_:1})):(m(),C(S,{key:1,round:"",color:"primary",class:"fixed",icon:"add",size:"lg",style:{right:"18px",bottom:"18px"},onClick:s.adicionarVenda},null,8,["onClick"]))])):g("",!0),d(_,{ref:"modalVenda",onExecutar:s.executar},null,8,["onExecutar"]),d(P,{ref:"modalEnvelope",onAtualizar:s.atualizar},null,8,["onAtualizar"]),d(q,{ref:"modalDevolucaoGarantia",onExecuta:s.finalizaDevolucaoGarantia},null,8,["onExecuta"]),d(O,{onFechar:s.fechouNFe},null,8,["onFechar"])])}var Fe=ia(ja,[["render",ve]]);export{Fe as default};
