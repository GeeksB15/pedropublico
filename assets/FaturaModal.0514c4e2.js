import{_ as Ta,Y as Ia,p as S,o as P,d as B,f as l,w as f,x as E,B as da,E as ha,e as k,t as x,i as z,bw as Ua,l as M,j,k as va,D as J,v as Ja,az as Na,C as za,N as ka,F as ia,r as Fa,P as sa,R as U,S as la,L as Oa,a4 as Qa,s as Ga,M as Ka,z as Za,bb as Ra,y as Aa,n as Ya,a as Wa,cR as Xa,cS as ao,cT as oo,cU as to,K as io,A as eo,G as no,H as ro,I as so,bm as lo}from"./index.88955961.js";import{D as co,C as uo}from"./DocumentosFiscais.57ca2cce.js";import{e as mo}from"./emitirNFe.35117289.js";import{V as fo}from"./VendaCard.4848a23d.js";import{E as po}from"./EnvelopeCard.6e38c4c1.js";const vo={components:{Avatar:Ia},computed:{mostrarMenuTresPontos(){return this.mostrarOpcaoMigrarFatura}},data(){return{titulo:{},tituloOriginal:{},detalhes:!1,contatos:{},documento:{},fatura:{},faturasAbertas:[],mostrarOpcaoMigrarFatura:!1,visibilidade:{botao:{remover:!1,editar:!1}},modalEditar:{visivel:!1,campos:{valorMulta:0},rules:[]},tema:["TituloCard","bg-white","rounded-borders"]}},emits:["executar"],methods:{irParaAtendimentoFatura(i){this.$router.push({name:"AtendimentoFatura",params:{id:i}})},async migrarFatura(i){try{await new Promise((t,r)=>{this.$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 migrar esta venda para outra fatura.",noRefocus:!0,preventClose:!0,title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{t()}).onCancel(()=>{r()})})}catch{return}if(!i&&this.titulo.idContato&&this.titulo.idEmpresa){const t=await $erp().contato.get(this.titulo.idContato)||{};let r=await $erp().contatoEndereco.where({idContato:this.titulo.idContato}).toArray(),h=await $erp().contatoTelefone.where({idContato:this.titulo.idContato}).toArray();r=r.find(y=>(y.grupo||"").trim().toLowerCase()==="Principal")||r[0]||{},h=h.find(y=>(y.tipoTelefone||"").trim().toLowerCase()==="Principal")||h[0]||{};const a=await $erp().contato.get(this.titulo.idEmpresa)||{};let c=await $erp().contatoEndereco.where({idContato:this.titulo.idEmpresa}).toArray();c=c.find(y=>y.grupo.trim().toLowerCase()==="Principal")||c[0]||{},i=$db.fatura.criar({idEmpresa:a.id,idEmpresaEndereco:c.id||"",descricaoEmpresa:a.nome||"",numeroDocumentoEmpresa:a.numeroDocumentoNacional||"",inscricaoMunicipalEmpresa:a.numeroDocumentoMunicipal||"",optanteSimplesNacional:a.regime==="SimplesNacional"?"1":"0",idContato:t.id,idContatoEndereco:r.id||"",numeroDocumentoContato:t.numeroDocumentoNacional||"",descricaoContato:t.nome||"",descricaoContatoEndereco:"".concat(r.logradouro||"",", ",r.numero||""," ",r.complemento||""," - ",r.bairro||""," - ",r.cep||""," - ",r.municipio||"","/",r.uf||""),telefoneContato:h.telefone||"",emailContato:t.email||"",regimeContato:t.regime||"",observacaoFaturamento:""}),await $db.fatura.grava({fatura:i})}i.id?(await $db.financeiroTitulo.grava({atual:{id:this.titulo.id,idFatura:i.id},original:this.titulo}),localStorage.setItem("idFatura",i.id),this.titulo.idContato&&(this.$emit("executar","atualizar"),this.irParaAtendimentoFatura(this.titulo.idContato))):this.$q.notify("N\xE3o foi poss\xEDvel realizar a opera\xE7\xE3o")},async salvar(){if(this.titulo.valorDesconto===this.tituloOriginal.valorDesconto){this.modalEditar.visivel=!1;return}try{await $db.financeiroTitulo.grava({atual:this.titulo,original:this.tituloOriginal}),this.tituloOriginal=$utils.clonar(this.titulo),this.modalEditar.visivel=!1,this.$q.notifyPositive("T\xEDtulo salvo."),this.$emit("executar","recalcular")}catch{this.$q.notifyPositive("N\xE3o foi poss\xEDvel salvar o t\xEDtulo. Por favor, tente novamente.")}},editar(){const i=Number(this.titulo.diasEmAtraso)||0;let t=0;i>0&&(t=Number(this.titulo.valorMulta)||0),this.modalEditar={visivel:!0,campos:{valorMulta:t},rules:[]}},async permissaoEditar(){return await $db.permissao.objeto("Diretiva_Caixa_DescontoTitulo")},cancelarDesconto(){this.titulo=$utils.clonar(this.tituloOriginal),this.modalEditar.visivel=!1},async desconto(){const i=this.titulo.valorDesconto;let t=0,r=0,h=0,a=Number(this.titulo.diasEmAtraso)||0;if(a<0&&(a=0),a>0&&(r=Number(this.titulo.valorMulta)||0,t=Number(this.titulo.valorJuros)||0,h=$utils.arredondar(r+t*a)),i<0||i>h){this.modalEditar.rules=[()=>"Desconto n\xE3o permitido"];return}this.modalEditar.rules=[()=>!0];const c=Number(this.titulo.valor)||0,y=$utils.arredondar(c-i+r+t*a),o=$utils.arredondar(i*100/(c||1));this.titulo.valorTotal=y,this.titulo.valorARealizar=y,this.titulo.percentualDesconto=o},alternarDetalhes(){this.detalhes=!this.detalhes},async remover(){try{await new Promise((i,t)=>{this.$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 remover este t\xEDtulo da fatura.",noRefocus:!0,preventClose:!0,title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-negative",textColor:"white",flat:!0}}).onOk(()=>{i()}).onCancel(()=>{t()})})}catch{return}this.titulo.idFatura="",await $db.financeiroTitulo.grava({atual:this.titulo,original:this.tituloOriginal}),this.visibilidade.botao.remover=!1,this.$q.notifyPositive("T\xEDtulo removido da fatura."),this.$emit("executar","remover")}},props:{dados:{required:!0,type:Object}},async mounted(){const i=new Date(this.dados.dataVencimento).setHours(0,0,0,0),t=new Date().setHours(0,0,0,0);i<t?this.tema.push("vencido"):this.tema=$lodash.remove(this.tema,h=>h!=="vencido"),this.tituloOriginal=$utils.clonar(this.dados),this.titulo=$utils.clonar(this.dados),this.titulo.documentoId&&(this.documento=await $db.hibrido.le({table:"documento",id:this.titulo.documentoId})),this.visibilidade.botao.remover=!1,this.permissaoEditar().then(h=>this.visibilidade.botao.editar=h&&!this.tituloOriginal.valorRealizado),this.contatos={};const r={};if(this.titulo.idContato){const h=await $db.contato.le({id:this.titulo.idContato});h&&(r[this.titulo.idContato]=h)}if(this.titulo.idEmpresa){const h=await $db.contato.le({id:this.titulo.idEmpresa});h&&(r[this.titulo.idEmpresa]=h)}this.contatos=r,this.mostrarOpcaoMigrarFatura=!0,this.titulo.idFatura&&$db.fatura.leNew({id:this.titulo.idFatura}).then(h=>{this.fatura=h,h.status==="Aberta"&&$db.contato.ler({filtros:{ativo:!0,empresas:!0}}).then(a=>{a.data.find(y=>y.id===this.titulo.idEmpresa)&&(this.visibilidade.botao.remover=!0)})})}},ho={class:"col-12 col-md-6 q-pl-none"},Co=E("br",null,null,-1),go={class:"col-4 col-md"},bo={key:0,class:"q-my-none"},$o={class:"q-my-none"},Fo={class:"q-my-none"},Eo={class:"col-4 col-md text-right"},Do={class:"col-4 col-md text-right"},wo={class:"col-12 col-md"},Po={class:"text-right text-h5 text-positive text-weight-bold q-my-none"},qo={class:"text-right text-weight-normal text-tertiary text-body2 q-my-none"},To={class:"col-6"},yo={class:"text-body2"},xo={class:"col-6 text-right"},_o={class:"col-12 col-md-6"},Mo={class:"text-body2 q-my-none q-mb-md"},Vo={class:"col-12 col-sm-4 col-md-2"},Io={class:"text-left q-my-none"},No={class:"col-6 col-md-1"},zo={class:"text-left q-my-none"},ko={class:"col-6 col-md-1"},Oo={class:"text-left q-my-none"},Ro={class:"col-12 col-sm-4 col-md-2 text-right"},Ao=E("p",{class:"text-subtitle1 text-weight-bold q-ma-none"}," Desconto ",-1),Bo={class:"q-ma-none"},So={class:"q-mt-xs"},Lo=E("small",{class:"block text-caption"},"Multa",-1),jo={class:"q-mt-xs"},Ho=E("small",{class:"block text-caption"},"Juros",-1),Uo={class:"q-mt-lg text-right q-gutter-md"};function Jo(i,t,r,h,a,c){const y=S("avatar"),o=S("row"),C=S("campo");return P(),B("div",{class:Ya([a.tema,"extratoItem bg-white q-pa-sm no-shadow"])},[l(o,{class:"items-center q-mx-none q-px-none q-mb-sm text-tertiary"},{default:f(()=>{var b;return[E("div",ho,[l(da,{class:"q-pa-none"},{default:f(()=>[l(y,{imagem:(a.contatos[a.titulo.idContato]||{}).imagem,rotulo:(a.contatos[a.titulo.idContato]||{}).apelido,tamanho:"30"},null,8,["imagem","rotulo"]),l(ha,null,{default:f(()=>[k(x((a.contatos[a.titulo.idContato]||{}).apelido)+" ",1),Co]),_:1}),a.titulo.parcela?(P(),z(Ua,{key:0,rounded:"",color:"tertiary",small:""},{default:f(()=>[k(x(a.titulo.parcela),1)]),_:1})):M("",!0)]),_:1})]),E("div",go,[a.titulo.documentoCodigo?(P(),B("p",bo,x(a.titulo.documentoTipo)+" #"+x((b=a.documento)==null?void 0:b.numero),1)):M("",!0),E("p",$o,x(a.titulo.formaDePagamento),1),E("p",Fo,x(a.titulo.descricaoPlanoConta),1)]),E("div",Eo,[a.titulo.dataVencimentoOriginal?(P(),z(j,{key:0,name:"mdi-calendar-today"})):M("",!0),k(" "+x(i.$filters.data(a.titulo.dataVencimentoOriginal))+" ",1),l(va,null,{default:f(()=>[k("Vencimento original")]),_:1})]),E("div",Do,[a.titulo.dataVencimento?(P(),z(j,{key:0,name:"mdi-calendar-check"})):M("",!0),k(" "+x(i.$filters.data(a.titulo.dataVencimento))+" ",1),l(va,null,{default:f(()=>[k("Vencimento")]),_:1})]),E("div",wo,[E("p",Po,x(i.$filters.numero(a.titulo.valorTotal,2)),1),E("p",qo,x(i.$filters.numero(a.titulo.valor,2)),1)])]}),_:1}),l(o,{class:"items-center justify-end"},{default:f(()=>[E("div",To,[E("div",yo,x(a.titulo.descricao),1)]),E("div",xo,[l(J,{rounded:"",dense:"",flat:"",icon:`keyboard_arrow_${a.detalhes?"up":"down"}`,color:"tertiary",onClick:c.alternarDetalhes},null,8,["icon","onClick"]),a.visibilidade.botao.editar?(P(),z(J,{key:0,rounded:"",dense:"",flat:"",icon:"edit",color:"primary",onClick:c.editar},null,8,["onClick"])):M("",!0),a.visibilidade.botao.remover?(P(),z(J,{key:1,rounded:"",dense:"",flat:"",icon:"clear",color:"tertiary",onClick:c.remover},{default:f(()=>[l(va,null,{default:f(()=>[k(" Remover da Fatura #"+x(parseInt(a.fatura.numero)||(a.fatura.id||"").slice(-6)),1)]),_:1})]),_:1},8,["onClick"])):M("",!0),Ja(i.$slots,"default"),c.mostrarMenuTresPontos?(P(),z(J,{key:2,rounded:"",dense:"",flat:"",icon:"more_vert",color:"tertiary"},{default:f(()=>[l(Na,null,{default:f(()=>[za((P(),z(ka,{link:"",separator:""},{default:f(()=>[a.mostrarOpcaoMigrarFatura?(P(),B(ia,{key:0},[(P(!0),B(ia,null,Fa(a.faturasAbertas,b=>(P(),z(sa,{clickable:"",key:b.id,onClick:T=>c.migrarFatura(b)},{default:f(()=>[l(U,{avatar:""},{default:f(()=>[l(j,{name:"mdi-folder-move"})]),_:1}),l(U,null,{default:f(()=>[l(la,null,{default:f(()=>[k(x("Migrar para fatura #"+(b.numero||b.id.slice(-6))),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),l(sa,{clickable:"",onClick:t[0]||(t[0]=b=>c.migrarFatura())},{default:f(()=>[l(U,{avatar:""},{default:f(()=>[l(j,{name:"mdi-folder-move"})]),_:1}),l(U,null,{default:f(()=>[l(la,null,{default:f(()=>[k("Migrar para nova fatura")]),_:1})]),_:1})]),_:1})],64)):M("",!0)]),_:1})),[[Oa]])]),_:1})]),_:1})):M("",!0)])]),_:3}),a.detalhes?(P(),z(Qa,{key:0,class:"hideondesktop q-my-sm"})):M("",!0),a.detalhes?(P(),z(o,{key:1,class:"items-start q-mx-none q-px-none q-mt-md"},{default:f(()=>[E("div",_o,[l(da,{class:"u-autoHeight q-pa-none",color:"none",dark:""},{default:f(()=>[l(j,{name:"business"}),l(ha,null,{default:f(()=>[k(x((a.contatos[a.titulo.idEmpresa]||{}).apelido),1)]),_:1})]),_:1}),E("p",Mo,x(a.titulo.observacao),1)]),E("div",Vo,[E("p",Io,x(a.titulo.descricaoCentroCusto),1)]),E("div",No,[E("p",zo,[a.titulo.dataEmissao?(P(),z(j,{key:0,name:"mdi-calendar-check"})):M("",!0),k(" "+x(i.$filters.data(a.titulo.dataEmissao))+" ",1),l(va,null,{default:f(()=>[k("Emiss\xE3o")]),_:1})])]),E("div",ko,[E("p",Oo,[a.titulo.dataCompetencia?(P(),z(j,{key:0,name:"mdi-calendar-check"})):M("",!0),k(" "+x(i.$filters.data(a.titulo.dataCompetencia))+" ",1),l(va,null,{default:f(()=>[k("Compet\xEAncia")]),_:1})])]),E("div",Ro,[Ao,E("p",Bo,x(i.$filters.numero(a.titulo.valorDesconto||0,2)),1),a.titulo.diasEmAtraso?(P(),B(ia,{key:0},[E("div",So,[Lo,E("strong",null,x(i.$filters.numero(a.titulo.valorMulta||0,2))+" ("+x(i.$filters.numero(a.titulo.percentualMulta||0,2))+"%) ",1)]),E("div",jo,[Ho,E("strong",null,x(i.$filters.numero(a.titulo.valorTotalJuros||0,2))+" ("+x(i.$filters.numero(a.titulo.percentualJuros||0,2))+"% dia) ",1)])],64)):M("",!0)])]),_:1})):M("",!0),l(Aa,{modelValue:a.modalEditar.visivel,"onUpdate:modelValue":t[7]||(t[7]=b=>a.modalEditar.visivel=b),onKeyup:Ra(c.cancelarDesconto,["esc"]),persistent:""},{default:f(()=>[l(Ga,{style:{"min-width":"30vw"}},{default:f(()=>[l(da,{class:"bg-primary text-white"},{default:f(()=>[l(ha,null,{default:f(()=>[k("Editar T\xEDtulo")]),_:1})]),_:1}),l(Ka,null,{default:f(()=>[l(Za,{onSubmit:c.salvar,class:"q-pa-lg q-gutter-md"},{default:f(()=>[l(C,{modelValue:a.titulo.valor,"onUpdate:modelValue":t[1]||(t[1]=b=>a.titulo.valor=b),rotulo:"Valor",tipo:"decimal",decimals:"2","somente-leitura":"",outlined:""},null,8,["modelValue"]),l(C,{modelValue:a.titulo.diasEmAtraso,"onUpdate:modelValue":t[2]||(t[2]=b=>a.titulo.diasEmAtraso=b),rotulo:"Dias em Atraso",tipo:"decimal",decimals:"0",zerosDireita:"0",zeros:"","somente-leitura":"",outlined:""},null,8,["modelValue"]),l(C,{modelValue:a.modalEditar.campos.valorMulta,"onUpdate:modelValue":t[3]||(t[3]=b=>a.modalEditar.campos.valorMulta=b),ajuda:`Multa de R$ ${i.$filters.numero(a.titulo.valorMulta,2)}`,rotulo:"Multa",tipo:"decimal",decimals:"2","somente-leitura":"",outlined:""},null,8,["modelValue","ajuda"]),l(C,{modelValue:a.titulo.valorTotalJuros,"onUpdate:modelValue":t[4]||(t[4]=b=>a.titulo.valorTotalJuros=b),ajuda:`Juros ao ${a.titulo.tipoJuros} de R$ ${i.$filters.numero(a.titulo.valorJuros,2)}`,rotulo:"Juros",tipo:"decimal",decimals:"2","somente-leitura":"",outlined:""},null,8,["modelValue","ajuda"]),l(C,{modelValue:a.titulo.valorDesconto,"onUpdate:modelValue":[t[5]||(t[5]=b=>a.titulo.valorDesconto=b),c.desconto],rotulo:"Desconto",tipo:"decimal",decimals:"2",rules:a.modalEditar.rules,outlined:""},null,8,["modelValue","onUpdate:modelValue","rules"]),l(C,{modelValue:a.titulo.valorTotal,"onUpdate:modelValue":t[6]||(t[6]=b=>a.titulo.valorTotal=b),rotulo:"Total",tipo:"decimal",decimals:"2","somente-leitura":"",outlined:""},null,8,["modelValue"]),E("div",Uo,[l(J,{color:"tertiary",flat:"",unelevated:"",label:"Cancelar",onClick:c.cancelarDesconto},null,8,["onClick"]),l(J,{color:"primary",unelevated:"",label:"Salvar",type:"submit"})])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue","onKeyup"])],2)}var Qo=Ta(vo,[["render",Jo]]),Go={async enviar(i,t){var r,h;try{const a=t.nome.replace("enviaemail.fatura.",""),c=(r=t.valor)!=null?r:"Impresso",y=(h=t.texto)!=null?h:`Voc\xEA est\xE1 recebendo o ${c} da empresa ${i.descricaoEmpresa}.`,o=await $db.contato.le({id:i.idContato}),C=await $utils.impressaoObterHtml(a,i),b={de:"Geeks Solu\xE7\xF5es <auto@geekssolucoes.com.br>",para:String(o==null?void 0:o.email).trim().toLowerCase(),assunto:`${c}`,mensagem:`${y}`},T=`${c} enviado para ${b.para}, com sucesso!.`,O=`Erro ao enviar e-mail. ${c} n\xE3o enviado.`;$q.loading.show({message:`Enviando ${c} por e-mail...`,html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"});const V=[{name:`${c}.pdf`,content:C,method:"html2pdf"}],A={host:"smtp.gmail.com",port:587,ssl:!0,auth:{user:"auto@geekssolucoes.com.br",pass:"xpto@9@9"},from:b.de,to:b.para,subject:b.assunto,text:b.mensagem,attachments:V},d=await Wa({baseURL:"https://api.b15.com.br",method:"post",url:"/email/v2",data:A});$q.notifyPositive((d==null?void 0:d.status)===200&&T?T:d.data.message)}catch(a){$q.notifyError(errorMsg||"Erro ao enviar e-mail",a)}finally{$q.loading.hide()}}},Ko={async finalizar(i,t){var r,h,a,c,y;try{if($utils.verificarErro(this.erroCalculo,"Erro de c\xE1lculo encontrado."),!i)try{await new Promise((e,n)=>{$q.dialog({cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},message:"Esta a\xE7\xE3o ir\xE1 finalizar esta fatura",ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0},title:"Tem certeza?"}).onOk(()=>{e()}).onCancel(()=>{n()})})}catch{return!1}this.$q.loading.show({message:"Processando..."});const o=$utils.clonar(this.fatura),C=$utils.clonar(this.vendas),b=$utils.clonar(this.documentosEnvelope),T=$utils.clonar(this.carnes),O=[...C,...b].map(e=>e.id),V=await $db.hibrido.lista({table:"documentoItem",whereIn:{idDocumento:O}}),A=$utils.clonar(V);if(T.length>0){const e=T.reduce((n,g)=>(g.idFinanceiroBoleto&&g.codigoFinanceiroTitulo&&(n+=String(g.codigoFinanceiroTitulo)+";"),n),"");if(e)try{$q.loading.show({message:"Baixando boletos..."});const n=`exec sp_Financeiro_BoletoBaixar '${e.slice(0,-1)}'`,g=await $utils.executarSql(n)}catch(n){$q.notifyError("N\xE3o foi poss\xEDvel baixar boletos",n);return}finally{$q.loading.hide()}}const d=i?o.dataHoraFinalizado:$utils.dataAtual(),q=d,s=await $db.hibrido.le({table:"documento",id:this.$refs.faturamento.idDocumentoCaixa}),p=await $db.formaPagamento.le();this.documentoStatus=[],await this.$refs.faturamento.validar();let u=$lodash.orderBy(this.$refs.faturamento.condicaoPagamento.filter(e=>e.valor),["idFormaPagamento","autorizacao","dataVencimento"]);$utils.verificarErro(C.some(e=>!e.dataHoraFinalizado),"Existe pedido de venda sem data de finaliza\xE7\xE3o.");const I=$utils.arredondar(this.carnes.reduce((e,n)=>e+(n.valorARealizar||0),0)),R=$utils.arredondar(u.reduce((e,n)=>e+(n.valor||0),0));let ea=0;if(i&&(u=u.filter(e=>!this.$refs.faturamento.condicaoPagamentoOriginal.find(n=>n.id===e.id))),o.totalDocumento>=0){if(this.carnes.length){if(R<I)return this.$q.notify("Valor pago menor que a soma dos t\xEDtulos \xE0 faturar!"),!1;if(!await $db.permissao.objeto("Diretiva_Caixa_PagarCarneCartao")){const n=u.reduce((g,F)=>{const D=`${F.autorizacao||""}${F.documento||""}${F.idFormaPagamento}`;return g[D]||(g[D]={parcelas:0,formaPagamento:F.formaPagamento}),g[D].parcelas++,g},{});for(const g in n)if(n[g].parcelas>this.carnes.length)return this.$q.notify(`Quantidade de parcelas da forma de pagamento ${n[g].formaPagamento} acima do permitido.`),!1}}R<o.totalDocumento&&(ea=1)}let oa=ea===1?"Aguardando Pagamento":"Finalizada";if(!i){this.documentoStatus.push({id:$utils.uuid(),idDocumento:o.id,operacao:"Fatura",statusOriginal:o.status,statusFinalizado:oa,dataHoraEmissao:d,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:s.id||""}),o.status=oa,o.dataHoraFinalizado=d,oa="Faturado";const e=parseInt(await $db.configuracoes.leValorComFiltroEmpresa("vendas.usaExpedicao",o.idEmpresa,0))||0;let n=0,g=b.filter(m=>m.status!=="Entregue").length,F=!1,D=!0;if(C.length>0&&e&&(this.$q.loading.hide(),await new Promise((m,$)=>{this.$q.dialog({cancel:{label:"N\xE3o",push:!0,color:"tertiary",flat:!0},ok:{label:"Sim",push:!0,class:"bg-primary",textColor:"white",flat:!0},message:"Gostaria de dar baixa na(s) venda(s), removendo-a(s) do processo de expedi\xE7\xE3o?",noRefocus:!0,preventClose:!0,persistent:!0,title:"Confirma?"}).onOk(()=>{D=!0,m()}).onCancel(()=>{D=!1,m()})}),this.$q.loading.show({message:"Processando..."})),g){let m="Nesta Fatura h\xE1 1 envelope aguardando entrega, deseja mudar o status deste para Entregue?";g>1&&(m=`Nesta Fatura h\xE1 ${g} envelopes aguardando entrega, deseja mudar o status destes para Entregue?`),this.$q.loading.hide();try{await new Promise(($,w)=>{this.$q.dialog({cancel:"N\xE3o",message:m,noRefocus:!0,ok:"Sim",preventClose:!0,title:"Confirma?"}).onOk(()=>{F=!0,$()}).onCancel(()=>{w()})})}catch{}this.$q.loading.show({message:"Processando..."})}let v=0;v=$utils.arredondar(A.reduce((m,$)=>($.total>0&&(m+=$.total),m),v));for(const m of[...C,...b])m.tipo==="Envelope"&&F&&(this.documentoStatus.push({id:$utils.uuid(),idDocumento:m.id,operacao:m.operacao,statusOriginal:m.status,statusFinalizado:"Entregue",dataHoraEmissao:d,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}),m.status="Entregue"),m.tipo==="Venda"&&D&&(this.documentoStatus.push({id:$utils.uuid(),idDocumento:m.id,operacao:m.operacao,statusOriginal:m.status,statusFinalizado:oa,dataHoraEmissao:d,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:s.id||""}),m.status="Faturado");for(const m of A){const $=[...C,...b].find(w=>w.id===m.idDocumento);if(m.status=$.status,m.total>0){m.quantidade=m.quantidade||1,m.valorItem=m.valorItem||0,m.descontoItem=m.descontoItem||0,m.descontoTotalRateado=m.descontoTotalRateado||0;let w=(m.valorItem-m.descontoItem)*m.quantidade-m.descontoTotalRateado;const _=$utils.arredondar((o.totalDesconto||0)*w/(v||1)||0);m.descontoFaturaRateado=$utils.arredondar(_),m.valorRealTotal=$utils.arredondar(w-_),m.valorReal=$utils.arredondar(m.valorRealTotal/m.quantidade),n+=_}}if(this.documentosItem=A,this.documentosItemOriginal=V,o.totalDesconto!==$utils.arredondar(n)){const m=$utils.arredondar((o.totalDesconto||0)-(n||0));let $,w=0;for(const _ of A)_.total>w&&(w=_.total,$=_);if($){const _=($.descontoFaturaRateado||0)+(m||0),Q=(($.valorItem||0)-($.descontoItem||0))*($.quantidade||1)-($.descontoTotalRateado||0)-(_||0),na=(Q||0)/($.quantidade||1);$.descontoFaturaRateado=$utils.arredondar(_),$.valorReal=$utils.arredondar(na),$.valorRealTotal=$utils.arredondar(Q)}}}const Ea=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.renegociacao"}))[0].valor),X=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ea}),ca=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.duplicatareceber"}))[0].valor);let K=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:ca});const Ca=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.duplicatapagar"}))[0].valor),Z=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ca}),ua=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.cheque"}))[0].valor),ma=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:ua}),Da=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.faturamentogeral"}))[0].valor),L=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Da}),Ba=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.comprageral"}))[0].valor),ya=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ba}),Sa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.frete"}))[0].valor),xa=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Sa}),La=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.cmv"}))[0].valor),ga=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:La}),ja=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.creditoclientes"}))[0].valor),Ha=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:ja}),wa=(r=this.contatos[o.idContato])==null?void 0:r.descontoCondicionadoPercentual;let ta=C.reduce((e,n)=>e+n.totalDocumento,0);ta=ta+b.reduce((e,n)=>e+n.totalDocumento,0),ta=$utils.arredondar(ta-o.totalDesconto);let aa=o.totalDocumento,G=[];const N=[],_a=[],ba=[],Ma=[];let fa=1,Pa="",$a=1,Y="";for(const e of u.filter(n=>!n.sinal)){e.sinal=e.sinal||ea;const n=p.filter(g=>g.id===e.idFormaPagamento)[0];if(aa<0)Y=$utils.uuid(),N.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:Y,idContato:o.idContato,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:L.id,dataEmissao:d,valorCredito:0,valorDebito:$utils.arredondar(aa*-1),descricao:L.descricao,observacao:`Movimenta\xE7\xE3o de d\xE9bito da devolu\xE7\xE3o de clientes no(s) pedido(s) da fatura c\xF3digo (${o.id})`,automatico:0,liquidando:0,dataCompetencia:q,dataVencimento:e.dataVencimento,dataMovimento:e.dataVencimento,documentoTipo:"Fatura",documentoId:o.id,idDocumentoCaixa:s.id}),N.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:Y,idContato:o.idContato,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:Ha.id,dataEmissao:d,valorCredito:$utils.arredondar(aa*-1),valorDebito:0,descricao:`Cr\xE9dito proveniente de produtos devolvidos no(s) pedido(s) da fatura c\xF3digo (${o.id})`,observacao:"Movimenta\xE7\xE3o de cr\xE9dito na conta de clientes",automatico:0,liquidando:0,dataCompetencia:q,dataVencimento:e.dataVencimento,dataMovimento:e.dataVencimento,documentoTipo:"Fatura",documentoId:o.id,idDocumentoCaixa:s.id});else{if(Pa!==e.idFormaPagamento+e.autorizacao&&(Pa=e.idFormaPagamento+e.autorizacao,fa=1,$a=u.reduce((g,F)=>F.idFormaPagamento+F.autorizacao===Pa?g+1:g,0)),n.tipoFinanceiro==="T\xEDtulo Liquidado"&&(Y=$utils.uuid()),I>0){const g=$utils.uuid(),F=$utils.arredondar(e.valor*(I/aa));let D=0,v=0,m=0,$=0;if(n.tipo===5){let w=(await $erp().financeiroBanco.toArray()).find(_=>_.codigoBanco===122);w&&(v=w.percentualMulta||0,$=w.percentualJuros||0,D=$utils.arredondar(v/100*F),m=$utils.arredondar($/100*F))}G.push({id:g,idFinanceiroPlanoConta:X.id,idContato:o.idContato,dataEmissao:d,dataCompetencia:q,dataVencimento:e.dataVencimento,dataVencimentoOriginal:e.dataVencimento,valor:F,valorTotal:F,valorARealizar:F,valorMulta:D,percentualMulta:v,valorJuros:m,percentualJuros:$,documentoId:o.id,documentoTipo:"Fatura",parcela:fa+"/"+$a,descricao:"Fatura de Venda Mercadoria",observacao:`${this.$refs.faturamento.observacaoFaturamento||""} ${e.observacao||""}`.trim(),documentoVinculado:1,receberPagar:1,valorDesconto:0,percentualDesconto:0,idEmpresa:o.idEmpresa,formaDePagamento:n.descricao,carne:n.tipo===5?1:0,dataEmissaoCarne:n.tipo===5?d:"",idDocumentoCaixa:s.id,idFinanceiroMovimentacaoAgrupamento:n.tipoFinanceiro==="T\xEDtulo Liquidado"?Y:""}),e.idFinanceiroTitulo=g,n.tipo===2&&ba.push({idTitulo:g,idDocumentoCondicaoPagamento:e.id,valor:F,dataVencimento:e.dataVencimento,idBanco:e.idBanco,agencia:e.agencia,conta:e.conta,numeroCheque:e.numeroCheque,formaPagamento:n}),Ma.push({idTitulo:g,valor:F,desconto:0})}if(ta>0){const g=$utils.uuid(),F=$utils.arredondar(e.valor*(ta/aa));let D=0,v=0,m=0,$=0;if(n.tipo===5){let w=(await $erp().financeiroBanco.toArray()).find(_=>_.codigoBanco===122);w&&(v=w.percentualMulta||0,$=w.percentualJuros||0,D=$utils.arredondar(v/100*F),m=$utils.arredondar($/100*F))}G.push({id:g,idFinanceiroPlanoConta:L.id,idContato:o.idContato,dataEmissao:d,dataCompetencia:q,dataVencimento:e.dataVencimento,dataVencimentoOriginal:e.dataVencimento,valor:F,valorTotal:F,valorARealizar:F,valorMulta:D,percentualMulta:v,valorJuros:m,percentualJuros:$,documentoId:o.id,documentoTipo:"Fatura",parcela:fa+"/"+$a,descricao:"Fatura de Venda Mercadoria",observacao:`${this.$refs.faturamento.observacaoFaturamento||""} ${e.observacao||""}`.trim(),documentoVinculado:1,receberPagar:1,valorDesconto:0,percentualDesconto:0,idEmpresa:o.idEmpresa,formaDePagamento:n.descricao,carne:n.tipo===5?1:0,dataEmissaoCarne:n.tipo===5?d:"",idDocumentoCaixa:s.id,idFinanceiroMovimentacaoAgrupamento:n.tipoFinanceiro==="T\xEDtulo Liquidado"?Y:"",descontoCondicionadoValor:wa>0?wa/100*F:0,descontoCondicionadoPercentual:wa}),e.idFinanceiroTitulo=g,n.tipo===2&&ba.push({idTitulo:g,idDocumentoCondicaoPagamento:e.id,valor:F,dataVencimento:e.dataVencimento,idBanco:e.idBanco,agencia:e.agencia,conta:e.conta,numeroCheque:e.numeroCheque,formaPagamento:n})}if(n.tipoFinanceiro==="T\xEDtulo Liquidado"&&ta>=0){N.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:Y,idEmpresa:o.idEmpresa,idContato:o.idContato,idFinanceiroPlanoConta:K.id,idFinanceiroTitulo:e.idFinanceiroTitulo,dataEmissao:d,valorCredito:e.valor,valorDebito:0,descricao:K.descricao,observacao:`Liquida\xE7\xE3o referente t\xEDtulo fatura (${o.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:q,dataVencimento:e.dataVencimento,dataMovimento:e.dataVencimento,documentoTipo:"Fatura",documentoId:o.id,idDocumentoCaixa:s.id});let g=n.idFinanceiroPlanoConta;n.tipo===1&&(s||{}).idFinanceiroPlanoContaCaixa&&(g=s.idFinanceiroPlanoContaCaixa);let F=await $db.financeiroPlanoConta.le({id:g});N.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:Y,idEmpresa:o.idEmpresa,idContato:o.idContato,idFinanceiroPlanoConta:F.id,idFinanceiroTitulo:e.idFinanceiroTitulo,dataEmissao:d,valorCredito:0,valorDebito:e.valor,descricao:F.descricao,observacao:`Liquida\xE7\xE3o referente t\xEDtulo fatura (${o.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:q,dataVencimento:e.dataVencimento,dataMovimento:e.dataVencimento,documentoTipo:"Fatura",documentoId:o.id,idDocumentoCaixa:s.id});for(const D of G)D.idFinanceiroMovimentacaoAgrupamento===Y&&(D.valorRealizado=D.valorARealizar,D.dataPagamento=e.dataVencimento,D.dataMovimento=e.dataVencimento,D.idDocumentoCaixaLiquidacao=s.id)}if(n.aliquota){const g=$utils.uuid(),F=$utils.arredondar(e.valor*(n.aliquota/100));if(G.push({id:g,idFinanceiroPlanoConta:n.idFinanceiroPlanoContaAliquota,idContato:n.idContatoOperadoraCartao,dataEmissao:d,dataCompetencia:q,dataVencimento:e.dataVencimento,dataVencimentoOriginal:e.dataVencimento,valor:F,valorTotal:F,valorARealizar:F,valorMulta:0,percentualJuros:0,documentoId:o.id,documentoTipo:"Fatura",parcela:fa+"/"+$a,descricao:`T\xEDtulo referente a al\xEDquota da forma de pagamento: ${n.descricao}`,observacao:`T\xEDtulo referente a al\xEDquota. ${this.$refs.faturamento.observacaoFaturamento||""} ${e.observacao||""}`.trim(),documentoVinculado:1,receberPagar:0,valorDesconto:0,percentualDesconto:0,idEmpresa:o.idEmpresa,formaDePagamento:n.descricao,idDocumentoCaixa:s.id}),e.idFinanceiroTituloPagar=g,n.tipoFinanceiro==="T\xEDtulo Liquidado"){const D=$utils.uuid();N.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:D,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:Z.id,dataEmissao:d,valorCredito:0,valorDebito:F,descricao:Z.descricao,observacao:`Liquida\xE7\xE3o al\xEDquota cart\xE3o referente fatura (${o.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:q,dataVencimento:e.dataVencimento,dataMovimento:e.dataVencimento,documentoTipo:"Fatura",documentoId:o.id,idFinanceiroTitulo:g,idContato:n.idContatoOperadoraCartao,idDocumentoCaixa:s.id});let v=n.idFinanceiroPlanoConta;n.tipo===1&&(s||{}).idFinanceiroPlanoContaCaixa&&(v=s.idFinanceiroPlanoContaCaixa);let m=await $db.financeiroPlanoConta.le({id:v});N.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:D,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:m.id,dataEmissao:d,valorCredito:F,valorDebito:0,descricao:m.descricao,observacao:`Liquida\xE7\xE3o al\xEDquota cart\xE3o referente fatura (${o.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:q,dataVencimento:e.dataVencimento,dataMovimento:e.dataVencimento,documentoTipo:"Fatura",documentoId:o.id,idFinanceiroTitulo:g,idContato:n.idContatoOperadoraCartao,idDocumentoCaixa:s.id});for(const $ of G)$.id===g&&($.idFinanceiroMovimentacaoAgrupamento=D,$.valorRealizado=F,$.dataPagamento=e.dataVencimento,$.dataMovimento=e.dataVencimento,$.idDocumentoCaixaLiquidacao=s.id)}}fa++}}const Va=[];for(const e of ba){const n=$utils.uuid(),g=$utils.uuid();for(const D of G)D.id===e.idTitulo&&(D.idFinanceiroMovimentacaoAgrupamento=g,D.valorRealizado=D.valorARealizar,D.dataPagamento=d,D.dataMovimento=d,D.dataVencimento=d,D.dataVencimentoOriginal=d,D.idDocumentoCaixaLiquidacao=s.id);if(Va.includes(e.idDocumentoCondicaoPagamento))continue;Va.push(e.idDocumentoCondicaoPagamento);const F=$utils.arredondar(ba.reduce((D,v)=>v.idDocumentoCondicaoPagamento===e.idDocumentoCondicaoPagamento?D+(v.valor||0):D,0));G.push({id:n,idFinanceiroPlanoConta:ma.id,idContato:o.idContato,dataEmissao:d,dataCompetencia:q,dataVencimento:e.dataVencimento,dataVencimentoOriginal:e.dataVencimento,valor:F,valorTotal:F,valorARealizar:F,valorMulta:0,percentualJuros:0,receberPagar:1,valorDesconto:0,percentualDesconto:0,documentoId:o.id,documentoTipo:"Fatura",idEmpresa:o.idEmpresa,formaDePagamento:e.formaPagamento.descricao,idDocumentoCaixa:s.id,cheque:1,idBanco:e.idBanco,agencia:e.agencia,conta:e.conta,numeroCheque:e.numeroCheque,observacao:`Liquida\xE7\xE3o de Cheques da Fatura #${o.id} - C\xF3digoN #${g}`,descricao:"Cheque"}),N.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:g,idEmpresa:o.idEmpresa,idContato:o.idContato,idFinanceiroPlanoConta:ma.id,idFinanceiroTitulo:n,dataEmissao:d,valorCredito:0,valorDebito:F,descricao:"Cheque - Cr\xE9dito de t\xEDtulos a receber",observacao:"Cr\xE9dito de t\xEDtulos a receber",automatico:0,liquidando:0,dataCompetencia:q,dataVencimento:d,dataMovimento:d,idFinanceiroCheque:n,idDocumentoCaixa:s.id,documentoId:o.id}),N.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:g,idEmpresa:o.idEmpresa,idContato:o.idContato,idFinanceiroPlanoConta:K.id,idFinanceiroTitulo:n,dataEmissao:d,valorCredito:F,valorDebito:0,descricao:K.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica",automatico:0,liquidando:0,dataCompetencia:q,dataVencimento:d,dataMovimento:d,idFinanceiroCheque:n,idDocumentoCaixa:s.id,documentoId:o.id})}if(I>0){const e=$utils.uuid();N.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:o.idEmpresa,idContato:o.idContato,idFinanceiroPlanoConta:K.id,dataEmissao:d,valorCredito:I,valorDebito:0,descricao:K.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica",automatico:1,liquidando:0,dataCompetencia:q,dataVencimento:d,dataMovimento:d,idDocumentoCaixa:s.id}),N.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:o.idEmpresa,idContato:o.idContato,idFinanceiroPlanoConta:X.id,dataEmissao:d,valorCredito:0,valorDebito:I,descricao:X.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica - Complemento",automatico:0,liquidando:0,dataCompetencia:q,dataVencimento:d,dataMovimento:d,documentoTipo:"Renegocia\xE7\xE3o",documentoId:e,idDocumentoCaixa:s.id});for(const n of Ma)_a.push({idFinanceiroMovimentacaoN:e,idFinanceiroTitulo:n.idTitulo,dataVencimento:d,valorOriginal:n.valor,valorDesconto:n.desconto,valorTotal:$utils.arredondar(n.valor-n.desconto)});for(const n of T){if(n.idFinanceiroMovimentacaoAgrupamento=e,n.idDocumentoCaixaLiquidacao=s.id,n.dataPagamento=d,n.dataMovimento=d,n.renegociado=1,n.cheque===1){n.valorRealizado=n.valor;continue}if(!n.valorARealizar){n.valorRealizado=n.valorTotal;continue}n.valorRealizado=n.valorARealizar}G=G.concat(T)}if(ea===0){let e=$utils.uuid();const n=o.valorFrete||0;let g=0,F=0;const D=[];if(n>0&&(N.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:L.id,dataEmissao:d,valorCredito:0,valorDebito:n,descricao:L.descricao,observacao:`Lan\xE7amento frete da fatura (${o.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:q,dataVencimento:d,dataMovimento:d,documentoTipo:"Fatura",documentoId:o.id,idDocumentoCaixa:s.id}),N.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:xa.id,dataEmissao:d,valorCredito:n,valorDebito:0,descricao:xa.descricao,observacao:`Lan\xE7amento frete da fatura (${o.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:q,dataVencimento:d,dataMovimento:d,documentoTipo:"Fatura",documentoId:o.id,idDocumentoCaixa:s.id})),!i){e=$utils.uuid();for(const v of A){let m="",$={},w="",_={},Q="",na={};const ra=await $db.item.leNew({id:v.idItem});if(m=v.idPlanoContaEstoque,!m){const H=await $db.perfilContabilItem.le({idPerfilContabil:ra.idPerfilContabil,idCfop:v.idCfop,and:{idPerfilContabil:ra.idPerfilContabil,idCfop:v.idCfop}});H.length&&H[0].idPlanoContaEstoque&&(m=H[0].idPlanoContaEstoque)}if(!m&&ya.id&&(m=ya.id),!m&&v.idCfop&&(m=(await $db.cfop.le({id:v.idCfop})).idPlanoContaEstoque),$=await $db.financeiroPlanoConta.le({id:m}),!$.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Estoque.");return}if(w="",!w){const H=await $db.perfilContabilItem.le({idPerfilContabil:ra.idPerfilContabil,idCfop:v.idCfop,and:{idPerfilContabil:ra.idPerfilContabil,idCfop:v.idCfop}});H.length&&H[0].idPlanoContaDespesa&&(w=H[0].idPlanoContaDespesa)}if(!w&&ga.id&&(w=ga.id),!w&&v.idCfop&&(w=(await $db.cfop.le({id:v.idCfop})).idPlanoContaDestino),_=await $db.financeiroPlanoConta.le({id:w}),!_.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Despesa.");return}const qa=$utils.arredondar(v.total-(v.descontoTotalRateado||0)-(v.descontoFaturaRateado||0)),pa=$utils.arredondar(v.valorCustoMedio*v.quantidade);if(pa){if(v.operacaoFator<0?(N.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:$.id,dataEmissao:v.dataHoraFinalizado||d,valorCredito:pa,valorDebito:0,descricao:$.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${o.id}) e item (${v.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:q,dataVencimento:d,dataMovimento:d,documentoTipo:o.tipo,documentoId:o.id,idDocumentoCaixa:s.id}),N.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:_.id,dataEmissao:v.dataHoraFinalizado||d,valorCredito:0,valorDebito:pa,descricao:_.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${o.id}) e item (${v.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:q,dataVencimento:d,dataMovimento:d,documentoTipo:o.tipo,documentoId:o.id,idDocumentoCaixa:s.id})):(N.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:$.id,dataEmissao:v.dataHoraFinalizado||d,valorCredito:0,valorDebito:pa,descricao:$.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${o.id}) e item (${v.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:q,dataVencimento:d,dataMovimento:d,documentoTipo:o.tipo,documentoId:o.id,idDocumentoCaixa:s.id}),N.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:_.id,dataEmissao:v.dataHoraFinalizado||d,valorCredito:pa,valorDebito:0,descricao:_.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${o.id}) e item (${v.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:q,dataVencimento:d,dataMovimento:d,documentoTipo:o.tipo,documentoId:o.id,idDocumentoCaixa:s.id})),Q=v.idPlanoContaDestino,!Q){const W=await $db.perfilContabilItem.le({idPerfilContabil:ra.idPerfilContabil,idCfop:v.idCfop,and:{idPerfilContabil:ra.idPerfilContabil,idCfop:v.idCfop}});W.length&&W[0].idPlanoContaDespesa&&(Q=W[0].idPlanoContaDespesa)}if(!Q&&ga.id&&(Q=ga.id),!Q&&v.idCfop&&(Q=(await $db.cfop.le({id:v.idCfop})).idPlanoContaDestino),na=await $db.financeiroPlanoConta.le({id:Q}),!na.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Receita.");return}let H=!0;for(const W of D)if(W.idPlanoContaDestino===na.id&&W.idPlanoContaEstoque===$.id){W.valor=$utils.arredondar(W.valor+qa),H=!1;break}H&&D.push({idPlanoContaDestino:na.id,idPlanoContaEstoque:$.id,valor:qa}),g+=qa}}for(const v of D)v.valor<0&&(F+=v.valor);for(const v of D)if(v.valor>0){const m=await $db.financeiroPlanoConta.le({id:v.idPlanoContaDestino}),$=$utils.arredondar(F*(v.valor/(g||1)));if($>0){N.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:L.id,dataEmissao:d,valorCredito:0,valorDebito:$,descricao:L.descricao,observacao:`Lan\xE7amento entrada faturamento geral da devolu\xE7\xE3o referente fatura (${o.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:q,dataVencimento:d,dataMovimento:d,documentoTipo:"Fatura",documentoId:o.id,idDocumentoCaixa:s.id}),N.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:m.id,dataEmissao:d,valorCredito:$,valorDebito:0,descricao:m.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de destino referente fatura (${o.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:q,dataVencimento:d,dataMovimento:d,documentoTipo:"Fatura",documentoId:o.id,idDocumentoCaixa:s.id});for(const w of u)N.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:L.id,dataEmissao:d,valorCredito:0,valorDebito:$utils.arredondar((v.valor-$)*(w.valor/(aa||1))),descricao:L.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de faturamento geral referente fatura (${o.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:q,dataVencimento:w.dataVencimento,dataMovimento:w.dataVencimento,documentoTipo:"Fatura",documentoId:o.id,idDocumentoCaixa:s.id}),N.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:m.id,dataEmissao:d,valorCredito:$utils.arredondar((v.valor-$)*(w.valor/(aa||1))),valorDebito:0,descricao:m.descricao,observacao:`Lan\xE7amento entrada na conta de venda do produto referente fatura (${o.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:q,dataVencimento:w.dataVencimento,dataMovimento:w.dataVencimento,documentoTipo:"Fatura",documentoId:o.id,idDocumentoCaixa:s.id})}else for(const w of u){const _=$utils.arredondar(v.valor*(w.valor/(aa||1)));N.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:L.id,dataEmissao:d,valorCredito:0,valorDebito:_,descricao:L.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de faturamento geral referente fatura (${o.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:q,dataVencimento:w.dataVencimento,dataMovimento:w.dataVencimento,documentoTipo:"Fatura",documentoId:o.id,idDocumentoCaixa:s.id}),N.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:e,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:m.id,dataEmissao:d,valorCredito:_,valorDebito:0,descricao:m.descricao,observacao:`Lan\xE7amento entrada na conta de venda do produto referente fatura (${o.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:q,dataVencimento:w.dataVencimento,dataMovimento:w.dataVencimento,documentoTipo:"Fatura",documentoId:o.id,idDocumentoCaixa:s.id})}}}}if(this.financeiroTitulo=G,this.financeiroMovimentacao=N,this.financeiroRenegociacao=_a,this.fatura=o,this.vendas=C,this.documentosEnvelope=b,this.carnes=T,!i){await this.salvarFatura(),$utils.emitter.emit("desativarBotoesFaturaModal");try{let n,g,F,D;if(n=await $db.configuracoes.porNome("integracao.bten.business"),g=(a=(h=n[0])==null?void 0:h.valor)!=null?a:!1,n=await $db.configuracoes.porNome("integracao.bten.authorization"),F=(y=(c=n[0])==null?void 0:c.valor)!=null?y:!1,D=g&&F,D){const v=[],m=this.contatos[o.idContato],$=await $api.bten.send(m,o);for(let w=0;w<$.length;w++){const _=$[w];_.status?v.push(_.telefone):this.$q.notifyError(`Falha ao enviar NPS para ${_.telefone}!`)}v.length&&this.$q.notifyPositive(`NPS enviado para ${v.join(",")}!`)}}catch(n){n.name==="GeeksException"&&this.$q.notifyAlert(`N\xE3o foi poss\xEDvel enviar NPS: ${n.message}`),n.name!=="GeeksException"&&this.$q.notifyError("N\xE3o foi possivel enviar NPS para o contato.",n)}let e;if(s!=null&&s.idCaixa){const n=await $erp().caixa.get(s==null?void 0:s.idCaixa);n!=null&&n.id&&(e=$db.caixa.tiposCaixa[Number(n.tipo)])}if([...C,...b].length&&~["SAT","NFCe"].indexOf(e))try{await this.$refs.documentosFiscais.emitirCupom(this.fatura.id)}catch{}if(this.$q.notifyPositive("Fatura finalizada"),this.fatura.status==="Finalizada"){const n=await $db.configuracoes.le({prefixoNome:"enviaemail.fatura"});let g=n.find(F=>F.idEmpresa===this.fatura.idEmpresa);g||(g=n.find(F=>!F.idEmpresa)),g&&await Go.enviar(this.fatura,g)}}return!0}catch(o){this.$q.notifyError("N\xE3o foi poss\xEDvel finalizar a fatura",o)}finally{this.$q.loading.hide()}}};const Zo={components:{Avatar:Ia,DocumentoCodigo:Xa,DocumentoMetas:ao,DocumentosFiscais:co,Faturamento:oo,TituloCard:Qo,VendaCard:fo,EnvelopeCard:po},computed:{config(){return $db.configuracoes.valores},descontoSomenteLeitura(){let i=!1;return i=this.fatura.status==="Aberta",i||(i=this.fatura.status==="Aguardando Pagamento"&&this.permissaoDescontoFaturaSinal),!i}},data(){return{contatos:{},faturaOriginal:{},fatura:{totalDocumento:0,subTotal:0,totalDesconto:0,totalPercentualDesconto:0},vendas:[],vendasOriginal:[],documentosEnvelope:[],documentosEnvelopeOriginal:[],documentosItem:[],documentosItemOriginal:[],carnes:[],carnesOriginal:[],documentoStatus:[],erroCalculo:!1,erroCalculoMsg:"",sistemaPai:"",configImpressaoCarne:[],configImpressaoConvenio:[],configImpressaoFatura:[],configImpressaoEnvelope:[],permissaoDesconto:!1,permissaoDescontoFaturaSinal:!1,pesoTotal:null,pesoBrutoTotal:null,metroCubicoTotal:null}},emits:["executar"],mixins:[mo],methods:{async calcularPesoTotal(){var c,y;const i=await $db.hibrido.lista({table:"documento",where:{idFatura:this.fatura.id}}),t=[],r={};let h=0,a=0;for(const o of i){const C=await $db.hibrido.lista({table:"documentoItem",where:{idDocumento:o.id}});for(const b of C)t.push(b)}for(const o of t)if(o.operacaoFator===-1){if(o.idItem&&!r[o.idItem]){const C=await $erp().item.get(o.idItem);C&&(r[o.idItem]=C)}h+=(((c=r[o.idItem])==null?void 0:c.peso)||0)*(o.quantidade||0),a+=(((y=r[o.idItem])==null?void 0:y.pesoBruto)||0)*(o.quantidade||0)}h=$utils.arredondar(h,4),a=$utils.arredondar(a,4),this.pesoTotal=h?$filters.numeroZerosDireita(h,4,2):null,this.pesoBrutoTotal=a?$filters.numeroZerosDireita(a,4,2):null},async calcularMetroCubicoTotal(){var a,c,y;const i=await $db.hibrido.lista({table:"documento",where:{idFatura:this.fatura.id}}),t=[],r={};let h=0;for(const o of i){const C=await $db.hibrido.lista({table:"documentoItem",where:{idDocumento:o.id}});for(const b of C)t.push(b)}for(const o of t){if(o.operacaoFator!==-1||o.tipoItem!=="Produto")continue;if(o.idItem&&!r[o.idItem]){const T=await $erp().item.get(o.idItem);T&&(r[o.idItem]=T)}const C=((a=r[o.idItem])==null?void 0:a.altura)*((c=r[o.idItem])==null?void 0:c.largura)*((y=r[o.idItem])==null?void 0:y.comprimento)||0,b=o.quantidade||0;h+=C>0?C*b:0}h=$utils.arredondar(h,4),this.metroCubicoTotal=h?$filters.numeroZerosDireita(h,4,2):null},atualizarDocumentoMetas(){!this.$refs.documentoMetas||(this.$refs.documentoMetas.documento=$utils.clonarV2(this.fatura))},...Ko,async atualizar(){let i=!1;if(this.permissaoDesconto=await $db.permissao.objeto("Diretiva_Caixa_DescontoFatura"),this.permissaoDescontoFaturaSinal=await $db.permissao.objeto("Diretiva_Caixa_DescontoFatura_Sinal"),this.vendas=[],this.documentosEnvelope=[],this.documentosEnvelopeOriginal=[],this.documentosItem=[],this.documentosItemOriginal=[],this.carnes=[],this.carnesOriginal=[],this.documentoStatus=[],this.contatos={},this.erroCalculo=!1,this.erroCalculoMsg="",this.prop.id){const t=await $db.fatura.leCompleto(this.prop.id);this.faturaOriginal=$utils.clonar(t.fatura),this.fatura=t.fatura,this.$refs.faturamento&&(this.$refs.faturamento.condicaoPagamentoOriginal=$utils.clonar(t.condicaoPagamento),this.$refs.faturamento.condicaoPagamento=t.condicaoPagamento),this.vendasOriginal=$utils.clonar(t.vendas),this.vendas=t.vendas.sort((a,c)=>new Date(a.dataHoraFinalizado)<new Date(c.dataHoraFinalizado)?-1:1);const r=t.documentosEnvelope.sort((a,c)=>new Date(a.dataHoraFinalizado)<new Date(c.dataHoraFinalizado)?-1:1);this.documentosEnvelopeOriginal=$utils.clonar(r),this.documentosEnvelope=$utils.clonar(r),this.receberTitulo.id&&!t.carnes.find(a=>a.id===this.receberTitulo.id)&&(t.carnes.push(await $db.financeiroTitulo.le({id:this.receberTitulo.id})),i=!0),this.carnesOriginal=$utils.clonar(t.carnes),this.carnes=t.carnes.sort((a,c)=>new Date(a.dataVencimento)<new Date(c.dataVencimento)?-1:1);const h={};if(t.fatura.idContato){const a=t.fatura.idContato;h[a]||(h[a]=await $db.contato.le({id:a}))}this.configuraImpressaoCarne(t.fatura.idEmpresa),this.configuraImpressaoConvenio(t.fatura.idEmpresa),this.configuraImpressaoEnvelope(t.fatura.idEmpresa),this.configuraImpressaoFatura(t.fatura.idEmpresa),this.contatos=h,await this.atualizarDocumentoMetas(),await this.calculaTotais(),await this.calcularPesoTotal(),await this.calcularMetroCubicoTotal(),i&&await this.salvarFatura()}},async executar(i){if(i==="recalcular"){if(this.prop.id){const t=await $db.fatura.leCompleto(this.prop.id);this.carnesOriginal=$utils.clonar(t.carnes),this.carnes=t.carnes,await this.calculaTotais()}}else i==="salvarFatura"?(await this.salvarFatura(),await this.atualizar(),this.$emit("executar","atualizarSemFechar")):(await this.atualizar(),this.$emit("executar",i))},async calculaTotais(i){const t=$utils.arredondar(this.vendas.reduce((a,c)=>a+c.totalDocumento||0,0)),r=$utils.arredondar(this.documentosEnvelope.reduce((a,c)=>a+c.totalDocumento||0,0)),h=$utils.arredondar(this.carnes.reduce((a,c)=>a+c.valorARealizar||0,0));if(i||(this.fatura.subTotal=$utils.arredondar(t+r+h),i="desconto"),i==="descontoPercentual"&&(this.fatura.totalDesconto=$utils.arredondar((this.fatura.totalPercentualDesconto||0)/100*this.fatura.subTotal)),i==="desconto"&&(this.fatura.totalPercentualDesconto=$utils.arredondar((this.fatura.totalDesconto||0)/this.fatura.subTotal*100)),this.fatura.totalDocumento=$utils.arredondar(this.fatura.subTotal-(this.fatura.totalDesconto||0)),this.erroCalculo=!1,this.erroCalculoMsg="",this.fatura.totalDesconto!==0){const a=t+r;a===0&&(this.erroCalculo=!0,this.erroCalculoMsg="Desconto n\xE3o permitido para fatura sem venda"),a>0&&this.fatura.totalDesconto>a&&(this.erroCalculo=!0,this.erroCalculoMsg="Desconto maior que o total das vendas")}this.fatura.totalDesconto!==0&&this.fatura.totalDocumento>this.fatura.subTotal&&(this.erroCalculo=!0);try{await this.$refs.faturamento.resumeCondicaoPagamento(),await this.$refs.faturamento.atualizaValorRestante(),await this.$refs.faturamento.redefinirCampos()}catch{}},async configuraImpressaoConvenio(i){const t=await $db.configuracoes.porNome("impressao.convenio",i);this.configImpressaoConvenio=[...t.length?t.map(r=>({texto:"Imprimir Conv\xEAnio",...r})):[{valor:"convenio",texto:"Imprimir Conv\xEAnio"}]]},async configuraImpressaoCarne(i){const t=await $db.configuracoes.porNome("impressao.carne",i);this.configImpressaoCarne=[...t.length?t.map(r=>({texto:"Imprimir Carn\xEA",...r})):[{valor:"carne-crediario",texto:"Reimprimir carn\xEA e notas promiss\xF3rias da fatura"}]]},async configuraImpressaoEnvelope(i){const t=await $db.configuracoes.porNome("impressao.envelope",i);this.configImpressaoEnvelope=[...t.length?t.map(r=>({texto:"Imprimir Envelope",...r})):[{valor:"envelope",texto:"Imprimir Envelope"},{valor:"envelopeMini",texto:"Imprimir Envelope Mini"}]]},async configuraImpressaoFatura(i){const t=await $db.configuracoes.porNome("impressao.fatura",i);this.configImpressaoFatura=[...t.length?t.map(r=>({texto:"Imprimir Fatura",...r})):[{valor:"invoice",texto:"Fatura (Invoice)"},{valor:"fatura-recibo",texto:"Recibo"},this.sistemaPai==="optisoul"?{valor:"termoGarantia",texto:"Termo de Garantia"}:{}]]},async reabrir(i){var t;if(!((t=this.fatura)!=null&&t.id)){this.$q.notifyError("N\xE3o foi poss\xEDvel encontrar o ID da fatura");return}if(!i)try{$q.loading.show(),await to({idDocumento:this.fatura.id})}catch(r){this.$q.notifyError(r.message);return}finally{$q.loading.hide()}if(!i)try{await new Promise((r,h)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 reabrir esta fatura",title:"Tem certeza?",cancel:{label:"CANCELAR",push:!0,color:"tertiary",flat:!0},ok:{label:"CONTINUAR",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{r()}).onCancel(()=>{h()})})}catch{return}try{this.$q.loading.show({message:"Processando..."});const r=$utils.clonar(this.fatura),h=$utils.clonar(this.vendas),a=$utils.clonar(this.documentosEnvelope),c=$utils.clonar(this.documentosItem),y=this.$refs.faturamento.condicaoPagamento.filter(T=>T.valor);if(!i){const T=[];y.reduce((O,V)=>(V.idDocumentoCaixa&&!O[V.idDocumentoCaixa]&&(O[V.idDocumentoCaixa]=!0,T.push($db.hibrido.le({table:"documento",id:V.idDocumentoCaixa}))),O),{});for await(const O of T)if(O.status!=="Aberto")return this.$q.notify({message:"N\xE3o \xE9 poss\xEDvel reabrir fatura de caixas fechados!"}),!1}try{await $db.fatura.checarTitulosLiquidados({condicoesPagamento:this.$refs.faturamento.condicaoPagamentoOriginal})}catch(T){$q.notifyError(T.message);return}let o=[],C=[],b=[];if(!i){o=await $db.financeiroTitulo.le({documentoId:r.id});for(const p of o)if(p.idFinanceiroBoleto){const u=await $erp().financeiroBoleto.get(p.idFinanceiroBoleto),I=await $db.financeiroBanco.le({id:u.idFinanceiroBanco}),R=await $db.banco.le({id:I.idBanco}),ea=u.revisao,oa=R.baixa,Ea=R.registro;if(u.remessaOperacao!==oa){const X=p.idFinanceiroBoleto,ca=$utils.uuid(),K={id:ca,idFinanceiroBanco:u.idFinanceiroBanco,nossoNumero:u.nossoNumero,nossoNumeroDv:u.nossoNumeroDv,revisao:ea+1,idEmpresa:u.idEmpresa,idContato:u.idContato,empresaNome:u.empresaNome,empresaNumeroDocumento:u.empresaNumeroDocumento,contatoNome:u.contatoNome,contatoNumeroDocumento:u.contatoNumeroDocumento,contatoLogradouro:u.contatoLogradouro,contatoCEP:u.contatoCEP,contatoBairro:u.contatoBairro,contatoCidade:u.contatoCidade,contatoUF:u.contatoUF,dataEmissao:$utils.dataAtual(),dataVencimento:u.dataVencimento,dataImpressao:u.dataImpressao,valor:u.valor,valorJuros:u.valorJuros,tipoJuros:u.tipoJuros,valorMulta:u.valorMulta,valorDesconto:u.valorDesconto,valorTotal:u.valorTotal,codigoBarras:u.codigoBarras,linhaDigitavel:u.linhaDigitavel,mensagem1:u.mensagem1,mensagem2:u.mensagem2,mensagem3:u.mensagem3,mensagem4:u.mensagem4,mensagem5:u.mensagem5,gerarRemessa:1,remessaOperacao:oa};await $db.financeiroBoleto.grava({atual:K});let Ca=[];X&&(Ca=await $db.financeiroTitulo.le({idFinanceiroBoleto:X}));for(const Z of Ca){const ua=$utils.clonar(Z);Z.idFinanceiroBoleto=ca;let ma=[];X&&(ma=await $db.financeiroBoletoTitulo.le({idFinanceiroBoleto:X}));for(const Da of ma){const L={id:$utils.uuid(),idFinanceiroBoleto:ca,idFinanceiroTitulo:Da.idFinanceiroTitulo};await $db.financeiroBoletoTitulo.grava({atual:L})}await $db.financeiroTitulo.grava({atual:Z,original:ua})}if(u.remessaOperacao===Ea&&u.gerarRemessa===1)for(const Z of[u,K]){const ua={...Z,gerarRemessa:0};await $db.financeiroBoleto.grava({original:Z,atual:ua})}}}let T=[];this.$refs.faturamento.idDocumentoCaixa&&(T=await $db.financeiroMovimentacao.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa})),o=await $db.financeiroTitulo.le({idFatura:r.id});let O=await $db.financeiroTitulo.le({idFatura:r.id});for(const p of $utils.clonar(o)){if(!p.idFinanceiroMovimentacaoAgrupamento)continue;const u=await $db.financeiroRenegociacao.le({idFinanceiroMovimentacaoN:p.idFinanceiroMovimentacaoAgrupamento});for(const I of u){const R=await $db.financeiroTitulo.le({id:I.idFinanceiroTitulo});R.idDocumentoCaixa===this.$refs.faturamento.idDocumentoCaixa&&(o=o.concat(R))}}let V=!1;for(const p of y){const u=await $db.financeiroTitulo.le({id:p.idFinanceiroTitulo});if(Object.keys(u).length){let I=[];I=T.filter(R=>R.idFinanceiroMovimentacaoN===u.idFinanceiroMovimentacaoAgrupamento),C=C.concat(I),I=T.filter(R=>R.idFinanceiroTitulo===u.id),C=C.concat(I),I=T.filter(R=>R.idFinanceiroCheque===u.id),C=C.concat(I),o=o.concat(u)}p.idFinanceiroTitulo="",p.sinal===1&&(V=!0)}O=await $db.financeiroTitulo.le({idFatura:r.id,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa});for(const p of O){if(!p.idFinanceiroMovimentacaoAgrupamento)continue;const u=await $db.financeiroMovimentacao.le({idFinanceiroMovimentacaoN:p.idFinanceiroMovimentacaoAgrupamento});C=C.concat(u);const I=await $db.financeiroRenegociacao.le({idFinanceiroMovimentacaoN:p.idFinanceiroMovimentacaoAgrupamento});b=b.concat(I)}if(O=await $db.financeiroTitulo.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:r.id}),o=o.concat(O),r.id){let p=await $db.financeiroMovimentacao.lerV2({documentoTipo:"Devolu\xE7\xE3o",documentoId:r.id});C=C.concat(p),p=await $db.financeiroMovimentacao.lerV2({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:r.id}),C=C.concat(p),p=await $db.financeiroMovimentacao.lerV2({documentoId:r.id});for(const u of p)(await $db.financeiroTitulo.le({id:u.idFinanceiroTitulo})).id||(C=C.concat(u))}const A=await $db.hibrido.lista({table:"documento",where:{idFatura:r.id}});for(const p of A){const u=await $db.financeiroMovimentacao.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:p.id});C=C.concat(u)}let d=[];for(const p in o){const u=o[p].id;d.includes(u)?delete o[p]:d.push(u)}o=o.filter(p=>p),d=[];for(const p in C){const u=C[p].id;d.includes(u)?delete C[p]:d.push(u)}C=C.filter(p=>p),d=[];for(const p in b){const u=b[p].id;d.includes(u)?delete b[p]:d.push(u)}b=b.filter(p=>p);let q=$utils.dataAtual(),s=V?"Aguardando Pagamento":"Aberta";this.documentoStatus=[{id:$utils.uuid(),idDocumento:r.id,operacao:"Fatura",statusOriginal:r.status,statusFinalizado:s,dataHoraEmissao:q,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}],r.status=s,s==="Aberta"&&(r.dataHoraFinalizado=""),s=V?"Aguardando Pagamento":"Aguardando Faturamento";for(const p of h)this.documentoStatus.push({id:$utils.uuid(),idDocumento:p.id,operacao:"Venda de Mercadoria",statusOriginal:p.status,statusFinalizado:s,dataHoraEmissao:q,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}),p.status=s;for(const p of a)this.documentoStatus.push({id:$utils.uuid(),idDocumento:p.id,operacao:"Envelope",statusOriginal:p.status,statusFinalizado:p.status,dataHoraEmissao:q,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa});for(const p of c)p.status=s;this.fatura=r,this.vendas=h,this.documentosEnvelope=a,this.documentosItem=c}if(this.$q.loading.hide(),i&&await this.finalizar(i),this.$q.loading.show({message:"Processando..."}),i){let T=[],O=[],V=[],A=[],d=[],q=[];T=this.$refs.faturamento.condicaoPagamento.map(s=>s.id),O=this.$refs.faturamento.condicaoPagamentoOriginal.filter(s=>!T.includes(s.id));for(const s of O)if(s.idFinanceiroTitulo&&V.push(s.idFinanceiroTitulo),s.idFormaPagamento){let p;p=await $erp().formaPagamento.get(s.idFormaPagamento),(p||{}).aliquota&&(s.idFinanceiroTituloPagar?V.push(s.idFinanceiroTituloPagar):this.$q.notify("N\xE3o foi poss\xEDvel excluir as movimenta\xE7\xF5es referentes \xE0 aliquota. Exclua-as manualmente."))}for(const s of V){let p;if(p=await $erp().financeiroTitulo.get(s),p.id&&A.push(p),p.idFinanceiroMovimentacaoAgrupamento){let u,I;if(u=await $db.hibrido.lista({table:"financeiroMovimentacao",where:{idFinanceiroMovimentacaoN:p.idFinanceiroMovimentacaoAgrupamento}}),I=(u.find(R=>R.idFinanceiroCheque)||{}).idFinanceiroCheque,I){let R=await $erp().financeiroTitulo.get(I);R.id&&A.push(R)}d.push(...u)}}for(let s of this.carnes){if(!s.id||(s=await $erp().financeiroTitulo.get(s.id),!(s||{}).idFinanceiroMovimentacaoAgrupamento))continue;let p,u;p=await $db.hibrido.lista({table:"financeiroMovimentacao",where:{idFinanceiroMovimentacaoN:s.idFinanceiroMovimentacaoAgrupamento}}),u=await $db.hibrido.lista({table:"financeiroRenegociacao",where:{idFinanceiroMovimentacaoN:s.idFinanceiroMovimentacaoAgrupamento}}),d.push(...p),q.push(...u)}await $db.financeiroTitulo.remove(A),await $db.financeiroMovimentacao.remove(d),await $db.financeiroRenegociacao.remove(q)}else{await $db.financeiroTitulo.remove(o.filter(T=>!(T.carne&&T.idFatura===r.id))),await $db.financeiroMovimentacao.remove(C),await $db.financeiroRenegociacao.remove(b);for(const T of o.filter(O=>O.carne&&O.idFatura===r.id))await $db.financeiroTitulo.grava({original:T,atual:{valorRealizado:0,receberPagar:1,dataPagamento:""}})}return await this.salvarFatura(),await this.atualizar(),i?this.$q.notifyPositive("Fatura corrigida."):this.$q.notifyPositive("Fatura reaberta."),!0}catch{this.$q.notify("N\xE3o foi poss\xEDvel reabrir a fatura."),this.$q.loading.hide()}finally{this.$q.loading.hide()}},async corrigir(){let i,t,r,h;if(i=this.$refs.faturamento.condicaoPagamentoOriginal,t=this.$refs.faturamento.condicaoPagamento,h=$utils.arredondar(this.fatura.totalDocumento||0),r=$utils.arredondar(t.reduce((a,c)=>a+c.valor||0,0)),r!==h){this.$q.notify("Total das condi\xE7\xF5es de pagamento difere do total da fatura");return}if(i.length){let a=!1;t.length||(a=!0);for(const c of t)if(!i.find(y=>y.id===c.id)){a=!0;break}if(!a){this.$q.notify("N\xE3o h\xE1 corre\xE7\xE3o a ser realizada");return}}try{return await new Promise((a,c)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 corrigir esta fatura",title:"Tem certeza?",cancel:{label:"CANCELAR",push:!0,color:"tertiary",flat:!0},ok:{label:"CONTINUAR",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{a()}).onCancel(()=>{c()})}),await this.reabrir(!0),!0}catch{return!1}},async salvarFatura(){try{this.$q.loading.show({message:"Processando..."});let i=$utils.clonar(this.$refs.faturamento.condicaoPagamento.filter(r=>r.valor));for(let r in i)delete i[r].idDocumentoCondicaoPagamento,delete i[r].parcelas,delete i[r].formaPagamento,delete i[r].edicao,delete i[r].codigoDocumento,delete i[r].codigoDocumentoCaixa;const t=(this.carnesOriginal||[]).filter(r=>(this.financeiroTitulo||[]).find(h=>h.id===r.id));if(await $db.fatura.grava({faturaOriginal:this.faturaOriginal,fatura:this.fatura,vendasOriginal:this.vendasOriginal,vendas:this.vendas,documentosEnvelope:this.documentosEnvelope,documentosEnvelopeOriginal:this.documentosEnvelopeOriginal,documentosItemOriginal:this.documentosItemOriginal,documentosItem:this.documentosItem,condicaoPagamentoOriginal:this.$refs.faturamento.condicaoPagamentoOriginal,condicaoPagamento:i,documentoStatus:this.documentoStatus,financeiroTitulo:this.financeiroTitulo,financeiroTituloOriginal:t,financeiroMovimentacao:this.financeiroMovimentacao,financeiroRenegociacao:this.financeiroRenegociacao}),this.receberTitulo.id){let r=this.carnes.find(h=>h.id===this.receberTitulo.id);r.id&&await $db.financeiroTitulo.grava({original:r,atual:{idFatura:this.fatura.id}})}}catch{this.$q.notify("N\xE3o foi poss\xEDvel salvar a fatura."),this.$q.loading.hide()}finally{this.$q.loading.hide()}}},props:{prop:{default:()=>({}),required:!0,type:Object},receberTitulo:{default:()=>({}),type:Object}},mounted(){this.sistemaPai=$utils.sistemaPai(),this.atualizar()}},Yo={class:"Fatura round-borders bg-grey-2 q-pb-sm"},Wo={class:"row items-center"},Xo={class:"col q-ma-sm q-title"},at=E("div",{class:"text-h5"},null,-1),ot={class:"bg-grey-2"},tt={class:"q-ma-sm"},it={key:0,class:"q-item-label",style:{color:"#0c0c0c"}},et={key:1,class:"q-item-label q-mt-md",style:{color:"#0c0c0c"}},nt={class:"col-12 col-md-4 border-1 q-ma-md"},rt=E("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Subtotal",-1),st={class:"col-8 text-right"},lt=E("div",{class:"col-4 col-lg-3",style:{"line-height":"50px"}},"Desconto",-1),dt={class:"col-3"},ct={class:"col-5"},ut=E("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Total",-1),mt={class:"col-8 q-mt-sm text-right"},ft=E("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Peso Total",-1),pt={class:"col-8 q-mt-sm text-right"},vt=E("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Peso Bruto Total",-1),ht={class:"col-8 q-mt-sm text-right"},Ct=E("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Metro C\xFAbico Total",-1),gt={class:"col-8 q-mt-sm text-right"},bt={class:"Fatura-faturamento round-borders q-ma-sm q-pa-md"},$t={class:"round-borders q-ma-sm q-pa-md"};function Ft(i,t,r,h,a,c){const y=S("avatar"),o=S("documento-codigo"),C=S("documento-metas"),b=S("VendaCard"),T=S("EnvelopeCard"),O=S("titulo-card"),V=S("row"),A=S("campo"),d=S("faturamento"),q=S("documentos-fiscais");return P(),B("div",Yo,[l(da,{class:"Fatura-barra bg-grey-2 q-py-md",color:"black",dark:""},{default:f(()=>[l(ha,null,{default:f(()=>[E("div",Wo,[l(y,{imagem:(a.contatos[a.fatura.idContato]||{}).imagem,rotulo:a.fatura.descricaoContato,tamanho:"60"},null,8,["imagem","rotulo"]),E("div",Xo,x(a.fatura.descricaoContato),1)]),at]),_:1}),a.fatura.id?(P(),z(o,{key:0,documento:a.fatura},null,8,["documento"])):M("",!0),l(J,{color:"tertiary",flat:"",icon:"more_vert",round:""},{default:f(()=>[l(Na,null,{default:f(()=>[l(ka,{link:"",separator:""},{default:f(()=>[a.fatura.id?(P(),z(sa,{key:0,clickable:"",onClick:t[0]||(t[0]=s=>i.$refs.documentosFiscais.emitirCupom(a.fatura.id))},{default:f(()=>[l(U,{avatar:""},{default:f(()=>[l(j,{name:"account_balance"})]),_:1}),l(U,null,{default:f(()=>[l(la,null,{default:f(()=>[k("Emitir cupom")]),_:1})]),_:1})]),_:1})):M("",!0),a.fatura.id&&i.$utils.mapearStatus(a.fatura).permiteNota?(P(),B(ia,{key:1},[l(sa,{clickable:"",onClick:t[1]||(t[1]=s=>i.emitirNFeV2({idFatura:a.fatura.id},1,"Venda"))},{default:f(()=>[l(U,{avatar:""},{default:f(()=>[l(j,{name:"account_balance"})]),_:1}),l(U,null,{default:f(()=>[l(la,null,{default:f(()=>[k("NFe de Sa\xEDda/Venda")]),_:1})]),_:1})]),_:1}),l(sa,{clickable:"",onClick:t[2]||(t[2]=s=>i.emitirNFeV2({idFatura:a.fatura.id},0,"Devolu\xE7\xE3o"))},{default:f(()=>[l(U,{avatar:""},{default:f(()=>[l(j,{name:"account_balance"})]),_:1}),l(U,null,{default:f(()=>[l(la,null,{default:f(()=>[k("NFe de Entrada/Devolu\xE7\xE3o")]),_:1})]),_:1})]),_:1}),l(sa,{clickable:"",onClick:t[3]||(t[3]=s=>i.emitirNFeV2({idFatura:a.fatura.id},1,"Remessa"))},{default:f(()=>[l(U,{avatar:""},{default:f(()=>[l(j,{name:"account_balance"})]),_:1}),l(U,null,{default:f(()=>[l(la,null,{default:f(()=>[k("NFe de Remessa")]),_:1})]),_:1})]),_:1})],64)):M("",!0)]),_:1})]),_:1})]),_:1})]),_:1}),E("div",ot,[l(C,{ref:"documentoMetas"},null,512)]),E("div",tt,[a.vendas.length>0?(P(),B("p",it,[l(j,{name:"shopping_cart",class:"q-mr-md",size:"24px",style:{color:"#737373"}}),k(" Vendas ")])):M("",!0),(P(!0),B(ia,null,Fa(a.vendas,s=>(P(),B("div",{key:s.id,class:"bg-white q-mt-sm round-borders"},[l(b,{id:s.id,onAtualizar:c.atualizar,onExecutar:c.executar},null,8,["id","onAtualizar","onExecutar"])]))),128)),(P(!0),B(ia,null,Fa(a.documentosEnvelope,s=>(P(),B("div",{key:s.id,class:"bg-white q-mt-sm round-borders"},[l(T,{id:s.id,onExecutar:c.executar},null,8,["id","onExecutar"])]))),128)),a.carnes.length>0?(P(),B("p",et,[l(j,{name:"attach_money",class:"q-mr-md",size:"24px",style:{color:"#737373"}}),k(" Carn\xEAs ")])):M("",!0),(P(!0),B(ia,null,Fa(a.carnes,s=>(P(),B("div",{key:s.id,class:"bg-white q-mt-sm round-borders"},[l(O,{dados:s,class:"q-mt-md",onExecutar:c.executar},null,8,["dados","onExecutar"])]))),128))]),l(V,{class:"justify-end"},{default:f(()=>[E("div",nt,[l(V,{class:"q-col-gutter-md q-mb-sm"},{default:f(()=>[rt,E("strong",st,x(i.$filters.numero(a.fatura.subTotal,2)),1)]),_:1}),a.permissaoDesconto?(P(),z(V,{key:0,class:"q-col-gutter-x-sm"},{default:f(()=>[lt,E("div",dt,[l(A,{modelValue:a.fatura.totalPercentualDesconto,"onUpdate:modelValue":[t[4]||(t[4]=s=>a.fatura.totalPercentualDesconto=s),t[5]||(t[5]=s=>c.calculaTotais("descontoPercentual"))],tipo:"decimal",decimals:"2",suffix:"%","somente-leitura":c.descontoSomenteLeitura,error:a.erroCalculo},null,8,["modelValue","somente-leitura","error"])]),E("div",ct,[l(A,{modelValue:a.fatura.totalDesconto,"onUpdate:modelValue":[t[6]||(t[6]=s=>a.fatura.totalDesconto=s),t[7]||(t[7]=s=>c.calculaTotais("desconto"))],tipo:"decimal",decimals:"2","somente-leitura":c.descontoSomenteLeitura,error:a.erroCalculo,errorMessage:a.erroCalculoMsg},null,8,["modelValue","somente-leitura","error","errorMessage"])])]),_:1})):M("",!0),l(V,{class:"q-col-gutter-x-sm q-mt-sm"},{default:f(()=>[ut,E("strong",mt,x(i.$filters.numero(a.fatura.totalDocumento,2)),1)]),_:1}),a.pesoTotal?(P(),z(V,{key:1,class:"q-col-gutter-x-sm q-mt-sm"},{default:f(()=>[ft,E("span",pt,x(a.pesoTotal),1)]),_:1})):M("",!0),a.pesoBrutoTotal?(P(),z(V,{key:2,class:"q-col-gutter-x-sm q-mt-sm"},{default:f(()=>[vt,E("span",ht,x(a.pesoBrutoTotal),1)]),_:1})):M("",!0),a.metroCubicoTotal?(P(),z(V,{key:3,class:"q-col-gutter-x-sm q-mt-sm"},{default:f(()=>[Ct,E("span",gt,x(a.metroCubicoTotal),1)]),_:1})):M("",!0)])]),_:1}),E("div",bt,[l(d,{documento:a.fatura,ref:"faturamento",onExecutar:c.executar,onSalvarFatura:c.salvarFatura},null,8,["documento","onExecutar","onSalvarFatura"])]),E("div",$t,[l(q,{ref:"documentosFiscais",idFatura:a.fatura.id},null,8,["idFatura"])])])}var Et=Ta(Zo,[["render",Ft]]);const Dt={components:{CpfCnpjNoCupom:uo,Fatura:Et},data(){return{fatura:{},cpfCnpjNoCupom:{visivel:!1,incluirCpfCnpjNoCupom:!1,idEmpresa:"",cpfCnpj:"",nomeCliente:"",tipoCaixa:""},visivel:!1,visibilidade:{botao:{finalizar:!1,reabrir:!1,corrigir:!1}},temPermissaoCorrigir:!1}},emits:["executar"],methods:{async atualizar(){let i;try{i=setTimeout(()=>{$q.loading.show({message:"Carregando informa\xE7\xF5es...",boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"})},500);let t=await $db.hibrido.le({table:"documento",id:this.id});this.fatura=t,await this.verificarPermissoes(),this.desativarBotoes(),t.status==="Aberta"&&(this.visibilidade.botao.salvar=!0),t.status==="Finalizada"||t.status!=="Aguardando Pagamento"&&t.dataHoraFinalizado?this.visibilidade.botao.reabrir=!0:this.visibilidade.botao.finalizar=!0,await $db.contato.exibirCondutaObservacao(t.idContato,$q.notify)}finally{clearTimeout(i),$q.loading.hide()}},desativarBotoes(){this.visibilidade.botao.finalizar=!1,this.visibilidade.botao.reabrir=!1,this.visibilidade.botao.salvar=!1},desativarEsc(){this.lockEsc=!0},reativarEsc(){this.lockEsc=!1},async reabrir(){await this.$refs.fatura.reabrir(),await this.atualizar(),this.runOnHide.push(()=>$utils.emitter.emit("atualizarAtendimentoFatura"))},voltar(i){i.stopPropagation(),!this.lockEsc&&this.fechar()},async finalizar(i){const r={cpfCnpjNoCupom:this.cpfCnpjNoCupom};if(this.lockEsc=!0,!await this.$refs.fatura.finalizar(!1,r)){this.lockEsc=!1;return}this.$emit("executar","finalizar"),this.fechar()},async executar(i){switch(i){case"finalizar":if(!await this.$refs.fatura.finalizar())return;break;case"retornarOrcamento":case"remover":await this.atualizar(),this.runOnHide.push(()=>$utils.emitter.emit("atualizarAtendimentoFatura"));return}if(i==="atualizarSemFechar"){await this.atualizar(),this.runOnHide.push(()=>this.$emit("executar","atualizar"));return}this.$emit("executar",i),this.fechar()},fechar(){this.visivel=!1},async mostrar(i={}){this.id=i.id,await this.atualizar(),this.visivel=!0},onHide(){this.fatura={},this.visibilidade={botao:{finalizar:!1,reabrir:!1,corrigir:!1}},this.temPermissaoCorrigir=!1,this.runOnHide.forEach(i=>i()),this.runOnHide=[]},async salvar(){try{await new Promise((i,t)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 salvar esta fatura",title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{i()}).onCancel(()=>{t()})})}catch{return}await this.$refs.fatura.salvarFatura(),this.$emit("executar","atualizar"),this.fechar()},corrigir(){this.$refs.fatura.corrigir().then(()=>{this.$emit("executar","atualizar"),this.fechar()})},async verificarPermissoes(){this.temPermissaoCorrigir=await $db.permissao.objeto("caixa/tesouraria")}},props:{receberTitulo:{default:()=>({}),type:Object}},created(){this.runOnHide=[]},mounted(){$utils.emitter.on("desativarBotoesFaturaModal",this.desativarBotoes),$utils.emitter.on("desativarVoltarEscModal",this.desativarEsc),$utils.emitter.on("reativarVoltarEscModal",this.reativarEsc)},beforeUnmount(){$utils.emitter.off("desativarBotoesFaturaModal",this.desativarBotoes),$utils.emitter.off("desativarVoltarEscModal",this.desativarEsc),$utils.emitter.off("reativarVoltarEscModal",this.reativarEsc)}};function wt(i,t,r,h,a,c){const y=S("fatura"),o=S("CpfCnpjNoCupom");return P(),B("div",null,[l(Aa,{modelValue:a.visivel,"onUpdate:modelValue":t[0]||(t[0]=C=>a.visivel=C),onKeyup:Ra(c.voltar,["esc"]),onHide:c.onHide,maximized:"",persistent:""},{default:f(()=>[l(io,{view:"hHh LpR fFf",container:"",class:"bg-grey-4"},{default:f(()=>[l(eo,null,{default:f(()=>[l(da,null,{default:f(()=>[za(l(J,{icon:"arrow_back",round:"",flat:"",dense:""},null,512),[[Oa]]),l(ha,null,{default:f(()=>[k("Fatura")]),_:1}),a.visibilidade.botao.salvar?(P(),z(J,{key:0,onClick:c.salvar,label:"Salvar",color:"white","text-color":"primary",unelevated:""},null,8,["onClick"])):M("",!0),a.visibilidade.botao.reabrir&&a.temPermissaoCorrigir?(P(),z(J,{key:1,onClick:c.corrigir,label:"Corrigir",color:"white","text-color":"negative",unelevated:""},null,8,["onClick"])):M("",!0)]),_:1})]),_:1}),l(no,null,{default:f(()=>[l(ro,{class:"u-container q-py-md"},{default:f(()=>[a.fatura.id?(P(),z(y,{key:0,onExecutar:c.executar,prop:{id:a.fatura.id},receberTitulo:r.receberTitulo,ref:"fatura"},null,8,["onExecutar","prop","receberTitulo"])):M("",!0)]),_:1})]),_:1}),l(so,{class:"bg-light",bordered:""},{default:f(()=>[l(da,{class:"q-pa-sm u-container"},{default:f(()=>[l(lo),a.visibilidade.botao.reabrir?(P(),z(J,{key:0,onClick:c.reabrir,label:"Reabrir",color:"negative",flat:"",class:"q-ml-sm"},null,8,["onClick"])):M("",!0),a.visibilidade.botao.reabrir?M("",!0):(P(),z(J,{key:1,onClick:c.finalizar,disabled:!a.visibilidade.botao.finalizar,label:"Finalizar",color:"primary",dark:"",unelevated:"",class:"q-ml-sm"},null,8,["onClick","disabled"]))]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","onKeyup","onHide"]),l(o,{modelValue:a.cpfCnpjNoCupom.visivel,"onUpdate:modelValue":t[1]||(t[1]=C=>a.cpfCnpjNoCupom.visivel=C),onConfirmar:t[2]||(t[2]=C=>c.finalizar()),dados:a.cpfCnpjNoCupom},null,8,["modelValue","dados"])])}var _t=Ta(Dt,[["render",wt]]);export{_t as F,Qo as T};
