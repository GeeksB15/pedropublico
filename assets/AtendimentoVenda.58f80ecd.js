import{aj as D,ab as aa,dA as ma,a5 as ua,dB as ea,a7 as k,Q as S,j as B,bb as ta,an as oa,dC as va,dD as ha,ai as Y,aC as ga,dE as fa,dF as pa,a6 as ba,_ as ia,r as P,o as m,d as C,w as c,f as d,y as na,h as Ca,i as Ia,k as _,G as sa,M as la,B as g,at as Va,aW as Z,e as h,C as wa,Z as _a,bj as ya,d8 as xa,n as w,az as Pa,O as X,R as M,S as T,T as j,z as N,bE as L,F as W,s as J,dl as Da,dm as R,t as y,m as Fa,bg as ka}from"./index.9b156bba.js";import{n as za}from"./nfePrincipal.7455ee94.js";import{E as qa}from"./EnvelopeCard.c011f679.js";import{V as Ea}from"./VendaCard.9cec35eb.js";import{G as Aa}from"./GChipsV2.cdff2fe0.js";import{o as Ga}from"./open-url.a4b7ddca.js";import"./compactarValidarNFe.d3892009.js";import"./obterItens.68ea9ec4.js";import"./codigosANP.a6c1a264.js";import"./emitirNFe.35117289.js";import"./DocumentosFiscais.9a161678.js";import"./Campo.7909a0e7.js";import"./ModalHistoricoStatus.d2a763d2.js";const Oa=["top","right","bottom","left"],K={type:{type:String,default:"a"},outline:Boolean,push:Boolean,flat:Boolean,unelevated:Boolean,color:String,textColor:String,glossy:Boolean,square:Boolean,padding:String,label:{type:[String,Number],default:""},labelPosition:{type:String,default:"right",validator:o=>Oa.includes(o)},externalLabel:Boolean,hideLabel:{type:Boolean},labelClass:[Array,String,Object],labelStyle:[Array,String,Object],disable:Boolean,tabindex:[Number,String]};function da(o,t){return{formClass:D(()=>`q-fab--form-${o.square===!0?"square":"rounded"}`),stacked:D(()=>o.externalLabel===!1&&["top","bottom"].includes(o.labelPosition)),labelProps:D(()=>{if(o.externalLabel===!0){const l=o.hideLabel===null?t.value===!1:o.hideLabel;return{action:"push",data:{class:[o.labelClass,`q-fab__label q-tooltip--style q-fab__label--external q-fab__label--external-${o.labelPosition}`+(l===!0?" q-fab__label--external-hidden":"")],style:o.labelStyle}}}return{action:["left","top"].includes(o.labelPosition)?"unshift":"push",data:{class:[o.labelClass,`q-fab__label q-fab__label--internal q-fab__label--internal-${o.labelPosition}`+(o.hideLabel===!0?" q-fab__label--internal-hidden":"")],style:o.labelStyle}}})}}const ra={start:"self-end",center:"self-center",end:"self-start"},Sa=Object.keys(ra);var $=aa({name:"QFabAction",props:{...K,icon:{type:String,default:""},anchor:{type:String,validator:o=>Sa.includes(o)},to:[String,Object],replace:Boolean},emits:["click"],setup(o,{slots:t,emit:l}){const n=ma(ea,()=>({showing:{value:!0},onChildClick:ua})),{formClass:a,labelProps:s}=da(o,n.showing),u=D(()=>{const v=ra[o.anchor];return a.value+(v!==void 0?` ${v}`:"")}),e=D(()=>o.disable===!0||n.showing.value!==!0);function f(v){n.onChildClick(v),l("click",v)}function V(){const v=[];return t.icon!==void 0?v.push(t.icon()):o.icon!==""&&v.push(k(B,{name:o.icon})),(o.label!==""||t.label!==void 0)&&v[s.value.action](k("div",s.value.data,t.label!==void 0?t.label():[o.label])),ta(t.default,v)}const b=oa();return Object.assign(b.proxy,{click:f}),()=>k(S,{class:u.value,...o,noWrap:!0,stack:o.stacked,icon:void 0,label:void 0,noCaps:!0,fabMini:!0,disable:e.value,onClick:f},V)}});const Ta=["up","right","down","left"],La=["left","center","right"];var Ra=aa({name:"QFab",props:{...K,...va,icon:String,activeIcon:String,hideIcon:Boolean,hideLabel:{...K.hideLabel,default:null},direction:{type:String,default:"right",validator:o=>Ta.includes(o)},persistent:Boolean,verticalActionsAlign:{type:String,default:"center",validator:o=>La.includes(o)}},emits:ha,setup(o,{slots:t}){const l=Y(null),n=Y(o.modelValue===!0),a=ga(),{proxy:{$q:s}}=oa(),{formClass:u,labelProps:e}=da(o,n),f=D(()=>o.persistent!==!0),{hide:V,toggle:b}=fa({showing:n,hideOnRouteChange:f}),v=D(()=>({opened:n.value})),F=D(()=>`q-fab z-fab row inline justify-center q-fab--align-${o.verticalActionsAlign} ${u.value}`+(n.value===!0?" q-fab--opened":" q-fab--closed")),x=D(()=>`q-fab__actions flex no-wrap inline q-fab__actions--${o.direction} q-fab__actions--${n.value===!0?"opened":"closed"}`),q=D(()=>{const I={id:a.value,role:"menu"};return n.value!==!0&&(I["aria-hidden"]="true"),I}),O=D(()=>`q-fab__icon-holder  q-fab__icon-holder--${n.value===!0?"opened":"closed"}`);function z(I,E){const A=t[I],G=`q-fab__${I} absolute-full`;return A===void 0?k(B,{class:G,name:o[E]||s.iconSet.fab[E]}):k("div",{class:G},A(v.value))}function i(){const I=[];return o.hideIcon!==!0&&I.push(k("div",{class:O.value},[z("icon","icon"),z("active-icon","activeIcon")])),(o.label!==""||t.label!==void 0)&&I[e.value.action](k("div",e.value.data,t.label!==void 0?t.label(v.value):[o.label])),ta(t.tooltip,I)}return pa(ea,{showing:n,onChildClick(I){V(I),l.value!==null&&l.value.$el.focus()}}),()=>k("div",{class:F.value},[k(S,{ref:l,class:u.value,...o,noWrap:!0,stack:o.stacked,align:void 0,icon:void 0,label:void 0,noCaps:!0,fab:!0,"aria-expanded":n.value===!0?"true":"false","aria-haspopup":"true","aria-controls":a.value,onClick:b},i),k("div",{class:x.value,...q.value},ba(t.default))])}});const Ba={data(){return{motivo:"",motivos:[],tipo:"devolucao",visivel:!1}},emits:["executa"],methods:{async atualizar(){this.motivo="",this.tipo="devolucao";const o=await $db.configuracoes.le({nome:"vendas.garantia.motivo"});this.motivos=o.map(t=>t.valor)},executa(){if(this.tipo==="garantia"&&!this.motivo){this.$q.notify({message:"Selecione o motivo",type:"negative"});return}this.visivel=!1,this.$emit("executa",{tipo:this.tipo,motivo:this.motivo})},async mostrar(){await this.atualizar(),this.visivel=!0}}},Qa={class:"layout-padding"},Ha={class:"q-mt-lg text-center"};function Ua(o,t,l,n,a,s){const u=P("campo");return m(),C(wa,{modelValue:a.visivel,"onUpdate:modelValue":t[5]||(t[5]=e=>a.visivel=e),"content-css":{minWidth:"30vw"}},{default:c(()=>[d(na,{class:"q-dialog-plugin"},{default:c(()=>[d(Ca,{class:"bg-primary text-white"},{default:c(()=>[d(Ia,null,{default:c(()=>[_("Devolu\xE7\xE3o/Garantia")]),_:1}),sa(d(S,{dense:"",flat:"",icon:"close",round:""},null,512),[[la]])]),_:1}),g("div",Qa,[g("form",{class:"q-pa-md",onSubmit:t[4]||(t[4]=Va((...e)=>s.executa&&s.executa(...e),["prevent"]))},[d(Z,{modelValue:a.tipo,"onUpdate:modelValue":[t[0]||(t[0]=e=>a.tipo=e),t[1]||(t[1]=e=>a.motivo="")],class:"q-mr-sm",label:"Devolu\xE7\xE3o",val:"devolucao"},null,8,["modelValue"]),d(Z,{modelValue:a.tipo,"onUpdate:modelValue":t[2]||(t[2]=e=>a.tipo=e),label:"Garantia",val:"garantia"},null,8,["modelValue"]),a.tipo==="garantia"?(m(),C(u,{key:0,modelValue:a.motivo,"onUpdate:modelValue":t[3]||(t[3]=e=>a.motivo=e),rotulo:"Motivo",tipo:"seletor",opcoes:a.motivos},null,8,["modelValue","opcoes"])):h("",!0),g("div",Ha,[d(S,{color:"primary",class:"q-ml-sm no-shadow",label:"Continua",type:"submit"})])],32)])]),_:1})]),_:1},8,["modelValue"])}var Ma=ia(Ba,[["render",Ua]]);const ja={components:{Avatar:_a,NfePrincipal:za,EnvelopeCard:qa,VendaCard:Ea,VendaDevolucaoGarantia:Ma,VendaModal:ya,Envelope:xa,GChipsV2:Aa},computed:{temVendasAbertas(){return!!this.vendasAbertas.length},temVendasCanceladas(){return!!this.vendasCanceladas.length},temVendasFinalizadas(){return!!this.vendasFinalizadas.length},temRegistros(){return this.temVendasAbertas||this.temVendasCanceladas||this.temVendasFinalizadas}},data(){return{grupos:[],documentos:{},itens:{},documentosItens:[],vendasCompletas:{},vendasAbertas:[],vendasFinalizadas:[],vendasCanceladas:[],totalVendasAbertas:0,totalVendasFinalizadas:0,totalVendasCanceladas:0,filtro:{},tipoLista:"documentos",dataIni:null,dataFim:null,carregando:!1,colunas:[{name:"descricao",label:"Descri\xE7\xE3o",align:"left"},{name:"documento",label:"Documento",align:"left"},{name:"valorUnitario",label:"Valor Unit\xE1rio",align:"right"},{name:"quantidade",label:"Quantidade",align:"right"},{name:"valorTotal",label:"Valor Total",align:"right"},{name:"botao",label:"",align:"right"}],contato:null,tablePagination:{page:1,rowsPerPage:25},vendaCardPagination:{maxPages:7,perPage:5,vendasAbertas:{page:1,min:1,max:1},vendasFinalizadas:{page:1,min:1,max:1},vendasCanceladas:{page:1,min:1,max:1}},documentoItemDevolucaoGarantia:{},modalVenda:{visivel:!1,orcamento:{}},urlHistoricoCliente:"",sistemaPai:""}},methods:{abrirHistoricoCliente(){Ga(this.urlHistoricoCliente)},adicionarVenda(){this.$refs.modalVenda.mostrar({idContato:this.$route.params.id})},adicionarEnvelope(){this.$refs.modalEnvelope.mostrar({idContato:this.$route.params.id})},abrirModalDevolucaoGarantia(o){this.documentoItemDevolucaoGarantia=o,this.$refs.modalDevolucaoGarantia.mostrar()},alternarLista(){this.tipoLista=this.tipoLista==="documentos"?"itens":"documentos",this.atualizar()},fechouNFe(o){o&&$utils.emitter.emit("atualizarDocumentosFiscais")},async finalizaDevolucaoGarantia(o){var x,q;let t,l;if(l=this.documentoItemDevolucaoGarantia||{},l.idDocumento&&(t=await $db.hibrido.le({table:"documento",id:l.idDocumento})),!t.id){this.$q.notify("Venda original n\xE3o encontrada");return}let n={};if(this.documentoItemDevolucaoGarantia.idItem&&(n=await $erp().item.get(this.documentoItemDevolucaoGarantia.idItem)||{}),!n.id){this.$q.notify("Erro na recupera\xE7\xE3o do item");return}const a=t.tipo==="Envelope"?t.idContatoResponsavel:t.idContato;if(!Boolean(a)){this.$q.notify("Destinat\xE1rio n\xE3o encontrado");return}if(!t.idEmpresa){this.$q.notify("Emitente n\xE3o encontrado");return}const s=await $erp().documento.where({idContato:a,idEmpresa:t.idEmpresa,tipo:"Venda",status:"Or\xE7amento"}).toArray();s.sort((O,z)=>new Date(O.dataHoraEmissao)<new Date(z.dataHoraEmissao)?1:-1);const u=await $utils.selecionarCfop({ncm:n.ncm,idItem:n.id,itemTipo:n.tipo,codigoDocumentoOperacao:((x=s[0])==null?void 0:x.codigoDocumentoOperacao)||t.codigoDocumentoOperacao,idContatoDestinatario:a,idContatoEmitente:t.idEmpresa,operacaoFator:1});if(!u){this.$q.notifyError("CFOP n\xE3o encontrado");return}let e={};const f=$utils.removerAcentos((this.documentoItemDevolucaoGarantia.tipoItem||"").toLowerCase())==="servico";o.tipo==="devolucao"&&(e.operacao=f?"Devolu\xE7\xE3o de Servi\xE7o":"Devolu\xE7\xE3o de Venda"),o.tipo==="garantia"&&(e.operacao=f?"Garantia de Servi\xE7o":"Garantia de Venda",e.motivo=o.motivo),e.id=$utils.uuid(),e.dataHoraFinalizado="",e.idDocumentoItemVenda=this.documentoItemDevolucaoGarantia.id,e.idDocumentoVenda=this.documentoItemDevolucaoGarantia.idDocumento,e.idItem=this.documentoItemDevolucaoGarantia.idItem,e.idPlanoContaDestino=this.documentoItemDevolucaoGarantia.idPlanoContaDestino,e.idPlanoContaEstoque=this.documentoItemDevolucaoGarantia.idPlanoContaEstoque,e.tipoItem=this.documentoItemDevolucaoGarantia.tipoItem,e.descricaoItem=this.documentoItemDevolucaoGarantia.descricaoItem,e.status="Or\xE7amento",e.quantidade=this.documentoItemDevolucaoGarantia.quantidade||1,e.operacaoFator=u==null?void 0:u.fator,e.idCfop=u==null?void 0:u.id;const V=this.documentoItemDevolucaoGarantia.descontoItem||0,b=(this.documentoItemDevolucaoGarantia.descontoTotalRateado||0)/e.quantidade,v=(this.documentoItemDevolucaoGarantia.descontoFaturaRateado||0)/e.quantidade,F=$utils.arredondar(V+b+v,4);e.descontoItem=$utils.arredondar(F*-1,4),e.descontoPercentualItem=$utils.arredondar(e.descontoItem/(this.documentoItemDevolucaoGarantia.valorItem||1)*100,2),e.descontoTotalRateado=0,e.descontoFaturaRateado=0,e.descontoSubTotal=this.documentoItemDevolucaoGarantia.descontoSubTotal||0,e.valorCustoMedio=this.documentoItemDevolucaoGarantia.valorCustoMedio||0,e.valorCustoReposicao=this.documentoItemDevolucaoGarantia.valorCustoReposicao||0,e.valorOriginal=(this.documentoItemDevolucaoGarantia.valorOriginal||0)*-1,e.valorItem=(this.documentoItemDevolucaoGarantia.valorItem||0)*-1,e.subTotal=$utils.arredondar(((this.documentoItemDevolucaoGarantia.valorItem||0)-F)*-e.quantidade,2),e.total=e.subTotal||0,e.valorReal=$utils.arredondar(((this.documentoItemDevolucaoGarantia.valorItem||0)-F)*-1,4),e.valorRealTotal=e.subTotal||0,e.valorIpi=(this.documentoItemDevolucaoGarantia.valorIpi||0)*-1,e.valorIcms=(this.documentoItemDevolucaoGarantia.valorIcms||0)*-1,e.valorIcmsSt=(this.documentoItemDevolucaoGarantia.valorIcmsSt||0)*-1,e.valorDifal=(this.documentoItemDevolucaoGarantia.valorDifal||0)*-1,e.loteEmpresa=this.documentoItemDevolucaoGarantia.loteEmpresa,localStorage.setItem("documentoItemDevolucao",JSON.stringify(e)),s.length&&(e.idDocumento=s[0].id,e.dataHoraEmissao=$utils.dataAtual(),await $db.documentoItem.grava({atual:e}),this.$q.notify({message:"Item adicionado ao or\xE7amento.",type:"positive"})),this.$refs.modalVenda.mostrar({id:(q=s[0])==null?void 0:q.id,idContato:this.$route.params.id})},async atualizar(){this.documentos={},this.itens={},this.documentosItens=[],this.vendasCompletas={},this.tablePagination={page:1,rowsPerPage:25};let o,t;t=JSON.parse(localStorage.getItem("clienteSistema"))||{},o="https://rel.storage.b15.com.br/Relatorios/OptiSoul/historico-cliente.html?",o+="CodigoCliente="+this.contato.codigoContato,o+="&BancoDeDados="+t.bancoDeDados,o+="&URLServidor="+t.urlServidor,this.urlHistoricoCliente=o,await this.atualizarVendas()},async carregarImagensItens(o){const t=Object.keys(o);if(!!t.length){await $utils.dormir(200);try{const l=await $db.hibrido.lista({table:"item",columns:["id","descricao","imagem"],whereIn:{id:t}});for(const n of l)o[n.id].imagem=n.imagem||""}catch(l){console.error("Erro ao ler imagens de itens - ",l)}}},async carregarImagensContatos(o){const t=Object.keys(o);if(!!t.length){await $utils.dormir(200);try{const l=await $db.hibrido.lista({table:"contato",columns:["id","apelido","imagem"],whereIn:{id:t}});for(const n of l)o[n.id].imagem=n.imagem||""}catch(l){console.error("Erro ao carregar imagens de contatos - ",l)}}},executar(){this.atualizar()},async atualizarVendas(){var t,l,n;const o=$utils.logarIni("AtendimentoVenda");await $tryLoading(async()=>{$db.hibrido.isOnline()?this.tipoLista==="itens"?await this.atualizarVendasItensOnline():await this.atualizarVendasOnline():this.tipoLista==="itens"?await this.atualizarVendasItensOffline():await this.atualizarVendasOffline()},{mensagem:"Carregando vendas...",erro:"Ocorreu um erro ao consultar vendas",carregando:a=>this.carregando=a}),$utils.logarFim(o,(((t=this.vendasAbertas)==null?void 0:t.length)||0)+(((l=this.vendasFinalizadas)==null?void 0:l.length)||0)+(((n=this.totalVendasCanceladas)==null?void 0:n.length)||0))},async atualizarVendasOnline(){var u,e,f,V,b,v;if(!this.contato.id){console.error("id contato n\xE3o fornecido em atualizarVendasOnline");return}const{vendasAbertas:o,vendasFinalizadas:t,vendasCanceladas:l}=await $db.venda.leListaCompletaOnline({where:{idContato:this.contato.id,periodo:{dataIni:this.dataIni,dataFim:this.dataFim},grupos:this.grupos},vendaCardPagination:this.vendaCardPagination}),n=[...o.data.vendas,...t.data.vendas,...l.data.vendas],a={...o.data.itens,...t.data.itens,...l.data.itens},s={...o.data.contatos,...t.data.contatos,...l.data.contatos};for(const F of n)for(const x of F.carrinho)x.item=a[x.idItem];this.vendasCompletas={dadosContatos:s,contatosEmpresa:t.data.contatosEmpresa,faturasAbertas:t.data.faturasAbertas},this.vendaCardPagination.vendasAbertas.max=(u=o.totalPages)!=null?u:0,this.vendaCardPagination.vendasFinalizadas.max=(e=t.totalPages)!=null?e:0,this.vendaCardPagination.vendasCanceladas.max=(f=l.totalPages)!=null?f:0,this.vendasAbertas=o.data.vendas,this.vendasFinalizadas=t.data.vendas,this.vendasCanceladas=l.data.vendas,this.totalVendasAbertas=$filters.numero((V=o.somaTotalDocumento)!=null?V:0,2),this.totalVendasFinalizadas=$filters.numero((b=t.somaTotalDocumento)!=null?b:0,2),this.totalVendasCanceladas=$filters.numero((v=l.somaTotalDocumento)!=null?v:0,2),this.carregarImagensContatos(this.vendasCompletas.dadosContatos)},async atualizarVendasOffline(){var E,A,G,Q,H,U;const o=await $db.venda.leListaCompletaOffline({where:{idContato:this.contato.id,periodo:{dataIni:this.dataIni,dataFim:this.dataFim},status:"aberta",grupos:this.grupos},page:this.vendaCardPagination.vendasAbertas.page,limit:5}),t=await $db.venda.leListaCompletaOffline({where:{idContato:this.contato.id,periodo:{dataIni:this.dataIni,dataFim:this.dataFim},status:"finalizada",grupos:this.grupos},page:this.vendaCardPagination.vendasFinalizadas.page,limit:5}),l=await $db.venda.leListaCompletaOffline({where:{idContato:this.contato.id,periodo:{dataIni:this.dataIni,dataFim:this.dataFim},status:"cancelada",grupos:this.grupos},page:this.vendaCardPagination.vendasCanceladas.page,limit:5}),n=[...o.data,...t.data,...l.data],a=n.map(({id:r})=>r),s=await $db.hibrido.lista({table:"documentoItem",whereIn:{idDocumento:a}}),u=await $db.hibrido.lista({table:"documento",whereIn:{documentoId:a}}),e=n.map(({idContato:r})=>r),f=n.map(({idContatoVendedor:r})=>r),V=[...e,...f].filter(Boolean),b=await $db.hibrido.lista({table:"contato",whereIn:{id:V}}),v={};for(const r of b)v[r.id]=r;const x=(await $db.hibrido.lista({table:"empresa",columns:["idContato"],whereFilter:{ativo:!0}})).map(({idContato:r})=>r),q=await $db.hibrido.lista({table:"contato",columns:["id"],whereIn:{id:x},whereFilter:{ativo:!0}}),O=(await $db.hibrido.lista({table:"documento",where:{tipo:"Fatura",idContato:this.contato.id},whereFilter:{status:"Aberta"}})).sort((r,p)=>!r.numero||r.numero<p.numero?-1:1),z=s.filter(({idItem:r})=>r).map(({idItem:r})=>r),i=await $db.hibrido.lista({table:"item",whereIn:{id:z}}),I={};for(const r of i)I[r.id]=r;for(const r of n){r.carrinho=s.filter(({idDocumento:p})=>p===r.id),r.envelopes=u.filter(p=>p.documentoId===r.id&&p.tipo==="Envelope"),r.customs=u.filter(p=>p.documentoId===r.id&&p.tipo==="Custom"),r.oss=u.filter(p=>p.documentoId===r.id&&p.tipo==="Ordem de Servi\xE7o"),r.kits=u.filter(p=>p.documentoId===r.id&&p.tipo==="Venda Kit");for(const p of r.carrinho)p.item=I[p.idItem];for(const p of r.envelopes)p.itens=r.carrinho.filter(({idDocumentoAdicional:ca})=>ca===p.id)}this.vendasCompletas={dadosContatos:v,contatosEmpresa:q,faturasAbertas:O},this.vendaCardPagination.vendasAbertas.max=(E=o.totalPages)!=null?E:0,this.vendaCardPagination.vendasFinalizadas.max=(A=t.totalPages)!=null?A:0,this.vendaCardPagination.vendasCanceladas.max=(G=l.totalPages)!=null?G:0,this.vendasAbertas=o.data,this.vendasFinalizadas=t.data,this.vendasCanceladas=l.data,this.totalVendasAbertas=$filters.numero((Q=o.somaTotalDocumento)!=null?Q:0,2),this.totalVendasFinalizadas=$filters.numero((H=t.somaTotalDocumento)!=null?H:0,2),this.totalVendasCanceladas=$filters.numero((U=l.somaTotalDocumento)!=null?U:0,2)},async atualizarVendasItensOnline(){if(!this.contato.id){console.error("id contato n\xE3o fornecido em atualizarVendasItensOnline");return}const{vendasFinalizadas:o}=await $db.venda.leListaCompletaItensOnline({where:{idContato:this.contato.id,periodo:{dataIni:this.dataIni,dataFim:this.dataFim},grupos:this.grupos},vendaCardPagination:this.vendaCardPagination}),t={};let l=[];for(const n of o.data.vendas)t[n.id]=n,!(n.tipo==="Envelope"&&n.idContatoResponsavel!==this.contato.id)&&l.push(...n.carrinho);if(this.documentos=t,this.itens=o.data.itens,l=l.filter(n=>n.idItem),this.grupos.length){const n=await this.filtraTermos(l,this.grupos);n.length>0&&(l=l.filter(a=>n.includes(a.idItem)))}this.documentosItens=l.sort((n,a)=>new Date(a.dataHoraFinalizado||a.DataHoraEmissao||0)-new Date(n.dataHoraFinalizado||n.DataHoraEmissao||0)),this.carregarImagensItens(this.itens)},async atualizarVendasItensOffline(){const o=await $db.venda.leListaCompletaOffline({where:{idContato:this.contato.id,periodo:{dataIni:this.dataIni,dataFim:this.dataFim},status:"finalizada",grupos:this.grupos},page:this.vendaCardPagination.vendasFinalizadas.page,limit:1e3}),t={},l={},n=o.data.filter(e=>e.tipo==="Envelope"&&e.idContatoResponsavel===this.contato.id||e.tipo==="Venda").map(({id:e})=>e);let a=await $db.hibrido.lista({table:"documentoItem",whereIn:{idDocumento:n}});await $db.hibrido.lista({table:"documento",whereIn:{documentoId:n}});const s=a.filter(({idItem:e})=>e).map(({idItem:e})=>e),u=await $db.hibrido.lista({table:"item",whereIn:{id:s}});for(const e of u)l[e.id]=e;for(const e of o.data)t[e.id]=e;if(this.documentos=t,this.itens=l,a=a.filter(e=>e.idItem),this.grupos.length){const e=await this.filtraTermos(a,this.grupos);e.length>0&&(a=a.filter(f=>e.includes(f.idItem)))}this.documentosItens=a.sort((e,f)=>new Date(f.dataHoraFinalizado||f.DataHoraEmissao||0)-new Date(e.dataHoraFinalizado||e.DataHoraEmissao||0))},async filtraTermos(o,t){const l=(await $db.item.ler({filtros:{ids:o.map(e=>e.idItem)}})).data,n=t.map(e=>$utils.removerAcentos(e.toUpperCase())).filter(Boolean),a=n.filter(e=>e.match(/^\d+$/)),s=n.filter(e=>!e.match(/^\d+$/)),u=new Set;for(const e of l){const f=$utils.removerAcentos([e.id,"#"+e.codigoItem,e.descricaoConcatenada,e.marca,e.referencia].join(" ").toUpperCase()),V=[e.codigoItem].map(String);let b=!0;for(const v of a)b=b&&V.includes(v);for(const v of s)b=b&&f.includes(v);b&&u.add(e.id)}return Array.from(u)},async limparFiltro(){this.grupos=[],this.dataFim=new Date;const o=new Date;if(o.setFullYear(o.getFullYear()-2),this.dataIni=o,this.contato.codigoContato){const t=await $db.configuracoes.leValorNumerico("venda.codigoconsumidor");this.contato.codigoContato===t&&(this.dataIni=this.dataFim)}}},watch:{"$route.params.id"(){const o=this.$route.params.id;!o||$db.contato.le({id:o}).then(t=>{this.contato=t,this.tipoLista="documentos",this.limparFiltro().then(()=>{this.atualizar()}).catch(l=>{$q.notifyError("Ops! Ocorreu um erro",l)})}).catch(t=>{$q.notifyError("Ops! Ocorreu um erro",t)})}},created(){$utils.emitter.off("atualizarAtendimentoVenda"),$utils.emitter.on("atualizarAtendimentoVenda",this.atualizar)},mounted(){this.sistemaPai=$utils.sistemaPai();const o=this.$route.params.id;!o||$db.contato.le({id:o}).then(t=>{this.contato=t,this.limparFiltro().then(()=>{this.atualizar()}).catch(l=>{$q.notifyError("Ops! Ocorreu um erro",l)})}).catch(t=>{$q.notifyError("Ops! Ocorreu um erro",t)})}},Na={class:"AtendimentoVenda q-pb-md"},Wa={class:"row q-mt-md",style:{display:"flex","align-items":"center"}},Ja={class:"col"},Ka={class:"col-12 col-md-6"},Ya={class:"col"},Za=g("div",{class:"col-auto",style:{"align-items":"center",display:"flex"}},[g("label",null,"at\xE9")],-1),Xa={class:"col"},$a={class:"col-auto q-ml-xs"},ae={key:0,class:"row justify-end q-mb-md"},ee={class:"row"},te={key:1,class:"row justify-end q-mb-md"},oe={key:0,class:"row justify-end q-mb-md"},ie={class:"row"},ne={key:1,class:"row justify-end q-mb-md"},se={key:0,class:"col-12",style:{"margin-bottom":"50px"}},le={key:1,class:"col-12",style:{"margin-bottom":"50px"}},de={class:"row items-center",style:{"min-width":"180px","max-width":"100%"}},re={class:"col-auto hideonmobile"},ce={class:"col",style:{"word-break":"break-word","white-space":"initial"}},me=g("br",null,null,-1),ue=g("br",null,null,-1),ve=g("br",null,null,-1),he=g("br",null,null,-1),ge=g("br",null,null,-1),fe={key:0,style:{"text-decoration":"line-through"}},pe={key:2,class:"q-pa-lg text-center"},be=g("p",null,[g("small",null,"Registros n\xE3o encontrados")],-1),Ce=[be],Ie={key:3};function Ve(o,t,l,n,a,s){var z;const u=P("GChipsV2"),e=P("campo"),f=P("row"),V=P("VendaCard"),b=P("EnvelopeCard"),v=P("avatar"),F=P("VendaModal"),x=P("Envelope"),q=P("VendaDevolucaoGarantia"),O=P("NfePrincipal");return m(),w("div",Na,[g("div",Wa,[g("div",Ja,[d(na,{class:"q-pa-sm q-ml-sm no-shadow"},{default:c(()=>[d(f,{class:"items-center q-col-gutter-md"},{default:c(()=>[g("div",Ka,[d(u,{modelValue:a.grupos,"onUpdate:modelValue":[t[0]||(t[0]=i=>a.grupos=i),s.atualizarVendas],placeholder:"Filtre por Produto, Marca, N\xFAmero..."},{prepend:c(()=>[d(B,{name:"mdi-filter"})]),_:1},8,["modelValue","onUpdate:modelValue"])]),g("div",Ya,[d(e,{modelValue:a.dataIni,"onUpdate:modelValue":t[1]||(t[1]=i=>a.dataIni=i),tipo:"data",onBlur:s.atualizar,dense:"",outlined:""},null,8,["modelValue","onBlur"])]),Za,g("div",Xa,[d(e,{modelValue:a.dataFim,"onUpdate:modelValue":t[2]||(t[2]=i=>a.dataFim=i),tipo:"data",onBlur:s.atualizar,dense:"",outlined:""},null,8,["modelValue","onBlur"])])]),_:1})]),_:1})]),g("div",$a,[d(S,{round:"",dense:"",flat:"",icon:"more_vert",color:"primary",size:"md"},{default:c(()=>[d(Pa,null,{default:c(()=>[sa((m(),C(X,{link:"","no-border":"",separator:""},{default:c(()=>[a.tipoLista==="itens"?(m(),C(M,{key:0,onClick:s.alternarLista,clickable:""},{default:c(()=>[d(T,{avatar:""},{default:c(()=>[d(B,{name:"view_stream"})]),_:1}),d(T,null,{default:c(()=>[d(j,null,{default:c(()=>[_("Vendas")]),_:1})]),_:1})]),_:1},8,["onClick"])):h("",!0),a.tipoLista==="documentos"?(m(),C(M,{key:1,onClick:s.alternarLista,clickable:""},{default:c(()=>[d(T,{avatar:""},{default:c(()=>[d(B,{name:"view_list"})]),_:1}),d(T,null,{default:c(()=>[d(j,null,{default:c(()=>[_("Produtos e Servi\xE7os")]),_:1})]),_:1})]),_:1},8,["onClick"])):h("",!0),d(M,{clickable:"",onClick:s.abrirHistoricoCliente},{default:c(()=>[d(T,{avatar:""},{default:c(()=>[d(B,{name:"mdi-account"})]),_:1}),d(T,null,{default:c(()=>[d(j,null,{default:c(()=>[_("Hist\xF3rico do Cliente")]),_:1})]),_:1})]),_:1},8,["onClick"])]),_:1})),[[la]])]),_:1})]),_:1})])]),!a.carregando&&s.temRegistros&&a.tipoLista==="documentos"?(m(),C(X,{key:0,class:"no-border"},{default:c(()=>[s.temVendasAbertas?(m(),C(N,{key:0,"model-value":!0,label:`Abertas (Total R$ ${a.totalVendasAbertas})`,group:"vendasAbertas"},{default:c(()=>[a.vendaCardPagination.vendasAbertas.max>1?(m(),w("div",ae,[d(L,{modelValue:a.vendaCardPagination.vendasAbertas.page,"onUpdate:modelValue":t[3]||(t[3]=i=>a.vendaCardPagination.vendasAbertas.page=i),min:a.vendaCardPagination.vendasAbertas.min,unelevated:"",max:a.vendaCardPagination.vendasAbertas.max,ellipses:"","max-pages":a.vendaCardPagination.maxPages,class:"float-right",onClick:s.atualizarVendas},null,8,["modelValue","min","max","max-pages","onClick"])])):h("",!0),g("div",ee,[(m(!0),w(W,null,J(a.vendasAbertas,i=>(m(),w("div",{class:"q-px-sm full-width",key:i.id},[i.tipo==="Venda"?(m(),C(V,{key:0,id:i.id,dadosVenda:i,vendasCompletas:a.vendasCompletas,onExecutar:s.executar,class:"q-mb-md"},null,8,["id","dadosVenda","vendasCompletas","onExecutar"])):h("",!0),i.tipo==="Envelope"?(m(),C(b,{key:1,id:i.id,onExecutar:s.executar,class:"q-mb-md"},null,8,["id","onExecutar"])):h("",!0)]))),128))]),a.vendaCardPagination.vendasAbertas.max>1?(m(),w("div",te,[d(L,{modelValue:a.vendaCardPagination.vendasAbertas.page,"onUpdate:modelValue":t[4]||(t[4]=i=>a.vendaCardPagination.vendasAbertas.page=i),min:a.vendaCardPagination.vendasAbertas.min,unelevated:"",max:a.vendaCardPagination.vendasAbertas.max,ellipses:"","max-pages":a.vendaCardPagination.maxPages,class:"float-right",onClick:s.atualizarVendas},null,8,["modelValue","min","max","max-pages","onClick"])])):h("",!0)]),_:1},8,["label"])):h("",!0),s.temVendasFinalizadas?(m(),C(N,{key:1,"model-value":!0,label:`Finalizadas (Total R$ ${a.totalVendasFinalizadas})`,group:"vendasFinalizadas"},{default:c(()=>[a.vendaCardPagination.vendasFinalizadas.max>1?(m(),w("div",oe,[d(L,{modelValue:a.vendaCardPagination.vendasFinalizadas.page,"onUpdate:modelValue":t[5]||(t[5]=i=>a.vendaCardPagination.vendasFinalizadas.page=i),unelevated:"",min:a.vendaCardPagination.vendasFinalizadas.min,max:a.vendaCardPagination.vendasFinalizadas.max,ellipses:"","max-pages":a.vendaCardPagination.maxPages,class:"float-right",onClick:s.atualizarVendas},null,8,["modelValue","min","max","max-pages","onClick"])])):h("",!0),g("div",ie,[(m(!0),w(W,null,J(a.vendasFinalizadas,i=>(m(),w("div",{class:"q-px-sm full-width",key:i.id},[i.tipo==="Venda"?(m(),C(V,{key:0,id:i.id,dadosVenda:i,vendasCompletas:a.vendasCompletas,onExecutar:s.executar,class:"q-mb-md"},null,8,["id","dadosVenda","vendasCompletas","onExecutar"])):h("",!0),i.tipo==="Envelope"?(m(),C(b,{key:1,id:i.id,onExecutar:s.executar,class:"q-mb-md"},null,8,["id","onExecutar"])):h("",!0)]))),128))]),a.vendaCardPagination.vendasFinalizadas.max>1?(m(),w("div",ne,[d(L,{modelValue:a.vendaCardPagination.vendasFinalizadas.page,"onUpdate:modelValue":t[6]||(t[6]=i=>a.vendaCardPagination.vendasFinalizadas.page=i),min:a.vendaCardPagination.vendasFinalizadas.min,max:a.vendaCardPagination.vendasFinalizadas.max,ellipses:"",unelevated:"","max-pages":a.vendaCardPagination.maxPages,class:"float-right",onClick:s.atualizarVendas},null,8,["modelValue","min","max","max-pages","onClick"])])):h("",!0)]),_:1},8,["label"])):h("",!0),s.temVendasCanceladas?(m(),C(N,{key:2,"model-value":!0,label:`Canceladas (Total R$ ${a.totalVendasCanceladas})`,group:"vendasCanceladas"},{default:c(()=>[a.vendaCardPagination.vendasCanceladas.max>1?(m(),w("div",se,[d(L,{modelValue:a.vendaCardPagination.vendasCanceladas.page,"onUpdate:modelValue":t[7]||(t[7]=i=>a.vendaCardPagination.vendasCanceladas.page=i),min:a.vendaCardPagination.vendasCanceladas.min,max:a.vendaCardPagination.vendasCanceladas.max,ellipses:"","max-pages":a.vendaCardPagination.maxPages,class:"float-right",onClick:s.atualizarVendas},null,8,["modelValue","min","max","max-pages","onClick"])])):h("",!0),(m(!0),w(W,null,J(a.vendasCanceladas,i=>(m(),w("div",{key:i.id},[i.tipo==="Venda"?(m(),C(V,{key:0,id:i.id,dadosVenda:i,vendasCompletas:a.vendasCompletas,onExecutar:s.executar,class:"q-mb-md"},null,8,["id","dadosVenda","vendasCompletas","onExecutar"])):h("",!0),i.tipo==="Envelope"?(m(),C(b,{key:1,id:i.id,onExecutar:s.executar,class:"q-mb-md"},null,8,["id","onExecutar"])):h("",!0)]))),128)),a.vendaCardPagination.vendasCanceladas.max>1?(m(),w("div",le,[d(L,{modelValue:a.vendaCardPagination.vendasCanceladas.page,"onUpdate:modelValue":t[8]||(t[8]=i=>a.vendaCardPagination.vendasCanceladas.page=i),min:a.vendaCardPagination.vendasCanceladas.min,max:a.vendaCardPagination.vendasCanceladas.max,ellipses:"","max-pages":a.vendaCardPagination.maxPages,class:"float-right",onClick:s.atualizarVendas},null,8,["modelValue","min","max","max-pages","onClick"])])):h("",!0)]),_:1},8,["label"])):h("",!0)]),_:1})):h("",!0),!a.carregando&&s.temRegistros&&a.tipoLista==="itens"?(m(),C(ka,{key:1,rows:a.documentosItens,columns:a.colunas,pagination:a.tablePagination,"onUpdate:pagination":t[9]||(t[9]=i=>a.tablePagination=i),class:"no-shadow text-left q-mt-md my-sticky-header-column-table"},{body:c(i=>[d(Da,{props:i},{default:c(()=>[d(R,{key:"descricao",props:i},{default:c(()=>{var I,E,A,G,Q,H,U,r;return[g("div",de,[g("div",re,[d(v,{imagem:(I=a.itens[i.row.idItem])==null?void 0:I.imagem,rotulo:(E=a.itens[i.row.idItem])==null?void 0:E.descricaoConcatenada,tamanho:"40",class:"q-mr-sm"},null,8,["imagem","rotulo"])]),g("div",ce,[_(y(i.row.idItem?(A=a.itens[i.row.idItem])==null?void 0:A.descricaoConcatenada:""),1),me,_(" "+y(i.row.idItem&&(G=a.itens[i.row.idItem])!=null&&G.referencia?"Ref. "+((Q=a.itens[i.row.idItem])==null?void 0:Q.referencia):""),1),ue,_(" "+y(i.row.idItem&&(H=a.itens[i.row.idItem])!=null&&H.codigoItem?"#"+((U=a.itens[i.row.idItem])==null?void 0:U.codigoItem):""),1),ve,_(" "+y(i.row.idItem&&((r=a.itens[i.row.idItem])==null?void 0:r.marca)||""),1)])])]}),_:2},1032,["props"]),d(R,{key:"documento",props:i},{default:c(()=>[_(y(a.documentos[i.row.idDocumento].tipo)+" #"+y(parseInt(a.documentos[i.row.idDocumento].numero)||(a.documentos[i.row.idDocumento].id||"").slice(-6)),1),he,_(" "+y(a.documentos[i.row.idDocumento].status),1),ge,_(" "+y(o.$filters.dataHora(a.documentos[i.row.idDocumento].dataHoraFinalizado||a.documentos[i.row.idDocumento].dataHoraEmissao)),1)]),_:2},1032,["props"]),d(R,{key:"valorUnitario",props:i},{default:c(()=>[i.row.valorReal!==i.row.valorItem?(m(),w("span",fe,y(o.$filters.numero(i.row.valorItem,2)),1)):h("",!0),_(" "+y(o.$filters.numero(i.row.valorReal,2)),1)]),_:2},1032,["props"]),d(R,{key:"quantidade",props:i},{default:c(()=>[_(y(i.row.quantidade*i.row.operacaoFator*-1),1)]),_:2},1032,["props"]),d(R,{key:"valorTotal",props:i},{default:c(()=>[_(y(o.$filters.numero(i.row.valorRealTotal,2)),1)]),_:2},1032,["props"]),d(R,{key:"botao",props:i},{default:c(()=>[i.row.operacaoFator===-1?(m(),C(S,{key:0,clickable:"",class:"q-ml-sm",color:"warning",dense:"",flat:"",icon:"replay",round:"",onClick:I=>s.abrirModalDevolucaoGarantia(i.row)},{default:c(()=>[d(Fa,null,{default:c(()=>[_("Devolu\xE7\xE3o/Garantia")]),_:1})]),_:2},1032,["onClick"])):h("",!0)]),_:2},1032,["props"])]),_:2},1032,["props"])]),_:1},8,["rows","columns","pagination"])):h("",!0),!a.carregando&&!s.temRegistros?(m(),w("div",pe,Ce)):h("",!0),(z=a.contato)!=null&&z.ativo?(m(),w("div",Ie,[a.sistemaPai==="optisoul"?(m(),C(Ra,{key:0,"vertical-actions-align":"right",round:"",color:"primary",class:"fixed",icon:"add",size:"lg",style:{right:"18px",bottom:"18px"},direction:"up"},{default:c(()=>[d($,{color:"primary",onClick:s.adicionarEnvelope,icon:"mdi-glasses",label:"Envelope"},null,8,["onClick"]),d($,{color:"primary",onClick:s.adicionarVenda,icon:"shopping_cart",label:"Venda"},null,8,["onClick"])]),_:1})):(m(),C(S,{key:1,round:"",color:"primary",class:"fixed",icon:"add",size:"lg",style:{right:"18px",bottom:"18px"},onClick:s.adicionarVenda},null,8,["onClick"]))])):h("",!0),d(F,{ref:"modalVenda",onExecutar:s.executar},null,8,["onExecutar"]),d(x,{ref:"modalEnvelope",onAtualizar:s.atualizar},null,8,["onAtualizar"]),d(q,{ref:"modalDevolucaoGarantia",onExecuta:s.finalizaDevolucaoGarantia},null,8,["onExecuta"]),d(O,{onFechar:s.fechouNFe},null,8,["onFechar"])])}var Oe=ia(ja,[["render",Ve]]);export{Oe as default};
