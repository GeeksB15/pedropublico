import{_ as T,a as A,by as j,p as k,o as g,d as V,f as s,w as r,C as F,i as v,P as S,R as u,j as w,e as p,L as D,l as x,x as C,Q as L,a6 as P,N as O,F as U,r as M,S as b,t as y,k as $,D as R,az as I,a4 as J,s as X,B as H,E as Q,M as B,z as Z,y as G}from"./index.20d4d726.js";import{x as z}from"./xlsx.699bbdd2.js";import{l as W}from"./listaV2.0bbb68dd.js";import{n as K}from"./Nfse.830737f3.js";import{J as Y}from"./JsonViewer.78f7d4bc.js";import"./QBreadcrumbs.a803238b.js";import"./optionsNfse.22979934.js";const aa={components:{lista:W,nfse:K,JsonViewer:Y},data(){return{lista:[],buscaCampo:"",checkboxModel:!0,im:"",dialogoSincronizarLote:{visivel:!1,listaEmpresas:[],empresa:null,periodoInicial:null,periodoFinal:null},filtros:{emitente:null,destinatario:null,numeroRps:null,numeroNfse:null,dataEmissaoNfseDe:null,dataEmissaoNfseAte:null,dataCriacaoRpsDe:null,dataCriacaoRpsAte:null},paginacao:{atual:1,maximo:1,total:1,limite:25,ordenacao:"dataEmissao",direcao:"desc"},tabSelecionada:{valor:"Rascunho"},tabs:[{rotulo:"Rascunho",value:"Rascunho"},{rotulo:"Protocoladas",value:"Protocolada"},{rotulo:"Enviadas",value:"Enviada"},{rotulo:"Canceladas",value:"Cancelada"},{rotulo:"Todos",value:"Todos"}]}},computed:{ordenacaoOpcoes(){return[{label:"Data de emiss\xE3o",value:"dataEmissao"},{label:"Data de cria\xE7\xE3o",value:"dataHoraCriacao"},{label:"RPS (Recibo provis\xF3rio)",value:"numeroRps"},{label:"N\xFAmero NFS-e",value:"numeroNfse"},{label:"Emitente",value:"xNomeEmitente"},{label:"Destinat\xE1rio",value:"xNomeDestinatario"},{label:"Valor",value:"valor"}]},direcaoOpcoes(){return[{label:"Crescente",value:"asc"},{label:"Decrescente",value:"desc"}]}},methods:{async selecionarEmpresa(){let t;const a={ativo:!0,empresas:!0},i=await $g.promptContato.show({filtro:a,placeholder:"Selecione"});if(!i)throw new Error("Nenhum contato selecionado");i.nome||(t="\xC9 preciso informar a Raz\xE3o Social do Prestador"),!t&&!i.numeroDocumentoMunicipal&&(t="\xC9 preciso informar a inscri\xE7\xE3o municipal");const o=!i.numeroDocumentoNacional||i.numeroDocumentoNacional.length<14;if(!t&&o&&(t="\xC9 preciso informar o CNPJ do Prestador"),t)throw $q.notifyError(t),new Error(t);return i},async mostrarNfse(t){this.$router.replace({params:{id:t}}),await this.$refs.modalNfse.show(t)},async criarRps(){var t;try{const a=await this.selecionarEmpresa(),i=(await $db.empresa.le({idContato:a.id}))[0],o=await $db.contatoEndereco.leEnderecoPrincipal(a.id),e={documento:a.numeroDocumentoNacional.match(/\d+/g).join(""),nome:a.nome,inscricaoMunicipal:a.numeroDocumentoMunicipal,nfseOptanteSimples:(i==null?void 0:i.nfseOptanteSimples)||"",nfseIncentivadorCultural:(i==null?void 0:i.nfseIncentivadorCultural)||"",nfseNaturezaOperacao:(i==null?void 0:i.nfseNaturezaOperacao)||"",nfseRegimeTributario:(i==null?void 0:i.nfseRegimeTributario)||"",nfseDescricaoServico:(i==null?void 0:i.nfseDescricaoServico)||"",nfseCodigoServico:(i==null?void 0:i.nfseCodigoServico)||"",nfseAliquotaIss:i==null?void 0:i.nfseAliquotaIss,nfseItensListaDeServico:JSON.parse(i==null?void 0:i.nfseItensListaDeServico)||"",ibgeCod:(o==null?void 0:o.ibgeCod)||"",cidadeUf:(o==null?void 0:o.municipio)+"-"+(o==null?void 0:o.uf)};this.im=(t=a==null?void 0:a.numeroDocumentoMunicipal)!=null?t:"";const l=await this.obterNFSeRPSMaisRecente();$utils.gconsole.log("NfseLista",{im:this.im,nfseRPSMaisRecente:l}),this.$refs.modalNfse.show(null,e,l)}catch(a){console.log(a.message)}},async obterNFSeRPSMaisRecente(){var t,a;if($db.hibrido.isOnline()){const i=await $utils.geeksApi({listaNfse:{funcao:"C79B2497-0D9C-4971-8656-2C04FF41F247",where:{inscricaoMunicipal:this.im},limit:1,page:1,sort:["JSON_VALUE(json, '$.rps.identificacaoRps.numero')"],dir:["desc"]}}),{data:o}=i.data.listaNfse;return(t=o[0])!=null?t:null}else{let i;i=await $db.hibrido.lista({table:"documentoFiscalEletronico",where:{tipo:"NFSe"}}),this.im&&(i=i.filter(e=>JSON.parse(e.json).rps.inscricaoMunicipal===this.im)),i.sort((e,l)=>{var d,f,h,N,n,E,_,q;const c=Number((N=(h=(f=JSON.parse((d=e.json)!=null?d:null))==null?void 0:f.rps)==null?void 0:h.identificacaoRps)==null?void 0:N.numero),m=Number((q=(_=(E=JSON.parse((n=l.json)!=null?n:null))==null?void 0:E.rps)==null?void 0:_.identificacaoRps)==null?void 0:q.numero);return c>m?-1:1});const o=(a=i[0])!=null?a:null;return o!=null&&o.json&&(o.rps=JSON.parse(o.json).rps),o}},async atualizar(t){var i,o;const a=$utils.logarIni("NfseLista");await $tryLoading(async()=>$db.hibrido.isOnline()?this.atualizarOnline(t):this.atualizarOffline(t)),$utils.logarFim(a,(o=(i=this.paginacao)==null?void 0:i.total)!=null?o:1)},async atualizarOffline(t){this.documentos=await $db.hibrido.lista({table:"documentoFiscalEletronico",where:{tipo:"NFSe"}});for(const o of this.documentos){const{rps:e}=JSON.parse(o.json);o.rps=e,o.showPreviewDetail=this.showPreviewDetail}const a=this.paginacao.direcao==="asc"?1:-1,i={numeroRps:(o,e)=>{var l,c;return(Number(((l=o.rps.identificacaoRps)==null?void 0:l.numero)||0)-Number(((c=e.rps.identificacaoRps)==null?void 0:c.numero)||0))*a},numeroNfse:(o,e)=>(Number(o.rps.numero||0)-Number(e.rps.numero||0))*a,valor:(o,e)=>{var l,c,m,d;return(Number(((c=(l=o.rps.servico)==null?void 0:l.valores)==null?void 0:c.valorServicos)||0)-Number(((d=(m=e.rps.servico)==null?void 0:m.valores)==null?void 0:d.valorServicos)||0))*a},dataEmissao:(o,e)=>(new Date(o.rps.dataEmissao||0)-new Date(e.rps.dataEmissao||0))*a,dataHoraCriacao:(o,e)=>(new Date(o.rps.dataHoraCriacao||0)-new Date(e.rps.dataHoraCriacao||0))*a,xNomeEmitente:(o,e)=>String(o.xNomeEmitente).localeCompare(String(e.xNomeEmitente))*a,xNomeDestinatario:(o,e)=>String(o.xNomeDestinatario).localeCompare(String(e.xNomeDestinatario))*a}[this.paginacao.ordenacao];if(this.documentos=this.documentos.sort(i),(t==null?void 0:t.id)&&(t==null?void 0:t.situacaoNfse)==="Enviada"){await this.aplicarFiltrosEPaginacao(t);return}await this.aplicarFiltrosEPaginacao()},async atualizarOnline(t){this.filtros.situacao=this.tabSelecionada.valor==="Todos"?null:this.tabSelecionada.valor;const a={numeroRps:"cast(JSON_VALUE(json, '$.rps.identificacaoRps.numero') as int)",numeroNfse:"cast(JSON_VALUE(json, '$.rps.numero') as int)",dataEmissao:"JSON_VALUE(json, '$.rps.dataEmissao')",dataHoraCriacao:"JSON_VALUE(json, '$.rps.dataHoraCriacao')",valor:"cast(JSON_VALUE(json, '$.rps.servico.valores.valorServicos') as decimal(10,2))"}[this.paginacao.ordenacao]||this.paginacao.ordenacao,i=await $utils.geeksApi({listaNfse:{funcao:"C79B2497-0D9C-4971-8656-2C04FF41F247",where:{...this.filtros,destinatario:this.filtros.destinatario||this.buscaCampo,id:t==null?void 0:t.id},limit:this.paginacao.limite,page:this.paginacao.atual,sort:[a],dir:[this.paginacao.direcao]}}),{data:o,total:e,totalPages:l}=i.data.listaNfse;for(const c of o)c.showPreviewDetail=this.showPreviewDetail;this.lista=o,this.paginacao.total=e,this.paginacao.maximo=l},async aplicarFiltrosEPaginacao(t){if(this.aplicarFiltroPelaTab({situacaoNfse:t==null?void 0:t.situacaoNfse}),t!=null&&t.id&&(this.buscaCampo=t==null?void 0:t.id),/^[A-F|0-9]{8}-[A-F|0-9]{4}-[A-F|0-9]{4}-[A-F|0-9]{4}-[A-F|0-9]{12}$/.test(this.buscaCampo)){this.paginacao.atual=1,this.paginacao.maximo=1,this.paginacao.total=1,this.listaTmp=this.listaTmp.filter(o=>o.id===this.buscaCampo),this.lista=this.listaTmp;return}if(this.filtros.emitente){const o=new RegExp(this.filtros.emitente,"i");this.listaTmp=this.listaTmp.filter(e=>o.test(e.xNomeEmitente))}if(this.filtros.destinatario||this.buscaCampo){const o=this.buscaCampo||this.filtros.destinatario,e=new RegExp(o,"i");this.listaTmp=this.listaTmp.filter(l=>e.test(l.xNomeDestinatario))}if(this.filtros.numeroRps){const o=new RegExp(this.filtros.numeroRps);this.listaTmp=this.listaTmp.filter(e=>o.test(e.rps.identificacaoRps.numero))}if(this.filtros.numeroNfse&&(this.listaTmp=this.listaTmp.filter(o=>o.rps.numero===this.filtros.numeroNfse)),this.filtros.dataEmissaoNfseDe&&this.filtros.dataEmissaoNfseDe.length===10){const o=this.filtros.dataEmissaoNfseDe.split("/"),e=new Date(Number(o[2]),Number(o[1])-1,Number(o[0]));this.listaTmp=this.listaTmp.filter(l=>new Date(new Date(l.rps.dataEmissao).toDateString())>=e)}if(this.filtros.dataEmissaoNfseAte&&this.filtros.dataEmissaoNfseAte.length===10){const o=this.filtros.dataEmissaoNfseAte.split("/"),e=new Date(Number(o[2]),Number(o[1])-1,Number(o[0]));this.listaTmp=this.listaTmp.filter(l=>new Date(new Date(l.rps.dataEmissao).toDateString())<=e)}if(this.filtros.dataCriacaoRpsDe&&this.filtros.dataCriacaoRpsDe.length===10){const o=this.filtros.dataCriacaoRpsDe.split("/"),e=new Date(Number(o[2]),Number(o[1])-1,Number(o[0]));this.listaTmp=this.listaTmp.filter(l=>new Date(new Date(l.rps.dataHoraCriacao).toDateString())>=e)}if(this.filtros.dataCriacaoRpsAte&&this.filtros.dataCriacaoRpsAte.length===10){const o=this.filtros.dataCriacaoRpsAte.split("/"),e=new Date(Number(o[2]),Number(o[1])-1,Number(o[0]));this.listaTmp=this.listaTmp.filter(l=>new Date(new Date(l.rps.dataHoraCriacao).toDateString())<=e)}this.setupPaginacao();const a=this.paginacao.atual*this.paginacao.limite-this.paginacao.limite,i=this.paginacao.atual*this.paginacao.limite;this.lista=this.listaTmp.slice(a,i)},aplicarFiltroPelaTab(t){if(t!=null&&t.situacaoNfse&&(this.tabSelecionada={valor:t.situacaoNfse}),this.tabSelecionada.valor==="Todos"){this.listaTmp=this.documentos;return}const a=this.tabSelecionada.valor;this.listaTmp=this.documentos.filter(i=>i.situacao===a)},setupPaginacao(){const t=Math.ceil(this.listaTmp.length/this.paginacao.limite);this.paginacao.atual=this.paginacao.atual>t?t:this.paginacao.atual,this.paginacao.total=this.listaTmp.length,this.paginacao.maximo=t},toogleTodosPreview(){this.showPreviewDetail=!this.showPreviewDetail;for(const t of this.lista)t.showPreviewDetail=this.showPreviewDetail},async limparFiltros_click(){this.filtros={emitente:null,destinatario:null,numeroRps:null,numeroNfse:null,dataEmissaoNfseDe:null,dataEmissaoNfseAte:null,dataCriacaoRpsDe:null,dataCriacaoRpsAte:null},await this.atualizar()},async exportarXLSX_click(){try{$q.loading.show();const t=$utils.eliminarVazios(this.filtros);delete t.ativo,this.tabSelecionada.valor==="Ativos"&&(t.ativo=!0),this.tabSelecionada.valor==="Excluidos"&&(t.ativo=!1);const a=await $db.item.leRefatorado({filtros:t,limit:999999,page:1,sort:"descricao"}),i=z.utils.book_new(),o=z.utils.json_to_sheet(a.data,{header:Object.keys(a.data[0])});z.utils.book_append_sheet(i,o,"itens"),z.writeFile(i,"itens.xlsx")}catch(t){$q.notifyError("Erro iniciar",t)}finally{$q.loading.hide()}},abrirModalDeCancelamento(t){$q.dialog({title:"Cancelar NFS-e",message:"Qual o motivo do cancelamento?",prompt:{model:"",isValid:a=>!!a},cancel:!0,persistent:!0}).onOk(async a=>{const{rps:i}=t,o={numero:i.numero,motivoCancelamento:a,inscricaoMunicipal:i.prestador.inscricaoMunicipal,cnpj:i.prestador.documento,codigoMunicipio:i.servico.municipioPrestacaoServico,codigoCancelamento:5};await this.cancelarNfse(o,t)})},async cancelarNfse(t,a){var i,o,e,l,c;this.$q.loading.show();try{if((i=a.rps)!=null&&i.plugNotasConsulta){console.log("cancelamento via plugNotas");const m={motivo:t.motivoCancelamento},d=await $api.plugnotas.nfse.solicitarCancelamentoNFSe((o=a.rps.plugNotasConsulta)==null?void 0:o.id,m);if((d==null?void 0:d.message)==="Cancelamento em processamento"&&((e=d==null?void 0:d.data)==null?void 0:e.protocol))if((await $api.plugnotas.nfse.consultarCancelamentoNFSe((l=d==null?void 0:d.data)==null?void 0:l.protocol)).data.status==="CONCLUIDO"){a.rps.motivoCancelamento=t.motivoCancelamento,a.rps.status="2";const h={...a,situacao:"Cancelada",json:JSON.stringify({rps:a.rps})};await $db.documentoFiscalEletronico.grava({atual:h,original:a});let N={};h.id&&(N=(await $db.hibrido.lista({table:"documentoFiscalEletronicoXml",where:{idDocumentoFiscalEletronico:h.id}}))[0],await $db.documentoFiscalEletronicoXml.grava({atual:{...N,situacao:h.situacao},original:N})),$q.notifyPositive("NFS-e cancelada!")}else $q.notifyError("N\xE3o foi poss\xEDvel realizar o cancelamento, por favor tente novamente!")}if(!((c=a.rps)!=null&&c.plugNotasConsulta))if((await A.post("https://api.b15.com.br/integradorjs/nfse/cancelar",{jsonParaXML:t})).data.xmlPassou){$q.notifyPositive("NFS-e cancelada!"),a.rps.motivoCancelamento=t.motivoCancelamento,a.rps.status="2";const d={...a,situacao:"Cancelada",json:JSON.stringify({rps:a.rps})};await $db.documentoFiscalEletronico.grava({atual:d,original:a});let f={};d.id&&(f=(await $db.hibrido.lista({table:"documentoFiscalEletronicoXml",where:{idDocumentoFiscalEletronico:d.id}}))[0],await $db.documentoFiscalEletronicoXml.grava({atual:{...f,situacao:d.situacao},original:f}))}else $q.notifyError("N\xE3o foi poss\xEDvel realizar o cancelamento, por favor tente novamente!")}catch{$q.notifyError("Falha ao enviar XML")}await this.atualizar(),this.$q.loading.hide()},confirmarExclusaoNfse(t){$q.dialog({title:"Remover NFS-e",message:"Deseja remover esta NFS-e?",cancel:{label:"N\xE3o",push:!0,color:"tertiary",flat:!0},ok:{label:"Sim",push:!0,class:"bg-negative",textColor:"white",flat:!0}}).onOk(async()=>{try{await $db.documentoFiscalEletronico.remove(t),$q.notifyPositive("NFS-e removida com sucesso")}catch{$q.notifyError("Falha ao remover NFS-e")}this.atualizar()})},async downloadPDF(t){var o;let a=await $db.hibrido.le({table:"documentoFiscalEletronico",id:t}),i=JSON.parse((o=a==null?void 0:a.json)!=null?o:null);try{$q.loading.show({message:"Solicitando URL...",html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"}),i.rps.pdf=await $db.nfse.solicitarURLImpressao(t);let e=document.createElement("a");e.href=i.rps.pdf,e.download=`nfse-${i.rps.identificacaoRps.numero}.pdf`,e.click()}catch(e){console.error(e.message)}finally{$q.loading.hide()}},async solicitarURLImpressao(t){var e,l,c;let a=await $db.hibrido.le({table:"documentoFiscalEletronico",id:t}),i=JSON.parse((e=a==null?void 0:a.json)!=null?e:null),o;try{$q.loading.show({message:"Solicitando URL...",html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"}),o=await $db.nfse.solicitarURLImpressao(t),(l=i==null?void 0:i.rps)!=null&&l.plugNotasConsulta&&window.open("","_blank").document.write(`<iframe width='100%' height='100%' src='${o}'></iframe>`),(c=i==null?void 0:i.rps)!=null&&c.plugNotasConsulta||window.open(o,"_blank"),await this.atualizar()}catch(m){let d=m.message.replace("db.nfse.sincronizarLote: ","");d.length!==m.message&&$q.notifyError(d),d.length===m.message&&console.error(m.message)}finally{$q.loading.hide()}},async solicitarURLImpressaoEmLote(){var a;const t=$utils.clonarV2(this.lista.filter(i=>i.situacao==="Enviada"));t.sort((i,o)=>{var c,m,d,f;const e=(m=(c=i==null?void 0:i.rps)==null?void 0:c.identificacaoRps)==null?void 0:m.numero,l=(f=(d=o==null?void 0:o.rps)==null?void 0:d.identificacaoRps)==null?void 0:f.numero;return e>l?1:-1});for(const i of t)try{let o=await $db.hibrido.le({table:"documentoFiscalEletronico",id:i.id}),e=JSON.parse((a=o==null?void 0:o.json)!=null?a:null),l;l=await $db.nfse.solicitarURLImpressao(i.id)}catch(o){console.log(o.message)}},async baixarXml(t){var o,e;let{xml:a}=t.rps;if((!a||/^https:\/\/.+$/.test(a))&&((e=(o=t.rps)==null?void 0:o.plugNotasConsulta)==null?void 0:e.xml)){const l=t.rps.plugNotasConsulta.xml;a=await $api.plugnotas.nfse.baixarXmlNFSe(l,t)}if(a){const l=document.createElement("a");var i=new Blob([a],{type:"text/plain"});l.setAttribute("href",window.URL.createObjectURL(i)),l.setAttribute("download",`${t.rps.identificacaoRps.numero}.xml`),l.dataset.downloadurl=["text/plain",l.download,l.href].join(":"),l.click()}a||this.$q.notifyError("N\xE3o foi poss\xEDvel recuperar o XML")},async recarregarPDF(t){var e,l,c;let a=await $db.hibrido.le({table:"documentoFiscalEletronico",id:t}),i=$utils.clonarV2(a),o=JSON.parse((e=a==null?void 0:a.json)!=null?e:null);(l=o.rps.plugNotasConsulta)!=null&&l.pdf&&((c=o.rps.plugNotasConsulta)==null||delete c.pdf),o.rps.pdf&&delete o.rps.pdf,a.json=o,await $db.documentoFiscalEletronico.grava({atual:a,original:i}),this.solicitarURLImpressao(t)},async enviarEmailNfse(t){var a,i;try{if(this.$q.loading.show(),!t.cpfCnpjDestinatario||!t.id)return;const o=await $db.hibrido.le({table:"documentoFiscalEletronico",id:t.id});if(!(o!=null&&o.id))return;const l=(await $db.contato.ler({filtros:{termoBusca:o.cpfCnpjDestinatario,ativo:!0}})).data.find(h=>{var N;return((N=h.numeroDocumentoNacional)!=null?N:"").replace(/\D/g,"")===o.cpfCnpjDestinatario}),c=(i=JSON.parse((a=o.json)!=null?a:null))==null?void 0:i.rps;if(!c)return;let m;this.$q.loading.hide();try{m=await new Promise((h,N)=>{var n;$q.dialog({title:"Informe o e-mail",message:"E-mail do destinat\xE1rio",prompt:{model:(n=l==null?void 0:l.email)!=null?n:"",isValid:E=>/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(E.toLowerCase()),type:"text"},cancel:!0,persistent:!1}).onOk(E=>{h(E)}).onCancel(()=>{N("Cancelado pelo usu\xE1rio")}).onDismiss(()=>{N("Cancelado pelo usu\xE1rio")})}).catch(h=>{throw new Error(h)})}catch(h){console.log(h.message);return}this.$q.loading.show();const d=[{name:"nfse.xml",content:c.xml}];c.link&&d.push({name:"nfse.pdf",url:c.link,method:"url2pdf"});const f={host:"smtp.gmail.com",port:587,ssl:!0,auth:{user:"auto@geekssolucoes.com.br",pass:"xpto@9@9"},from:"Geeks Solu\xE7\xF5es <auto@geekssolucoes.com.br>",to:m,subject:`Nota Fiscal Eletr\xF4nica de Servi\xE7os N\xBA ${c.numero}`,text:`Voc\xEA est\xE1 recebendo os arquivos digitais NFS-e (Nota Fiscal Eletr\xF4nica de Servi\xE7os) da empresa ${o.xNomeEmitente}`,attachments:d};await A({baseURL:"https://api.b15.com.br",method:"post",url:"/email/v2",data:f}),this.$q.notifyPositive("E-mail enviado com sucesso")}catch{this.$q.notifyError("Erro ao enviar email")}finally{this.$q.loading.hide()}},async enviarLote(){var t,a;try{$q.loading.show({message:"Preparando envio do lote...",html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"});const i=$utils.clonarV2(this.lista.filter(o=>o.situacao==="Rascunho"));$utils.gconsole.log("NFSeEnviaLote",`Inicio envio de lote com ${i.length} notas`);for(const o of i){const e=(await $db.hibrido.lista({table:"documentoFiscalEletronicoXml",where:{idDocumentoFiscalEletronico:o.id}}))[0],l=o.rps;l!=null&&l.dataEmissao||(l.dataEmissao=$utils.dataAtual()),$q.loading.show({message:`Enviando...
                <br /><br />
                <strong>Lote</strong> ${l.numeroLote}<br />
                <strong>RPS</strong> ${l.identificacaoRps.numero}<br />
                <strong>S\xE9rie</strong> ${l.identificacaoRps.serie}<br />
                <br />
                ${l.tomador.razaoSocial}`,html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"}),$utils.gconsole.log("NFSeEnviaLote",`rps:${(t=l==null?void 0:l.identificacaoRps)==null?void 0:t.numero} tomador:${l.tomador.razaoSocial}`);const{nfse:c,situacao:m}=await $db.nfse.emitir({nfse:l,aguardarRetorno:!1}),d={id:o.id,tipo:"NFSe",tpAmb:"2",situacao:m,mod:"",serie:"",nNF:"",chNFe:"",vNF:0,dhEmi:j.formatarDataNFe(new Date((a=this.nfse)==null?void 0:a.dataEmissao)),cpfCnpjEmitente:c.prestador.documento,xNomeEmitente:c.prestador.razaoSocial,cpfCnpjDestinatario:c.tomador.documento,xNomeDestinatario:c.tomador.razaoSocial,dataHoraEmissao:c==null?void 0:c.dataEmissao,dataHoraCriacao:o.dataHoraCriacao||$utils.dataAtual(),json:JSON.stringify({rps:c})},f={id:(e==null?void 0:e.id)||$utils.uuid(),tipo:d.tipo,situacao:m,tpAmb:d.tpAmb,dataHoraEnvio:c==null?void 0:c.dataEmissao,cpfCnpjEmitente:c.prestador.documento,xmlEnvio:c.xml,idDocumentoFiscalEletronico:d.id};await $db.documentoFiscalEletronico.grava({atual:d,original:o}),await $db.documentoFiscalEletronicoXml.grava({atual:f,original:e})}this.atualizar()}catch(i){console.log(i.message)}finally{$q.loading.hide()}},async protocolarLote(){var t;try{$q.loading.show({message:"Preparando envio do lote...",html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"});const a=$utils.clonarV2(this.lista.filter(i=>i.situacao==="Protocolada"));a.sort((i,o)=>{var c,m,d,f;const e=(m=(c=i==null?void 0:i.rps)==null?void 0:c.identificacaoRps)==null?void 0:m.numero,l=(f=(d=o==null?void 0:o.rps)==null?void 0:d.identificacaoRps)==null?void 0:f.numero;return e>l?1:-1});for(const i of a){const o=(await $db.hibrido.lista({table:"documentoFiscalEletronicoXml",where:{idDocumentoFiscalEletronico:i.id}}))[0],e=i==null?void 0:i.rps;e!=null&&e.dataEmissao||(e.dataEmissao=$utils.dataAtual()),$q.loading.show({message:`Enviando...
                <br /><br />
                <strong>Lote</strong> ${e.numeroLote}<br />
                <strong>RPS</strong> ${e.identificacaoRps.numero}<br />
                <strong>S\xE9rie</strong> ${e.identificacaoRps.serie}<br />
                <br />
                ${e.tomador.razaoSocial}`,html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"});const{nfse:l,situacao:c}=await $db.nfse.emitir({nfse:e,aguardarRetorno:!1}),m={id:i.id,tipo:"NFSe",tpAmb:"2",situacao:c,mod:"",serie:"",nNF:"",chNFe:"",vNF:0,dhEmi:j.formatarDataNFe(new Date((t=this.nfse)==null?void 0:t.dataEmissao)),cpfCnpjEmitente:l.prestador.documento,xNomeEmitente:l.prestador.razaoSocial,cpfCnpjDestinatario:l.tomador.documento,xNomeDestinatario:l.tomador.razaoSocial,dataHoraEmissao:l==null?void 0:l.dataEmissao,dataHoraCriacao:i.dataHoraCriacao||$utils.dataAtual(),json:JSON.stringify({rps:l})},d={id:(o==null?void 0:o.id)||$utils.uuid(),tipo:m.tipo,situacao:c,tpAmb:m.tpAmb,dataHoraEnvio:l==null?void 0:l.dataEmissao,cpfCnpjEmitente:l.prestador.documento,xmlEnvio:l.xml,idDocumentoFiscalEletronico:m.id};await $db.documentoFiscalEletronico.grava({atual:m,original:i}),await $db.documentoFiscalEletronicoXml.grava({atual:d,original:o})}this.atualizar()}catch(a){console.log(a.message)}finally{$q.loading.hide()}},async abrirDialogoSincronizarLote(){const t=new Date,a=(await $db.contato.ler({filtros:{ativo:!0,empresas:!0}})).data;this.dialogoSincronizarLote.listaEmpresas=a.map(i=>({value:i.id,label:i.nome+" - "+i.numeroDocumentoNacional,cnpj:i.numeroDocumentoNacional,inscricaoMunicipal:i.numeroDocumentoMunicipal})),this.dialogoSincronizarLote.empresa=this.dialogoSincronizarLote.listaEmpresas[0],this.dialogoSincronizarLote.periodoInicial=t,this.dialogoSincronizarLote.periodoFinal=t,this.dialogoSincronizarLote.visivel=!0},async sincronizarLote(){try{$q.loading.show({message:"Obtendo dados do servidor...",html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"}),await $db.nfse.sincronizarLote({inscricaoMunicipal:this.dialogoSincronizarLote.empresa.inscricaoMunicipal,cnpj:this.dialogoSincronizarLote.empresa.cnpj,periodo:{inicial:this.dialogoSincronizarLote.periodoInicial,final:this.dialogoSincronizarLote.periodoFinal}},(t,a)=>$q.loading.show({message:`${a}...
                <br /><br />
                <strong>Lote</strong> ${t.numeroLote}<br />
                <strong>RPS</strong> ${t.identificacaoRps.numero}<br />
                <strong>S\xE9rie</strong> ${t.identificacaoRps.serie}<br />
                <br />
                ${t.tomador.razaoSocial}`,html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"})),this.dialogoSincronizarLote.visivel=!1,this.atualizar()}catch(t){let a=t.message.replace("db.nfse.sincronizarLote: ","");a.length!==t.message&&$q.notifyError(a),a.length===t.message&&console.error(t.message)}finally{$q.loading.hide()}},async mostrarJsonViewer(){await this.$refs.jsonViewer.show(this)}},mounted(){this.$route.params.id&&this.$route.params.id.length&&this.mostrarNfse(this.$route.params.id),this.atualizar()}},oa=C("div",{class:"q-mt-md"},"Data de emiss\xE3o NFS-e",-1),ea={class:"row q-col-gutter-x-sm"},ta=C("div",{class:"q-mt-md"},"Data de cria\xE7\xE3o RPS",-1),ia={class:"row q-col-gutter-x-sm"},sa=C("div",{class:"q-mt-lg"},"Ordena\xE7\xE3o",-1),la={class:"text-tertiary q-col-gutter-xs"},ra={class:"row full-width"},na={class:"col-12"},ca={class:"col"},da=C("div",{class:"col-auto",style:{"align-items":"center",display:"flex"}},[C("label",null,"at\xE9")],-1),ua={class:"col"},ma={class:"q-mt-lg text-right"};function pa(t,a,i,o,e,l){const c=k("campo"),m=k("badge"),d=k("lista"),f=k("nfse"),h=k("JsonViewer"),N=k("row");return g(),V("div",null,[s(d,{titulo:"NFS-e",checkboxModel:e.checkboxModel,"onUpdate:checkboxModel":a[16]||(a[16]=n=>e.checkboxModel=n),buscaCampo:e.buscaCampo,"onUpdate:buscaCampo":a[17]||(a[17]=n=>e.buscaCampo=n),onCriar_click:l.criarRps,onFiltro_change:l.atualizar,onLimparFiltros_click:l.limparFiltros_click,onAbrirTodosPreview:l.toogleTodosPreview,onExportarXLSX_click:l.exportarXLSX_click,lista:e.lista,tabs:e.tabs,tabSelecionada:e.tabSelecionada,paginacao:e.paginacao,filtros:e.filtros,permissaoExtras:!0,exportarXLSXVisible:!1,checkboxVisible:!1,removerTodosVisible:!1,showQuickAdd:!1},{menuExtras:r(()=>[F((g(),v(S,{clickable:"",onClick:a[0]||(a[0]=n=>l.enviarLote())},{default:r(()=>[s(u,{avatar:""},{default:r(()=>[s(w,{name:"mdi-file-replace",size:"sm"})]),_:1}),s(u,null,{default:r(()=>[p("Enviar Lote")]),_:1})]),_:1})),[[D]]),F((g(),v(S,{clickable:"",onClick:a[1]||(a[1]=n=>l.protocolarLote())},{default:r(()=>[s(u,{avatar:""},{default:r(()=>[s(w,{name:"mdi-file-replace",size:"sm"})]),_:1}),s(u,null,{default:r(()=>[p("Protocolar Lote")]),_:1})]),_:1})),[[D]]),F((g(),v(S,{clickable:"",onClick:a[2]||(a[2]=n=>l.solicitarURLImpressaoEmLote())},{default:r(()=>[s(u,{avatar:""},{default:r(()=>[s(w,{name:"mdi-file-replace",size:"sm"})]),_:1}),s(u,null,{default:r(()=>[p("Solicitar PDF Lote")]),_:1})]),_:1})),[[D]]),F((g(),v(S,{clickable:"",onClick:a[3]||(a[3]=n=>l.abrirDialogoSincronizarLote())},{default:r(()=>[s(u,{avatar:""},{default:r(()=>[s(w,{name:"mdi-file-replace",size:"sm"})]),_:1}),s(u,null,{default:r(()=>[p("Sincronizar Lote")]),_:1})]),_:1})),[[D]]),t.$db.usuario.desenvolvedor()?F((g(),v(S,{key:0,clickable:"",onClick:a[4]||(a[4]=n=>l.mostrarJsonViewer())},{default:r(()=>[s(u,{avatar:""},{default:r(()=>[s(w,{name:"mdi-file-replace",size:"sm"})]),_:1}),s(u,null,{default:r(()=>[p("Ver Objeto")]),_:1})]),_:1})),[[D]]):x("",!0)]),filtroCampos:r(()=>[s(c,{modelValue:e.filtros.emitente,"onUpdate:modelValue":a[5]||(a[5]=n=>e.filtros.emitente=n),rotulo:"Emitente",dense:""},null,8,["modelValue"]),s(c,{modelValue:e.filtros.destinatario,"onUpdate:modelValue":a[6]||(a[6]=n=>e.filtros.destinatario=n),rotulo:"Destinat\xE1rio",dense:""},null,8,["modelValue"]),s(c,{modelValue:e.filtros.numeroRps,"onUpdate:modelValue":a[7]||(a[7]=n=>e.filtros.numeroRps=n),rotulo:"RPS (Recibo provis\xF3rio)",dense:""},null,8,["modelValue"]),s(c,{modelValue:e.filtros.numeroNfse,"onUpdate:modelValue":a[8]||(a[8]=n=>e.filtros.numeroNfse=n),rotulo:"N\xFAmero NFS-e",dense:""},null,8,["modelValue"]),oa,C("div",ea,[s(L,{class:"col-12 col-md-6",modelValue:e.filtros.dataEmissaoNfseDe,"onUpdate:modelValue":a[9]||(a[9]=n=>e.filtros.dataEmissaoNfseDe=n),mask:"##/##/####",label:"De",dense:""},null,8,["modelValue"]),s(L,{class:"col-12 col-md-6",modelValue:e.filtros.dataEmissaoNfseAte,"onUpdate:modelValue":a[10]||(a[10]=n=>e.filtros.dataEmissaoNfseAte=n),mask:"##/##/####",label:"At\xE9",dense:""},null,8,["modelValue"])]),ta,C("div",ia,[s(L,{class:"col-12 col-md-6",modelValue:e.filtros.dataCriacaoRpsDe,"onUpdate:modelValue":a[11]||(a[11]=n=>e.filtros.dataCriacaoRpsDe=n),mask:"##/##/####",label:"De",dense:""},null,8,["modelValue"]),s(L,{class:"col-12 col-md-6",modelValue:e.filtros.dataCriacaoRpsAte,"onUpdate:modelValue":a[12]||(a[12]=n=>e.filtros.dataCriacaoRpsAte=n),mask:"##/##/####",label:"At\xE9",dense:""},null,8,["modelValue"])]),sa,s(P,{modelValue:e.paginacao.ordenacao,"onUpdate:modelValue":a[13]||(a[13]=n=>e.paginacao.ordenacao=n),options:l.ordenacaoOpcoes,dense:"","emit-value":"","map-options":"",class:"q-field--with-bottom"},null,8,["modelValue","options"]),s(P,{modelValue:e.paginacao.direcao,"onUpdate:modelValue":a[14]||(a[14]=n=>e.paginacao.direcao=n),options:l.direcaoOpcoes,dense:"","emit-value":"","map-options":"",class:"q-field--with-bottom"},null,8,["modelValue","options"]),s(c,{modelValue:e.paginacao.limite,"onUpdate:modelValue":a[15]||(a[15]=n=>e.paginacao.limite=n),rotulo:"Quantidade por p\xE1gina",tipo:"quantidade",min:"1",class:"q-field--with-bottom q-mt-lg"},null,8,["modelValue"])]),itemLista:r(()=>[e.lista.length>0?(g(),v(O,{key:0,bordered:"",class:"bg-white q-mb-xs rounded-borders",style:{"min-height":"calc(100vh - 200px)"}},{default:r(()=>[(g(!0),V(U,null,M(e.lista,n=>(g(),V("div",{key:n},[s(S,null,{default:r(()=>[s(u,{top:"",class:"col-2 gt-sm"},{default:r(()=>[s(b,null,{default:r(()=>[p(y(n.rps.identificacaoRps.numero||0)+" RPS ",1),s($,null,{default:r(()=>[p(" RPS (Recibo provis\xF3rio) ")]),_:1})]),_:2},1024),s(b,{caption:""},{default:r(()=>[p(y(n.rps.numero)+" ",1),s($,null,{default:r(()=>[p(" N\xBA Nota ")]),_:1})]),_:2},1024)]),_:2},1024),s(u,{top:"",class:"col-5 gt-sm"},{default:r(()=>[s(b,null,{default:r(()=>[p(y(n.xNomeDestinatario),1)]),_:2},1024),s(b,{caption:""},{default:r(()=>[p(y(n.cpfCnpjDestinatario),1)]),_:2},1024)]),_:2},1024),s(u,null,{default:r(()=>[n.rps.mensagemDeRetorno?(g(),v(w,{key:0,name:"report",size:"sm",color:"red"},{default:r(()=>[s($,null,{default:r(()=>[p(y(n.rps.mensagemDeRetorno),1)]),_:2},1024)]),_:2},1024)):x("",!0)]),_:2},1024),s(u,null,{default:r(()=>[s(b,{lines:"1"},{default:r(()=>[s(w,{name:"event",class:"text-tertiary"}),p(" "+y(t.$filters.data(n.rps.dataEmissao))+" ",1),s($,null,{default:r(()=>[p("Data/Hora da emiss\xE3o: "+y(t.$filters.dataHora(n.rps.dataEmissao)),1)]),_:2},1024)]),_:2},1024)]),_:2},1024),s(u,{avatar:""},{default:r(()=>[s(m,{class:"q-mr-sm",escuro:"",cor:"tertiary"},{default:r(()=>[p(y(n.situacao),1)]),_:2},1024)]),_:2},1024),s(u,null,{default:r(()=>[s(u,{caption:"",class:"text-right text-tertiary"},{default:r(()=>[C("span",null,[p(y(t.$filters.numero(n.rps.servico.valores.valorServicos,2))+" ",1),s($,null,{default:r(()=>[p("Valor dos Servi\xE7os")]),_:1})])]),_:2},1024)]),_:2},1024),s(u,{side:"",center:""},{default:r(()=>[C("div",la,[s(R,{icon:n!=null&&n.showPreviewDetail?"keyboard_arrow_up":"keyboard_arrow_down",class:"gt-xs",clickable:"",color:"tertiary",dense:"",flat:"",round:"",size:"12px",onClick:E=>n.showPreviewDetail=!(n!=null&&n.showPreviewDetail)},null,8,["icon","onClick"]),s(R,{class:"gt-xs",color:"tertiary",dense:"",flat:"",icon:"edit",round:"",size:"12px",onClick:E=>l.mostrarNfse(n.id)},null,8,["onClick"]),n.situacao==="Rascunho"?(g(),v(R,{key:0,class:"gt-xs",color:"tertiary",icon:"delete",size:"12px",onClick:E=>l.confirmarExclusaoNfse(n.id),dense:"",flat:"",round:""},null,8,["onClick"])):x("",!0),n.situacao==="Enviada"?(g(),v(R,{key:1,dense:"",flat:"",icon:"more_vert",round:"",size:"12px"},{default:r(()=>[s(I,null,{default:r(()=>[F((g(),v(O,{link:"",separator:""},{default:r(()=>{var E;return[s(S,{clickable:"",onClick:_=>l.solicitarURLImpressao(n.id)},{default:r(()=>[s(u,{avatar:""},{default:r(()=>[s(w,{name:"print"})]),_:1}),s(u,null,{default:r(()=>[s(b,null,{default:r(()=>[p("Imprimir")]),_:1})]),_:1})]),_:2},1032,["onClick"]),(E=n.rps)!=null&&E.plugNotasConsulta?(g(),v(S,{key:0,clickable:"",onClick:_=>l.downloadPDF(n.id)},{default:r(()=>[s(u,{avatar:""},{default:r(()=>[s(w,{name:"download_for_offline"})]),_:1}),s(u,null,{default:r(()=>[s(b,null,{default:r(()=>[p("Download PDF")]),_:1})]),_:1})]),_:2},1032,["onClick"])):x("",!0),s(S,{clickable:"",onClick:_=>l.recarregarPDF(n.id)},{default:r(()=>[s(u,{avatar:""},{default:r(()=>[s(w,{name:"download_for_offline"})]),_:1}),s(u,null,{default:r(()=>[s(b,null,{default:r(()=>[p("Recarregar PDF")]),_:1})]),_:1})]),_:2},1032,["onClick"]),n.rps.numero&&n.situacao==="Enviada"?(g(),v(S,{key:1,clickable:"",onClick:_=>l.abrirModalDeCancelamento(n)},{default:r(()=>[s(u,{avatar:""},{default:r(()=>[s(w,{name:"delete"})]),_:1}),s(u,null,{default:r(()=>[s(b,null,{default:r(()=>[p("Cancelar")]),_:1})]),_:1})]),_:2},1032,["onClick"])):x("",!0),n.rps.xml?(g(),v(S,{key:2,clickable:"",onClick:_=>l.baixarXml(n)},{default:r(()=>[s(u,{avatar:""},{default:r(()=>[s(w,{name:"mdi-download"})]),_:1}),s(u,null,{default:r(()=>[s(b,null,{default:r(()=>[p("Baixar XML")]),_:1})]),_:1})]),_:2},1032,["onClick"])):x("",!0),n.rps.xml?(g(),v(S,{key:3,clickable:"",onClick:_=>l.enviarEmailNfse(n)},{default:r(()=>[s(u,{avatar:""},{default:r(()=>[s(w,{name:"mail"})]),_:1}),s(u,null,{default:r(()=>[s(b,null,{default:r(()=>[p("Enviar por email")]),_:1})]),_:1})]),_:2},1032,["onClick"])):x("",!0)]}),_:2},1024)),[[D]])]),_:2},1024)]),_:2},1024)):x("",!0)])]),_:2},1024)]),_:2},1024),n!=null&&n.showPreviewDetail?(g(),v(S,{key:0,align:"left",class:"collumnOnMobile q-px-md q-py-xs"},{default:r(()=>[C("div",ra,[s(u,null,{default:r(()=>[s(b,{caption:"",class:"text-tertiary"},{default:r(()=>[p("Emitente")]),_:1}),s(b,{class:"text-tertiary"},{default:r(()=>[p(y(n.xNomeEmitente),1)]),_:2},1024)]),_:2},1024),s(u,{avatar:""},{default:r(()=>[s(w,{name:"event",class:"text-h5 text-tertiary"})]),_:1}),s(u,null,{default:r(()=>[s(b,{caption:"",class:"text-tertiary"},{default:r(()=>[p("Cria\xE7\xE3o RPS")]),_:1}),s(b,{class:"text-tertiary"},{default:r(()=>[p(y(t.$filters.dataHora(n.rps.dataHoraCriacao)),1)]),_:2},1024)]),_:2},1024),s(u,{avatar:""},{default:r(()=>[s(w,{name:"today",class:"text-h5 text-tertiary"})]),_:1}),s(u,null,{default:r(()=>[s(b,{caption:"",class:"text-tertiary"},{default:r(()=>[p("Emiss\xE3o NFS-e")]),_:1}),s(b,{class:"text-tertiary"},{default:r(()=>[p(y(t.$filters.dataHora(n.rps.dataEmissao)),1)]),_:2},1024)]),_:2},1024)])]),_:2},1024)):x("",!0),s(J,{spaced:""})]))),128))]),_:1})):x("",!0)]),_:1},8,["checkboxModel","buscaCampo","onCriar_click","onFiltro_change","onLimparFiltros_click","onAbrirTodosPreview","onExportarXLSX_click","lista","tabs","tabSelecionada","paginacao","filtros"]),s(f,{ref:"modalNfse",onAtualizar:l.atualizar},null,8,["onAtualizar"]),s(h,{ref:"jsonViewer"},null,512),s(G,{modelValue:e.dialogoSincronizarLote.visivel,"onUpdate:modelValue":a[21]||(a[21]=n=>e.dialogoSincronizarLote.visivel=n),"content-css":{minWidth:"50vw"}},{default:r(()=>[s(X,null,{default:r(()=>[s(H,{class:"bg-primary text-white"},{default:r(()=>[s(Q,null,{default:r(()=>[p("Sincronizar Lote")]),_:1}),F(s(R,{dense:"",flat:"",icon:"close",round:""},null,512),[[D]])]),_:1}),s(B,null,{default:r(()=>[s(Z,{onSubmit:l.sincronizarLote},{default:r(()=>[s(N,{class:"q-col-gutter-md"},{default:r(()=>[C("div",na,[s(P,{modelValue:e.dialogoSincronizarLote.empresa,"onUpdate:modelValue":a[18]||(a[18]=n=>e.dialogoSincronizarLote.empresa=n),label:"Empresa",options:e.dialogoSincronizarLote.listaEmpresas,"option-value":"id","option-label":"label","emit-value":"","map-options":""},null,8,["modelValue","options"])]),C("div",ca,[s(c,{modelValue:e.dialogoSincronizarLote.periodoInicial,"onUpdate:modelValue":a[19]||(a[19]=n=>e.dialogoSincronizarLote.periodoInicial=n),tipo:"data",dense:"",outlined:""},null,8,["modelValue"])]),da,C("div",ua,[s(c,{modelValue:e.dialogoSincronizarLote.periodoFinal,"onUpdate:modelValue":a[20]||(a[20]=n=>e.dialogoSincronizarLote.periodoFinal=n),tipo:"data",dense:"",outlined:""},null,8,["modelValue"])])]),_:1}),C("div",ma,[F(s(R,{color:"tertiary",flat:"",label:"Cancelar"},null,512),[[D]]),s(R,{color:"primary",class:"q-ml-sm no-shadow",unelevated:"",label:"Sincronizar",type:"submit"})])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}var Ca=T(aa,[["render",pa]]);export{Ca as default};
