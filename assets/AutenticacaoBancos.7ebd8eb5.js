import{_,aR as g,aG as S,aS as f,o as t,n as r,d as u,w as p,k as x,aT as A,at as k,B as c,f as d,q as w,aU as b,F as $,s as O,aV as C,aW as q,e as P,Q as v,aX as y,t as V}from"./index.9b156bba.js";const I={data(){return{filtro:"",mostrarCheckboxModoOffline:!1,modoOffline:!0,idClienteSistemaSelecionado:null,idsClienteSistemaSelecionados:[],operacao:"",plataformaPercentagem:"0 %",clienteSistemasFiltrado:[],erroAcoes:[{label:"Retomar",handler:this.atualizar}]}},methods:{async abrirSistema(){this.operacao="redirecionando",this.$router.push({name:"Home"})},async atualizar(){$utils.gconsole.log("AutenticacaoBancos","atualizar()");try{if($q.loading.show(),!navigator.onLine){this.operacao="semConexao";return}const i=JSON.parse(localStorage.getItem("clienteSistemaBaixados")||"[]").map(a=>a.idClienteSistema),n=a=>""+(99-Number(a.padrao))+Number(!i.includes(a.idClienteSistema))+a.sistema+a.bancoDeDados;if(await $db.usuario.inicializaLogado(),navigator.onLine){const a=await $utils.geeksApi({clienteSistemas:{funcao:"50BD6521-7654-4455-A161-BDFFCC1AA3A9"}},{bancoDeDados:"GeeksPlat15A"});this.sistemas=a.data.clienteSistemas.sort((m,s)=>n(m).localeCompare(n(s)))}else this.sistemas=$db.usuario.logado.sistemas.sort((a,m)=>n(a).localeCompare(n(m)));if(!(await g.getDatabaseNames()).includes("plataforma"))return this.$q.notifyError("O banco principal n\xE3o foi encontrado."),this.desconectar();if(!Array.isArray(this.sistemas))return this.$q.notifyError("N\xE3o foi poss\xEDvel obter os bancos de dados."),this.desconectar();if(this.sistemas.length<=0)return this.$q.notifyError("Este usu\xE1rio n\xE3o possui direito de acesso a nenhum sistema."),this.desconectar();const o=this.sistemas.filter(a=>a.versao==="19A");if(this.operacao==="selecionar"){$utils.gconsole.log("AutenticacaoBancos","aguardando selecionar sistemas/bancos"),this.idsClienteSistemaSelecionados=i,this.idsClienteSistemaSelecionadosBkp=$utils.clonar(this.idsClienteSistemaSelecionados),this.clienteSistemasFiltrado=this.sistemas;return}if(!localStorage.getItem("clienteSistema")){o.length<=1&&this.sistemas.length<=10?($utils.gconsole.log("AutenticacaoBancos","menos de 10 sistemas online e 1 banco offline"),this.idsClienteSistemaSelecionados=this.sistemas.map(a=>a.idClienteSistema),this.adicionarBancos()):($utils.gconsole.log("AutenticacaoBancos","aguardando selecionar sistemas/bancos"),this.idsClienteSistemaSelecionados=i,this.clienteSistemasFiltrado=this.sistemas,this.operacao="selecionar");return}return!$db.app.modoOnline.le()&&localStorage.getItem("sincronismoPlat")!=="ok"?this.sincronismoInicial():($utils.gconsole.log("abrirSistema","via atualizar"),this.abrirSistema())}catch(e){this.$q.notifyError("Erro na opera\xE7\xE3o",e)}finally{$q.loading.hide()}},obterDispositivo(){let e=localStorage.getItem("dispositivoCliente");return e||(e=$utils.uuid(),localStorage.setItem("dispositivoCliente",e)),{id:e,detalhe:JSON.stringify({navigator:navigator?{platform:navigator.platform,vendor:navigator.vendor,appVersion:navigator.appVersion,userAgent:navigator.userAgent,deviceMemory:navigator.deviceMemory,connection_downlink:(navigator.connection||{}).downlink}:{},screen:screen?{width:screen.width,height:screen.height}:{},usuario:{id:$db.usuario.logado.id,nome:$db.usuario.logado.nome},dataHora:$utils.dataAtual()})}},toggleModoOffline(){var e;this.idClienteSistemaSelecionado=null,this.idsClienteSistemaSelecionados=$utils.clonar((e=this.idsClienteSistemaSelecionadosBkp)!=null?e:[])},async logarOnline(){$db.app.modoOnline.grava(!0);const e=this.sistemas.find(n=>n.idClienteSistema===this.idClienteSistemaSelecionado);$db.cache.setJson("clienteSistema",e),$db.cache.set("bancoDeDados",e.bancoDeDados);const i=await $db.permissao.telaInicial();await this.$router.push(i)},clienteSistemaSelecionado(){this.idClienteSistemaSelecionado&&(this.idsClienteSistemaSelecionados=[this.idsClienteSistemaSelecionados])},async adicionarBancos(){if($utils.gconsole.log("AutenticacaoBancos","adicionarBancos()"),!this.idsClienteSistemaSelecionados.length)return this.operacao="selecionar",this.$q.notifyError("Banco de dados n\xE3o selecionado");if(this.modoOffline===!1&&this.idClienteSistemaSelecionado){await this.logarOnline();return}$db.app.modoOnline.grava(!1),this.operacao="adicionandoBancoDeDados";const e=JSON.parse(localStorage.getItem("clienteSistema")||"null"),i=this.sistemas.filter(s=>this.idsClienteSistemaSelecionados.includes(s.idClienteSistema)),n=e&&this.idsClienteSistemaSelecionados.includes(e.id)?e:i[0],h=this.obterDispositivo(),o=i.filter(s=>s.versao==="19A"),l=$utils.unicos(o,"bancoDeDados"),a=await S.sincronismo.toArray();$db.cache.setJson("clienteSistemaBaixados",i),$db.cache.setJson("clienteSistema",n),$db.cache.set("bancoDeDados",n.bancoDeDados),localStorage.setItem("sincronismoPlat","sincronizando"),localStorage.setItem("versaoPlataforma",""),$db.cache.setJson("sincronismoPlataforma",{});for(const s of S.tables)s.name!=="login"&&await s.clear();(await g.getDatabaseNames()).filter(s=>s!=="plataforma"&&!l.includes(s)).forEach(s=>{$erp(s,"delete")});for(const s of l){const D=a.find(B=>B.bancoDeDados===s)||{bancoDeDados:s};await S.sincronismo.put(D),await $db.dispositivoCliente.grava(h,s)}return await f.atualizarStatus(),this.plataformaPercentagem="0 %",this.sincronismoInicial()},desconectar(){$utils.gconsole.log("AutenticacaoBancos","desconectar()"),$db.usuario.desconecta(),this.$router.push({name:"Autenticacao"})},async sincronismoInicial(){$utils.gconsole.log("AutenticacaoBancos","sincronismoInicial()"),f.descarregarPlataforma(),f.descarregarErp(),this.operacao="sincronizando"},sincronismoPlataformaPercentagem(e){this.plataformaPercentagem=e,e==="100 %"&&e&&this.operacao!=="selecionar"&&this.abrirSistema()}},watch:{filtro(e){$utils.gconsole.log("AutenticacaoBancos","filtro",e),e?this.clienteSistemasFiltrado=this.sistemas.filter(i=>i.bancoDeDados.toUpperCase().includes(e.toUpperCase())):this.clienteSistemasFiltrado=this.sistemas}},async created(){this.operacao=this.$route.params.operacao;const e=JSON.parse(localStorage.getItem("usuario"));e.administrador&&e.grupoInterno===1&&(this.mostrarCheckboxModoOffline=!0,this.modoOffline=!$db.app.modoOnline.le())},async mounted(){await this.atualizar(),this.sistemas.length===1&&this.sistemas[0].versao==="15A"&&(this.idClienteSistemaSelecionado=this.sistemas[0].idClienteSistema,await this.logarOnline()),$utils.emitter.on("sincronismoPlataformaPercentagem",this.sincronismoPlataformaPercentagem,this)},beforeUnmount(){$utils.emitter.off("sincronismoPlataformaPercentagem",this.sincronismoPlataformaPercentagem)}},z={class:"AutenticacaoBancos"},N=c("p",null,"Selecione os bancos de dados que deseja disponibilizar nesta m\xE1quina:",-1),F={class:"AutenticacaoBancos-bancos"},E={key:0,class:"actions q-mt-lg"},U={class:"actions q-mt-lg"},J={key:2,class:"q-mt-md text-white"},M=c("div",{class:"text-body2 q-mt-sm"},"Aguarde, sincronizando...",-1),Q={class:"text-caption q-mt-sm text-light"},R={key:3,class:"q-mt-md text-white"},L=c("div",{class:"text-body2 q-mt-sm"},"Redirecionando...",-1),T=[L],G={key:4,class:"q-mt-md text-white"},H=c("div",{class:"text-body2 q-mt-sm"},"Adicionado bancos de dados...",-1),j={key:5,class:"q-mt-md text-white"},W=c("div",{class:"text-body2 q-mt-sm"},"Carregando...",-1),X=[W];function K(e,i,n,h,o,l){return t(),r("div",z,[o.operacao==="semConexao"?(t(),u(A,{key:0,actions:o.erroAcoes,detail:"Tente novamente em instantes.",type:"negative"},{default:p(()=>[x(" Erro ao estabelecer conex\xE3o. ")]),_:1},8,["actions"])):o.operacao==="selecionar"?(t(),r("form",{key:1,class:"text-white",onSubmit:i[4]||(i[4]=k((...a)=>l.adicionarBancos&&l.adicionarBancos(...a),["prevent"]))},[N,c("div",F,[d(b,{"error-label":"Informe uma senha v\xE1lida.",class:"q-px-sm"},{default:p(()=>[d(w,{modelValue:o.filtro,"onUpdate:modelValue":i[0]||(i[0]=a=>o.filtro=a),filled:"",dark:"",dense:"",label:"Filtro"},null,8,["modelValue"])]),_:1}),(t(!0),r($,null,O(o.clienteSistemasFiltrado,(a,m)=>(t(),u(b,{key:m},{default:p(()=>[o.modoOffline?(t(),u(C,{key:0,modelValue:o.idsClienteSistemaSelecionados,"onUpdate:modelValue":i[1]||(i[1]=s=>o.idsClienteSistemaSelecionados=s),label:a.sistema+" - "+a.bancoDeDados,val:a.idClienteSistema,dark:"",color:"primary"},null,8,["modelValue","label","val"])):(t(),u(q,{key:1,modelValue:o.idClienteSistemaSelecionado,"onUpdate:modelValue":[i[2]||(i[2]=s=>o.idClienteSistemaSelecionado=s),l.clienteSistemaSelecionado],label:a.sistema+" - "+a.bancoDeDados,val:a.idClienteSistema,dark:"",color:"primary"},null,8,["modelValue","label","val","onUpdate:modelValue"]))]),_:2},1024))),128))]),o.mostrarCheckboxModoOffline?(t(),r("div",E,[d(C,{modelValue:o.modoOffline,"onUpdate:modelValue":[i[3]||(i[3]=a=>o.modoOffline=a),l.toggleModoOffline],label:"Permitir funcionamento sem internet",dark:"",color:"primary"},null,8,["modelValue","onUpdate:modelValue"])])):P("",!0),c("div",U,[d(v,{color:"transparent",label:"Desconectar",size:"md","text-color":"primary",onClick:l.desconectar},null,8,["onClick"]),d(v,{autofocus:"",class:"q-ml-md",color:"white",label:"Continuar","text-color":"primary",type:"submit",disable:!o.idsClienteSistemaSelecionados.length},null,8,["disable"])])],32)):o.operacao==="sincronizando"?(t(),r("div",J,[d(y,{color:"white",size:35}),M,c("div",Q," plataforma: "+V(o.plataformaPercentagem),1)])):o.operacao==="redirecionando"?(t(),r("div",R,T)):o.operacao==="adicionandoBancoDeDados"?(t(),r("div",G,[d(y,{color:"white",size:35}),H])):(t(),r("div",j,X))])}var Z=_(I,[["render",K]]);export{Z as default};
